<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@solutionschecker.com"/><meta name="twitter:creator" content="@solutionschecker.com"/><meta property="og:url" content="https://solutionschecker.com"/><meta property="og:type" content="website"/><meta property="og:image" content="https://solutionschecker.com/solutions-checker-banner.png"/><meta property="og:image:alt" content="Find the solution to any question. We focus on finding the fastest possible solution for users. Main topics like coding, learning. - solutionschecker.com"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","logo":"/logo.svg","url":"https://solutionschecker.com"}</script><title>postgresql tags | Solution Checker</title><meta name="robots" content="index,follow"/><meta name="description" content="All questions and solutions for postgresql tags"/><meta property="og:title" content="postgresql tags | Solution Checker"/><meta property="og:description" content="All questions and solutions for postgresql tags"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/c116652e2d6f4ad0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c116652e2d6f4ad0.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-42cdea76c8170223.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-ccfab947c79712f4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-43d1c35cd6eb9b8f.js" defer=""></script><script src="/_next/static/chunks/29107295-fbcfe2172188e46f.js" defer=""></script><script src="/_next/static/chunks/294-106ef8570fa99deb.js" defer=""></script><script src="/_next/static/chunks/912-9618bcf05da7091d.js" defer=""></script><script src="/_next/static/chunks/596-971e6593fb286f13.js" defer=""></script><script src="/_next/static/chunks/pages/questions/tag/%5Bslug%5D-e6668db30eb0d032.js" defer=""></script><script src="/_next/static/00bsHgHZki2FteshOatnd/_buildManifest.js" defer=""></script><script src="/_next/static/00bsHgHZki2FteshOatnd/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="wrapper"><header><nav class="bg-white border-gray-200 px-4 lg:px-6 py-2.5 dark:bg-gray-800"><div class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl"><a class="flex items-center" href="/"><img src="/logo-second.png" class="mr-3 h-6 sm:h-9" alt="Solution Checker Logo"/><h1 class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">Solution Checker</h1></a><div class="flex items-center lg:order-2"><button data-collapse-toggle="mobile-menu-2" type="button" class="inline-flex items-center p-2 ml-1 text-sm text-gray-500 rounded-lg lg:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="mobile-menu-2" aria-expanded="false"><span class="sr-only">Open main menu</span><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg><svg class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><div class="hidden justify-between items-center w-full lg:flex lg:w-auto lg:order-1" id="mobile-menu-2"><ul class="flex flex-col mt-4 font-medium lg:flex-row lg:space-x-8 lg:mt-0"><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" aria-current="page" href="/">Home</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions?tab=news">Questions</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/post?tab=news">Post</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions/tag/postgresql#">Coding</a></li></ul></div></div></nav></header><div class="main-content"><div class="pagination-page-wrapper"><span class="pagination-buttons previous bg-stone-500 cursor-not-allowed  hover:bg-stone-500 text-white font-bold py-2 px-4 rounded">Previous</span></div><div class="question my-5"><div class="flex items-center justify-center"><div class="rounded-xl border p-5 shadow-md post-layout-inner bg-white"><div class="flex w-full items-center justify-between border-b pb-3"><div class="flex items-center space-x-3"><div class="text-lg font-bold text-slate-700"><a href="/questions/select-first-row-in-each-group-by-group-1657384809388">Select first row in each GROUP BY group?</a></div></div></div><div class="tags-wrap h-max space-x-8"><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div><div class="flex items-center justify-between text-slate-500"><div class="flex space-x-4 md:space-x-8"><span class="btn bg-stone-500 cursor-pointer mt-5  hover:bg-stone-500 text-white font-bold py-2 px-4 rounded">Show Solution</span></div></div></div></div></div></div><div class="pagination-page-wrapper"><span class="pagination-buttons next bg-stone-500 cursor-not-allowed  hover:bg-stone-500 text-white font-bold py-2 px-4 rounded">Next</span></div><div class="widget"><a href="/questions/tag/startactivityforresult">startactivityforresult</a><a href="/questions/tag/computer-science">computer-science</a><a href="/questions/tag/event-loop">event-loop</a><a href="/questions/tag/tkinter">tkinter</a><a href="/questions/tag/php-password-hash">php-password-hash</a><a href="/questions/tag/server-side">server-side</a><a href="/questions/tag/selenium4">selenium4</a><a href="/questions/tag/validation">validation</a><a href="/questions/tag/deep-copy">deep-copy</a><a href="/questions/tag/shallow-copy">shallow-copy</a><a href="/questions/tag/python">python</a><a href="/questions/tag/return">return</a><a href="/questions/tag/c++-faq">c++-faq</a><a href="/questions/tag/git-rewrite-history">git-rewrite-history</a><a href="/questions/tag/objective-c">objective-c</a><a href="/questions/tag/selenium3">selenium3</a><a href="/questions/tag/greatest-n-per-group">greatest-n-per-group</a><a href="/questions/tag/iterator">iterator</a><a href="/questions/tag/data.table">data.table</a><a href="/questions/tag/standards">standards</a></div></div><span class="cursor-pointer text-lg p-2" style="position:fixed;bottom:20px;left:20px;background:#000;z-index:2000;color:white">Go go top</span></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"count":1,"rows":[{"id":157,"title":"Select first row in each GROUP BY group?","slug":"select-first-row-in-each-group-by-group-1657384809388","postType":"QUESTION","createdAt":"2022-07-09T16:40:09.000Z","updatedAt":"2022-07-09T16:40:09.000Z","tags":[{"id":571,"name":"postgresql","slug":"postgresql","createdAt":"2022-07-09T16:40:09.000Z","updatedAt":"2022-07-09T16:40:09.000Z","Questions_Tags":{"questionId":157,"tagId":571}}]}]},"slug":"postgresql","page":1,"answers":{"157":["\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;\u0026lt;/a\u0026gt; is typically simplest and fastest for this in \u0026lt;strong\u0026gt;PostgreSQL\u0026lt;/strong\u0026gt;.\u0026lt;br\u0026gt;\n\u0026lt;sub\u0026gt;(For performance optimization for certain workloads see below.)\u0026lt;/sub\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; (customer)\n       id, customer, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Or shorter (if not as clear) with ordinal numbers of output columns:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;)\n       id, customer, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;If \u0026lt;code\u0026gt;total\u0026lt;/code\u0026gt; can be NULL, add \u0026lt;code\u0026gt;NULLS LAST\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;...\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt; NULLS \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LAST\u0026lt;/span\u0026gt;, id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Works either way, but you\u0026apos;ll want to \u0026lt;a href=\u0026quot;https://dba.stackexchange.com/q/254731/3684\u0026quot;\u0026gt;match existing indexes\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=bf589b26f6e9fe8cdf3c6ca6e045eb6d\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;Major points\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt; is a PostgreSQL extension of the standard, where only \u0026lt;code\u0026gt;DISTINCT\u0026lt;/code\u0026gt; on the whole \u0026lt;code\u0026gt;SELECT\u0026lt;/code\u0026gt; list is defined.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;List any number of expressions in the \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; clause, the combined row value defines duplicates. \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/queries-select-lists.html#QUERIES-DISTINCT\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;The manual:\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;Obviously, two rows are considered distinct if they differ in at least\none column value. \u0026lt;strong\u0026gt;Null values are considered equal in this\ncomparison.\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\u0026lt;p\u0026gt;Bold emphasis mine.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; can be combined with \u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;. Leading expressions in \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; must be in the set of expressions in \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;, but you can rearrange order among those freely. \u0026lt;a href=\u0026quot;https://dba.stackexchange.com/a/89786/3684\u0026quot;\u0026gt;Example.\u0026lt;/a\u0026gt;\u0026lt;br\u0026gt;\nYou can add \u0026lt;em\u0026gt;additional\u0026lt;/em\u0026gt; expressions to \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; to pick a particular row from each group of peers. Or, as \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;the manual puts it\u0026lt;/a\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;The \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; expression(s) must match the leftmost \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt;\nexpression(s). The \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; clause will normally contain additional\nexpression(s) that determine the desired precedence of rows within\neach \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; group.\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\u0026lt;p\u0026gt;I added \u0026lt;code\u0026gt;id\u0026lt;/code\u0026gt; as last item to break ties:\u0026lt;br\u0026gt;\n\u0026lt;em\u0026gt;\u0026quot;Pick the row with the smallest \u0026lt;code\u0026gt;id\u0026lt;/code\u0026gt; from each group sharing the highest \u0026lt;code\u0026gt;total\u0026lt;/code\u0026gt;.\u0026quot;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;To order results in a way that disagrees with the sort order determining the first per group, you can nest above query in an outer query with another \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt;. \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/9796104/939860\u0026quot;\u0026gt;Example.\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;If \u0026lt;code\u0026gt;total\u0026lt;/code\u0026gt; can be NULL, you \u0026lt;em\u0026gt;most probably\u0026lt;/em\u0026gt; want the row with the greatest non-null value. Add \u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;NULLS LAST\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt; like demonstrated. See:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/9510509/postgresql-sort-by-datetime-asc-null-first/9511492#9511492\u0026quot;\u0026gt;Sort by column ASC, but NULL values first?\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;The \u0026lt;code\u0026gt;SELECT\u0026lt;/code\u0026gt; list\u0026lt;/strong\u0026gt; is not constrained by expressions in \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; or \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; in any way:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;You \u0026lt;em\u0026gt;don\u0026apos;t have to\u0026lt;/em\u0026gt; include any of the expressions in \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; or \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt;.\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;You \u0026lt;em\u0026gt;can\u0026lt;/em\u0026gt; include any other expression in the \u0026lt;code\u0026gt;SELECT\u0026lt;/code\u0026gt; list. This is instrumental for replacing complex subqueries and aggregate / window functions.\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;I tested with Postgres versions 8.3  15. But the feature has been there at least since version 7.1, so basically always.\u0026lt;/p\u0026gt;\n\u0026lt;h2\u0026gt;Index\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;The \u0026lt;em\u0026gt;perfect\u0026lt;/em\u0026gt; index for the above query would be a \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/indexes-multicolumn.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;multi-column index\u0026lt;/a\u0026gt; spanning all three columns in matching sequence and with matching sort order:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; INDEX purchases_3c_idx \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; purchases (customer, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;May be too specialized. But use it if read performance for the particular query is crucial. If you have \u0026lt;code\u0026gt;DESC NULLS LAST\u0026lt;/code\u0026gt; in the query, use the same in the index so that sort order matches and the index is perfectly applicable.\u0026lt;/p\u0026gt;\n\u0026lt;h2\u0026gt;Effectiveness / Performance optimization\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;Weigh cost and benefit before creating tailored indexes for each query. The potential of above index largely depends on \u0026lt;strong\u0026gt;data distribution\u0026lt;/strong\u0026gt;.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;The index is used because it delivers pre-sorted data. In Postgres 9.2 or later the query can also benefit from an \u0026lt;strong\u0026gt;\u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/indexes-index-only-scans.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;index only scan\u0026lt;/a\u0026gt;\u0026lt;/strong\u0026gt; if the index is smaller than the underlying table. The index has to be scanned in its entirety, though. \u0026lt;a href=\u0026quot;https://dba.stackexchange.com/a/313755/3684\u0026quot;\u0026gt;Example.\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;For \u0026lt;strong\u0026gt;\u0026lt;em\u0026gt;few\u0026lt;/em\u0026gt; rows per customer\u0026lt;/strong\u0026gt; (high cardinality in column \u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt;), this is very efficient. Even more so if you need sorted output anyway. The benefit shrinks with a growing number of rows per customer.\u0026lt;br\u0026gt;\nIdeally, you have enough \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-WORK-MEM\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;work_mem\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;\u0026lt;/a\u0026gt; to process the involved sort step in RAM and not spill to disk. But generally setting \u0026lt;code\u0026gt;work_mem\u0026lt;/code\u0026gt; \u0026lt;em\u0026gt;too\u0026lt;/em\u0026gt; high can have adverse effects. Consider \u0026lt;code\u0026gt;SET LOCAL\u0026lt;/code\u0026gt; for exceptionally big queries. Find how much you need with \u0026lt;code\u0026gt;EXPLAIN ANALYZE\u0026lt;/code\u0026gt;. Mention of \u0026quot;\u0026lt;em\u0026gt;Disk:\u0026lt;/em\u0026gt;\u0026quot; in the sort step indicates the need for more:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/8106181/configuration-parameter-work-mem-in-postgresql-on-linux/8108807#8108807\u0026quot;\u0026gt;Configuration parameter work_mem in PostgreSQL on Linux\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://dba.stackexchange.com/a/48633/3684\u0026quot;\u0026gt;Optimize simple query using ORDER BY date and text\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;For \u0026lt;strong\u0026gt;\u0026lt;em\u0026gt;many\u0026lt;/em\u0026gt; rows per customer\u0026lt;/strong\u0026gt; (low cardinality in column \u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt;), a \u0026lt;a href=\u0026quot;https://wiki.postgresql.org/wiki/Loose_indexscan\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;strong\u0026gt;loose index scan\u0026lt;/strong\u0026gt;\u0026lt;/a\u0026gt; (a.k.a. \u0026quot;skip scan\u0026quot;) would be (much) more efficient, but that\u0026apos;s not implemented up to Postgres 14. (An implementation for index-only scans is in development for Postgres 15. See \u0026lt;a href=\u0026quot;https://commitfest.postgresql.org/19/1741/\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt; and \u0026lt;a href=\u0026quot;https://www.postgresql.org/message-id/flat/20200609102247.jdlatmfyeecg52fi%40localhost\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;.)\u0026lt;br\u0026gt;\nFor now, there are \u0026lt;strong\u0026gt;faster query techniques\u0026lt;/strong\u0026gt; to substitute for this. In particular if you have a separate table holding unique customers, which is the typical use case. But also if you don\u0026apos;t:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/66893968/select-distinct-is-slower-than-expected-on-my-table-in-postgresql/66894500#66894500\u0026quot;\u0026gt;SELECT DISTINCT is slower than expected on my table in PostgreSQL\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/25536422/optimize-group-by-query-to-retrieve-latest-record-per-user/25536748#25536748\u0026quot;\u0026gt;Optimize GROUP BY query to retrieve latest row per user\u0026lt;/a\u0026gt;\u0026lt;/strong\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/24244026/optimize-groupwise-maximum-query/24377356#24377356\u0026quot;\u0026gt;Optimize groupwise maximum query\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/25957558/querying-last-n-related-records-in-postgres/25965393#25965393\u0026quot;\u0026gt;Query last N related rows per row\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h2\u0026gt;Benchmarks\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/34715134/939860\u0026quot;\u0026gt;See separate answer.\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;h2\u0026gt;On databases that \u0026lt;a href=\u0026quot;https://en.wikipedia.org/wiki/Hierarchical_and_recursive_queries_in_SQL#Common_table_expression\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;support CTE and windowing functions\u0026lt;/a\u0026gt;:\u0026lt;/h2\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WITH\u0026lt;/span\u0026gt; summary \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; p.id, \n           p.customer, \n           p.total, \n           \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ROW_NUMBER\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.customer \n                                 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; rank\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; PURCHASES p)\n \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; summary\n \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; rank \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h2\u0026gt;Supported by any database:\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;But you need to add logic to break ties:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MIN\u0026lt;/span\u0026gt;(x.id),  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- change to MAX if you want the highest\u0026lt;/span\u0026gt;\n         x.customer, \n         x.total\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; PURCHASES x\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; p.customer,\n                 \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; max_total\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; PURCHASES p\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.customer) y \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; y.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; x.customer\n                              \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; y.max_total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; x.total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; x.customer, x.total\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;h1\u0026gt;Benchmarks\u0026lt;/h1\u0026gt;\n\u0026lt;p\u0026gt;I tested the most interesting candidates:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Initially with \u0026lt;strong\u0026gt;Postgres 9.4\u0026lt;/strong\u0026gt; and \u0026lt;strong\u0026gt;9.5\u0026lt;/strong\u0026gt;.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Added accented tests for \u0026lt;strong\u0026gt;Postgres 13\u0026lt;/strong\u0026gt; later.\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h3\u0026gt;Basic test setup\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;Main table: \u0026lt;code\u0026gt;purchases\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; purchases (\n  id          serial  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- PK constraint added below\u0026lt;/span\u0026gt;\n, customer_id \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- REFERENCES customer\u0026lt;/span\u0026gt;\n, total       \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- could be amount of money in Cent\u0026lt;/span\u0026gt;\n, some_column text    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- to make the row bigger, more realistic\u0026lt;/span\u0026gt;\n);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Dummy data (with some dead tuples), PK, index:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INSERT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INTO\u0026lt;/span\u0026gt; purchases (customer_id, total, some_column)    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- 200k rows\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; (random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10000\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; customer_id  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- 10k distinct customers\u0026lt;/span\u0026gt;\n     , (random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;100000\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; total     \n     , \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;note: \u0026apos;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;||\u0026lt;/span\u0026gt; repeat(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;x\u0026apos;\u0026lt;/span\u0026gt;, (random()\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;^\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   generate_series(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;200000\u0026lt;/span\u0026gt;) g;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ALTER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ADD\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CONSTRAINT\u0026lt;/span\u0026gt; purchases_id_pkey \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PRIMARY\u0026lt;/span\u0026gt; KEY (id);\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DELETE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0.9\u0026lt;/span\u0026gt;;  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- some dead rows\u0026lt;/span\u0026gt;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INSERT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INTO\u0026lt;/span\u0026gt; purchases (customer_id, total, some_column)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; (random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10000\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; customer_id  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- 10k customers\u0026lt;/span\u0026gt;\n     , (random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;100000\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; total     \n     , \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;note: \u0026apos;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;||\u0026lt;/span\u0026gt; repeat(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;x\u0026apos;\u0026lt;/span\u0026gt;, (random()\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;^\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   generate_series(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;20000\u0026lt;/span\u0026gt;) g;  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- add 20k to make it ~ 200k\u0026lt;/span\u0026gt;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; INDEX purchases_3c_idx \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; purchases (customer_id, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id);\n\nVACUUM ANALYZE purchases;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt; table - used for optimized query:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; customer \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; customer_id, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;customer_\u0026apos;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;||\u0026lt;/span\u0026gt; customer_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ALTER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; customer \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ADD\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CONSTRAINT\u0026lt;/span\u0026gt; customer_customer_id_pkey \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PRIMARY\u0026lt;/span\u0026gt; KEY (customer_id);\n\nVACUUM ANALYZE customer;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;In my second test for 9.5 I used the same setup, but with 100000 distinct \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt; to get \u0026lt;em\u0026gt;few\u0026lt;/em\u0026gt; rows per \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt;.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;Object sizes for table \u0026lt;code\u0026gt;purchases\u0026lt;/code\u0026gt;\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;Basic setup: 200k rows in \u0026lt;code\u0026gt;purchases\u0026lt;/code\u0026gt;, 10k distinct \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt;, avg. 20 rows per customer.\u0026lt;br\u0026gt;\nFor Postgres 9.5 I added a 2nd test with 86446 distinct customers - avg. 2.3 rows per customer.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Generated with a query taken from here:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://dba.stackexchange.com/a/23933/3684\u0026quot;\u0026gt;Measure the size of a PostgreSQL table row\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;Gathered for Postgres 9.5:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;               what                | bytes/ct | bytes_pretty | bytes_per_row\n-----------------------------------+----------+--------------+---------------\n core_relation_size                | 20496384 | 20 MB        |           102\n visibility_map                    |        0 | 0 bytes      |             0\n free_space_map                    |    24576 | 24 kB        |             0\n table_size_incl_toast             | 20529152 | 20 MB        |           102\n indexes_size                      | 10977280 | 10 MB        |            54\n total_size_incl_toast_and_indexes | 31506432 | 30 MB        |           157\n live_rows_in_text_representation  | 13729802 | 13 MB        |            68\n ------------------------------    |          |              |\n row_count                         |   200045 |              |\n live_tuples                       |   200045 |              |\n dead_tuples                       |    19955 |              |\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h1\u0026gt;Queries\u0026lt;/h1\u0026gt;\n\u0026lt;h3\u0026gt;1. \u0026lt;code\u0026gt;row_number()\u0026lt;/code\u0026gt; in CTE, (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/3800572/939860\u0026quot;\u0026gt;see other answer\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WITH\u0026lt;/span\u0026gt; cte \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; (\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n        , \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; rn\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n   )\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   cte\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  rn \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;2. \u0026lt;code\u0026gt;row_number()\u0026lt;/code\u0026gt; in subquery (my optimization)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   (\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n        , \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; rn\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n   ) sub\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  rn \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;3. \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/7630564/939860\u0026quot;\u0026gt;see other answer\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; (customer_id)\n       id, customer_id, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;4. rCTE with \u0026lt;code\u0026gt;LATERAL\u0026lt;/code\u0026gt; subquery (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/25536748/939860\u0026quot;\u0026gt;see here\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WITH\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;RECURSIVE\u0026lt;/span\u0026gt; cte \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; (\n   (  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- parentheses required\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n   LIMIT  \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n   )\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;UNION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ALL\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; u.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   cte c\n   ,      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LATERAL\u0026lt;/span\u0026gt; (\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  customer_id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt; c.customer_id  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- lateral reference\u0026lt;/span\u0026gt;\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n      LIMIT  \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n      ) u\n   )\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   cte\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;5. \u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt; table with \u0026lt;code\u0026gt;LATERAL\u0026lt;/code\u0026gt; (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/25536748/939860\u0026quot;\u0026gt;see here\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; l.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   customer c\n,      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LATERAL\u0026lt;/span\u0026gt; (\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  customer_id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; c.customer_id  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- lateral reference\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n   LIMIT  \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n   ) l;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;6. \u0026lt;code\u0026gt;array_agg()\u0026lt;/code\u0026gt; with \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/25534279/939860\u0026quot;\u0026gt;see other answer\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;array_agg\u0026lt;/span\u0026gt;(id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;))[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;] \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; id\n     , customer_id\n     , \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;max\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h1\u0026gt;Results\u0026lt;/h1\u0026gt;\n\u0026lt;p\u0026gt;Execution time for above queries with \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/sql-explain.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;code\u0026gt;EXPLAIN (ANALYZE, TIMING OFF, COSTS OFF\u0026lt;/code\u0026gt;\u0026lt;/a\u0026gt;, \u0026lt;em\u0026gt;best of 5 runs\u0026lt;/em\u0026gt; to compare with warm cache.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;All\u0026lt;/em\u0026gt; queries used an \u0026lt;strong\u0026gt;Index Only Scan\u0026lt;/strong\u0026gt; on \u0026lt;code\u0026gt;purchases2_3c_idx\u0026lt;/code\u0026gt; (among other steps). Some only to benefit from the smaller size of the index, others more effectively.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;A. Postgres 9.4 with 200k rows and ~ 20 per \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt;\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 273.274 ms  \n2. 194.572 ms  \n3. 111.067 ms  \n4.  92.922 ms  -- !\n5.  37.679 ms  -- winner\n6. 189.495 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;B. Same as A. with Postgres 9.5\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 288.006 ms\n2. 223.032 ms  \n3. 107.074 ms  \n4.  78.032 ms  -- !\n5.  33.944 ms  -- winner\n6. 211.540 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;C. Same as B., but with ~ 2.3 rows per \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt;\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 381.573 ms\n2. 311.976 ms\n3. 124.074 ms  -- winner\n4. 710.631 ms\n5. 311.976 ms\n6. 421.679 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h1\u0026gt;Retest with Postgres 13 on 2021-08-11\u0026lt;/h1\u0026gt;\n\u0026lt;p\u0026gt;Simplified test setup: no deleted rows, because \u0026lt;code\u0026gt;VACUUM ANALYZE\u0026lt;/code\u0026gt; cleans the table completely for the simple case.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Important changes for Postgres:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;General performance improvements.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;CTEs can be inlined since Postgres 12, so query 1. and 2. now perform mostly identical (same query plan).\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h3\u0026gt;D. Like B. ~ 20 rows per customer_id\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 103 ms\n2. 103 ms  \n3.  23 ms  -- winner  \n4.  71 ms  \n5.  22 ms  -- winner\n6.  81 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=4cfd751a33e9d0ca3b024cb5795a5f6b\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;E. Like C. ~ 2.3 rows per customer_id\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 127 ms\n2. 126 ms  \n3.  36 ms  -- winner  \n4. 620 ms  \n5. 145 ms\n6. 203 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=e0eda395be68b453f51dc6fba4f3d4a6\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h2\u0026gt;Accented tests with Postgres 13\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;1M rows\u0026lt;/strong\u0026gt;, 10.000 vs. 100 vs. 1.6 rows per customer.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;F. with ~ 10.000 rows per customer\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 526 ms\n2. 527 ms  \n3. 127 ms\n4.   2 ms  -- winner !\n5.   1 ms  -- winner !\n6. 356 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=1ded28c4adedd3292ba5e0a8401a641f\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;G. with ~ 100 rows per customer\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 535 ms\n2. 529 ms  \n3. 132 ms\n4. 108 ms  -- !\n5.  71 ms  -- winner\n6. 376 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=5f797bb9e694a4f0117ed3c957af1de2\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;H. with ~ 1.6 rows per customer\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1.  691 ms\n2.  684 ms  \n3.  234 ms  -- winner\n4. 4669 ms\n5. 1089 ms\n6. 1264 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=6cd53673f04cf3b00a3aeb16fc071926\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h1\u0026gt;Conclusions\u0026lt;/h1\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;\u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; uses the index effectively and typically performs best for \u0026lt;strong\u0026gt;few\u0026lt;/strong\u0026gt; rows per group. And it performs decently even with many rows per group.\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;For \u0026lt;strong\u0026gt;many\u0026lt;/strong\u0026gt; rows per group, emulating an index skip scan with an rCTE performs best - second only to the query technique with a separate lookup table (if that\u0026apos;s available).\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;The \u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;row_number()\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt; technique demonstrated in the currently accepted answer \u0026lt;strong\u0026gt;never wins any performance test\u0026lt;/strong\u0026gt;. Not then, not now. It never comes even close to \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;, not even when the data distribution is unfavorable for the latter. The only good thing about \u0026lt;code\u0026gt;row_number()\u0026lt;/code\u0026gt;: it does not scale terribly, just mediocre.\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h2\u0026gt;More benchmarks\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;Benchmark by \u0026quot;ogr\u0026quot; with \u0026lt;strong\u0026gt;10M rows and 60k unique \u0026quot;customers\u0026quot;\u0026lt;/strong\u0026gt; on \u0026lt;strong\u0026gt;Postgres 11.5\u0026lt;/strong\u0026gt;. Results are in line with what we have seen so far:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/57893251/proper-way-to-access-latest-row-for-each-individual-identifier/57975451#57975451\u0026quot;\u0026gt;Proper way to access latest row for each individual identifier?\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h3\u0026gt;Original (outdated) benchmark from 2011\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;I ran three tests with PostgreSQL \u0026lt;strong\u0026gt;9.1\u0026lt;/strong\u0026gt; on a real life table of 65579 rows and single-column btree indexes on each of the three columns involved and took the best \u0026lt;em\u0026gt;execution time\u0026lt;/em\u0026gt; of 5 runs.\u0026lt;br\u0026gt;\nComparing \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/3800572/939860\u0026quot;\u0026gt;@OMGPonies\u0026apos;\u0026lt;/a\u0026gt; first query (\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;A\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;) to the \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/7630564/939860\u0026quot;\u0026gt;above \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; solution\u0026lt;/a\u0026gt; (\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;B\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;):\u0026lt;/p\u0026gt;\n\u0026lt;ol\u0026gt;\n\u0026lt;li\u0026gt;Select the whole table, results in 5958 rows in this case.\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;A: 567.218 ms\nB: 386.673 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;ol start=\u0026quot;2\u0026quot;\u0026gt;\n\u0026lt;li\u0026gt;Use condition \u0026lt;code\u0026gt;WHERE customer BETWEEN x AND y\u0026lt;/code\u0026gt; resulting in 1000 rows.\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;A: 249.136 ms\nB:  55.111 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;ol start=\u0026quot;3\u0026quot;\u0026gt;\n\u0026lt;li\u0026gt;Select a single customer with \u0026lt;code\u0026gt;WHERE customer = x\u0026lt;/code\u0026gt;.\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;A:   0.143 ms\nB:   0.072 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Same test repeated with the index described in the other answer:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; INDEX purchases_3c_idx \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; purchases (customer, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1A: 277.953 ms  \n1B: 193.547 ms\n\n2A: 249.796 ms -- special index not used  \n2B:  28.679 ms\n\n3A:   0.120 ms  \n3B:   0.048 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This is common \u0026lt;a href=\u0026quot;/questions/tagged/greatest-n-per-group\u0026quot; class=\u0026quot;post-tag\u0026quot; title=\u0026quot;show questions tagged \u0026apos;greatest-n-per-group\u0026apos;\u0026quot; rel=\u0026quot;tag\u0026quot;\u0026gt;greatest-n-per-group\u0026lt;/a\u0026gt; problem, which already has well tested and highly \u0026lt;a href=\u0026quot;https://stackoverflow.com/q/8748986/684229\u0026quot;\u0026gt;optimized solutions\u0026lt;/a\u0026gt;. Personally I prefer the \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/8749095/684229\u0026quot;\u0026gt;left join solution by Bill Karwin\u0026lt;/a\u0026gt; (the \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/123481/684229\u0026quot;\u0026gt;original post with lots of other solutions\u0026lt;/a\u0026gt;).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Note that bunch of solutions to this common problem can surprisingly be found in the one of most official sources, \u0026lt;strong\u0026gt;MySQL manual\u0026lt;/strong\u0026gt;! See \u0026lt;a href=\u0026quot;http://dev.mysql.com/doc/refman/5.0/en/example-maximum-column-group-row.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;Examples of Common Queries :: The Rows Holding the Group-wise Maximum of a Certain Column\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;In Postgres you can use \u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; like this:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;  customer,\n        (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;array_agg\u0026lt;/span\u0026gt;(id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;))[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;],\n        \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;max\u0026lt;/span\u0026gt;(total)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;This will give you the \u0026lt;code\u0026gt;id\u0026lt;/code\u0026gt; of each customer\u0026apos;s largest purchase.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Some things to note:\u0026lt;/p\u0026gt;\n\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; is an aggregate function, so it works with \u0026lt;code\u0026gt;GROUP BY\u0026lt;/code\u0026gt;.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; lets you specify an ordering scoped to just itself, so it doesn\u0026apos;t constrain the structure of the whole query. There is also syntax for how you sort NULLs, if you need to do something different from the default.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Once we build the array, we take the first element. (Postgres arrays are 1-indexed, not 0-indexed).\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;You could use \u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; in a similar way for your third output column, but \u0026lt;code\u0026gt;max(total)\u0026lt;/code\u0026gt; is simpler.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Unlike \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;, using \u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; lets you keep your \u0026lt;code\u0026gt;GROUP BY\u0026lt;/code\u0026gt;, in case you want that for other reasons.\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The solution is not very efficient as pointed by Erwin, because of presence of SubQs\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchases p1 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt;\n(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;max\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; p1.customer\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;customer) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;desc\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The Query:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; purchases.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LEFT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; p \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; \n  p.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; purchases.customer \n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \n  purchases.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt; p.total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IS\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;NULL\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;HOW DOES THAT WORK!\u0026lt;/strong\u0026gt; (I\u0026apos;ve been there)\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;We want to make sure that we only have the highest total for each purchase.\u0026lt;/p\u0026gt;\n\u0026lt;hr\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Some Theoretical Stuff\u0026lt;/strong\u0026gt; (skip this part if you only want to understand the query)\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Let Total be a function T(customer,id) where it returns a value given the name and id\nTo prove that the given total (T(customer,id)) is the highest we have to prove that\nWe want to prove either\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;x T(customer,id) \u0026amp;gt; T(customer,x) (this total is higher than all other\ntotal for that customer)\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;OR\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;¬x T(customer, id) \u0026amp;lt; T(customer, x)   (there exists no higher total for\nthat customer)\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;The first approach will need us to get all the records for that name which I do not really like.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;The second one will need a smart way to say there can be no record higher than this one.\u0026lt;/p\u0026gt;\n\u0026lt;hr\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Back to SQL\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;If we left joins the table on the name and total being less than the joined table:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LEFT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; p \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; \np.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; purchases.customer \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \npurchases.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt; p.total\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;we make sure that all records that have another record with the higher total for the same user to be joined:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+---------------------+-----------------+------+------------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;  purchases.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+---------------------+-----------------+------+------------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Tom                 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;200\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;    \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Tom        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;300\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Tom                 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;300\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Bob                 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;400\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;    \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Bob        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Bob                 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Alice               \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;600\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;    \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Alice      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;700\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Alice               \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;700\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+---------------------+-----------------+------+------------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;That will help us filter for the highest total for each purchase with no grouping needed:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IS\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;NULL\u0026lt;/span\u0026gt;\n    \n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+----------------+-----------------+------+--------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.name \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.name \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+----------------+-----------------+------+--------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Tom            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;300\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Bob            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Alice          \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;700\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+----------------+-----------------+------+--------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;And that\u0026apos;s the answer we need.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I use this way (postgresql only): \u0026lt;a href=\u0026quot;https://wiki.postgresql.org/wiki/First/last_%28aggregate%29\u0026quot;\u0026gt;https://wiki.postgresql.org/wiki/First/last_%28aggregate%29\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- Create a function that always returns the first non-NULL item\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OR\u0026lt;/span\u0026gt; REPLACE \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FUNCTION\u0026lt;/span\u0026gt; public.first_agg ( anyelement, anyelement )\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;RETURNS\u0026lt;/span\u0026gt; anyelement \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LANGUAGE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;sql\u0026lt;/span\u0026gt; IMMUTABLE STRICT \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; $$\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; $\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n$$;\n\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- And then wrap an aggregate around it\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; AGGREGATE public.first (\n        sfunc    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; public.first_agg,\n        basetype \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; anyelement,\n        stype    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; anyelement\n);\n\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- Create a function that always returns the last non-NULL item\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OR\u0026lt;/span\u0026gt; REPLACE \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FUNCTION\u0026lt;/span\u0026gt; public.last_agg ( anyelement, anyelement )\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;RETURNS\u0026lt;/span\u0026gt; anyelement \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LANGUAGE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;sql\u0026lt;/span\u0026gt; IMMUTABLE STRICT \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; $$\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; $\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;;\n$$;\n\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- And then wrap an aggregate around it\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; AGGREGATE public.last (\n        sfunc    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; public.last_agg,\n        basetype \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; anyelement,\n        stype    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; anyelement\n);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Then your example should work \u0026lt;em\u0026gt;almost\u0026lt;/em\u0026gt; as is:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FIRST\u0026lt;/span\u0026gt;(id), customer, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FIRST\u0026lt;/span\u0026gt;(total)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;  purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FIRST\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;CAVEAT: It ignore\u0026apos;s NULL rows\u0026lt;/p\u0026gt;\n\n\u0026lt;hr\u0026gt;\n\n\u0026lt;h1\u0026gt;Edit 1 - Use the postgres extension instead\u0026lt;/h1\u0026gt;\n\n\u0026lt;p\u0026gt;Now I use this way: \u0026lt;a href=\u0026quot;http://pgxn.org/dist/first_last_agg/\u0026quot;\u0026gt;http://pgxn.org/dist/first_last_agg/\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;To install on ubuntu 14.04:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;apt\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;get\u0026lt;/span\u0026gt; install postgresql\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;server\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;dev\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;-9.3\u0026lt;/span\u0026gt; git build\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;essential \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;y\ngit clone git:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;github.com\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;wulczer\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;first_last_agg.git\ncd first_last_app\nmake \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;amp;\u0026amp;amp;\u0026lt;/span\u0026gt; sudo make install\npsql \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;c \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;create extension first_last_agg\u0026apos;\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;It\u0026apos;s a postgres extension that gives you first and last functions; apparently faster than the above way.\u0026lt;/p\u0026gt;\n\n\u0026lt;hr\u0026gt;\n\n\u0026lt;h1\u0026gt;Edit 2 - Ordering and filtering\u0026lt;/h1\u0026gt;\n\n\u0026lt;p\u0026gt;If you use aggregate functions (like these), you can order the results, without the need to have the data already ordered:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;http:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;www.postgresql.org\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;docs\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;current\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;sql\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;expressions.html#SYNTAX\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;AGGREGATES\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;So the equivalent example, with ordering would be something like:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;first\u0026lt;/span\u0026gt;(id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; id), customer, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;first\u0026lt;/span\u0026gt;(total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; id)\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases\n \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;first\u0026lt;/span\u0026gt;(total);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Of course you can order and filter as you deem fit within the aggregate; it\u0026apos;s very powerful syntax.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Use \u0026lt;code\u0026gt;ARRAY_AGG\u0026lt;/code\u0026gt; function for \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/9.5/functions-aggregate.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;PostgreSQL\u0026lt;/a\u0026gt;, \u0026lt;a href=\u0026quot;https://docs.microsoft.com/en-us/u-sql/functions/aggregate/array-agg\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;U-SQL\u0026lt;/a\u0026gt;, \u0026lt;a href=\u0026quot;https://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0050494.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;IBM DB2\u0026lt;/a\u0026gt;, and \u0026lt;a href=\u0026quot;https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#array_agg\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;Google BigQuery SQL\u0026lt;/a\u0026gt;:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; customer, (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ARRAY_AGG\u0026lt;/span\u0026gt;(id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;))[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;], \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(total)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;In SQL Server you can do this:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; (\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ROW_NUMBER\u0026lt;/span\u0026gt;()\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; StRank, \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; Purchases) n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; StRank \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Explaination:Here  \u0026lt;strong\u0026gt;Group by\u0026lt;/strong\u0026gt; is done on the basis of customer and then order it by total then each such group is given serial number as StRank and we are taking out first 1 customer whose StRank is 1\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Very fast solution\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; a.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;\n    purchases a \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; ( \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; customer, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;min\u0026lt;/span\u0026gt;( id ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; id \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer \n    ) b \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;USING\u0026lt;/span\u0026gt; ( id );\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;and really very fast if table is indexed by id:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;create\u0026lt;/span\u0026gt; index purchases_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;on\u0026lt;/span\u0026gt; purchases (id);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Snowflake/Teradata supports \u0026lt;a href=\u0026quot;https://docs.snowflake.net/manuals/sql-reference/constructs/qualify.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;code\u0026gt;QUALIFY\u0026lt;/code\u0026gt;\u0026lt;/a\u0026gt; clause which works like \u0026lt;code\u0026gt;HAVING\u0026lt;/code\u0026gt; for windowed functions:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; PURCHASES\nQUALIFY \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ROW_NUMBER\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.customer \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;In PostgreSQL, another possibility is to use the \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/functions-window.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;code\u0026gt;first_value\u0026lt;/code\u0026gt;\u0026lt;/a\u0026gt; window function in combination with \u0026lt;code\u0026gt;SELECT DISTINCT\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;distinct\u0026lt;/span\u0026gt; customer_id,\n                \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;first_value\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;row\u0026lt;/span\u0026gt;(id, total)) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; customer_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;desc\u0026lt;/span\u0026gt;, id)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt;            purchases;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;I created a composite \u0026lt;code\u0026gt;(id, total)\u0026lt;/code\u0026gt;, so both values are returned by the same aggregate. You can of course always apply \u0026lt;code\u0026gt;first_value()\u0026lt;/code\u0026gt; twice.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This way it work for me:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; article, dealer, price\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   shop s1\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  price\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(s2.price)\n              \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; shop s2\n              \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; s1.article \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; s2.article\n              \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; s2.article)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; article;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Select highest price on each article\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This is how we can achieve this by using windows function:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;create\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;table\u0026lt;/span\u0026gt; purchases (id int4, customer \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;varchar\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;), total \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;integer\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;Joe\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;Sally\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;Joe\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;Sally\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;);\n    \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; ID, CUSTOMER, TOTAL \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; ID, CUSTOMER, TOTAL,\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt; () \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; CUSTOMER \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; TOTAL \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;desc\u0026lt;/span\u0026gt;) RN\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchases) A \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; RN \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://i.stack.imgur.com/uwrys.png\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;img src=\u0026quot;https://i.stack.imgur.com/uwrys.png\u0026quot; alt=\u0026quot;enter image description here\u0026quot;\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The accepted OMG Ponies\u0026apos; \u0026quot;Supported by any database\u0026quot; solution has good speed from my test.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Here I provide a same-approach, but more complete and clean any-database solution.   Ties are considered (assume desire to get only one row for each customer, even multiple records for max total per customer), and other purchase fields (e.g. purchase_payment_id) will be selected for the real matching rows in the purchase table.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Supported by any database:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchase\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;join\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;min\u0026lt;/span\u0026gt;(id) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchase\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;join\u0026lt;/span\u0026gt; (\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; customer, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;max\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchase\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;group\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; customer\n    ) t1 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;using\u0026lt;/span\u0026gt; (customer, total)\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;group\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; customer\n) t2 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;using\u0026lt;/span\u0026gt; (id)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; customer\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;This query is reasonably fast especially when there is a composite index like (customer, total) on the purchase table.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Remark:\u0026lt;/p\u0026gt;\n\n\u0026lt;ol\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;t1, t2 are subquery alias which could be removed depending on database.\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Caveat\u0026lt;/strong\u0026gt;: the \u0026lt;code\u0026gt;using (...)\u0026lt;/code\u0026gt; clause is currently not supported in MS-SQL and Oracle db as of this edit on Jan 2017. You have to expand it yourself to e.g. \u0026lt;code\u0026gt;on t2.id = purchase.id\u0026lt;/code\u0026gt; etc.  The USING syntax works in SQLite, MySQL and PostgreSQL.\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n    ","\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;If you want to select any (by your some specific condition) row from the set of aggregated rows. \u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;If you want to use another (\u0026lt;code\u0026gt;sum/avg\u0026lt;/code\u0026gt;) aggregation function in addition to \u0026lt;code\u0026gt;max/min\u0026lt;/code\u0026gt;. Thus you can not use clue with \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\n\u0026lt;p\u0026gt;You can use next subquery:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;  \n    (  \n       \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;id\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; t2   \n       \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ANY\u0026lt;/span\u0026gt; ( \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ARRAY_AGG\u0026lt;/span\u0026gt;( tf.id ) ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; amount \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;( tf.amount )   \n    ) id,  \n    name,   \n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(amount) ma,  \n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;SUM\u0026lt;/span\u0026gt;( ratio )  \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; t2  tf  \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; name\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;You can replace \u0026lt;code\u0026gt;amount = MAX( tf.amount )\u0026lt;/code\u0026gt; with any condition you want with one restriction: This subquery must not return more than one row\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;But if you wanna to do such things you probably looking for \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/static/tutorial-window.html\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;window functions\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;For SQl Server the most efficient way is:   \u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;with\u0026lt;/span\u0026gt;\nids \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; ( \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--condition for split table into groups\u0026lt;/span\u0026gt;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; i \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;9\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;17\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;18\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;19\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;20\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;22\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;21\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;23\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;)) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; v(i) \n) \n,src \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; ( \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; yourTable \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;condition\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--use this as filter for other conditions\u0026lt;/span\u0026gt;\n)\n,joined \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; tops.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; ids \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;cross\u0026lt;/span\u0026gt; apply \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--it`s like for each rows\u0026lt;/span\u0026gt;\n    (\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; top(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; src\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; CommodityId \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; ids.i \n    ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; tops\n)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; joined\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;and don\u0026apos;t forget to create clustered index for used columns\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;My approach via window function \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=01c699f3f47ca9fca8215f8cbf556218\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;dbfiddle\u0026lt;/a\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;ol\u0026gt;\n\u0026lt;li\u0026gt;Assign \u0026lt;code\u0026gt;row_number\u0026lt;/code\u0026gt; at each group: \u0026lt;code\u0026gt;row_number() over (partition by agreement_id, order_id ) as nrow\u0026lt;/code\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Take only first row at group: \u0026lt;code\u0026gt;filter (where nrow = 1)\u0026lt;/code\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;with\u0026lt;/span\u0026gt; intermediate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \n \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;,\n \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; ( \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; agreement_id, order_id ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; nrow,\n (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;sum\u0026lt;/span\u0026gt;( suma ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; ( \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; agreement_id, order_id ))::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;numeric\u0026lt;/span\u0026gt;( \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; order_suma,\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt;your \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;table\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt;)\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \n  \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;,\n  \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;sum\u0026lt;/span\u0026gt;( order_suma ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;filter\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; nrow \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; agreement_id)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; intermediate\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This can be achieved easily by MAX FUNCTION on total and GROUP BY id and customer.\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;  purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id, customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    "]},"randomTags":[{"name":"startactivityforresult","slug":"startactivityforresult"},{"name":"computer-science","slug":"computer-science"},{"name":"event-loop","slug":"event-loop"},{"name":"tkinter","slug":"tkinter"},{"name":"php-password-hash","slug":"php-password-hash"},{"name":"server-side","slug":"server-side"},{"name":"selenium4","slug":"selenium4"},{"name":"validation","slug":"validation"},{"name":"deep-copy","slug":"deep-copy"},{"name":"shallow-copy","slug":"shallow-copy"},{"name":"python","slug":"python"},{"name":"return","slug":"return"},{"name":"c++-faq","slug":"c++-faq"},{"name":"git-rewrite-history","slug":"git-rewrite-history"},{"name":"objective-c","slug":"objective-c"},{"name":"selenium3","slug":"selenium3"},{"name":"greatest-n-per-group","slug":"greatest-n-per-group"},{"name":"iterator","slug":"iterator"},{"name":"data.table","slug":"data.table"},{"name":"standards","slug":"standards"}]},"__N_SSG":true},"page":"/questions/tag/[slug]","query":{"slug":"postgresql"},"buildId":"00bsHgHZki2FteshOatnd","isFallback":false,"gsp":true,"locale":"en","locales":["en"],"defaultLocale":"en","scriptLoader":[]}</script></body></html>