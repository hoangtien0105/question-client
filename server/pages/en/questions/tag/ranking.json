{"pageProps":{"data":{"count":1,"rows":[{"id":529,"title":"Using LIMIT within GROUP BY to get N results per group?","slug":"using-limit-within-group-by-to-get-n-results-per-group-1657388324167","postType":"QUESTION","createdAt":"2022-07-09T17:38:44.000Z","updatedAt":"2022-07-09T17:38:44.000Z","tags":[{"id":2604,"name":"ranking","slug":"ranking","createdAt":"2022-07-09T17:38:44.000Z","updatedAt":"2022-07-09T17:38:44.000Z","Questions_Tags":{"questionId":529,"tagId":2604}}]}]},"slug":"ranking","page":1,"answers":{"529":["\n&lt;p&gt;You could use &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html#function_group-concat&quot; rel=&quot;noreferrer&quot;&gt;GROUP_CONCAT&lt;/a&gt; aggregated function to get all years into a single column, grouped by &lt;code&gt;id&lt;/code&gt; and ordered by &lt;code&gt;rate&lt;/code&gt;:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;   id, GROUP_CONCAT(&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;) grouped_year\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;     yourtable\n&lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Result:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;-----------------------------------------------------------&lt;/span&gt;\n&lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt;  ID &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; GROUPED_YEAR                                      &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt;\n&lt;span class=&quot;hljs-comment&quot;&gt;-----------------------------------------------------------&lt;/span&gt;\n&lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; p01 &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2008&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2005&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt;\n&lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; p02 &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;                &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt;\n&lt;span class=&quot;hljs-comment&quot;&gt;-----------------------------------------------------------&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;And then you could use &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_find-in-set&quot; rel=&quot;noreferrer&quot;&gt;FIND_IN_SET&lt;/a&gt;, that returns the position of the first argument inside the second one, eg.&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; FIND_IN_SET(&lt;span class=&quot;hljs-string&quot;&gt;&apos;2006&apos;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&apos;2006,2003,2008,2001,2007,2009,2002,2004,2005,2000&apos;&lt;/span&gt;);\n&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;\n\n&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; FIND_IN_SET(&lt;span class=&quot;hljs-string&quot;&gt;&apos;2009&apos;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&apos;2006,2003,2008,2001,2007,2009,2002,2004,2005,2000&apos;&lt;/span&gt;);\n&lt;span class=&quot;hljs-number&quot;&gt;6&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Using a combination of &lt;code&gt;GROUP_CONCAT&lt;/code&gt; and &lt;code&gt;FIND_IN_SET&lt;/code&gt;, and filtering by the position returned by find_in_set, you could then use this query that returns only the first 5 years for every id:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;\n  yourtable.&lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;\n  yourtable &lt;span class=&quot;hljs-keyword&quot;&gt;INNER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;JOIN&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;\n      id,\n      GROUP_CONCAT(&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;) grouped_year\n    &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;\n      yourtable\n    &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id) group_max\n  &lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; yourtable.id &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; group_max.id\n     &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; FIND_IN_SET(&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;, grouped_year) &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt;\n  yourtable.id, yourtable.year &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Please see fiddle &lt;a href=&quot;http://sqlfiddle.com/#!2/1c220/1&quot; rel=&quot;noreferrer&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;\n&lt;p&gt;Please note that if more than one row can have the same rate, you should consider using &lt;code&gt;GROUP_CONCAT(DISTINCT rate ORDER BY rate)&lt;/code&gt; on the &lt;code&gt;rate&lt;/code&gt; column instead of the &lt;code&gt;year&lt;/code&gt; column.&lt;/p&gt;\n&lt;p&gt;The maximum length of the string returned by &lt;code&gt;GROUP_CONCAT&lt;/code&gt; is limited, so this works well if you need to select a few records for every group.&lt;/p&gt;\n    ","\n&lt;p&gt;You want to find &lt;em&gt;&lt;strong&gt;top n rows per group&lt;/strong&gt;&lt;/em&gt;. This answer provides a generic solution using example data that is different from OP.&lt;/p&gt;\n&lt;p&gt;In MySQL 8 or later you can use the &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html&quot; rel=&quot;noreferrer&quot;&gt;&lt;code&gt;ROW_NUMBER&lt;/code&gt;, &lt;code&gt;RANK&lt;/code&gt; or &lt;code&gt;DENSE_RANK&lt;/code&gt;&lt;/a&gt; function depending on the exact definition of top 5. Below are the numbers generated by these functions based on &lt;code&gt;value&lt;/code&gt; sorted descending. Notice how ties are handled:&lt;/p&gt;\n&lt;div class=&quot;s-table-container&quot;&gt;\n&lt;table class=&quot;s-table&quot;&gt;\n&lt;thead&gt;\n&lt;tr&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;pkid&lt;/th&gt;\n&lt;th&gt;catid&lt;/th&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;value&lt;/th&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;row_number&lt;/th&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;rank&lt;/th&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;dense_rank&lt;/th&gt;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;1&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;100&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*1&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*1&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*1&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;2&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;90&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;3&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;90&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*3&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;4&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;80&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*3&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;5&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;80&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*5&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*3&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;6&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;80&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;6&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*3&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;7&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;70&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;7&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;7&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;8&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;60&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;8&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;8&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*5&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;9&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;50&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;9&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;9&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;6&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;10&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;40&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;10&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;10&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;7&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;/div&gt;\n&lt;p&gt;Once you have chosen the function, use it like so:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;, &lt;span class=&quot;hljs-built_in&quot;&gt;ROW_NUMBER&lt;/span&gt;() &lt;span class=&quot;hljs-keyword&quot;&gt;OVER&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;PARTITION&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; t\n) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; x\n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; n &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;a href=&quot;https://dbfiddle.uk/?rdbms=mysql_8.0&amp;amp;fiddle=29ff3dde85d2fb2085fcd195a7a9134e&quot; rel=&quot;noreferrer&quot;&gt;DB&amp;lt;&amp;gt;Fiddle&lt;/a&gt;&lt;/p&gt;\n&lt;hr&gt;\n&lt;p&gt;In MySQL 5.x you can use poor man&apos;s rank over partition to achieve desired result: outer join the table with itself and for each row, count the number of rows &lt;em&gt;&lt;strong&gt;before&lt;/strong&gt;&lt;/em&gt; it (e.g. the before row could be the one with higher value).&lt;/p&gt;\n&lt;p&gt;The following will produce results similar to &lt;code&gt;RANK&lt;/code&gt; function:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; t.pkid, t.catid, t.value, &lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(b.value) &lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; rank\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; t\n&lt;span class=&quot;hljs-keyword&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;JOIN&lt;/span&gt; t &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; b &lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; b.catid &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; t.catid &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; b.value &lt;span class=&quot;hljs-operator&quot;&gt;&amp;gt;&lt;/span&gt; t.value\n&lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; t.pkid, t.catid, t.value\n&lt;span class=&quot;hljs-keyword&quot;&gt;HAVING&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(b.value) &lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; t.catid, t.value &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;, t.pkid\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Make the following change to produce results similar to &lt;code&gt;DENSE_RANK&lt;/code&gt; function:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;DISTINCT&lt;/span&gt; b.value)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Or make the following change to produce results similar to &lt;code&gt;ROW_NUMBER&lt;/code&gt; function:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; b.catid &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; t.catid &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; (b.value &lt;span class=&quot;hljs-operator&quot;&gt;&amp;gt;&lt;/span&gt; t.value &lt;span class=&quot;hljs-keyword&quot;&gt;OR&lt;/span&gt; b.value &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; t.value &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; b.pkid &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;&lt;/span&gt; t.pkid)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;a href=&quot;https://dbfiddle.uk/?rdbms=mysql_5.5&amp;amp;fiddle=d4baaf1a1df9b681545b13031e641d9f&quot; rel=&quot;noreferrer&quot;&gt;DB&amp;lt;&amp;gt;Fiddle&lt;/a&gt;&lt;/p&gt;\n    ","\n&lt;p&gt;For me something like &lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;SUBSTRING_INDEX(group_concat(col_name &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; desired_col_order_name), &lt;span class=&quot;hljs-string&quot;&gt;&apos;,&apos;&lt;/span&gt;, N) \n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;works perfectly. No complicated query.&lt;/p&gt;\n\n&lt;hr&gt;\n\n&lt;p&gt;for example: get top 1 for each group&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; \n    &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;\n    yourtable\n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt;\n    id &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; \n            SUBSTRING_INDEX(GROUP_CONCAT(id\n                            &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;),\n                        &lt;span class=&quot;hljs-string&quot;&gt;&apos;,&apos;&lt;/span&gt;,\n                        &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) id\n        &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;\n            yourtable\n        &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;)\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;No, you can&apos;t LIMIT subqueries arbitrarily (you can do it to a limited extent in newer MySQLs, but not for 5 results per group).&lt;/p&gt;\n\n&lt;p&gt;This is a groupwise-maximum type query, which is not trivial to do in SQL. There are &lt;a href=&quot;https://stackoverflow.com/questions/755918/simple-query-to-grab-max-value-for-each-id/756892#756892&quot;&gt;various ways&lt;/a&gt; to tackle that which can be more efficient for some cases, but for top-n in general you&apos;ll want to look at &lt;a href=&quot;https://stackoverflow.com/questions/1442527/how-to-select-the-newest-four-items-per-category/1442867#1442867&quot;&gt;Bill&apos;s answer&lt;/a&gt; to a similar previous question.&lt;/p&gt;\n\n&lt;p&gt;As with most solutions to this problem, it can return more than five rows if there are multiple rows with the same &lt;code&gt;rate&lt;/code&gt; value, so you may still need a quantity of post-processing to check for that.&lt;/p&gt;\n    ","\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;, id, rate\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;\n  &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;, id, rate, &lt;span class=&quot;hljs-built_in&quot;&gt;row_number&lt;/span&gt;() &lt;span class=&quot;hljs-keyword&quot;&gt;over&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;)\n  &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; h\n  &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;\n  &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; rid &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; table2)\n  &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;\n  &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; subquery\n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; row_number &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;The subquery is almost identical to your query. Only change is adding&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;row_number&lt;/span&gt;() &lt;span class=&quot;hljs-keyword&quot;&gt;over&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;)\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;This requires a series of subqueries to rank the values, limit them, then perform the sum while grouping&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-variable&quot;&gt;@Rnk&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;\n&lt;span class=&quot;hljs-variable&quot;&gt;@N&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;;\n&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;\n  c.id,\n  &lt;span class=&quot;hljs-built_in&quot;&gt;sum&lt;/span&gt;(c.val)\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; (\n&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;\n  b.id,\n  b.bal\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; (\n&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;   \n  if(&lt;span class=&quot;hljs-variable&quot;&gt;@last&lt;/span&gt;_id&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;id,&lt;span class=&quot;hljs-variable&quot;&gt;@Rnk&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; Rnk,\n  a.id,\n  a.val,\n  &lt;span class=&quot;hljs-variable&quot;&gt;@last&lt;/span&gt;_id&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;id,\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; (   \n&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; \n  id,\n  val \n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; list\n&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; id,val &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; a) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; b\n&lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt; b.rnk &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@N&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; c\n&lt;span class=&quot;hljs-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; c.id;\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;Try this: &lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; h.year, h.id, h.rate \n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; h.year, h.id, h.rate, IF(&lt;span class=&quot;hljs-variable&quot;&gt;@lastid&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; (&lt;span class=&quot;hljs-variable&quot;&gt;@lastid&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;h.id), &lt;span class=&quot;hljs-variable&quot;&gt;@index&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-variable&quot;&gt;@index&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;@index&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;) indx \n      &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; h.year, h.id, h.rate \n            &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; h\n            &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; h.year &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; rid &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; table2)\n            &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, h.year\n            &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;\n            ) h, (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@lastid&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;&apos;&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;@index&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; a\n    ) h \n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; h.indx &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;Build the virtual columnslike RowID in Oracle&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;Table:&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;TABLE&lt;/span&gt; `stack` \n(`&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;` &lt;span class=&quot;hljs-type&quot;&gt;int&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;NULL&lt;/span&gt;,\n`id` &lt;span class=&quot;hljs-type&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;NULL&lt;/span&gt;,\n`rate` &lt;span class=&quot;hljs-type&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;NULL&lt;/span&gt;) \nENGINE&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;InnoDB &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; CHARSET&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;utf8mb4\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;Data:&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;5.9&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;5.3&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;4.4&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;12.5&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;12.4&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2005&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2.1&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;0.8&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;12.2&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;3.9&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;3.5&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;10.3&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;8.7&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;4.6&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;3.3&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;7.4&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2008&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;6.8&lt;/span&gt;);\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;SQL like this:&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; t3.year,t3.id,t3.rate \n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; t1.&lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;, (&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; stack t2 &lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt; t1.rate&lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt;t2.rate &lt;span class=&quot;hljs-keyword&quot;&gt;and&lt;/span&gt; t1.id&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;t2.id) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; rownum &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; stack t1) t3 \n&lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt; rownum &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; id,rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;If delete the where clause in t3, it shows like this:&lt;/p&gt;\n&lt;p&gt;&lt;a href=&quot;https://i.stack.imgur.com/lnxDj.jpg&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;img src=&quot;https://i.stack.imgur.com/lnxDj.jpg&quot; alt=&quot;enter image description here&quot;&gt;&lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;GET &quot;TOP N Record&quot; --&amp;gt; add the &lt;code&gt;rownum &amp;lt;=3&lt;/code&gt; in &lt;code&gt;where&lt;/code&gt; clause (the where-clause of t3);&lt;/p&gt;\n&lt;p&gt;CHOOSE &quot;the year&quot; --&amp;gt; add the &lt;code&gt;BETWEEN 2000 AND 2009&lt;/code&gt; in &lt;code&gt;where&lt;/code&gt; clause (the where-clause of t3);&lt;/p&gt;\n    ","\n&lt;p&gt;Took some working, but I thougth my solution would be something to share as it is seems elegant as well as quite fast.&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; h.year, h.id, h.rate \n  &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; id, \n      SUBSTRING_INDEX(GROUP_CONCAT(CONCAT(id, &lt;span class=&quot;hljs-string&quot;&gt;&apos;-&apos;&lt;/span&gt;, &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;), &lt;span class=&quot;hljs-string&quot;&gt;&apos;,&apos;&lt;/span&gt; , &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; l\n      &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; h\n      &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;\n      &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id\n      &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id\n  ) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; h_temp\n    &lt;span class=&quot;hljs-keyword&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;JOIN&lt;/span&gt; h &lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; h.id &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; h_temp.id \n      &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; SUBSTRING_INDEX(h_temp.l, CONCAT(h.id, &lt;span class=&quot;hljs-string&quot;&gt;&apos;-&apos;&lt;/span&gt;, h.year), &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;hljs-operator&quot;&gt;!=&lt;/span&gt; h_temp.l\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;Note that this example is specified for the purpose of the question and can be modified quite easily for other similar purposes.&lt;/p&gt;\n    ","\n&lt;p&gt;The following post: &lt;a href=&quot;http://code.openark.org/blog/mysql/sql-selecting-top-n-records-per-group&quot; rel=&quot;nofollow&quot;&gt;sql: selcting top N record per group&lt;/a&gt; describes the complicated way of achieving this without subqueries.&lt;/p&gt;\n\n&lt;p&gt;It improves on other solutions offered here by:&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;Doing everything in a single query&lt;/li&gt;\n&lt;li&gt;Being able to properly utilize indexes&lt;/li&gt;\n&lt;li&gt;Avoiding subqueries, notoriously known to produce bad execution plans in MySQL&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;It is however not pretty. A good solution would be achievable were Window Functions (aka Analytic Functions) enabled in MySQL -- but they are not.\nThe trick used in said post utilizes GROUP_CONCAT, which is sometimes described as &quot;poor man&apos;s Window Functions for MySQL&quot;.&lt;/p&gt;\n    ","\n&lt;p&gt;for those like me that had queries time out. I made the below to use limits and anything else by a specific group.&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;DELIMITER $$\n&lt;span class=&quot;hljs-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;PROCEDURE&lt;/span&gt; count_limit200()\n&lt;span class=&quot;hljs-keyword&quot;&gt;BEGIN&lt;/span&gt;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; a &lt;span class=&quot;hljs-type&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;Default&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; stop_loop &lt;span class=&quot;hljs-type&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;Default&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; domain_val &lt;span class=&quot;hljs-type&quot;&gt;VARCHAR&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;250&lt;/span&gt;);\n    &lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; domain_list &lt;span class=&quot;hljs-keyword&quot;&gt;CURSOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;DISTINCT&lt;/span&gt; domain &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; db.one;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;OPEN&lt;/span&gt; domain_list;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;DISTINCT&lt;/span&gt;(domain)) &lt;span class=&quot;hljs-keyword&quot;&gt;INTO&lt;/span&gt; stop_loop \n    &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; db.one;\n    &lt;span class=&quot;hljs-comment&quot;&gt;-- BEGIN LOOP&lt;/span&gt;\n    loop_thru_domains: LOOP\n        &lt;span class=&quot;hljs-keyword&quot;&gt;FETCH&lt;/span&gt; domain_list &lt;span class=&quot;hljs-keyword&quot;&gt;INTO&lt;/span&gt; domain_val;\n        &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; a&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;a&lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;;\n\n        &lt;span class=&quot;hljs-keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;INTO&lt;/span&gt; db.two(book,artist,title,title_count,last_updated) \n        &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; \n        (\n            &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; book,artist,title,&lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(ObjectKey) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; titleCount, NOW() \n            &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; db.one \n            &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; book &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; domain_val\n            &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; artist,title\n            &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; book,titleCount &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;\n            LIMIT &lt;span class=&quot;hljs-number&quot;&gt;200&lt;/span&gt;\n        ) a &lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; DUPLICATE KEY &lt;span class=&quot;hljs-keyword&quot;&gt;UPDATE&lt;/span&gt; title_count &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; titleCount, last_updated &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; NOW();\n\n        IF a &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; stop_loop &lt;span class=&quot;hljs-keyword&quot;&gt;THEN&lt;/span&gt;\n            LEAVE loop_thru_domain;\n        &lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; IF;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; LOOP loop_thru_domain;\n&lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; $$\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;it loops through a list of domains and then inserts only a limit of 200 each&lt;/p&gt;\n    ","\n&lt;p&gt;Try this:&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@num&lt;/span&gt; :&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;@type&lt;/span&gt; :&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&apos;&apos;&lt;/span&gt;;\n&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; `&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;`, `id`, `rate`,\n    &lt;span class=&quot;hljs-variable&quot;&gt;@num&lt;/span&gt; :&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; if(&lt;span class=&quot;hljs-variable&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; `id`, &lt;span class=&quot;hljs-variable&quot;&gt;@num&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; `row_number`,\n    &lt;span class=&quot;hljs-variable&quot;&gt;@type&lt;/span&gt; :&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; `id` &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; `dummy`\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; `h`\n    &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; (\n        `&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;` &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&apos;2000&apos;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&apos;2009&apos;&lt;/span&gt;\n        &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; `id` &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; `rid` &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; `table2`) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; `temp_rid`\n    )\n    &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; `id`\n) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; `temph`\n&lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; `&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;`, `id`, `rate`\n&lt;span class=&quot;hljs-keyword&quot;&gt;HAVING&lt;/span&gt; `row_number`&lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;5&apos;&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; `id`, `rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;Please try below stored procedure. I have already verified. I am getting proper result but without using &lt;code&gt;groupby&lt;/code&gt;.&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;CREATE&lt;/span&gt; DEFINER&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;`ks_root`@`&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;` &lt;span class=&quot;hljs-keyword&quot;&gt;PROCEDURE&lt;/span&gt; `first_five_record_per_id`()\n&lt;span class=&quot;hljs-keyword&quot;&gt;BEGIN&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; query_string text;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; datasource1 &lt;span class=&quot;hljs-type&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; done &lt;span class=&quot;hljs-type&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; tenants &lt;span class=&quot;hljs-type&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;50&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; cur1 &lt;span class=&quot;hljs-keyword&quot;&gt;CURSOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; rid &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; demo1;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; CONTINUE HANDLER &lt;span class=&quot;hljs-keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;NOT&lt;/span&gt; FOUND &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; done &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;&apos;&lt;/span&gt;;\n\n      &lt;span class=&quot;hljs-keyword&quot;&gt;OPEN&lt;/span&gt; cur1;\n      read_loop: LOOP\n\n      &lt;span class=&quot;hljs-keyword&quot;&gt;FETCH&lt;/span&gt; cur1 &lt;span class=&quot;hljs-keyword&quot;&gt;INTO&lt;/span&gt; tenants ;\n\n      IF done &lt;span class=&quot;hljs-keyword&quot;&gt;THEN&lt;/span&gt;\n        LEAVE read_loop;\n      &lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; IF;\n\n      &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@datasource1&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; tenants;\n      &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; concat(&lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string,&lt;span class=&quot;hljs-string&quot;&gt;&apos;(select * from demo  where `id` = &apos;&apos;&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-variable&quot;&gt;@datasource1&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;&apos;&apos; order by rate desc LIMIT 5) UNION ALL &apos;&lt;/span&gt;);\n\n       &lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; LOOP; \n      &lt;span class=&quot;hljs-keyword&quot;&gt;close&lt;/span&gt; cur1;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string  &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;TRIM&lt;/span&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;TRAILING&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&apos;UNION ALL&apos;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;TRIM&lt;/span&gt;(&lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string));  \n  &lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string;\n&lt;span class=&quot;hljs-keyword&quot;&gt;PREPARE&lt;/span&gt; stmt &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string;\n&lt;span class=&quot;hljs-keyword&quot;&gt;EXECUTE&lt;/span&gt; stmt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DEALLOCATE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;PREPARE&lt;/span&gt; stmt;\n\n&lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n    "]},"randomTags":[{"name":"generic-list","slug":"generic-list"},{"name":"undo","slug":"undo"},{"name":"webdriver","slug":"webdriver"},{"name":"date-parsing","slug":"date-parsing"},{"name":"parameter-passing","slug":"parameter-passing"},{"name":"pcre","slug":"pcre"},{"name":"unique","slug":"unique"},{"name":"pseudo-element","slug":"pseudo-element"},{"name":"aggregation-framework","slug":"aggregation-framework"},{"name":"vb.net","slug":"vb.net"},{"name":"merge","slug":"merge"},{"name":"istream","slug":"istream"},{"name":"startactivityforresult","slug":"startactivityforresult"},{"name":"haversine","slug":"haversine"},{"name":"angularfire2","slug":"angularfire2"},{"name":"parameters","slug":"parameters"},{"name":"sql-server","slug":"sql-server"},{"name":"user-interface","slug":"user-interface"},{"name":"expected-condition","slug":"expected-condition"},{"name":"return-value-optimization","slug":"return-value-optimization"}]},"__N_SSG":true}