{"pageProps":{"data":{"count":1,"rows":[{"id":159,"title":"Trouble with UTF-8 characters; what I see is not what I stored","slug":"trouble-with-utf-8-characters-what-i-see-is-not-what-i-stored-1657384817490","postType":"QUESTION","createdAt":"2022-07-09T16:40:17.000Z","updatedAt":"2022-07-09T16:40:17.000Z","tags":[{"id":580,"name":"unicode","slug":"unicode","createdAt":"2022-07-09T16:40:17.000Z","updatedAt":"2022-07-09T16:40:17.000Z","Questions_Tags":{"questionId":159,"tagId":580}}]}]},"slug":"unicode","page":1,"answers":{"159":["\n&lt;p&gt;This problem plagues the participants of this site, and many others.&lt;/p&gt;\n\n&lt;p&gt;You have listed the five main cases of &lt;code&gt;CHARACTER SET&lt;/code&gt; troubles.&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;Best Practice&lt;/strong&gt;&lt;/p&gt;\n\n&lt;p&gt;Going forward, it is best to use &lt;code&gt;CHARACTER SET utf8mb4&lt;/code&gt; and &lt;code&gt;COLLATION utf8mb4_unicode_520_ci&lt;/code&gt;. (There is a newer version of the Unicode collation in the pipeline.)&lt;/p&gt;\n\n&lt;p&gt;&lt;code&gt;utf8mb4&lt;/code&gt; is a superset of &lt;code&gt;utf8&lt;/code&gt; in that it handles 4-byte utf8 codes, which are needed by Emoji and some of Chinese.&lt;/p&gt;\n\n&lt;p&gt;Outside of MySQL, &quot;UTF-8&quot; refers to all size encodings, hence effectively the same as MySQL&apos;s &lt;code&gt;utf8mb4&lt;/code&gt;, not &lt;code&gt;utf8&lt;/code&gt;.&lt;/p&gt;\n\n&lt;p&gt;I will try to use those spellings and capitalizations to distinguish inside versus outside MySQL in the following.&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;Overview of what you &lt;em&gt;should&lt;/em&gt; do&lt;/strong&gt;&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;Have your editor, etc. set to UTF-8.&lt;/li&gt;\n&lt;li&gt;HTML forms should start like &lt;code&gt;&amp;lt;form accept-charset=&quot;UTF-8&quot;&amp;gt;&lt;/code&gt;.&lt;/li&gt;\n&lt;li&gt;Have your bytes encoded as UTF-8.&lt;/li&gt;\n&lt;li&gt;Establish UTF-8 as the encoding being used in the client.&lt;/li&gt;\n&lt;li&gt;Have the column/table declared &lt;code&gt;CHARACTER SET utf8mb4&lt;/code&gt; (Check with &lt;code&gt;SHOW CREATE TABLE&lt;/code&gt;.)&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;&amp;lt;meta charset=UTF-8&amp;gt;&lt;/code&gt; at the beginning of HTML&lt;/li&gt;\n&lt;li&gt;Stored Routines acquire the current charset/collation.  They may need rebuilding.&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;&lt;em&gt;&lt;a href=&quot;https://stackoverflow.com/questions/279170/how-to-support-utf-8-completely-in-a-web-application&quot;&gt;UTF-8 all the way through&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;\n\n&lt;p&gt;&lt;a href=&quot;http://mysql.rjweb.org/doc.php/charcoll#python&quot; rel=&quot;noreferrer&quot;&gt;More details for computer languages&lt;/a&gt; (and its following sections)&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;Test the data&lt;/strong&gt;&lt;/p&gt;\n\n&lt;p&gt;Viewing the data with a tool or with &lt;code&gt;SELECT&lt;/code&gt; cannot be trusted.\nToo many such clients, especially browsers, try to compensate for incorrect encodings, and show you correct text even if the database is mangled.\nSo, pick a table and column that has some non-English text and do&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; col, HEX(col) &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; tbl &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; ...\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;The HEX for correctly stored UTF-8 will be&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;For a blank space (in any language):  &lt;code&gt;20&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;For English:  &lt;code&gt;4x&lt;/code&gt;, &lt;code&gt;5x&lt;/code&gt;, &lt;code&gt;6x&lt;/code&gt;, or &lt;code&gt;7x&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;For most of Western Europe, accented letters should be &lt;code&gt;Cxyy&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;Cyrillic, Hebrew, and Farsi/Arabic:  &lt;code&gt;Dxyy&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;Most of Asia:  &lt;code&gt;Exyyzz&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;Emoji and some of Chinese:  &lt;code&gt;F0yyzzww&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;http://mysql.rjweb.org/doc.php/charcoll#diagnosing_charset_issues&quot; rel=&quot;noreferrer&quot;&gt;More details&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;&lt;strong&gt;Specific causes and fixes of the problems seen&lt;/strong&gt;&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;Truncated&lt;/strong&gt; text (&lt;code&gt;Se&lt;/code&gt; for &lt;code&gt;Señor&lt;/code&gt;):&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;The bytes to be stored are not encoded as utf8mb4. Fix this.&lt;/li&gt;\n&lt;li&gt;Also, check that the connection during reading is UTF-8.&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;&lt;strong&gt;Black Diamonds&lt;/strong&gt; with question marks (&lt;code&gt;Seor&lt;/code&gt; for &lt;code&gt;Señor&lt;/code&gt;);\none of these cases exists:&lt;/p&gt;\n\n&lt;p&gt;Case 1 (original bytes were &lt;em&gt;not&lt;/em&gt; UTF-8):&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;The bytes to be stored are not encoded as utf8. Fix this.&lt;/li&gt;\n&lt;li&gt;The connection (or &lt;code&gt;SET NAMES&lt;/code&gt;) for the &lt;code&gt;INSERT&lt;/code&gt; &lt;em&gt;and&lt;/em&gt; the &lt;code&gt;SELECT&lt;/code&gt; was not utf8/utf8mb4.  Fix this.&lt;/li&gt;\n&lt;li&gt;Also, check that the column in the database is &lt;code&gt;CHARACTER SET utf8&lt;/code&gt; (or utf8mb4).&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;Case 2 (original bytes &lt;em&gt;were&lt;/em&gt; UTF-8):&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;The connection (or &lt;code&gt;SET NAMES&lt;/code&gt;) for the &lt;code&gt;SELECT&lt;/code&gt; was not utf8/utf8mb4.  Fix this.&lt;/li&gt;\n&lt;li&gt;Also, check that the column in the database is &lt;code&gt;CHARACTER SET utf8&lt;/code&gt; (or utf8mb4).&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;Black diamonds occur only when the browser is set to &lt;code&gt;&amp;lt;meta charset=UTF-8&amp;gt;&lt;/code&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;Question Marks&lt;/strong&gt; (regular ones, not black diamonds) (&lt;code&gt;Se?or&lt;/code&gt; for &lt;code&gt;Señor&lt;/code&gt;):&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;The bytes to be stored are not encoded as utf8/utf8mb4.  Fix this.&lt;/li&gt;\n&lt;li&gt;The column in the database is not &lt;code&gt;CHARACTER SET utf8&lt;/code&gt; (or utf8mb4).  Fix this.  (Use &lt;code&gt;SHOW CREATE TABLE&lt;/code&gt;.)&lt;/li&gt;\n&lt;li&gt;Also, check that the connection during reading is UTF-8.&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;&lt;strong&gt;Mojibake&lt;/strong&gt; (&lt;code&gt;SeÃ±or&lt;/code&gt; for &lt;code&gt;Señor&lt;/code&gt;):\n(This discussion also applies to &lt;strong&gt;Double Encoding&lt;/strong&gt;, which is not necessarily visible.)&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;The bytes to be stored need to be UTF-8-encoded.  Fix this.&lt;/li&gt;\n&lt;li&gt;The connection when &lt;code&gt;INSERTing&lt;/code&gt; and &lt;code&gt;SELECTing&lt;/code&gt; text needs to specify utf8 or utf8mb4.  Fix this.&lt;/li&gt;\n&lt;li&gt;The column needs to be declared &lt;code&gt;CHARACTER SET utf8&lt;/code&gt; (or utf8mb4).  Fix this.&lt;/li&gt;\n&lt;li&gt;HTML should start with &lt;code&gt;&amp;lt;meta charset=UTF-8&amp;gt;&lt;/code&gt;.&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;If the data looks correct, but won&apos;t sort correctly, then\neither you have picked the wrong collation,\nor there is no collation that suits your need,\nor you have &lt;strong&gt;Double Encoding&lt;/strong&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;Double Encoding&lt;/strong&gt; can be confirmed by doing the &lt;code&gt;SELECT .. HEX ..&lt;/code&gt; described above.&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;é should come back C3A9, but instead shows C383C2A9\nThe Emoji  should come back F09F91BD, but comes back C3B0C5B8E28098C2BD\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;That is, the hex is about twice as long as it should be.\nThis is caused by converting from latin1 (or whatever) to utf8, then treating those\nbytes as if they were latin1 and repeating the conversion.\nThe sorting (and comparing) does not work correctly because it is, for example,\nsorting as if the string were &lt;code&gt;SeÃ±or&lt;/code&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;Fixing the Data, where possible&lt;/strong&gt;&lt;/p&gt;\n\n&lt;p&gt;For &lt;strong&gt;Truncation&lt;/strong&gt; and &lt;strong&gt;Question Marks&lt;/strong&gt;, the data is lost.&lt;/p&gt;\n\n&lt;p&gt;For &lt;strong&gt;Mojibake&lt;/strong&gt; / &lt;strong&gt;Double Encoding&lt;/strong&gt;, ...&lt;/p&gt;\n\n&lt;p&gt;For &lt;strong&gt;Black Diamonds&lt;/strong&gt;, ...&lt;/p&gt;\n\n&lt;p&gt;The &lt;strong&gt;Fixes&lt;/strong&gt; are listed here.  (5 different fixes for 5 different situations; pick carefully):  &lt;a href=&quot;http://mysql.rjweb.org/doc.php/charcoll#fixes_for_various_cases&quot; rel=&quot;noreferrer&quot;&gt;http://mysql.rjweb.org/doc.php/charcoll#fixes_for_various_cases&lt;/a&gt;&lt;/p&gt;\n    ","\n&lt;p&gt;I had similar issues with two of my projects, after a server migration. After searching and trying a lot of solutions, I came across with this one:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;mysqli_set_charset($con,&quot;utf8&quot;);\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;After adding this line to my configuration file, everything works fine!&lt;/p&gt;\n&lt;p&gt;I found this solution for &lt;a href=&quot;https://en.wikipedia.org/wiki/MySQLi&quot; rel=&quot;nofollow noreferrer&quot;&gt;MySQLi&lt;/a&gt;&lt;em&gt;&lt;a href=&quot;https://www.w3schools.com/PHP/func_mysqli_set_charset.asp&quot; rel=&quot;nofollow noreferrer&quot;&gt;PHP mysqli set_charset() Function&lt;/a&gt;&lt;/em&gt;when I was looking to solve an insert from an HTML query.&lt;/p&gt;\n    ","\n&lt;p&gt;I was also searching for the same issue. It took me nearly one month to find the appropriate solution.&lt;/p&gt;\n&lt;p&gt;First of all, you will have to update you database will all the recent CHARACTER and COLLATION to utf8mb4 or at least which support UTF-8 data.&lt;/p&gt;\n&lt;p&gt;For Java:&lt;/p&gt;\n&lt;p&gt;while making a JDBC connection, add this to the connection URL &lt;em&gt;useUnicode=yes&amp;amp;characterEncoding=UTF-8&lt;/em&gt; as parameters and it will work.&lt;/p&gt;\n&lt;p&gt;For Python:&lt;/p&gt;\n&lt;p&gt;Before querying into the database, try enforcing this over the cursor&lt;/p&gt;\n&lt;p&gt;*\n&lt;code&gt;cursor.execute(&apos;SET NAMES utf8mb4&apos;)&lt;/code&gt;\n&lt;code&gt;cursor.execute(&quot;SET CHARACTER SET utf8mb4&quot;)&lt;/code&gt;\n&lt;code&gt;cursor.execute(&quot;SET character_set_connection=utf8mb4&quot;)&lt;/code&gt;\n*&lt;/p&gt;\n&lt;p&gt;If it does not work, happy hunting for the right solution.&lt;/p&gt;\n    ","\n&lt;ol&gt;\n&lt;li&gt;&lt;p&gt;Set your code IDE language to UTF-8&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;p&gt;Add &amp;lt;meta charset=&quot;utf-8&quot;&amp;gt; to your webpage header where you collect data form.&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;p&gt;Check your MySQL table definition looks like this:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;TABLE&lt;/span&gt; your_table (\n   ...\n ) ENGINE&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;InnoDB &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; CHARSET&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;utf8\n&lt;/code&gt;&lt;/pre&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;p&gt;If you are using &lt;a href=&quot;https://en.wikipedia.org/wiki/PHP#Development_and_community&quot; rel=&quot;nofollow noreferrer&quot;&gt;PDO&lt;/a&gt;, make sure&lt;/p&gt;\n&lt;pre class=&quot;lang-php s-code-block&quot;&gt;&lt;code class=&quot;hljs language-php&quot;&gt;&lt;span class=&quot;hljs-variable&quot;&gt;$options&lt;/span&gt; = &lt;span class=&quot;hljs-keyword&quot;&gt;array&lt;/span&gt;(PDO::&lt;span class=&quot;hljs-variable constant_&quot;&gt;MYSQL_ATTR_INIT_COMMAND&lt;/span&gt;=&amp;gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;SET NAMES utf8&apos;&lt;/span&gt;);\n&lt;span class=&quot;hljs-variable&quot;&gt;$dbL&lt;/span&gt; = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title function_ invoke__&quot;&gt;PDO&lt;/span&gt;(&lt;span class=&quot;hljs-variable&quot;&gt;$pdo&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;$user&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;$pass&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;$options&lt;/span&gt;);\n&lt;/code&gt;&lt;/pre&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;If you already got a large database with above problem, you can try SIDU to export with correct charset, and import back with UTF-8.&lt;/p&gt;\n    ","\n&lt;p&gt;Depending on how the server is setup, you have to change the encode accordingly. utf8 from what you said should work the best. However, if you&apos;re getting weird characters, it might help if you change the webpage encoding to ANSI.&lt;/p&gt;\n&lt;p&gt;This helped me when I was setting up a PHP &lt;a href=&quot;https://en.wikipedia.org/wiki/MySQLi&quot; rel=&quot;nofollow noreferrer&quot;&gt;MySQLi&lt;/a&gt;. This might help you understand more: &lt;em&gt;&lt;a href=&quot;https://superuser.com/questions/762473/ansi-to-utf-8-in-notepad&quot;&gt;ANSI to UTF-8 in Notepad++&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;\n    "]},"randomTags":[{"name":"jsp","slug":"jsp"},{"name":"pygame-surface","slug":"pygame-surface"},{"name":"arrayindexoutofboundsexception","slug":"arrayindexoutofboundsexception"},{"name":"int","slug":"int"},{"name":"sql","slug":"sql"},{"name":"ecmascript-2017","slug":"ecmascript-2017"},{"name":"utf-8","slug":"utf-8"},{"name":"greatest-n-per-group","slug":"greatest-n-per-group"},{"name":"parameters","slug":"parameters"},{"name":"combinations","slug":"combinations"},{"name":"attr","slug":"attr"},{"name":"w3c","slug":"w3c"},{"name":"asp.net-mvc","slug":"asp.net-mvc"},{"name":"python-2.7","slug":"python-2.7"},{"name":"dynamic","slug":"dynamic"},{"name":"max","slug":"max"},{"name":"html-parsing","slug":"html-parsing"},{"name":"angular","slug":"angular"},{"name":"function-pointers","slug":"function-pointers"},{"name":"dependent-name","slug":"dependent-name"}]},"__N_SSG":true}