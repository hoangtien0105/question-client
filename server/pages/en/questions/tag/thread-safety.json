{"pageProps":{"data":{"count":1,"rows":[{"id":427,"title":"Are global variables thread-safe in Flask? How do I share data between requests?","slug":"are-global-variables-thread-safe-in-flask-how-do-i-share-data-between-requests-1657387949951","postType":"QUESTION","createdAt":"2022-07-09T17:32:29.000Z","updatedAt":"2022-07-09T17:32:29.000Z","tags":[{"id":2246,"name":"thread-safety","slug":"thread-safety","createdAt":"2022-07-09T17:32:30.000Z","updatedAt":"2022-07-09T17:32:30.000Z","Questions_Tags":{"questionId":427,"tagId":2246}}]}]},"slug":"thread-safety","page":1,"answers":{"427":["\n&lt;p&gt;You can&apos;t use global variables to hold this sort of data. Not only is it not thread safe, it&apos;s not &lt;em&gt;process&lt;/em&gt; safe, and WSGI servers in production spawn multiple processes. Not only would your counts be wrong if you were using threads to handle requests, they would also vary depending on which process handled the request.&lt;/p&gt;\n\n&lt;p&gt;Use a data source outside of Flask to hold global data. A database, memcached, or redis are all appropriate separate storage areas, depending on your needs. If you need to load and access Python data, consider &lt;a href=&quot;https://stackoverflow.com/a/28426819&quot;&gt;&lt;code&gt;multiprocessing.Manager&lt;/code&gt;&lt;/a&gt;. You could also use the session for simple data that is per-user.&lt;/p&gt;\n\n&lt;hr&gt;\n\n&lt;p&gt;The development server may run in single thread and process. You won&apos;t see the behavior you describe since each request will be handled synchronously. Enable threads or processes and you will see it. &lt;code&gt;app.run(threaded=True)&lt;/code&gt; or &lt;code&gt;app.run(processes=10)&lt;/code&gt;. (In 1.0 the server is threaded by default.)&lt;/p&gt;\n\n&lt;hr&gt;\n\n&lt;p&gt;Some WSGI servers may support gevent or another async worker. Global variables are still not thread safe because there&apos;s still no protection against most race conditions. You can still have a scenario where one worker gets a value, yields, another modifies it, yields, then the first worker also modifies it.&lt;/p&gt;\n\n&lt;hr&gt;\n\n&lt;p&gt;If you need to store some global data &lt;em&gt;during&lt;/em&gt; a request, you may use Flask&apos;s &lt;a href=&quot;http://flask.pocoo.org/docs/1.0/api/#flask.g&quot; rel=&quot;noreferrer&quot;&gt;&lt;code&gt;g&lt;/code&gt; object&lt;/a&gt;. Another common case is some top-level object that manages database connections. The distinction for this type of &quot;global&quot; is that it&apos;s unique to each request, not used &lt;em&gt;between&lt;/em&gt; requests, and there&apos;s something managing the set up and teardown of the resource.&lt;/p&gt;\n    ","\n&lt;p&gt;This is not really an answer to thread safety of globals.&lt;/p&gt;\n\n&lt;p&gt;But I think it is important to mention sessions here.\nYou are looking for a way to store client-specific data. Every connection should have access to its own pool of data, in a threadsafe way.&lt;/p&gt;\n\n&lt;p&gt;This is possible with server-side sessions, and they are available in a very neat flask plugin: &lt;a href=&quot;https://pythonhosted.org/Flask-Session/&quot; rel=&quot;noreferrer&quot;&gt;https://pythonhosted.org/Flask-Session/&lt;/a&gt;&lt;/p&gt;\n\n&lt;p&gt;If you set up sessions, a &lt;code&gt;session&lt;/code&gt; variable is available in all your routes and it behaves like a dictionary. The data stored in this dictionary is individual for each connecting client.&lt;/p&gt;\n\n&lt;p&gt;Here is a short demo:&lt;/p&gt;\n\n&lt;pre class=&quot;lang-py s-code-block&quot;&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; flask &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; Flask, session\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; flask_session &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; Session\n\napp = Flask(__name__)\n&lt;span class=&quot;hljs-comment&quot;&gt;# Check Configuration section for more details&lt;/span&gt;\nSESSION_TYPE = &lt;span class=&quot;hljs-string&quot;&gt;&apos;filesystem&apos;&lt;/span&gt;\napp.config.from_object(__name__)\nSession(app)\n\n&lt;span class=&quot;hljs-meta&quot;&gt;@app.route(&lt;span class=&quot;hljs-params&quot;&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;/&apos;&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;reset&lt;/span&gt;():\n    session[&lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt;]=&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;counter was reset&quot;&lt;/span&gt;\n\n&lt;span class=&quot;hljs-meta&quot;&gt;@app.route(&lt;span class=&quot;hljs-params&quot;&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;/inc&apos;&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;routeA&lt;/span&gt;():\n    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; session:\n        session[&lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt;]=&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;\n\n    session[&lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt;]+=&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;counter is {}&quot;&lt;/span&gt;.&lt;span class=&quot;hljs-built_in&quot;&gt;format&lt;/span&gt;(session[&lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt;])\n\n&lt;span class=&quot;hljs-meta&quot;&gt;@app.route(&lt;span class=&quot;hljs-params&quot;&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;/dec&apos;&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;routeB&lt;/span&gt;():\n    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; session:\n        session[&lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt;] = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;\n\n    session[&lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt;] -= &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;counter is {}&quot;&lt;/span&gt;.&lt;span class=&quot;hljs-built_in&quot;&gt;format&lt;/span&gt;(session[&lt;span class=&quot;hljs-string&quot;&gt;&quot;counter&quot;&lt;/span&gt;])\n\n\n&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; __name__ == &lt;span class=&quot;hljs-string&quot;&gt;&apos;__main__&apos;&lt;/span&gt;:\n    app.run()\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;After &lt;code&gt;pip install Flask-Session&lt;/code&gt;, you should be able to run this. Try accessing it from different browsers, you&apos;ll see that the counter is not shared between them.&lt;/p&gt;\n    ","\n&lt;p&gt;Another example of a data source external to requests is a cache, such as what&apos;s provided by &lt;a href=&quot;https://flask-caching.readthedocs.io/en/latest/index.html&quot; rel=&quot;noreferrer&quot;&gt;Flask-Caching&lt;/a&gt; or another extension.&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;Create a file &lt;code&gt;common.py&lt;/code&gt; and place in it the following:&lt;/li&gt;\n&lt;/ol&gt;\n&lt;pre class=&quot;lang-py s-code-block&quot;&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; flask_caching &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; Cache\n\n&lt;span class=&quot;hljs-comment&quot;&gt;# Instantiate the cache&lt;/span&gt;\ncache = Cache()\n&lt;/code&gt;&lt;/pre&gt;\n&lt;ol start=&quot;2&quot;&gt;\n&lt;li&gt;In the file where your &lt;code&gt;flask app&lt;/code&gt; is created, register your cache with the following code:&lt;/li&gt;\n&lt;/ol&gt;\n&lt;pre class=&quot;lang-py s-code-block&quot;&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;# Import cache&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; common &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; cache\n\n&lt;span class=&quot;hljs-comment&quot;&gt;# ...&lt;/span&gt;\napp = Flask(__name__)\n\ncache.init_app(app=app, config={&lt;span class=&quot;hljs-string&quot;&gt;&quot;CACHE_TYPE&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;filesystem&quot;&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;CACHE_DIR&apos;&lt;/span&gt;: Path(&lt;span class=&quot;hljs-string&quot;&gt;&apos;/tmp&apos;&lt;/span&gt;)})\n&lt;/code&gt;&lt;/pre&gt;\n&lt;ol start=&quot;3&quot;&gt;\n&lt;li&gt;Now use throughout your application by importing the cache and executing as follows:&lt;/li&gt;\n&lt;/ol&gt;\n&lt;pre class=&quot;lang-py s-code-block&quot;&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;# Import cache&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; common &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; cache\n\n&lt;span class=&quot;hljs-comment&quot;&gt;# store a value&lt;/span&gt;\ncache.&lt;span class=&quot;hljs-built_in&quot;&gt;set&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;my_value&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;1_000_000&lt;/span&gt;)\n\n&lt;span class=&quot;hljs-comment&quot;&gt;# Get a value&lt;/span&gt;\nmy_value = cache.get(&lt;span class=&quot;hljs-string&quot;&gt;&quot;my_value&quot;&lt;/span&gt;)\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;While totally accepting the previous upvoted answers, and discouraging use of global variables for production and scalable Flask storage, for the purpose of prototyping or really simple servers, running under the flask &apos;development server&apos;...&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&lt;p&gt;The Python built-in data types, and I personally used and tested the global &lt;code&gt;dict&lt;/code&gt;, &lt;a href=&quot;https://docs.python.org/3/glossary.html#term-global-interpreter-lock&quot; rel=&quot;nofollow noreferrer&quot;&gt;as per Python documentation&lt;/a&gt; are &lt;strong&gt;thread&lt;/strong&gt; safe. Not &lt;strong&gt;process&lt;/strong&gt; safe.&lt;/p&gt;\n&lt;p&gt;The insertions, lookups, and reads from such a (server global) dict will be OK from each (possibly concurrent) Flask session running under the development server.&lt;/p&gt;\n&lt;p&gt;When such a global dict is keyed with a unique Flask session key, it can be rather useful for server-side storage of session specific data otherwise not fitting into the cookie (max size 4 kB).&lt;/p&gt;\n&lt;p&gt;Of course, such a server global dict should be carefully guarded for growing too large, being in-memory. Some sort of expiring the &apos;old&apos; key/value pairs can be coded during request processing.&lt;/p&gt;\n&lt;p&gt;Again, it is not recommended for production or scalable deployments, but it is possibly OK for local task-oriented servers where a separate database is too much for the given task.&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n    "]},"randomTags":[{"name":"session-variables","slug":"session-variables"},{"name":"inner-join","slug":"inner-join"},{"name":"ecmascript-harmony","slug":"ecmascript-harmony"},{"name":"local-storage","slug":"local-storage"},{"name":"random","slug":"random"},{"name":"mariadb","slug":"mariadb"},{"name":"angularjs","slug":"angularjs"},{"name":"null","slug":"null"},{"name":"pass-by-value","slug":"pass-by-value"},{"name":"bcrypt","slug":"bcrypt"},{"name":"javafx","slug":"javafx"},{"name":"relative-path","slug":"relative-path"},{"name":"polymorphism","slug":"polymorphism"},{"name":"foreach","slug":"foreach"},{"name":"python-3.x","slug":"python-3.x"},{"name":"iife","slug":"iife"},{"name":"ereg","slug":"ereg"},{"name":"html","slug":"html"},{"name":"getter","slug":"getter"},{"name":"w3c","slug":"w3c"}]},"__N_SSG":true}