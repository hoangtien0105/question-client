{"pageProps":{"data":{"count":1,"rows":[{"id":176,"title":"Variables are not behaving as expected","slug":"variables-are-not-behaving-as-expected-1657384865672","postType":"QUESTION","createdAt":"2022-07-09T16:41:05.000Z","updatedAt":"2022-07-09T16:41:05.000Z","tags":[{"id":647,"name":"batch-file","slug":"batch-file","createdAt":"2022-07-09T16:41:05.000Z","updatedAt":"2022-07-09T16:41:05.000Z","Questions_Tags":{"questionId":176,"tagId":647}}]}]},"slug":"batch-file","page":"1","answers":{"176":["\n\n&lt;p&gt;You are not the first, who fell into the famous &quot;delayed expansion trap&quot; (and you won&apos;t be the last).&lt;/p&gt;\n&lt;p&gt;You need delayed expansion if you want to use a variable, that you changed in the same block (a block is a series of commands within parentheses &lt;code&gt;(&lt;/code&gt;and &lt;code&gt;)&lt;/code&gt;).&lt;/p&gt;\n&lt;p&gt;Delayed variables are referenced with &lt;code&gt;!var!&lt;/code&gt; instead of &lt;code&gt;%var%&lt;/code&gt;.&lt;/p&gt;\n&lt;p&gt;Reason is the way, &lt;code&gt;cmd&lt;/code&gt; parses the code. A complete line or block is parsed at once, replacing normal variables with their value at parse time. Delayed variables are evaluated at runtime.&lt;/p&gt;\n&lt;p&gt;Two simple batch files to demonstrate:&lt;/p&gt;\n&lt;pre class=&quot;lang-bat s-code-block&quot;&gt;&lt;code class=&quot;hljs language-csharp&quot;&gt;setlocal EnableDelayedExpansion\n&lt;span class=&quot;hljs-keyword&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;var=hello&quot;&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;==&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;var=world&quot;&lt;/span&gt;\n    echo %&lt;span class=&quot;hljs-keyword&quot;&gt;var&lt;/span&gt;% !&lt;span class=&quot;hljs-keyword&quot;&gt;var&lt;/span&gt;!\n)\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;pre class=&quot;lang-bat s-code-block&quot;&gt;&lt;code class=&quot;hljs language-lua&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;setlocal&lt;/span&gt; EnableDelayedExpansion\n&lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; /L %%i &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; (&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;do&lt;/span&gt; (\n    echo %&lt;span class=&quot;hljs-built_in&quot;&gt;random&lt;/span&gt;% !&lt;span class=&quot;hljs-built_in&quot;&gt;random&lt;/span&gt;!\n)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;em&gt;Note&lt;/em&gt;: A line is also treated as a block:&lt;/p&gt;\n&lt;pre class=&quot;lang-bat s-code-block&quot;&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;var=old&quot;&lt;/span&gt;\n&lt;span class=&quot;hljs-built_in&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;var=new&quot;&lt;/span&gt; &amp;amp; &lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; %var% \n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;With delayed expansion:&lt;/p&gt;\n&lt;pre class=&quot;lang-bat s-code-block&quot;&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;setlocal EnableDelayedExpansion\n&lt;span class=&quot;hljs-built_in&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;var=old&quot;&lt;/span&gt;\n&lt;span class=&quot;hljs-built_in&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;var=new&quot;&lt;/span&gt; &amp;amp; &lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; !var! \n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Delayed expansion is per default turned off at the command prompt. If you really need it, you can do:&lt;/p&gt;\n&lt;pre class=&quot;lang-bat s-code-block&quot;&gt;&lt;code class=&quot;hljs language-csharp&quot;&gt;cmd /V:ON /C &lt;span class=&quot;hljs-string&quot;&gt;&quot;set &quot;&lt;/span&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;var&lt;/span&gt;=hello&lt;span class=&quot;hljs-string&quot;&gt;&quot; &amp;amp; echo !var!&quot;&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Also there is a way to do the same without delayed expansion (but &lt;code&gt;call&lt;/code&gt; costs some time, so it&apos;s slower, but if for some reason you can&apos;t / don&apos;t want to use delayed expansion, it&apos;s an alternative):&lt;/p&gt;\n&lt;pre class=&quot;lang-bat s-code-block&quot;&gt;&lt;code class=&quot;hljs language-lua&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;setlocal&lt;/span&gt; DISabledelayedexpansion\n&lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; /L %%i &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; (&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;do&lt;/span&gt; (\n    call echo %&lt;span class=&quot;hljs-built_in&quot;&gt;random&lt;/span&gt;% %%&lt;span class=&quot;hljs-built_in&quot;&gt;random&lt;/span&gt;%% \n)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Both methods can also be used to display &lt;a href=&quot;https://stackoverflow.com/a/10167990&quot;&gt;array-like variables&lt;/a&gt;:&lt;/p&gt;\n&lt;p&gt;(This is often asked like &quot;variable which contains another variable&quot; or &quot;nested variables&quot;)&lt;/p&gt;\n&lt;p&gt;Here is a collection for using such array-like variables in different situations:&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;With delayed expansion:&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=&quot;lang-bat s-code-block&quot;&gt;&lt;code class=&quot;hljs language-dart&quot;&gt;setlocal ENableDelayedExpansion\n&lt;span class=&quot;hljs-keyword&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;num=4&quot;&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;var[%num%]=HELLO&quot;&lt;/span&gt;\necho plain delayed: !&lt;span class=&quot;hljs-keyword&quot;&gt;var&lt;/span&gt;[%&lt;span class=&quot;hljs-built_in&quot;&gt;num&lt;/span&gt;%]!\n&lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; /L %%i &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; (&lt;span class=&quot;hljs-number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;4&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;do&lt;/span&gt; (\n    echo &lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; delayed: !&lt;span class=&quot;hljs-keyword&quot;&gt;var&lt;/span&gt;[%%i]!\n    &lt;span class=&quot;hljs-keyword&quot;&gt;set&lt;/span&gt; a=%%i\n    call echo &lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; delayed &lt;span class=&quot;hljs-keyword&quot;&gt;with&lt;/span&gt; variable: %%&lt;span class=&quot;hljs-keyword&quot;&gt;var&lt;/span&gt;[!a!]%%\n)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;without delayed expansion:&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=&quot;lang-bat s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;setlocal DISableDelayedExpansion\n&lt;span class=&quot;hljs-keyword&quot;&gt;set&lt;/span&gt; &quot;num=4&quot;\n&lt;span class=&quot;hljs-keyword&quot;&gt;set&lt;/span&gt; &quot;var[%num%]=HELLO&quot;\n&lt;span class=&quot;hljs-keyword&quot;&gt;call&lt;/span&gt; echo plain &lt;span class=&quot;hljs-keyword&quot;&gt;called&lt;/span&gt;: &lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;var[&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;num&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;]&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;/&lt;/span&gt;L &lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;i &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; (&lt;span class=&quot;hljs-number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;4&lt;/span&gt;) do (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;call&lt;/span&gt; echo &lt;span class=&quot;hljs-keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;called&lt;/span&gt;: &lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;var[&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;i]&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;set&lt;/span&gt; a&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;i\n    &lt;span class=&quot;hljs-keyword&quot;&gt;call&lt;/span&gt; echo &lt;span class=&quot;hljs-keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;called&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;with&lt;/span&gt; variable: &lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;var[&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;a&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;]&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;\n)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: &lt;code&gt;setlocal&lt;/code&gt; has no effect outside of batchfiles, so &lt;code&gt;delayedexpansion&lt;/code&gt; works only:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;In batch files&lt;/li&gt;\n&lt;li&gt;When the cmd was started with delayed expansion enabled (&lt;code&gt;cmd /V:ON&lt;/code&gt;) (by default, the cmd runs with delayed expansion &lt;strong&gt;dis&lt;/strong&gt;abled)&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;(Follow the links, when you are interested in the &lt;a href=&quot;http://blogs.msdn.com/b/oldnewthing/archive/2006/08/23/714650.aspx&quot; rel=&quot;nofollow noreferrer&quot;&gt;technical background&lt;/a&gt; or even the &lt;a href=&quot;http://stackoverflow.com/q/4094699/2152082&quot;&gt;advanced technical stuff&lt;/a&gt;)&lt;/p&gt;\n    "]},"randomTags":[{"name":"srand","slug":"srand"},{"name":"tsql","slug":"tsql"},{"name":"unobtrusive-javascript","slug":"unobtrusive-javascript"},{"name":"memory-management","slug":"memory-management"},{"name":"loops","slug":"loops"},{"name":"var","slug":"var"},{"name":"c++-standard-library","slug":"c++-standard-library"},{"name":"cuda","slug":"cuda"},{"name":"merge","slug":"merge"},{"name":"python-2.7","slug":"python-2.7"},{"name":"forward-declaration","slug":"forward-declaration"},{"name":"dhtml","slug":"dhtml"},{"name":"autowired","slug":"autowired"},{"name":"layout-manager","slug":"layout-manager"},{"name":"nameerror","slug":"nameerror"},{"name":"equality-operator","slug":"equality-operator"},{"name":"unsupported-class-version","slug":"unsupported-class-version"},{"name":"idioms","slug":"idioms"},{"name":"abi","slug":"abi"},{"name":"forms","slug":"forms"}]},"__N_SSG":true}