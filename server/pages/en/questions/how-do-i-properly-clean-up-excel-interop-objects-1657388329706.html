<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@solutionschecker.com"/><meta name="twitter:creator" content="@solutionschecker.com"/><meta property="og:url" content="https://solutionschecker.com"/><meta property="og:type" content="website"/><meta property="og:image" content="https://solutionschecker.com/solutions-checker-banner.png"/><meta property="og:image:alt" content="Find the solution to any question. We focus on finding the fastest possible solution for users. Main topics like coding, learning. - solutionschecker.com"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","logo":"/logo.svg","url":"https://solutionschecker.com"}</script><link name="keywords" content="interop,com-interop,solutions checker, solution checker, how to, solution for, check for solution, resolve question, what is, what solution for, find solution"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://solutionschecker.com","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@id":"https://solutionschecker.com/questions","name":"Questions"}},{"@type":"ListItem","position":3,"item":{"@id":"https://solutionschecker.com/questions/how-do-i-properly-clean-up-excel-interop-objects-1657388329706","name":"Questions"}}]}</script><title>How do I properly clean up Excel interop objects? | Solution Checker</title><meta name="robots" content="index,follow"/><meta name="description" content="I&#x27;m using the Excel interop in C# (ApplicationClass) and have placed the following code in my finally clause:

while (System.Runtime.InteropServices.Marshal.ReleaseComObject(excelSheet) != 0) { }
excelSheet = null;
GC.Collect();
GC.WaitForPendingFinalizers();


Although this kind of works, the Excel.exe process is still in the background even after I close Excel. It is only released once my application is manually closed.

What am I doing wrong, or is there an alternative to ensure interop objects are properly disposed of?
    "/><meta property="og:title" content="How do I properly clean up Excel interop objects? | Solution Checker"/><meta property="og:description" content="I&#x27;m using the Excel interop in C# (ApplicationClass) and have placed the following code in my finally clause:

while (System.Runtime.InteropServices.Marshal.ReleaseComObject(excelSheet) != 0) { }
excelSheet = null;
GC.Collect();
GC.WaitForPendingFinalizers();


Although this kind of works, the Excel.exe process is still in the background even after I close Excel. It is only released once my application is manually closed.

What am I doing wrong, or is there an alternative to ensure interop objects are properly disposed of?
    "/><script type="application/ld+json">{"@context":"https://schema.org","@type":"QAPage","mainEntity":{"name":"How do I properly clean up Excel interop objects?","text":"I&apos;m using the Excel interop in C# (ApplicationClass) and have placed the following code in my finally clause:\n\nwhile (System.Runtime.InteropServices.Marshal.ReleaseComObject(excelSheet) != 0) { }\nexcelSheet = null;\nGC.Collect();\nGC.WaitForPendingFinalizers();\n\n\nAlthough this kind of works, the Excel.exe process is still in the background even after I close Excel. It is only released once my application is manually closed.\n\nWhat am I doing wrong, or is there an alternative to ensure interop objects are properly disposed of?\n    ","answerCount":30,"upVoteCount":500,"suggestedAnswer":[{"text":"Excel does not quit because your application is still holding references to COM objects.\n\nI guess you&apos;re invoking at least one member of a COM object without assigning it to a variable.\n\nFor me it was the excelApp.Worksheets object which I directly used without assigning it to a variable:\n\nWorksheet sheet = excelApp.Worksheets.Open(...);\n...\nMarshal.ReleaseComObject(sheet);\n\n\nI didn&apos;t know that internally C# created a wrapper for the Worksheets COM object which didn&apos;t get released by my code (because I wasn&apos;t aware of it) and was the cause why Excel was not unloaded.\n\nI found the solution to my problem on this page, which also has a nice rule for the usage of COM objects in C#:\n\n\n  Never use two dots with COM objects.\n\n\n\n\nSo with this knowledge the right way of doing the above is:\n\nWorksheets sheets = excelApp.Worksheets; // &lt;-- The important part\nWorksheet sheet = sheets.Open(...);\n...\nMarshal.ReleaseComObject(sheets);\nMarshal.ReleaseComObject(sheet);\n\n\nPOST MORTEM UPDATE:\n\nI want every reader to read this answer by Hans Passant very carefully as it explains the trap I and lots of other developers stumbled into. When I wrote this answer years ago I didn&apos;t know about the effect the debugger has to the garbage collector and drew the wrong conclusions. I keep my answer unaltered for the sake of history but please read this link and don&apos;t go the way of &quot;the two dots&quot;: Understanding garbage collection in .NET and Clean up Excel Interop Objects with IDisposable\n    ","url":"/questions/[slug]#solution1","@type":"Answer","upvoteCount":0},{"text":"You can actually release your Excel Application object cleanly, but you do have to take care. \n\nThe advice to maintain a named reference for absolutely every COM object you access and then explicitly release it via Marshal.FinalReleaseComObject() is correct in theory, but, unfortunately, very difficult to manage in practice. If one ever slips anywhere and uses &quot;two dots&quot;, or iterates cells via a for each loop, or any other similar kind of command, then you&apos;ll have unreferenced COM objects and risk a hang. In this case, there would be no way to find the cause in the code; you would have to review all your code by eye and hopefully find the cause, a task that could be nearly impossible for a large project.\n\nThe good news is that you do not actually have to maintain a named variable reference to every COM object you use. Instead, call GC.Collect() and then GC.WaitForPendingFinalizers() to release all the (usually minor) objects to which you do not hold a reference, and then explicitly release the objects to which you do hold a named variable reference. \n\nYou should also release your named references in reverse order of importance: range objects first, then worksheets, workbooks, and then finally your Excel Application object.\n\nFor example, assuming that you had a Range object variable named xlRng, a Worksheet variable named xlSheet, a Workbook variable named xlBook and an Excel Application variable named xlApp, then your cleanup code could look something like the following:\n\n// Cleanup\nGC.Collect();\nGC.WaitForPendingFinalizers();\n\nMarshal.FinalReleaseComObject(xlRng);\nMarshal.FinalReleaseComObject(xlSheet);\n\nxlBook.Close(Type.Missing, Type.Missing, Type.Missing);\nMarshal.FinalReleaseComObject(xlBook);\n\nxlApp.Quit();\nMarshal.FinalReleaseComObject(xlApp);\n\n\nIn most code examples you&apos;ll see for cleaning up COM objects from .NET, the GC.Collect() and GC.WaitForPendingFinalizers() calls are made TWICE as in:\n\nGC.Collect();\nGC.WaitForPendingFinalizers();\nGC.Collect();\nGC.WaitForPendingFinalizers();\n\n\nThis should not be required, however, unless you are using Visual Studio Tools for Office (VSTO), which uses finalizers that cause an entire graph of objects to be promoted in the finalization queue. Such objects would not be released until the next garbage collection. However, if you are not using VSTO, you should be able to call GC.Collect() and GC.WaitForPendingFinalizers() just once.\n\nI know that explicitly calling GC.Collect() is a no-no (and certainly doing it twice sounds very painful), but there is no way around it, to be honest. Through normal operations you will generate hidden objects to which you hold no reference that you, therefore, cannot release through any other means other than calling GC.Collect().\n\nThis is a complex topic, but this really is all there is to it. Once you establish this template for your cleanup procedure you can code normally, without the need for wrappers, etc. :-)\n\nI have a tutorial on this here:\n\nAutomating Office Programs with VB.Net / COM Interop\n\nIt&apos;s written for VB.NET, but don&apos;t be put off by that, the principles are exactly the same as when using C#.\n    ","url":"/questions/[slug]#solution2","@type":"Answer","upvoteCount":0},{"text":"Preface: my answer contains two solutions, so be careful when reading and don&apos;t miss anything.\n\nThere are different ways and advice of how to make Excel instance unload, such as:  \n\n\nReleasing EVERY com object explicitly\nwith Marshal.FinalReleaseComObject()\n(not forgetting about implicitly\ncreated com-objects). To release\nevery created com object, you may use\nthe rule of 2 dots mentioned here:\nHow do I properly clean up Excel interop objects?\nCalling GC.Collect() and\nGC.WaitForPendingFinalizers() to make\nCLR release unused com-objects * (Actually, it works, see my second solution for details)\nChecking if com-server-application\nmaybe shows a message box waiting for\nthe user to answer (though I am not\nsure it can prevent Excel from\nclosing, but I heard about it a few\ntimes)\nSending WM_CLOSE message to the main\nExcel window\nExecuting the function that works\nwith Excel in a separate AppDomain.\nSome people believe Excel instance\nwill be shut, when AppDomain is\nunloaded.\nKilling all excel instances which were instantiated after our excel-interoping code started.\n\n\nBUT! Sometimes all these options just don&apos;t help or can&apos;t be appropriate!\n\nFor example, yesterday I found out that in one of my functions (which works with excel) Excel keeps running after the function ends. I tried everything! I thoroughly checked the whole function 10 times and added Marshal.FinalReleaseComObject() for everything! I also had GC.Collect() and GC.WaitForPendingFinalizers(). I checked for hidden message boxes. I tried to send WM_CLOSE message to the main Excel window. I executed my function in a separate AppDomain and unloaded that domain. Nothing helped! The option with closing all excel instances is inappropriate, because if the user starts another Excel instance manually, during execution of my function which works also with Excel, then that instance will also be closed by my function. I bet the user will not be happy! So, honestly, this is a lame option (no offence guys). So I spent a couple of hours before I found a good (in my humble opinion) solution: Kill excel process by hWnd of its main window (it&apos;s the first solution).\n\nHere is the simple code:\n\n[DllImport(&quot;user32.dll&quot;)]\nprivate static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint lpdwProcessId);\n\n/// &lt;summary&gt; Tries to find and kill process by hWnd to the main window of the process.&lt;/summary&gt;\n/// &lt;param name=&quot;hWnd&quot;&gt;Handle to the main window of the process.&lt;/param&gt;\n/// &lt;returns&gt;True if process was found and killed. False if process was not found by hWnd or if it could not be killed.&lt;/returns&gt;\npublic static bool TryKillProcessByMainWindowHwnd(int hWnd)\n{\n    uint processID;\n    GetWindowThreadProcessId((IntPtr)hWnd, out processID);\n    if(processID == 0) return false;\n    try\n    {\n        Process.GetProcessById((int)processID).Kill();\n    }\n    catch (ArgumentException)\n    {\n        return false;\n    }\n    catch (Win32Exception)\n    {\n        return false;\n    }\n    catch (NotSupportedException)\n    {\n        return false;\n    }\n    catch (InvalidOperationException)\n    {\n        return false;\n    }\n    return true;\n}\n\n/// &lt;summary&gt; Finds and kills process by hWnd to the main window of the process.&lt;/summary&gt;\n/// &lt;param name=&quot;hWnd&quot;&gt;Handle to the main window of the process.&lt;/param&gt;\n/// &lt;exception cref=&quot;ArgumentException&quot;&gt;\n/// Thrown when process is not found by the hWnd parameter (the process is not running). \n/// The identifier of the process might be expired.\n/// &lt;/exception&gt;\n/// &lt;exception cref=&quot;Win32Exception&quot;&gt;See Process.Kill() exceptions documentation.&lt;/exception&gt;\n/// &lt;exception cref=&quot;NotSupportedException&quot;&gt;See Process.Kill() exceptions documentation.&lt;/exception&gt;\n/// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;See Process.Kill() exceptions documentation.&lt;/exception&gt;\npublic static void KillProcessByMainWindowHwnd(int hWnd)\n{\n    uint processID;\n    GetWindowThreadProcessId((IntPtr)hWnd, out processID);\n    if (processID == 0)\n        throw new ArgumentException(&quot;Process has not been found by the given main window handle.&quot;, &quot;hWnd&quot;);\n    Process.GetProcessById((int)processID).Kill();\n}\n\n\nAs you can see I provided two methods, according to Try-Parse pattern (I think it is appropriate here): one method doesn&apos;t throw the exception if the Process could not be killed (for example the process doesn&apos;t exist anymore), and another method throws the exception if the Process was not killed. The only weak place in this code is security permissions. Theoretically, the user may not have permissions to kill the process, but in 99.99% of all cases, user has such permissions. I also tested it with a guest account - it works perfectly.\n\nSo, your code, working with Excel, can look like this:\n\nint hWnd = xl.Application.Hwnd;\n// ...\n// here we try to close Excel as usual, with xl.Quit(),\n// Marshal.FinalReleaseComObject(xl) and so on\n// ...\nTryKillProcessByMainWindowHwnd(hWnd);\n\n\nVoila! Excel is terminated! :)\n\nOk, let&apos;s go back to the second solution, as I promised in the beginning of the post.\nThe second solution is to call GC.Collect() and GC.WaitForPendingFinalizers(). Yes, they actually work, but you need to be careful here!\nMany people say (and I said) that calling GC.Collect() doesn&apos;t help. But the reason it wouldn&apos;t help is if there are still references to COM objects! One of the most popular reasons for GC.Collect() not being helpful is running the project in Debug-mode. In debug-mode objects that are not really referenced anymore will not be garbage collected until the end of the method.\nSo, if you tried GC.Collect() and GC.WaitForPendingFinalizers() and it didn&apos;t help, try to do the following:  \n\n1) Try to run your project in Release mode and check if Excel closed correctly  \n\n2) Wrap the method of working with Excel in a separate method.\nSo, instead of something like this:\n\nvoid GenerateWorkbook(...)\n{\n  ApplicationClass xl;\n  Workbook xlWB;\n  try\n  {\n    xl = ...\n    xlWB = xl.Workbooks.Add(...);\n    ...\n  }\n  finally\n  {\n    ...\n    Marshal.ReleaseComObject(xlWB)\n    ...\n    GC.Collect();\n    GC.WaitForPendingFinalizers();\n  }\n}\n\n\nyou write:\n\nvoid GenerateWorkbook(...)\n{\n  try\n  {\n    GenerateWorkbookInternal(...);\n  }\n  finally\n  {\n    GC.Collect();\n    GC.WaitForPendingFinalizers();\n  }\n}\n\nprivate void GenerateWorkbookInternal(...)\n{\n  ApplicationClass xl;\n  Workbook xlWB;\n  try\n  {\n    xl = ...\n    xlWB = xl.Workbooks.Add(...);\n    ...\n  }\n  finally\n  {\n    ...\n    Marshal.ReleaseComObject(xlWB)\n    ...\n  }\n}\n\n\nNow, Excel will close =)\n    ","url":"/questions/[slug]#solution3","@type":"Answer","upvoteCount":0},{"text":"UPDATE: Added C# code, and link to Windows Jobs\n\nI spent sometime trying to figure out this problem, and at the time XtremeVBTalk was the most active and responsive.  Here is a link to my original post, Closing an Excel Interop process cleanly, even if your application crashes. Below is a summary of the post, and the code copied to this post. \n\n\nClosing the Interop process with Application.Quit() and Process.Kill() works for the most part, but fails if the applications crashes catastrophically. I.e. if the app crashes, the Excel process will still be running loose.\nThe solution is to let the OS handle the cleanup of your processes through Windows Job Objects using Win32 calls.  When your main application dies, the associated processes (i.e. Excel) will get terminated as well.  \n\n\nI found this to be a clean solution because the OS is doing real work of cleaning up.  All you have to do is register the Excel process.\n\nWindows Job Code\n\nWraps the Win32 API Calls to register Interop processes.\n\npublic enum JobObjectInfoType\n{\n    AssociateCompletionPortInformation = 7,\n    BasicLimitInformation = 2,\n    BasicUIRestrictions = 4,\n    EndOfJobTimeInformation = 6,\n    ExtendedLimitInformation = 9,\n    SecurityLimitInformation = 5,\n    GroupInformation = 11\n}\n\n[StructLayout(LayoutKind.Sequential)]\npublic struct SECURITY_ATTRIBUTES\n{\n    public int nLength;\n    public IntPtr lpSecurityDescriptor;\n    public int bInheritHandle;\n}\n\n[StructLayout(LayoutKind.Sequential)]\nstruct JOBOBJECT_BASIC_LIMIT_INFORMATION\n{\n    public Int64 PerProcessUserTimeLimit;\n    public Int64 PerJobUserTimeLimit;\n    public Int16 LimitFlags;\n    public UInt32 MinimumWorkingSetSize;\n    public UInt32 MaximumWorkingSetSize;\n    public Int16 ActiveProcessLimit;\n    public Int64 Affinity;\n    public Int16 PriorityClass;\n    public Int16 SchedulingClass;\n}\n\n[StructLayout(LayoutKind.Sequential)]\nstruct IO_COUNTERS\n{\n    public UInt64 ReadOperationCount;\n    public UInt64 WriteOperationCount;\n    public UInt64 OtherOperationCount;\n    public UInt64 ReadTransferCount;\n    public UInt64 WriteTransferCount;\n    public UInt64 OtherTransferCount;\n}\n\n[StructLayout(LayoutKind.Sequential)]\nstruct JOBOBJECT_EXTENDED_LIMIT_INFORMATION\n{\n    public JOBOBJECT_BASIC_LIMIT_INFORMATION BasicLimitInformation;\n    public IO_COUNTERS IoInfo;\n    public UInt32 ProcessMemoryLimit;\n    public UInt32 JobMemoryLimit;\n    public UInt32 PeakProcessMemoryUsed;\n    public UInt32 PeakJobMemoryUsed;\n}\n\npublic class Job : IDisposable\n{\n    [DllImport(&quot;kernel32.dll&quot;, CharSet = CharSet.Unicode)]\n    static extern IntPtr CreateJobObject(object a, string lpName);\n\n    [DllImport(&quot;kernel32.dll&quot;)]\n    static extern bool SetInformationJobObject(IntPtr hJob, JobObjectInfoType infoType, IntPtr lpJobObjectInfo, uint cbJobObjectInfoLength);\n\n    [DllImport(&quot;kernel32.dll&quot;, SetLastError = true)]\n    static extern bool AssignProcessToJobObject(IntPtr job, IntPtr process);\n\n    private IntPtr m_handle;\n    private bool m_disposed = false;\n\n    public Job()\n    {\n        m_handle = CreateJobObject(null, null);\n\n        JOBOBJECT_BASIC_LIMIT_INFORMATION info = new JOBOBJECT_BASIC_LIMIT_INFORMATION();\n        info.LimitFlags = 0x2000;\n\n        JOBOBJECT_EXTENDED_LIMIT_INFORMATION extendedInfo = new JOBOBJECT_EXTENDED_LIMIT_INFORMATION();\n        extendedInfo.BasicLimitInformation = info;\n\n        int length = Marshal.SizeOf(typeof(JOBOBJECT_EXTENDED_LIMIT_INFORMATION));\n        IntPtr extendedInfoPtr = Marshal.AllocHGlobal(length);\n        Marshal.StructureToPtr(extendedInfo, extendedInfoPtr, false);\n\n        if (!SetInformationJobObject(m_handle, JobObjectInfoType.ExtendedLimitInformation, extendedInfoPtr, (uint)length))\n            throw new Exception(string.Format(&quot;Unable to set information.  Error: {0}&quot;, Marshal.GetLastWin32Error()));\n    }\n\n    #region IDisposable Members\n\n    public void Dispose()\n    {\n        Dispose(true);\n        GC.SuppressFinalize(this);\n    }\n\n    #endregion\n\n    private void Dispose(bool disposing)\n    {\n        if (m_disposed)\n            return;\n\n        if (disposing) {}\n\n        Close();\n        m_disposed = true;\n    }\n\n    public void Close()\n    {\n        Win32.CloseHandle(m_handle);\n        m_handle = IntPtr.Zero;\n    }\n\n    public bool AddProcess(IntPtr handle)\n    {\n        return AssignProcessToJobObject(m_handle, handle);\n    }\n\n}\n\n\nNote about Constructor code\n\n\nIn the constructor, the info.LimitFlags = 0x2000; is called. 0x2000 is the JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE enum value, and this value is defined by MSDN as:\n\n\n\n  Causes all processes associated with the job to terminate when the\n  last handle to the job is closed.\n\n\nExtra Win32 API Call to get the Process ID (PID)\n\n    [DllImport(&quot;user32.dll&quot;, SetLastError = true)]\n    public static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint lpdwProcessId);\n\n\nUsing the code\n\n    Excel.Application app = new Excel.ApplicationClass();\n    Job job = new Job();\n    uint pid = 0;\n    Win32.GetWindowThreadProcessId(new IntPtr(app.Hwnd), out pid);\n    job.AddProcess(Process.GetProcessById((int)pid).Handle);\n\n    ","url":"/questions/[slug]#solution4","@type":"Answer","upvoteCount":0},{"text":"This worked for a project I was working on:\n\nexcelApp.Quit();\nMarshal.ReleaseComObject (excelWB);\nMarshal.ReleaseComObject (excelApp);\nexcelApp = null;\n\n\nWe learned that it was important to set every reference to an Excel COM object to null when you were done with it. This included Cells, Sheets, and everything.\n    ","url":"/questions/[slug]#solution5","@type":"Answer","upvoteCount":0},{"text":"First - you never have to call Marshal.ReleaseComObject(...) or Marshal.FinalReleaseComObject(...) when doing Excel interop. It is a confusing anti-pattern, but any information about this, including from Microsoft, that indicates you have to manually release COM references from .NET is incorrect. The fact is that the .NET runtime and garbage collector correctly keep track of and clean up COM references. For your code, this means you can remove the whole `while (...) loop at the top.\n\nSecond, if you want to ensure that the COM references to an out-of-process COM object are cleaned up when your process ends (so that the Excel process will close), you need to ensure that the garbage collector runs. You do this correctly with calls to GC.Collect() and GC.WaitForPendingFinalizers(). Calling this twice is safe, and ensures that cycles are definitely cleaned up too (though I&apos;m not sure it&apos;s needed, and would appreciate an example that shows this).\n\nThird, when running under the debugger, local references will be artificially kept alive until the end of the method (so that local variable inspection works). So  GC.Collect() calls are not effective for cleaning object like rng.Cells from the same method. You should split the code doing the COM interop from the GC cleanup into separate methods. (This was a key discovery for me, from one part of the answer posted here by @nightcoder.)\n\nThe general pattern would thus be:\n\nSub WrapperThatCleansUp()\n\n    &apos; NOTE: Don&apos;t call Excel objects in here... \n    &apos;       Debugger would keep alive until end, preventing GC cleanup\n\n    &apos; Call a separate function that talks to Excel\n    DoTheWork()\n\n    &apos; Now let the GC clean up (twice, to clean up cycles too)\n    GC.Collect()    \n    GC.WaitForPendingFinalizers()\n    GC.Collect()    \n    GC.WaitForPendingFinalizers()\n\nEnd Sub\n\nSub DoTheWork()\n    Dim app As New Microsoft.Office.Interop.Excel.Application\n    Dim book As Microsoft.Office.Interop.Excel.Workbook = app.Workbooks.Add()\n    Dim worksheet As Microsoft.Office.Interop.Excel.Worksheet = book.Worksheets(&quot;Sheet1&quot;)\n    app.Visible = True\n    For i As Integer = 1 To 10\n        worksheet.Cells.Range(&quot;A&quot; &amp; i).Value = &quot;Hello&quot;\n    Next\n    book.Save()\n    book.Close()\n    app.Quit()\n\n    &apos; NOTE: No calls the Marshal.ReleaseComObject() are ever needed\nEnd Sub\n\n\nThere is a lot of false information and confusion about this issue, including many posts on MSDN and on Stack Overflow (and especially this question!).\n\nWhat finally convinced me to have a closer look and figure out the right advice was blog post Marshal.ReleaseComObject Considered Dangerous together with finding the issue with references kept alive under the debugger that was confusing my earlier testing.\n    ","url":"/questions/[slug]#solution6","@type":"Answer","upvoteCount":0},{"text":"Anything that is in the Excel namespace needs to be released. Period\n\nYou can&apos;t be doing:\n\nWorksheet ws = excel.WorkBooks[1].WorkSheets[1];\n\n\nYou have to be doing\n\nWorkbooks books = excel.WorkBooks;\nWorkbook book = books[1];\nSheets sheets = book.WorkSheets;\nWorksheet ws = sheets[1];\n\n\nfollowed by the releasing of the objects.\n    ","url":"/questions/[slug]#solution7","@type":"Answer","upvoteCount":0},{"text":"I found a useful generic template that can help implement the correct disposal pattern for COM objects, that need Marshal.ReleaseComObject called when they go out of scope:\n\nUsage:\n\nusing (AutoReleaseComObject&lt;Application&gt; excelApplicationWrapper = new AutoReleaseComObject&lt;Application&gt;(new Application()))\n{\n    try\n    {\n        using (AutoReleaseComObject&lt;Workbook&gt; workbookWrapper = new AutoReleaseComObject&lt;Workbook&gt;(excelApplicationWrapper.ComObject.Workbooks.Open(namedRangeBase.FullName, false, false, missing, missing, missing, true, missing, missing, true, missing, missing, missing, missing, missing)))\n        {\n           // do something with your workbook....\n        }\n    }\n    finally\n    {\n         excelApplicationWrapper.ComObject.Quit();\n    } \n}\n\n\nTemplate:\n\npublic class AutoReleaseComObject&lt;T&gt; : IDisposable\n{\n    private T m_comObject;\n    private bool m_armed = true;\n    private bool m_disposed = false;\n\n    public AutoReleaseComObject(T comObject)\n    {\n        Debug.Assert(comObject != null);\n        m_comObject = comObject;\n    }\n\n#if DEBUG\n    ~AutoReleaseComObject()\n    {\n        // We should have been disposed using Dispose().\n        Debug.WriteLine(&quot;Finalize being called, should have been disposed&quot;);\n\n        if (this.ComObject != null)\n        {\n            Debug.WriteLine(string.Format(&quot;ComObject was not null:{0}, name:{1}.&quot;, this.ComObject, this.ComObjectName));\n        }\n\n        //Debug.Assert(false);\n    }\n#endif\n\n    public T ComObject\n    {\n        get\n        {\n            Debug.Assert(!m_disposed);\n            return m_comObject;\n        }\n    }\n\n    private string ComObjectName\n    {\n        get\n        {\n            if(this.ComObject is Microsoft.Office.Interop.Excel.Workbook)\n            {\n                return ((Microsoft.Office.Interop.Excel.Workbook)this.ComObject).Name;\n            }\n\n            return null;\n        }\n    }\n\n    public void Disarm()\n    {\n        Debug.Assert(!m_disposed);\n        m_armed = false;\n    }\n\n    #region IDisposable Members\n\n    public void Dispose()\n    {\n        Dispose(true);\n#if DEBUG\n        GC.SuppressFinalize(this);\n#endif\n    }\n\n    #endregion\n\n    protected virtual void Dispose(bool disposing)\n    {\n        if (!m_disposed)\n        {\n            if (m_armed)\n            {\n                int refcnt = 0;\n                do\n                {\n                    refcnt = System.Runtime.InteropServices.Marshal.ReleaseComObject(m_comObject);\n                } while (refcnt &gt; 0);\n\n                m_comObject = default(T);\n            }\n\n            m_disposed = true;\n        }\n    }\n}\n\n\nReference:\n\nhttp://www.deez.info/sengelha/2005/02/11/useful-idisposable-class-3-autoreleasecomobject/\n    ","url":"/questions/[slug]#solution8","@type":"Answer","upvoteCount":0},{"text":"I cant believe this problem has haunted the world for 5 years.... If you have created an application, you need to shut it down first before removing the link.\n\nobjExcel = new Excel.Application();  \nobjBook = (Excel.Workbook)(objExcel.Workbooks.Add(Type.Missing)); \n\n\nwhen closing\n\nobjBook.Close(true, Type.Missing, Type.Missing); \nobjExcel.Application.Quit();\nobjExcel.Quit(); \n\n\nWhen you new an excel application, it opens a excel program in the background. You need to command that excel program to quit before you release the link because that excel program is not part of your direct control. Therefore, it will stay open if the link is released!\n\nGood programming everyone~~\n    ","url":"/questions/[slug]#solution9","@type":"Answer","upvoteCount":0},{"text":"Common developers, none of your solutions worked for me, \nso I decide to implement a new trick.\n\nFirst let specify &quot;What is our goal?&quot; =&gt; &quot;Not to see excel object after our job in task manager&quot; \n\nOk. Let no to challenge and start destroying it, but consider not to destroy other instance os Excel which are running in parallel.\n\nSo , get the list of current processors and fetch PID of EXCEL processes , then once your job is done, we have a new guest in processes list with a unique PID ,find and destroy just that one.\n\n&lt; keep in mind any new excel process during your excel job will be detected as new and destroyed &gt;\n &lt; A better solution is to capture PID of new created excel object and just destroy that&gt;\n\nProcess[] prs = Process.GetProcesses();\nList&lt;int&gt; excelPID = new List&lt;int&gt;();\nforeach (Process p in prs)\n   if (p.ProcessName == &quot;EXCEL&quot;)\n       excelPID.Add(p.Id);\n\n.... // your job \n\nprs = Process.GetProcesses();\nforeach (Process p in prs)\n   if (p.ProcessName == &quot;EXCEL&quot; &amp;&amp; !excelPID.Contains(p.Id))\n       p.Kill();\n\n\nThis resolves my issue, hope yours too.\n    ","url":"/questions/[slug]#solution10","@type":"Answer","upvoteCount":0},{"text":"This sure seems like it has been over-complicated. From my experience, there are just three key things to get Excel to close properly:\n\n1: make sure there are no remaining references to the excel application you created (you should only have one anyway; set it to null)\n\n2: call GC.Collect()\n\n3: Excel has to be closed, either by the user manually closing the program, or by you calling Quit on the Excel object. (Note that Quit will function just as if the user tried to close the program, and will present a confirmation dialog if there are unsaved changes, even if Excel is not visible. The user could press cancel, and then Excel will not have been closed.)\n\n1 needs to happen before 2, but 3 can happen anytime.\n\nOne way to implement this is to wrap the interop Excel object with your own class, create the interop instance in the constructor, and implement IDisposable with Dispose looking something like\n\nif (!mDisposed) {\n   mExcel = null;\n   GC.Collect();\n   mDisposed = true;\n}\n\n\nThat will clean up excel from your program&apos;s side of things. Once Excel is closed (manually by the user or by you calling Quit) the process will go away. If the program has already been closed, then the process will disappear on the GC.Collect() call.\n\n(I&apos;m not sure how important it is, but you may want a GC.WaitForPendingFinalizers() call after the GC.Collect() call but it is not strictly necessary to get rid of the Excel process.)\n\nThis has worked for me without issue for years. Keep in mind though that while this works, you actually have to close gracefully for it to work. You will still get accumulating excel.exe processes if you interrupt your program before Excel is cleaned up (usually by hitting &quot;stop&quot; while your program is being debugged).\n    ","url":"/questions/[slug]#solution11","@type":"Answer","upvoteCount":0},{"text":"I&apos;ve traditionally followed the advice found in VVS&apos;s answer.  However, in an effort to keep this answer up-to-date with the latest options, I think all my future projects will use the &quot;NetOffice&quot; library.\n\nNetOffice is a complete replacement for the Office PIAs and is completely version-agnostic. It&apos;s a collection of Managed COM wrappers that can handle the cleanup that often causes such headaches when working with Microsoft Office in .NET.\n\nSome key features are:\n\n\nMostly version-independent (and version-dependant features are documented)\nNo dependencies\nNo PIA\nNo registration\nNo VSTO\n\n\nI am in no way affiliated with the project; I just genuinely appreciate the stark reduction in headaches.\n    ","url":"/questions/[slug]#solution12","@type":"Answer","upvoteCount":0},{"text":"To add to reasons why Excel does not close, even when you create direct refrences to each object upon read, creation, is the &apos;For&apos; loop.\n\nFor Each objWorkBook As WorkBook in objWorkBooks &apos;local ref, created from ExcelApp.WorkBooks to avoid the double-dot\n   objWorkBook.Close &apos;or whatever\n   FinalReleaseComObject(objWorkBook)\n   objWorkBook = Nothing\nNext \n\n&apos;The above does not work, and this is the workaround:\n\nFor intCounter As Integer = 1 To mobjExcel_WorkBooks.Count\n   Dim objTempWorkBook As Workbook = mobjExcel_WorkBooks.Item(intCounter)\n   objTempWorkBook.Saved = True\n   objTempWorkBook.Close(False, Type.Missing, Type.Missing)\n   FinalReleaseComObject(objTempWorkBook)\n   objTempWorkBook = Nothing\nNext\n\n    ","url":"/questions/[slug]#solution13","@type":"Answer","upvoteCount":0},{"text":"The accepted answer here is correct, but also take note that not only &quot;two dot&quot; references need to be avoided, but also objects that are retrieved via the index.  You also do not need to wait until you are finished with the program to clean up these objects, it&apos;s best to create functions that will clean them up as soon as you&apos;re finished with them, when possible.  Here is a function I created that assigns some properties of a Style object called xlStyleHeader:\n\npublic Excel.Style xlStyleHeader = null;\n\nprivate void CreateHeaderStyle()\n{\n    Excel.Styles xlStyles = null;\n    Excel.Font xlFont = null;\n    Excel.Interior xlInterior = null;\n    Excel.Borders xlBorders = null;\n    Excel.Border xlBorderBottom = null;\n\n    try\n    {\n        xlStyles = xlWorkbook.Styles;\n        xlStyleHeader = xlStyles.Add(&quot;Header&quot;, Type.Missing);\n\n        // Text Format\n        xlStyleHeader.NumberFormat = &quot;@&quot;;\n\n        // Bold\n        xlFont = xlStyleHeader.Font;\n        xlFont.Bold = true;\n\n        // Light Gray Cell Color\n        xlInterior = xlStyleHeader.Interior;\n        xlInterior.Color = 12632256;\n\n        // Medium Bottom border\n        xlBorders = xlStyleHeader.Borders;\n        xlBorderBottom = xlBorders[Excel.XlBordersIndex.xlEdgeBottom];\n        xlBorderBottom.Weight = Excel.XlBorderWeight.xlMedium;\n    }\n    catch (Exception ex)\n    {\n        throw ex;\n    }\n    finally\n    {\n        Release(xlBorderBottom);\n        Release(xlBorders);\n        Release(xlInterior);\n        Release(xlFont);\n        Release(xlStyles);\n    }\n}\n\nprivate void Release(object obj)\n{\n    // Errors are ignored per Microsoft&apos;s suggestion for this type of function:\n    // http://support.microsoft.com/default.aspx/kb/317109\n    try\n    {\n        System.Runtime.InteropServices.Marshal.ReleaseComObject(obj);\n    }\n    catch { } \n}\n\n\nNotice that I had to set xlBorders[Excel.XlBordersIndex.xlEdgeBottom] to a variable in order to clean that up (Not because of the two dots, which refer to an enumeration which does not need to be released, but because the object I&apos;m referring to is actually a Border object that does need to be released).\n\nThis sort of thing is not really necessary in standard applications, which do a great job of cleaning up after themselves, but in ASP.NET applications, if you miss even one of these, no matter how often you call the garbage collector, Excel will still be running on your server.  \n\nIt requires a lot of attention to detail and many test executions while monitoring the Task Manager when writing this code, but doing so saves you the hassle of desperately searching through pages of code to find the one instance you missed.  This is especially important when working in loops, where you need to release EACH INSTANCE of an object, even though it uses the same variable name each time it loops.\n    ","url":"/questions/[slug]#solution14","@type":"Answer","upvoteCount":0},{"text":"After trying\n\n\nRelease COM objects in reverse order\nAdd GC.Collect() and GC.WaitForPendingFinalizers() twice at the end\nNo more than two dots\nClose workbook and quit application\nRun in release mode\n\n\nthe final solution that works for me is to move one set of\n\nGC.Collect();\nGC.WaitForPendingFinalizers();\n\n\nthat we added to the end of the function to a wrapper, as follows:\n\nprivate void FunctionWrapper(string sourcePath, string targetPath)\n{\n    try\n    {\n        FunctionThatCallsExcel(sourcePath, targetPath);\n    }\n    finally\n    {\n        GC.Collect();\n        GC.WaitForPendingFinalizers();\n    }\n}\n\n    ","url":"/questions/[slug]#solution15","@type":"Answer","upvoteCount":0},{"text":"I followed this exactly... But I still ran into issues 1 out of 1000 times. Who knows why. Time to bring out the hammer...\n\nRight after the Excel Application class is instantiated I get a hold of the Excel process that was just created.\n\nexcel = new Microsoft.Office.Interop.Excel.Application();\nvar process = Process.GetProcessesByName(&quot;EXCEL&quot;).OrderByDescending(p =&gt; p.StartTime).First();\n\n\nThen once I&apos;ve done all the above COM clean-up, I make sure that process isn&apos;t running. If it is still running, kill it!\n\nif (!process.HasExited)\n   process.Kill();\n\n    ","url":"/questions/[slug]#solution16","@type":"Answer","upvoteCount":0},{"text":"¨°º¤ø¸ Shoot Excel proc and chew bubble gum ¸ø¤º°¨\n\npublic class MyExcelInteropClass\n{\n    Excel.Application xlApp;\n    Excel.Workbook xlBook;\n\n    public void dothingswithExcel() \n    {\n        try { /* Do stuff manipulating cells sheets and workbooks ... */ }\n        catch {}\n        finally {KillExcelProcess(xlApp);}\n    }\n\n    static void KillExcelProcess(Excel.Application xlApp)\n    {\n        if (xlApp != null)\n        {\n            int excelProcessId = 0;\n            GetWindowThreadProcessId(xlApp.Hwnd, out excelProcessId);\n            Process p = Process.GetProcessById(excelProcessId);\n            p.Kill();\n            xlApp = null;\n        }\n    }\n\n    [DllImport(&quot;user32.dll&quot;)]\n    static extern int GetWindowThreadProcessId(int hWnd, out int lpdwProcessId);\n}\n\n    ","url":"/questions/[slug]#solution17","@type":"Answer","upvoteCount":0},{"text":"You need to be aware that Excel is very sensitive to the culture you are running under as well.\n\nYou may find that you need to set the culture to EN-US before calling Excel functions.\nThis does not apply to all functions - but some of them.\n\n    CultureInfo en_US = new System.Globalization.CultureInfo(&quot;en-US&quot;); \n    System.Threading.Thread.CurrentThread.CurrentCulture = en_US;\n    string filePathLocal = _applicationObject.ActiveWorkbook.Path;\n    System.Threading.Thread.CurrentThread.CurrentCulture = orgCulture;\n\n\nThis applies even if you are using VSTO.\n\nFor details: http://support.microsoft.com/default.aspx?scid=kb;en-us;Q320369\n    ","url":"/questions/[slug]#solution18","@type":"Answer","upvoteCount":0},{"text":"&quot;Never use two dots with COM objects&quot; is a great rule of thumb to avoid leakage of COM references, but Excel PIA can lead to leakage in more ways than apparent at first sight.\nOne of these ways is subscribing to any event exposed by any of the Excel object model&apos;s COM objects.\nFor example, subscribing to the Application class&apos;s WorkbookOpen event.\nSome theory on COM events\nCOM classes expose a group of events through call-back interfaces. In order to subscribe to events, the client code can simply register an object implementing the call-back interface and the COM class will invoke its methods in response to specific events. Since the call-back interface is a COM interface, it is the duty of the implementing object to decrement the reference count of any COM object it receives (as a parameter) for any of the event handlers.\nHow Excel PIA expose COM Events\nExcel PIA exposes COM events of Excel Application class as conventional .NET events. Whenever the client code subscribes to a .NET event (emphasis on &apos;a&apos;), PIA creates an instance of a class implementing the call-back interface and registers it with Excel.\nHence, a number of call-back objects get registered with Excel in response to different subscription requests from the .NET code. One call-back object per event subscription.\nA call-back interface for event handling means that, PIA has to subscribe to all interface events for every .NET event subscription request. It cannot pick and choose. On receiving an event call-back, the call-back object checks if the associated .NET event handler is interested in the current event or not and then either invokes the handler or silently ignores the call-back.\nEffect on COM instance reference counts\nAll these call-back objects do not decrement the reference count of any of the COM objects they receive (as parameters) for any of the call-back methods (even for the ones that are silently ignored). They rely solely on the CLR garbage collector to free up the COM objects.\nSince GC run is non-deterministic, this can lead to the holding off of Excel process for a longer duration than desired and create an impression of a &apos;memory leak&apos;.\nSolution\nThe only solution as of now is to avoid the PIAs event provider for the COM class and write your own event provider which deterministically releases COM objects.\nFor the Application class, this can be done by implementing the AppEvents interface and then registering the implementation with Excel by using IConnectionPointContainer interface. The Application class (and for that matter all COM objects exposing events using callback mechanism) implements the IConnectionPointContainer interface.\n    ","url":"/questions/[slug]#solution19","@type":"Answer","upvoteCount":0},{"text":"As others have pointed out, you need to create an explicit reference for every Excel object you use, and call Marshal.ReleaseComObject on that reference, as described in this KB article.  You also need to use try/finally to ensure ReleaseComObject is always called, even when an exception is thrown.  I.e. instead of:\n\nWorksheet sheet = excelApp.Worksheets(1)\n... do something with sheet\n\n\nyou need to do something like:\n\nWorksheets sheets = null;\nWorksheet sheet = null\ntry\n{ \n    sheets = excelApp.Worksheets;\n    sheet = sheets(1);\n    ...\n}\nfinally\n{\n    if (sheets != null) Marshal.ReleaseComObject(sheets);\n    if (sheet != null) Marshal.ReleaseComObject(sheet);\n}\n\n\nYou also need to call Application.Quit before releasing the Application object if you want Excel to close.\n\nAs you can see, this quickly becomes extremely unwieldy as soon as you try to do anything even moderately complex.  I have successfully developed .NET applications with a simple wrapper class that wraps a few simple manipulations of the Excel object model (open a workbook, write to a Range, save/close the workbook etc).  The wrapper class implements IDisposable, carefully implements Marshal.ReleaseComObject on every object it uses, and does not pubicly expose any Excel objects to the rest of the app.\n\nBut this approach doesn&apos;t scale well for more complex requirements.  \n\nThis is a big deficiency of .NET COM Interop.  For more complex scenarios, I would seriously consider writing an ActiveX DLL in VB6 or other unmanaged language to which you can delegate all interaction with out-proc COM objects such as Office.  You can then reference this ActiveX DLL from your .NET application, and things will be much easier as you will only need to release this one reference.\n    ","url":"/questions/[slug]#solution20","@type":"Answer","upvoteCount":0},{"text":"When all the stuff above didn&apos;t work, try giving Excel some time to close its sheets:\n\napp.workbooks.Close();\nThread.Sleep(500); // adjust, for me it works at around 300+\napp.Quit();\n\n...\nFinalReleaseComObject(app);\n\n    ","url":"/questions/[slug]#solution21","@type":"Answer","upvoteCount":0},{"text":"Make sure that you release all objects related to Excel!\n\nI spent a few hours by trying several ways. All are great ideas but I finally found my mistake: If you don&apos;t release all objects, none of the ways above can help you like in my case. Make sure you release all objects including range one!\n\nExcel.Range rng = (Excel.Range)worksheet.Cells[1, 1];\nworksheet.Paste(rng, false);\nreleaseObject(rng);\n\n\nThe options are together here.\n    ","url":"/questions/[slug]#solution22","@type":"Answer","upvoteCount":0},{"text":"A great article on releasing COM objects is 2.5 Releasing COM Objects (MSDN).\n\nThe method that I would advocate is to null your Excel.Interop references if they are non-local variables, and then call GC.Collect() and GC.WaitForPendingFinalizers() twice. Locally scoped Interop variables will be taken care of automatically.\n\nThis removes the need to keep a named reference for every COM object.\n\nHere&apos;s an example taken from the article:\n\npublic class Test {\n\n    // These instance variables must be nulled or Excel will not quit\n    private Excel.Application xl;\n    private Excel.Workbook book;\n\n    public void DoSomething()\n    {\n        xl = new Excel.Application();\n        xl.Visible = true;\n        book = xl.Workbooks.Add(Type.Missing);\n\n        // These variables are locally scoped, so we need not worry about them.\n        // Notice I don&apos;t care about using two dots.\n        Excel.Range rng = book.Worksheets[1].UsedRange;\n    }\n\n    public void CleanUp()\n    {\n        book = null;\n        xl.Quit();\n        xl = null;\n\n        GC.Collect();\n        GC.WaitForPendingFinalizers();\n        GC.Collect();\n        GC.WaitForPendingFinalizers();\n    }\n}\n\n\nThese words are straight from the article:\n\n\n  In almost all situations, nulling the RCW reference and forcing a garbage collection will clean up properly. If you also call GC.WaitForPendingFinalizers, garbage collection will be as deterministic as you can make it. That is, you&apos;ll be pretty sure exactly when the object has been cleaned upon the return from the second call to WaitForPendingFinalizers. As an alternative, you can use Marshal.ReleaseComObject. However, note that you are very unlikely to ever need to use this method.\n\n    ","url":"/questions/[slug]#solution23","@type":"Answer","upvoteCount":0},{"text":"The two dots rule did not work for me. In my case I created a method to clean my resources as follows:\n\nprivate static void Clean()\n{\n    workBook.Close();\n    Marshall.ReleaseComObject(workBook);\n    excel.Quit();\n    CG.Collect();\n    CG.WaitForPendingFinalizers();\n}\n\n    ","url":"/questions/[slug]#solution24","@type":"Answer","upvoteCount":0},{"text":"My solution\n\n[DllImport(&quot;user32.dll&quot;)]\nstatic extern int GetWindowThreadProcessId(int hWnd, out int lpdwProcessId);\n\nprivate void GenerateExcel()\n{\n    var excel = new Microsoft.Office.Interop.Excel.Application();\n    int id;\n    // Find the Excel Process Id (ath the end, you kill him\n    GetWindowThreadProcessId(excel.Hwnd, out id);\n    Process excelProcess = Process.GetProcessById(id);\n\ntry\n{\n    // Your code\n}\nfinally\n{\n    excel.Quit();\n\n    // Kill him !\n    excelProcess.Kill();\n}\n\n    ","url":"/questions/[slug]#solution25","@type":"Answer","upvoteCount":0},{"text":"You should be very careful using Word/Excel interop applications. After trying all the solutions we still had a lot of &quot;WinWord&quot; process left open on server (with more than 2000 users).\n\nAfter working on the problem for hours, I realized that if I open more than a couple of documents using Word.ApplicationClass.Document.Open() on different threads simultaneously, IIS worker process (w3wp.exe) would crash leaving all WinWord processes open!\n\nSo I guess there is no absolute solution to this problem, but switching to other methods such as Office Open XML development.\n    ","url":"/questions/[slug]#solution26","@type":"Answer","upvoteCount":0},{"text":"The accepted answer did not work for me. The following code in the destructor did the job.\n\nif (xlApp != null)\n{\n    xlApp.Workbooks.Close();\n    xlApp.Quit();\n}\n\nSystem.Diagnostics.Process[] processArray = System.Diagnostics.Process.GetProcessesByName(&quot;EXCEL&quot;);\nforeach (System.Diagnostics.Process process in processArray)\n{\n    if (process.MainWindowTitle.Length == 0) { process.Kill(); }\n}\n\n    ","url":"/questions/[slug]#solution27","@type":"Answer","upvoteCount":0},{"text":"I am currently working on Office automation and have stumbled across a solution for this that works every time for me. It is simple and does not involve killing any processes.\n\nIt seems that by merely looping through the current active processes, and in any way &apos;accessing&apos; an open Excel process, any stray hanging instance of Excel will be removed. The below code simply checks for processes where the name is &apos;Excel&apos;, then writes the MainWindowTitle property of the process to a string. This &apos;interaction&apos; with the process seems to make Windows catch up and abort the frozen instance of Excel. \n\nI run the below method just before the add-in which I am developing quits, as it fires it unloading event. It removes any hanging instances of Excel every time. In all honesty I am not entirely sure why this works, but it works well for me and could be placed at the end of any Excel application without having to worry about double dots, Marshal.ReleaseComObject, nor killing processes. I would be very interested in any suggestions as to why this is effective.\n\npublic static void SweepExcelProcesses()\n{           \n            if (Process.GetProcessesByName(&quot;EXCEL&quot;).Length != 0)\n            {\n                Process[] processes = Process.GetProcesses();\n                foreach (Process process in processes)\n                {\n                    if (process.ProcessName.ToString() == &quot;excel&quot;)\n                    {                           \n                        string title = process.MainWindowTitle;\n                    }\n                }\n            }\n}\n\n    ","url":"/questions/[slug]#solution28","@type":"Answer","upvoteCount":0},{"text":"I think that some of that is just the way that the framework handles Office applications, but I could be wrong. On some days, some applications clean up the processes immediately, and other days it seems to wait until the application closes. In general, I quit paying attention to the details and just make sure that there aren&apos;t any extra processes floating around at the end of the day.\n\nAlso, and maybe I&apos;m over simplifying things, but I think you can just...\n\nobjExcel = new Excel.Application();\nobjBook = (Excel.Workbook)(objExcel.Workbooks.Add(Type.Missing));\nDoSomeStuff(objBook);\nSaveTheBook(objBook);\nobjBook.Close(false, Type.Missing, Type.Missing);\nobjExcel.Quit();\n\n\nLike I said earlier, I don&apos;t tend to pay attention to the details of when the Excel process appears or disappears, but that usually works for me.  I also don&apos;t like to keep Excel processes around for anything other than the minimal amount of time, but I&apos;m probably just being paranoid on that.\n    ","url":"/questions/[slug]#solution29","@type":"Answer","upvoteCount":0},{"text":"As some have probably already written, it&apos;s not just important how you close the Excel (object); it&apos;s also important how you open it and also by the type of the project.\n\nIn a WPF application, basically the same code is working without or with very few problems.\n\nI have a project in which the same Excel file is being processed several times for different parameter value - e.g. parsing it based on values inside a generic list. \n\nI put all Excel-related functions into the base class, and parser into a subclass (different parsers use common Excel functions). I didn&apos;t want that Excel is opened and closed again for each item in a generic list, so I&apos;ve opened it only once in the base class and close it in the subclass. I had problems when moving the code into a desktop application. I&apos;ve tried many of the above mentioned solutions. GC.Collect() was already implemented before, twice as suggested.\n\nThen I&apos;ve decided that I will move the code for opening Excel to a subclass. Instead of opening only once, now I create a new object (base class) and open Excel for every item and close it at the end. There is some performance penalty, but based on several tests Excel processes are closing without problems (in debug mode), so also temporary files are removed. I will continue with testing and write some more if I will get some updates.\n\nThe bottom line is: You must also check the initialize code, especially if you have many classes, etc.\n    ","url":"/questions/[slug]#solution30","@type":"Answer","upvoteCount":0}],"@type":"Question"}}</script><meta name="next-head-count" content="22"/><link rel="preload" href="/_next/static/css/c116652e2d6f4ad0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c116652e2d6f4ad0.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-42cdea76c8170223.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-ccfab947c79712f4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c0d2dcb5e85faf18.js" defer=""></script><script src="/_next/static/chunks/294-106ef8570fa99deb.js" defer=""></script><script src="/_next/static/chunks/490-7f0418bb4354ac73.js" defer=""></script><script src="/_next/static/chunks/pages/questions/%5Bslug%5D-50e201fdaa1e0fd1.js" defer=""></script><script src="/_next/static/DSpI0pSdXueTMCIVyw0q4/_buildManifest.js" defer=""></script><script src="/_next/static/DSpI0pSdXueTMCIVyw0q4/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="wrapper"><header><nav class="bg-white border-gray-200 px-4 lg:px-6 py-2.5 dark:bg-gray-800"><div class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl"><a class="flex items-center" href="/"><img src="/logo-second.png" class="mr-3 h-6 sm:h-9" alt="Solution Checker Logo"/><h1 class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">Solution Checker</h1></a><div class="flex items-center lg:order-2"><button data-collapse-toggle="mobile-menu-2" type="button" class="inline-flex items-center p-2 ml-1 text-sm text-gray-500 rounded-lg lg:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="mobile-menu-2" aria-expanded="false"><span class="sr-only">Open main menu</span><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg><svg class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><div class="hidden justify-between items-center w-full lg:flex lg:w-auto lg:order-1" id="mobile-menu-2"><ul class="flex flex-col mt-4 font-medium lg:flex-row lg:space-x-8 lg:mt-0"><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" aria-current="page" href="/">Home</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions?tab=news">Questions</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/post?tab=news">Post</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions/how-do-i-properly-clean-up-excel-interop-objects-1657388329706#">Coding</a></li></ul></div></div></nav></header><div class="main-content"><div class="question my-5"><div class="flex question-header items-center m-auto justify-center"><div class="rounded-xl w-full border p-5 shadow-md bg-white"><div class="flex w-full items-center justify-between border-b pb-3"><div class="flex items-center space-x-3"><div class="text-lg font-bold text-slate-700"><a href="/questions/how-do-i-properly-clean-up-excel-interop-objects-1657388329706"><h1>How do I properly clean up Excel interop objects?</h1></a></div></div><div class="flex flex-wrap h-auto justify-end items-center space-x-8"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold" href="/questions/tag/com-interop">com-interop</a></div></div><div class="question-content mt-5">
                
<p>I'm using the Excel interop in C# (<code>ApplicationClass</code>) and have placed the following code in my finally clause:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">while</span> (System.Runtime.InteropServices.Marshal.ReleaseComObject(excelSheet) != <span class="hljs-number">0</span>) { }
excelSheet = <span class="hljs-literal">null</span>;
GC.Collect();
GC.WaitForPendingFinalizers();
</code></pre>

<p>Although this kind of works, the <code>Excel.exe</code> process is still in the background even after I close Excel. It is only released once my application is manually closed.</p>

<p>What am I doing wrong, or is there an alternative to ensure interop objects are properly disposed of?</p>
    </div></div></div><div class="solution-section"><nav class="flex pagination-solution flex-col justify-end"><h1 class="text-lg font-semibold mb-5">Navigate to solutions: </h1><ul class="inline-flex -space-x-px overflow-auto"><li class="pagination-solution-item"><span data-id="#solution1" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">1</span></li><li class="pagination-solution-item"><span data-id="#solution2" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">2</span></li><li class="pagination-solution-item"><span data-id="#solution3" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">3</span></li><li class="pagination-solution-item"><span data-id="#solution4" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">4</span></li><li class="pagination-solution-item"><span data-id="#solution5" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">5</span></li><li class="pagination-solution-item"><span data-id="#solution6" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">6</span></li><li class="pagination-solution-item"><span data-id="#solution7" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">7</span></li><li class="pagination-solution-item"><span data-id="#solution8" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">8</span></li><li class="pagination-solution-item"><span data-id="#solution9" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">9</span></li><li class="pagination-solution-item"><span data-id="#solution10" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">10</span></li><li class="pagination-solution-item"><span data-id="#solution11" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">11</span></li><li class="pagination-solution-item"><span data-id="#solution12" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">12</span></li><li class="pagination-solution-item"><span data-id="#solution13" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">13</span></li><li class="pagination-solution-item"><span data-id="#solution14" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">14</span></li><li class="pagination-solution-item"><span data-id="#solution15" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">15</span></li><li class="pagination-solution-item"><span data-id="#solution16" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">16</span></li><li class="pagination-solution-item"><span data-id="#solution17" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">17</span></li><li class="pagination-solution-item"><span data-id="#solution18" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">18</span></li><li class="pagination-solution-item"><span data-id="#solution19" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">19</span></li><li class="pagination-solution-item"><span data-id="#solution20" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">20</span></li><li class="pagination-solution-item"><span data-id="#solution21" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">21</span></li><li class="pagination-solution-item"><span data-id="#solution22" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">22</span></li><li class="pagination-solution-item"><span data-id="#solution23" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">23</span></li><li class="pagination-solution-item"><span data-id="#solution24" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">24</span></li><li class="pagination-solution-item"><span data-id="#solution25" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">25</span></li><li class="pagination-solution-item"><span data-id="#solution26" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">26</span></li><li class="pagination-solution-item"><span data-id="#solution27" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">27</span></li><li class="pagination-solution-item"><span data-id="#solution28" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">28</span></li><li class="pagination-solution-item"><span data-id="#solution29" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">29</span></li><li class="pagination-solution-item"><span data-id="#solution30" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">30</span></li></ul></nav><div id="solution1" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 1</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Excel does not quit because your application is still holding references to COM objects.</p>

<p><strong>I guess you're invoking at least one member of a COM object without assigning it to a variable.</strong></p>

<p>For me it was the <em>excelApp.Worksheets</em> object which I directly used without assigning it to a variable:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">Worksheet sheet = excelApp.Worksheets.Open(...);
...
Marshal.ReleaseComObject(sheet);
</code></pre>

<p>I didn't know that internally C# created a wrapper for the <strong>Worksheets</strong> COM object which didn't get released by my code (because I wasn't aware of it) and was the cause why Excel was not unloaded.</p>

<p>I found the solution to my problem on <a href="http://www.velocityreviews.com/forums/showpost.php?s=f87f0674feda4442dcbd40019cbca65b&amp;p=528575&amp;postcount=2" rel="noreferrer">this page</a>, which also has a nice rule for the usage of COM objects in C#:</p>

<blockquote>
  <p>Never use two dots with COM objects.</p>
</blockquote>

<hr>

<p>So with this knowledge the right way of doing the above is:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">Worksheets sheets = excelApp.Worksheets; <span class="hljs-comment">// &lt;-- The important part</span>
Worksheet sheet = sheets.Open(...);
...
Marshal.ReleaseComObject(sheets);
Marshal.ReleaseComObject(sheet);
</code></pre>

<p><strong>POST MORTEM UPDATE:</strong></p>

<p>I want every reader to read this answer by Hans Passant very carefully as it explains the trap I and lots of other developers stumbled into. When I wrote this answer years ago I didn't know about the effect the debugger has to the garbage collector and drew the wrong conclusions. I keep my answer unaltered for the sake of history but please read this link and <strong>don't</strong> go the way of "the two dots": <a href="https://stackoverflow.com/questions/17130382/understanding-garbage-collection-in-net/17131389#17131389">Understanding garbage collection in .NET</a> and <a href="https://stackoverflow.com/questions/25134024/clean-up-excel-interop-objects-with-idisposable/25135685#25135685">Clean up Excel Interop Objects with IDisposable</a></p>
    </div></div></div></div><div id="solution2" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 2</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>You can actually release your Excel Application object cleanly, but you do have to take care. </p>

<p>The advice to maintain a named reference for absolutely every COM object you access and then explicitly release it via <code>Marshal.FinalReleaseComObject()</code> is correct in theory, but, unfortunately, very difficult to manage in practice. If one ever slips anywhere and uses "two dots", or iterates cells via a <code>for each</code> loop, or any other similar kind of command, then you'll have unreferenced COM objects and risk a hang. In this case, there would be no way to find the cause in the code; you would have to review all your code by eye and hopefully find the cause, a task that could be nearly impossible for a large project.</p>

<p>The good news is that you do not actually have to maintain a named variable reference to every COM object you use. Instead, call <code>GC.Collect()</code> and then <code>GC.WaitForPendingFinalizers()</code> to release all the (usually minor) objects to which you do not hold a reference, and then explicitly release the objects to which you do hold a named variable reference. </p>

<p>You should also release your named references in reverse order of importance: range objects first, then worksheets, workbooks, and then finally your Excel Application object.</p>

<p>For example, assuming that you had a Range object variable named <code>xlRng</code>, a Worksheet variable named <code>xlSheet</code>, a Workbook variable named <code>xlBook</code> and an Excel Application variable named <code>xlApp</code>, then your cleanup code could look something like the following:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-comment">// Cleanup</span>
GC.Collect();
GC.WaitForPendingFinalizers();

Marshal.FinalReleaseComObject(xlRng);
Marshal.FinalReleaseComObject(xlSheet);

xlBook.Close(Type.Missing, Type.Missing, Type.Missing);
Marshal.FinalReleaseComObject(xlBook);

xlApp.Quit();
Marshal.FinalReleaseComObject(xlApp);
</code></pre>

<p>In most code examples you'll see for cleaning up COM objects from .NET, the <code>GC.Collect()</code> and <code>GC.WaitForPendingFinalizers()</code> calls are made TWICE as in:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">GC.Collect();
GC.WaitForPendingFinalizers();
GC.Collect();
GC.WaitForPendingFinalizers();
</code></pre>

<p>This should not be required, however, unless you are using Visual Studio Tools for Office (VSTO), which uses finalizers that cause an entire graph of objects to be promoted in the finalization queue. Such objects would not be released until the <em>next</em> garbage collection. However, if you are not using VSTO, you should be able to call <code>GC.Collect()</code> and <code>GC.WaitForPendingFinalizers()</code> just once.</p>

<p>I know that explicitly calling <code>GC.Collect()</code> is a no-no (and certainly doing it twice sounds very painful), but there is no way around it, to be honest. Through normal operations you will generate hidden objects to which you hold no reference that you, therefore, cannot release through any other means other than calling <code>GC.Collect()</code>.</p>

<p>This is a complex topic, but this really is all there is to it. Once you establish this template for your cleanup procedure you can code normally, without the need for wrappers, etc. :-)</p>

<p>I have a tutorial on this here:</p>

<p><a href="http://www.xtremevbtalk.com/showthread.php?t=160433" rel="noreferrer">Automating Office Programs with VB.Net / COM Interop</a></p>

<p>It's written for VB.NET, but don't be put off by that, the principles are exactly the same as when using C#.</p>
    </div></div></div></div><div id="solution3" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 3</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p><strong>Preface: my answer contains two solutions, so be careful when reading and don't miss anything.</strong></p>

<p>There are different ways and advice of how to make Excel instance unload, such as:  </p>

<ul>
<li><p>Releasing EVERY com object explicitly
with Marshal.FinalReleaseComObject()
(not forgetting about implicitly
created com-objects). To release
every created com object, you may use
the rule of 2 dots mentioned here:<br>
<a href="https://stackoverflow.com/questions/158706/how-to-properly-clean-up-excel-interop-objects-in-c/158752#158752">How do I properly clean up Excel interop objects?</a></p></li>
<li><p>Calling GC.Collect() and
GC.WaitForPendingFinalizers() to make
CLR release unused com-objects * (Actually, it works, see my second solution for details)</p></li>
<li><p>Checking if com-server-application
maybe shows a message box waiting for
the user to answer (though I am not
sure it can prevent Excel from
closing, but I heard about it a few
times)</p></li>
<li><p>Sending WM_CLOSE message to the main
Excel window</p></li>
<li><p>Executing the function that works
with Excel in a separate AppDomain.
Some people believe Excel instance
will be shut, when AppDomain is
unloaded.</p></li>
<li><p>Killing all excel instances which were instantiated after our excel-interoping code started.</p></li>
</ul>

<p><strong>BUT!</strong> Sometimes all these options just don't help or can't be appropriate!</p>

<p>For example, yesterday I found out that in one of my functions (which works with excel) Excel keeps running after the function ends. I tried everything! I thoroughly checked the whole function 10 times and added Marshal.FinalReleaseComObject() for everything! I also had GC.Collect() and GC.WaitForPendingFinalizers(). I checked for hidden message boxes. I tried to send WM_CLOSE message to the main Excel window. I executed my function in a separate AppDomain and unloaded that domain. Nothing helped! The option with closing all excel instances is inappropriate, because if the user starts another Excel instance manually, during execution of my function which works also with Excel, then that instance will also be closed by my function. I bet the user will not be happy! So, honestly, this is a lame option (no offence guys). So I spent a couple of hours before I found a good (in my humble opinion) <strong>solution</strong>: <strong>Kill excel process by hWnd of its main window</strong> (it's the first solution).</p>

<p>Here is the simple code:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">"user32.dll"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">uint</span> <span class="hljs-title">GetWindowThreadProcessId</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-keyword">out</span> <span class="hljs-built_in">uint</span> lpdwProcessId</span>)</span>;

<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span> Tries to find and kill process by hWnd to the main window of the process.<span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="hWnd"&gt;</span>Handle to the main window of the process.<span class="hljs-doctag">&lt;/param&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>True if process was found and killed. False if process was not found by hWnd or if it could not be killed.<span class="hljs-doctag">&lt;/returns&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryKillProcessByMainWindowHwnd</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> hWnd</span>)</span>
{
    <span class="hljs-built_in">uint</span> processID;
    GetWindowThreadProcessId((IntPtr)hWnd, <span class="hljs-keyword">out</span> processID);
    <span class="hljs-keyword">if</span>(processID == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span>
    {
        Process.GetProcessById((<span class="hljs-built_in">int</span>)processID).Kill();
    }
    <span class="hljs-keyword">catch</span> (ArgumentException)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">catch</span> (Win32Exception)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">catch</span> (NotSupportedException)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">catch</span> (InvalidOperationException)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span> Finds and kills process by hWnd to the main window of the process.<span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="hWnd"&gt;</span>Handle to the main window of the process.<span class="hljs-doctag">&lt;/param&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;exception cref="ArgumentException"&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> Thrown when process is not found by the hWnd parameter (the process is not running). </span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> The identifier of the process might be expired.</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/exception&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;exception cref="Win32Exception"&gt;</span>See Process.Kill() exceptions documentation.<span class="hljs-doctag">&lt;/exception&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;exception cref="NotSupportedException"&gt;</span>See Process.Kill() exceptions documentation.<span class="hljs-doctag">&lt;/exception&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;exception cref="InvalidOperationException"&gt;</span>See Process.Kill() exceptions documentation.<span class="hljs-doctag">&lt;/exception&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">KillProcessByMainWindowHwnd</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> hWnd</span>)</span>
{
    <span class="hljs-built_in">uint</span> processID;
    GetWindowThreadProcessId((IntPtr)hWnd, <span class="hljs-keyword">out</span> processID);
    <span class="hljs-keyword">if</span> (processID == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Process has not been found by the given main window handle."</span>, <span class="hljs-string">"hWnd"</span>);
    Process.GetProcessById((<span class="hljs-built_in">int</span>)processID).Kill();
}
</code></pre>

<p>As you can see I provided two methods, according to Try-Parse pattern (I think it is appropriate here): one method doesn't throw the exception if the Process could not be killed (for example the process doesn't exist anymore), and another method throws the exception if the Process was not killed. The only weak place in this code is security permissions. Theoretically, the user may not have permissions to kill the process, but in 99.99% of all cases, user has such permissions. I also tested it with a guest account - it works perfectly.</p>

<p>So, your code, working with Excel, can look like this:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-built_in">int</span> hWnd = xl.Application.Hwnd;
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// here we try to close Excel as usual, with xl.Quit(),</span>
<span class="hljs-comment">// Marshal.FinalReleaseComObject(xl) and so on</span>
<span class="hljs-comment">// ...</span>
TryKillProcessByMainWindowHwnd(hWnd);
</code></pre>

<p>Voila! Excel is terminated! :)</p>

<p>Ok, let's go back to the second solution, as I promised in the beginning of the post.
<strong>The second solution is to call GC.Collect() and GC.WaitForPendingFinalizers().</strong> Yes, they actually work, but you need to be careful here!<br>
Many people say (and I said) that calling GC.Collect() doesn't help. But the reason it wouldn't help is if there are still references to COM objects! One of the most popular reasons for GC.Collect() not being helpful is running the project in Debug-mode. In debug-mode objects that are not really referenced anymore will not be garbage collected until the end of the method.<br>
So, if you tried GC.Collect() and GC.WaitForPendingFinalizers() and it didn't help, try to do the following:  </p>

<p>1) Try to run your project in Release mode and check if Excel closed correctly  </p>

<p>2) Wrap the method of working with Excel in a separate method.
So, instead of something like this:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GenerateWorkbook</span>(<span class="hljs-params">...</span>)</span>
{
  ApplicationClass xl;
  Workbook xlWB;
  <span class="hljs-keyword">try</span>
  {
    xl = ...
    xlWB = xl.Workbooks.Add(...);
    ...
  }
  <span class="hljs-keyword">finally</span>
  {
    ...
    Marshal.ReleaseComObject(xlWB)
    ...
    GC.Collect();
    GC.WaitForPendingFinalizers();
  }
}
</code></pre>

<p>you write:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GenerateWorkbook</span>(<span class="hljs-params">...</span>)</span>
{
  <span class="hljs-keyword">try</span>
  {
    GenerateWorkbookInternal(...);
  }
  <span class="hljs-keyword">finally</span>
  {
    GC.Collect();
    GC.WaitForPendingFinalizers();
  }
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GenerateWorkbookInternal</span>(<span class="hljs-params">...</span>)</span>
{
  ApplicationClass xl;
  Workbook xlWB;
  <span class="hljs-keyword">try</span>
  {
    xl = ...
    xlWB = xl.Workbooks.Add(...);
    ...
  }
  <span class="hljs-keyword">finally</span>
  {
    ...
    Marshal.ReleaseComObject(xlWB)
    ...
  }
}
</code></pre>

<p>Now, Excel will close =)</p>
    </div></div></div></div><div id="solution4" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 4</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p><strong>UPDATE</strong>: Added C# code, and link to Windows Jobs</p>

<p>I spent sometime trying to figure out this problem, and at the time XtremeVBTalk was the most active and responsive.  Here is a link to my original post, <a href="http://www.xtremevbtalk.com/showpost.php?p=1335552&amp;postcount=22" rel="noreferrer">Closing an Excel Interop process cleanly, even if your application crashes</a>. Below is a summary of the post, and the code copied to this post. </p>

<ul>
<li>Closing the Interop process with <code>Application.Quit()</code> and <code>Process.Kill()</code> works for the most part, but fails if the applications crashes catastrophically. I.e. if the app crashes, the Excel process will still be running loose.</li>
<li>The solution is to let the OS handle the cleanup of your processes through <a href="http://msdn.microsoft.com/en-us/library/ms682409(VS.85).aspx" rel="noreferrer">Windows Job Objects</a> using Win32 calls.  When your main application dies, the associated processes (i.e. Excel) will get terminated as well.  </li>
</ul>

<p>I found this to be a clean solution because the OS is doing real work of cleaning up.  All you have to do is <em>register</em> the Excel process.</p>

<p><strong>Windows Job Code</strong></p>

<p>Wraps the Win32 API Calls to register Interop processes.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> JobObjectInfoType
{
    AssociateCompletionPortInformation = <span class="hljs-number">7</span>,
    BasicLimitInformation = <span class="hljs-number">2</span>,
    BasicUIRestrictions = <span class="hljs-number">4</span>,
    EndOfJobTimeInformation = <span class="hljs-number">6</span>,
    ExtendedLimitInformation = <span class="hljs-number">9</span>,
    SecurityLimitInformation = <span class="hljs-number">5</span>,
    GroupInformation = <span class="hljs-number">11</span>
}

[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> SECURITY_ATTRIBUTES
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> nLength;
    <span class="hljs-keyword">public</span> IntPtr lpSecurityDescriptor;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> bInheritHandle;
}

[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">struct</span> JOBOBJECT_BASIC_LIMIT_INFORMATION
{
    <span class="hljs-keyword">public</span> Int64 PerProcessUserTimeLimit;
    <span class="hljs-keyword">public</span> Int64 PerJobUserTimeLimit;
    <span class="hljs-keyword">public</span> Int16 LimitFlags;
    <span class="hljs-keyword">public</span> UInt32 MinimumWorkingSetSize;
    <span class="hljs-keyword">public</span> UInt32 MaximumWorkingSetSize;
    <span class="hljs-keyword">public</span> Int16 ActiveProcessLimit;
    <span class="hljs-keyword">public</span> Int64 Affinity;
    <span class="hljs-keyword">public</span> Int16 PriorityClass;
    <span class="hljs-keyword">public</span> Int16 SchedulingClass;
}

[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">struct</span> IO_COUNTERS
{
    <span class="hljs-keyword">public</span> UInt64 ReadOperationCount;
    <span class="hljs-keyword">public</span> UInt64 WriteOperationCount;
    <span class="hljs-keyword">public</span> UInt64 OtherOperationCount;
    <span class="hljs-keyword">public</span> UInt64 ReadTransferCount;
    <span class="hljs-keyword">public</span> UInt64 WriteTransferCount;
    <span class="hljs-keyword">public</span> UInt64 OtherTransferCount;
}

[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">struct</span> JOBOBJECT_EXTENDED_LIMIT_INFORMATION
{
    <span class="hljs-keyword">public</span> JOBOBJECT_BASIC_LIMIT_INFORMATION BasicLimitInformation;
    <span class="hljs-keyword">public</span> IO_COUNTERS IoInfo;
    <span class="hljs-keyword">public</span> UInt32 ProcessMemoryLimit;
    <span class="hljs-keyword">public</span> UInt32 JobMemoryLimit;
    <span class="hljs-keyword">public</span> UInt32 PeakProcessMemoryUsed;
    <span class="hljs-keyword">public</span> UInt32 PeakJobMemoryUsed;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Job</span> : <span class="hljs-title">IDisposable</span>
{
    [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32.dll"</span>, CharSet = CharSet.Unicode)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">CreateJobObject</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> a, <span class="hljs-built_in">string</span> lpName</span>)</span>;

    [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32.dll"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">SetInformationJobObject</span>(<span class="hljs-params">IntPtr hJob, JobObjectInfoType infoType, IntPtr lpJobObjectInfo, <span class="hljs-built_in">uint</span> cbJobObjectInfoLength</span>)</span>;

    [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32.dll"</span>, SetLastError = true)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">AssignProcessToJobObject</span>(<span class="hljs-params">IntPtr job, IntPtr process</span>)</span>;

    <span class="hljs-keyword">private</span> IntPtr m_handle;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> m_disposed = <span class="hljs-literal">false</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Job</span>()</span>
    {
        m_handle = CreateJobObject(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);

        JOBOBJECT_BASIC_LIMIT_INFORMATION info = <span class="hljs-keyword">new</span> JOBOBJECT_BASIC_LIMIT_INFORMATION();
        info.LimitFlags = <span class="hljs-number">0x2000</span>;

        JOBOBJECT_EXTENDED_LIMIT_INFORMATION extendedInfo = <span class="hljs-keyword">new</span> JOBOBJECT_EXTENDED_LIMIT_INFORMATION();
        extendedInfo.BasicLimitInformation = info;

        <span class="hljs-built_in">int</span> length = Marshal.SizeOf(<span class="hljs-keyword">typeof</span>(JOBOBJECT_EXTENDED_LIMIT_INFORMATION));
        IntPtr extendedInfoPtr = Marshal.AllocHGlobal(length);
        Marshal.StructureToPtr(extendedInfo, extendedInfoPtr, <span class="hljs-literal">false</span>);

        <span class="hljs-keyword">if</span> (!SetInformationJobObject(m_handle, JobObjectInfoType.ExtendedLimitInformation, extendedInfoPtr, (<span class="hljs-built_in">uint</span>)length))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-built_in">string</span>.Format(<span class="hljs-string">"Unable to set information.  Error: {0}"</span>, Marshal.GetLastWin32Error()));
    }

    <span class="hljs-meta">#<span class="hljs-keyword">region</span> IDisposable Members</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
    {
        Dispose(<span class="hljs-literal">true</span>);
        GC.SuppressFinalize(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span>

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span>
    {
        <span class="hljs-keyword">if</span> (m_disposed)
            <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">if</span> (disposing) {}

        Close();
        m_disposed = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span>
    {
        Win32.CloseHandle(m_handle);
        m_handle = IntPtr.Zero;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">AddProcess</span>(<span class="hljs-params">IntPtr handle</span>)</span>
    {
        <span class="hljs-keyword">return</span> AssignProcessToJobObject(m_handle, handle);
    }

}
</code></pre>

<p><strong>Note about Constructor code</strong></p>

<ul>
<li>In the constructor, the <code>info.LimitFlags = 0x2000;</code> is called. <code>0x2000</code> is the <code>JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE</code> enum value, and this value is defined by <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684147(v=vs.85).aspx" rel="noreferrer">MSDN</a> as:</li>
</ul>

<blockquote>
  <p>Causes all processes associated with the job to terminate when the
  last handle to the job is closed.</p>
</blockquote>

<p><strong>Extra Win32 API Call to get the Process ID (PID)</strong></p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">    [<span class="hljs-meta">DllImport(<span class="hljs-string">"user32.dll"</span>, SetLastError = true)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">uint</span> <span class="hljs-title">GetWindowThreadProcessId</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-keyword">out</span> <span class="hljs-built_in">uint</span> lpdwProcessId</span>)</span>;
</code></pre>

<p><strong>Using the code</strong></p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">    Excel.Application app = <span class="hljs-keyword">new</span> Excel.ApplicationClass();
    Job job = <span class="hljs-keyword">new</span> Job();
    <span class="hljs-built_in">uint</span> pid = <span class="hljs-number">0</span>;
    Win32.GetWindowThreadProcessId(<span class="hljs-keyword">new</span> IntPtr(app.Hwnd), <span class="hljs-keyword">out</span> pid);
    job.AddProcess(Process.GetProcessById((<span class="hljs-built_in">int</span>)pid).Handle);
</code></pre>
    </div></div></div></div><div id="solution5" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 5</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>This worked for a project I was working on:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">excelApp.Quit();
Marshal.ReleaseComObject (excelWB);
Marshal.ReleaseComObject (excelApp);
excelApp = <span class="hljs-literal">null</span>;
</code></pre>

<p>We learned that it was important to set <strong>every</strong> reference to an Excel COM object to null when you were done with it. This included Cells, Sheets, and everything.</p>
    </div></div></div></div><div id="solution6" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 6</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>First - you <em>never</em> have to call <code>Marshal.ReleaseComObject(...)</code> or <code>Marshal.FinalReleaseComObject(...)</code> when doing Excel interop. It is a confusing anti-pattern, but any information about this, including from Microsoft, that indicates you have to manually release COM references from .NET is incorrect. The fact is that the .NET runtime and garbage collector correctly keep track of and clean up COM references. For your code, this means you can remove the whole `while (...) loop at the top.</p>

<p>Second, if you want to ensure that the COM references to an out-of-process COM object are cleaned up when your process ends (so that the Excel process will close), you need to ensure that the garbage collector runs. You do this correctly with calls to <code>GC.Collect()</code> and <code>GC.WaitForPendingFinalizers()</code>. Calling this twice is safe, and ensures that cycles are definitely cleaned up too (though I'm not sure it's needed, and would appreciate an example that shows this).</p>

<p>Third, when running under the debugger, local references will be artificially kept alive until the end of the method (so that local variable inspection works). So  <code>GC.Collect()</code> calls are not effective for cleaning object like <code>rng.Cells</code> from the same method. You should split the code doing the COM interop from the GC cleanup into separate methods. (This was a key discovery for me, from one part of the answer posted here by @nightcoder.)</p>

<p>The general pattern would thus be:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function">Sub <span class="hljs-title">WrapperThatCleansUp</span>()

    ' NOTE: Don't call Excel objects <span class="hljs-keyword">in</span> here... 
    '       Debugger would keep alive until end, preventing GC cleanup

    ' Call a separate function that talks to Excel
    <span class="hljs-title">DoTheWork</span>()

    ' Now <span class="hljs-keyword">let</span> the GC clean <span class="hljs-title">up</span> (<span class="hljs-params">twice, to clean up cycles too</span>)
    GC.<span class="hljs-title">Collect</span>()    
    GC.<span class="hljs-title">WaitForPendingFinalizers</span>()
    GC.<span class="hljs-title">Collect</span>()    
    GC.<span class="hljs-title">WaitForPendingFinalizers</span>()

End Sub

Sub <span class="hljs-title">DoTheWork</span>()
    Dim app As New Microsoft.Office.Interop.Excel.Application
    Dim book As Microsoft.Office.Interop.Excel.Workbook</span> = app.Workbooks.Add()
    Dim worksheet As Microsoft.Office.Interop.Excel.Worksheet = book.Worksheets(<span class="hljs-string">"Sheet1"</span>)
    app.Visible = True
    For i As Integer = <span class="hljs-number">1</span> To <span class="hljs-number">10</span>
        worksheet.Cells.Range(<span class="hljs-string">"A"</span> &amp; i).Value = <span class="hljs-string">"Hello"</span>
    Next
    book.Save()
    book.Close()
    app.Quit()

    <span class="hljs-string">' NOTE: No calls the Marshal.ReleaseComObject() are ever needed
End Sub
</span></code></pre>

<p>There is a lot of false information and confusion about this issue, including many posts on MSDN and on Stack Overflow (and especially this question!).</p>

<p>What finally convinced me to have a closer look and figure out the right advice was blog post <em><a href="https://blogs.msdn.microsoft.com/visualstudio/2010/03/01/marshal-releasecomobject-considered-dangerous/" rel="noreferrer">Marshal.ReleaseComObject Considered Dangerous</a></em> together with finding the issue with references kept alive under the debugger that was confusing my earlier testing.</p>
    </div></div></div></div><div id="solution7" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 7</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p><strong>Anything that is in the Excel namespace needs to be released. Period</strong></p>

<p>You can't be doing:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">Worksheet ws = excel.WorkBooks[<span class="hljs-number">1</span>].WorkSheets[<span class="hljs-number">1</span>];
</code></pre>

<p>You have to be doing</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">Workbooks books = excel.WorkBooks;
Workbook book = books[<span class="hljs-number">1</span>];
Sheets sheets = book.WorkSheets;
Worksheet ws = sheets[<span class="hljs-number">1</span>];
</code></pre>

<p>followed by the releasing of the objects.</p>
    </div></div></div></div><div id="solution8" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 8</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>I <a href="http://www.deez.info/sengelha/2005/02/11/useful-idisposable-class-3-autoreleasecomobject/" rel="noreferrer">found</a> a useful generic template that can help implement the correct disposal pattern for COM objects, that need Marshal.ReleaseComObject called when they go out of scope:</p>

<p><strong>Usage:</strong></p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">using</span> (AutoReleaseComObject&lt;Application&gt; excelApplicationWrapper = <span class="hljs-keyword">new</span> AutoReleaseComObject&lt;Application&gt;(<span class="hljs-keyword">new</span> Application()))
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">using</span> (AutoReleaseComObject&lt;Workbook&gt; workbookWrapper = <span class="hljs-keyword">new</span> AutoReleaseComObject&lt;Workbook&gt;(excelApplicationWrapper.ComObject.Workbooks.Open(namedRangeBase.FullName, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, missing, missing, missing, <span class="hljs-literal">true</span>, missing, missing, <span class="hljs-literal">true</span>, missing, missing, missing, missing, missing)))
        {
           <span class="hljs-comment">// do something with your workbook....</span>
        }
    }
    <span class="hljs-keyword">finally</span>
    {
         excelApplicationWrapper.ComObject.Quit();
    } 
}
</code></pre>

<p><strong>Template:</strong></p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AutoReleaseComObject</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IDisposable</span>
{
    <span class="hljs-keyword">private</span> T m_comObject;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> m_armed = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> m_disposed = <span class="hljs-literal">false</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AutoReleaseComObject</span>(<span class="hljs-params">T comObject</span>)</span>
    {
        Debug.Assert(comObject != <span class="hljs-literal">null</span>);
        m_comObject = comObject;
    }

<span class="hljs-meta">#<span class="hljs-keyword">if</span> DEBUG</span>
    ~AutoReleaseComObject()
    {
        <span class="hljs-comment">// We should have been disposed using Dispose().</span>
        Debug.WriteLine(<span class="hljs-string">"Finalize being called, should have been disposed"</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.ComObject != <span class="hljs-literal">null</span>)
        {
            Debug.WriteLine(<span class="hljs-built_in">string</span>.Format(<span class="hljs-string">"ComObject was not null:{0}, name:{1}."</span>, <span class="hljs-keyword">this</span>.ComObject, <span class="hljs-keyword">this</span>.ComObjectName));
        }

        <span class="hljs-comment">//Debug.Assert(false);</span>
    }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    <span class="hljs-keyword">public</span> T ComObject
    {
        <span class="hljs-keyword">get</span>
        {
            Debug.Assert(!m_disposed);
            <span class="hljs-keyword">return</span> m_comObject;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> ComObjectName
    {
        <span class="hljs-keyword">get</span>
        {
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.ComObject <span class="hljs-keyword">is</span> Microsoft.Office.Interop.Excel.Workbook)
            {
                <span class="hljs-keyword">return</span> ((Microsoft.Office.Interop.Excel.Workbook)<span class="hljs-keyword">this</span>.ComObject).Name;
            }

            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Disarm</span>()</span>
    {
        Debug.Assert(!m_disposed);
        m_armed = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-meta">#<span class="hljs-keyword">region</span> IDisposable Members</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
    {
        Dispose(<span class="hljs-literal">true</span>);
<span class="hljs-meta">#<span class="hljs-keyword">if</span> DEBUG</span>
        GC.SuppressFinalize(<span class="hljs-keyword">this</span>);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    }

    <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span>

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span>
    {
        <span class="hljs-keyword">if</span> (!m_disposed)
        {
            <span class="hljs-keyword">if</span> (m_armed)
            {
                <span class="hljs-built_in">int</span> refcnt = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">do</span>
                {
                    refcnt = System.Runtime.InteropServices.Marshal.ReleaseComObject(m_comObject);
                } <span class="hljs-keyword">while</span> (refcnt &gt; <span class="hljs-number">0</span>);

                m_comObject = <span class="hljs-literal">default</span>(T);
            }

            m_disposed = <span class="hljs-literal">true</span>;
        }
    }
}
</code></pre>

<p><strong>Reference:</strong></p>

<p><a href="http://www.deez.info/sengelha/2005/02/11/useful-idisposable-class-3-autoreleasecomobject/" rel="noreferrer">http://www.deez.info/sengelha/2005/02/11/useful-idisposable-class-3-autoreleasecomobject/</a></p>
    </div></div></div></div><div id="solution9" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 9</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>I cant believe this problem has haunted the world for 5 years.... If you have created an application, you need to shut it down first before removing the link.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">objExcel = <span class="hljs-keyword">new</span> Excel.Application();  
objBook = (Excel.Workbook)(objExcel.Workbooks.Add(Type.Missing)); 
</code></pre>

<p>when closing</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">objBook.Close(<span class="hljs-literal">true</span>, Type.Missing, Type.Missing); 
objExcel.Application.Quit();
objExcel.Quit(); 
</code></pre>

<p>When you new an excel application, it opens a excel program in the background. You need to command that excel program to quit before you release the link because that excel program is not part of your direct control. Therefore, it will stay open if the link is released!</p>

<p>Good programming everyone~~</p>
    </div></div></div></div><div id="solution10" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 10</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Common developers, none of your solutions worked for me, 
so I decide to implement a new <strong>trick</strong>.</p>

<p>First let specify "What is our goal?" =&gt; "Not to see excel object after our job in task manager" </p>

<p>Ok. Let no to challenge and start destroying it, but consider not to destroy other instance os Excel which are running in parallel.</p>

<p>So , get the list of current processors and fetch PID of EXCEL processes , then once your job is done, we have a new guest in processes list with a unique PID ,find and destroy just that one.</p>

<p>&lt; keep in mind any new excel process during your excel job will be detected as new and destroyed &gt;
 &lt; A better solution is to capture PID of new created excel object and just destroy that&gt;</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">Process[] prs = Process.GetProcesses();
List&lt;<span class="hljs-built_in">int</span>&gt; excelPID = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();
<span class="hljs-keyword">foreach</span> (Process p <span class="hljs-keyword">in</span> prs)
   <span class="hljs-keyword">if</span> (p.ProcessName == <span class="hljs-string">"EXCEL"</span>)
       excelPID.Add(p.Id);

.... <span class="hljs-comment">// your job </span>

prs = Process.GetProcesses();
<span class="hljs-keyword">foreach</span> (Process p <span class="hljs-keyword">in</span> prs)
   <span class="hljs-keyword">if</span> (p.ProcessName == <span class="hljs-string">"EXCEL"</span> &amp;&amp; !excelPID.Contains(p.Id))
       p.Kill();
</code></pre>

<p>This resolves my issue, hope yours too.</p>
    </div></div></div></div><div id="solution11" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 11</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>This sure seems like it has been over-complicated. From my experience, there are just three key things to get Excel to close properly:</p>

<p>1: make sure there are no remaining references to the excel application you created (you should only have one anyway; set it to <code>null</code>)</p>

<p>2: call <code>GC.Collect()</code></p>

<p>3: Excel has to be closed, either by the user manually closing the program, or by you calling <code>Quit</code> on the Excel object. (Note that <code>Quit</code> will function just as if the user tried to close the program, and will present a confirmation dialog if there are unsaved changes, even if Excel is not visible. The user could press cancel, and then Excel will not have been closed.)</p>

<p>1 needs to happen before 2, but 3 can happen anytime.</p>

<p>One way to implement this is to wrap the interop Excel object with your own class, create the interop instance in the constructor, and implement IDisposable with Dispose looking something like</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">if</span> (!mDisposed) {
   mExcel = <span class="hljs-literal">null</span>;
   GC.Collect();
   mDisposed = <span class="hljs-literal">true</span>;
}
</code></pre>

<p>That will clean up excel from your program's side of things. Once Excel is closed (manually by the user or by you calling <code>Quit</code>) the process will go away. If the program has already been closed, then the process will disappear on the <code>GC.Collect()</code> call.</p>

<p>(I'm not sure how important it is, but you may want a <code>GC.WaitForPendingFinalizers()</code> call after the <code>GC.Collect()</code> call but it is not strictly necessary to get rid of the Excel process.)</p>

<p>This has worked for me without issue for years. Keep in mind though that while this works, you actually have to close gracefully for it to work. You will still get accumulating excel.exe processes if you interrupt your program before Excel is cleaned up (usually by hitting "stop" while your program is being debugged).</p>
    </div></div></div></div><div id="solution12" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 12</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>I've traditionally followed the advice found in <a href="https://stackoverflow.com/a/158752/741988">VVS's answer</a>.  However, in an effort to keep this answer up-to-date with the latest options, I think all my future projects will use the "NetOffice" library.</p>

<p><a href="https://osdn.net/projects/netoffice/" rel="nofollow noreferrer">NetOffice</a> is a complete replacement for the Office PIAs and is completely version-agnostic. It's a collection of Managed COM wrappers that can handle the cleanup that often causes such headaches when working with Microsoft Office in .NET.</p>

<p>Some key features are:</p>

<ul>
<li>Mostly version-independent (and version-dependant features are documented)</li>
<li>No dependencies</li>
<li>No PIA</li>
<li>No registration</li>
<li>No VSTO</li>
</ul>

<p>I am in no way affiliated with the project; I just genuinely appreciate the stark reduction in headaches.</p>
    </div></div></div></div><div id="solution13" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 13</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>To add to reasons why Excel does not close, even when you create direct refrences to each object upon read, creation, is the 'For' loop.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">For Each objWorkBook As WorkBook <span class="hljs-keyword">in</span> objWorkBooks <span class="hljs-string">'local ref, created from ExcelApp.WorkBooks to avoid the double-dot
   objWorkBook.Close '</span><span class="hljs-function"><span class="hljs-keyword">or</span> whatever
   <span class="hljs-title">FinalReleaseComObject</span>(<span class="hljs-params">objWorkBook</span>)
   objWorkBook</span> = Nothing
Next 

<span class="hljs-string">'The above does not work, and this is the workaround:

For intCounter As Integer = 1 To mobjExcel_WorkBooks.Count
   Dim objTempWorkBook As Workbook = mobjExcel_WorkBooks.Item(intCounter)
   objTempWorkBook.Saved = True
   objTempWorkBook.Close(False, Type.Missing, Type.Missing)
   FinalReleaseComObject(objTempWorkBook)
   objTempWorkBook = Nothing
Next
</span></code></pre>
    </div></div></div></div><div id="solution14" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 14</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The accepted answer here is correct, but also take note that not only "two dot" references need to be avoided, but also objects that are retrieved via the index.  You also do not need to wait until you are finished with the program to clean up these objects, it's best to create functions that will clean them up as soon as you're finished with them, when possible.  Here is a function I created that assigns some properties of a Style object called <code>xlStyleHeader</code>:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">public</span> Excel.Style xlStyleHeader = <span class="hljs-literal">null</span>;

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CreateHeaderStyle</span>()</span>
{
    Excel.Styles xlStyles = <span class="hljs-literal">null</span>;
    Excel.Font xlFont = <span class="hljs-literal">null</span>;
    Excel.Interior xlInterior = <span class="hljs-literal">null</span>;
    Excel.Borders xlBorders = <span class="hljs-literal">null</span>;
    Excel.Border xlBorderBottom = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">try</span>
    {
        xlStyles = xlWorkbook.Styles;
        xlStyleHeader = xlStyles.Add(<span class="hljs-string">"Header"</span>, Type.Missing);

        <span class="hljs-comment">// Text Format</span>
        xlStyleHeader.NumberFormat = <span class="hljs-string">"@"</span>;

        <span class="hljs-comment">// Bold</span>
        xlFont = xlStyleHeader.Font;
        xlFont.Bold = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// Light Gray Cell Color</span>
        xlInterior = xlStyleHeader.Interior;
        xlInterior.Color = <span class="hljs-number">12632256</span>;

        <span class="hljs-comment">// Medium Bottom border</span>
        xlBorders = xlStyleHeader.Borders;
        xlBorderBottom = xlBorders[Excel.XlBordersIndex.xlEdgeBottom];
        xlBorderBottom.Weight = Excel.XlBorderWeight.xlMedium;
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">throw</span> ex;
    }
    <span class="hljs-keyword">finally</span>
    {
        Release(xlBorderBottom);
        Release(xlBorders);
        Release(xlInterior);
        Release(xlFont);
        Release(xlStyles);
    }
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Release</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span>
{
    <span class="hljs-comment">// Errors are ignored per Microsoft's suggestion for this type of function:</span>
    <span class="hljs-comment">// http://support.microsoft.com/default.aspx/kb/317109</span>
    <span class="hljs-keyword">try</span>
    {
        System.Runtime.InteropServices.Marshal.ReleaseComObject(obj);
    }
    <span class="hljs-keyword">catch</span> { } 
}
</code></pre>

<p>Notice that I had to set <code>xlBorders[Excel.XlBordersIndex.xlEdgeBottom]</code> to a variable in order to clean that up (Not because of the two dots, which refer to an enumeration which does not need to be released, but because the object I'm referring to is actually a Border object that does need to be released).</p>

<p>This sort of thing is not really necessary in standard applications, which do a great job of cleaning up after themselves, but in ASP.NET applications, if you miss even one of these, no matter how often you call the garbage collector, Excel will still be running on your server.  </p>

<p>It requires a lot of attention to detail and many test executions while monitoring the Task Manager when writing this code, but doing so saves you the hassle of desperately searching through pages of code to find the one instance you missed.  This is especially important when working in loops, where you need to release EACH INSTANCE of an object, even though it uses the same variable name each time it loops.</p>
    </div></div></div></div><div id="solution15" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 15</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>After trying</p>

<ol>
<li>Release COM objects in reverse order</li>
<li>Add <code>GC.Collect()</code> and <code>GC.WaitForPendingFinalizers()</code> twice at the end</li>
<li>No more than two dots</li>
<li>Close workbook and quit application</li>
<li>Run in release mode</li>
</ol>

<p>the final solution that works for me is to move one set of</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">GC.Collect();
GC.WaitForPendingFinalizers();
</code></pre>

<p>that we added to the end of the function to a wrapper, as follows:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FunctionWrapper</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> sourcePath, <span class="hljs-built_in">string</span> targetPath</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        FunctionThatCallsExcel(sourcePath, targetPath);
    }
    <span class="hljs-keyword">finally</span>
    {
        GC.Collect();
        GC.WaitForPendingFinalizers();
    }
}
</code></pre>
    </div></div></div></div><div id="solution16" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 16</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>I followed this exactly... But I still ran into issues 1 out of 1000 times. Who knows why. Time to bring out the hammer...</p>

<p>Right after the Excel Application class is instantiated I get a hold of the Excel process that was just created.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">excel = <span class="hljs-keyword">new</span> Microsoft.Office.Interop.Excel.Application();
<span class="hljs-keyword">var</span> process = Process.GetProcessesByName(<span class="hljs-string">"EXCEL"</span>).OrderByDescending(p =&gt; p.StartTime).First();
</code></pre>

<p>Then once I've done all the above COM clean-up, I make sure that process isn't running. If it is still running, kill it!</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">if</span> (!process.HasExited)
   process.Kill();
</code></pre>
    </div></div></div></div><div id="solution17" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 17</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p><strong>¨°º¤ø¸ Shoot Excel proc and chew bubble gum ¸ø¤º°¨</strong></p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyExcelInteropClass</span>
{
    Excel.Application xlApp;
    Excel.Workbook xlBook;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dothingswithExcel</span>()</span> 
    {
        <span class="hljs-keyword">try</span> { <span class="hljs-comment">/* Do stuff manipulating cells sheets and workbooks ... */</span> }
        <span class="hljs-keyword">catch</span> {}
        <span class="hljs-keyword">finally</span> {KillExcelProcess(xlApp);}
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">KillExcelProcess</span>(<span class="hljs-params">Excel.Application xlApp</span>)</span>
    {
        <span class="hljs-keyword">if</span> (xlApp != <span class="hljs-literal">null</span>)
        {
            <span class="hljs-built_in">int</span> excelProcessId = <span class="hljs-number">0</span>;
            GetWindowThreadProcessId(xlApp.Hwnd, <span class="hljs-keyword">out</span> excelProcessId);
            Process p = Process.GetProcessById(excelProcessId);
            p.Kill();
            xlApp = <span class="hljs-literal">null</span>;
        }
    }

    [<span class="hljs-meta">DllImport(<span class="hljs-string">"user32.dll"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetWindowThreadProcessId</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> hWnd, <span class="hljs-keyword">out</span> <span class="hljs-built_in">int</span> lpdwProcessId</span>)</span>;
}
</code></pre>
    </div></div></div></div><div id="solution18" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 18</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>You need to be aware that Excel is very sensitive to the culture you are running under as well.</p>

<p>You may find that you need to set the culture to EN-US before calling Excel functions.
This does not apply to all functions - but some of them.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">    CultureInfo en_US = <span class="hljs-keyword">new</span> System.Globalization.CultureInfo(<span class="hljs-string">"en-US"</span>); 
    System.Threading.Thread.CurrentThread.CurrentCulture = en_US;
    <span class="hljs-built_in">string</span> filePathLocal = _applicationObject.ActiveWorkbook.Path;
    System.Threading.Thread.CurrentThread.CurrentCulture = orgCulture;
</code></pre>

<p>This applies even if you are using VSTO.</p>

<p>For details: <a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;Q320369" rel="noreferrer">http://support.microsoft.com/default.aspx?scid=kb;en-us;Q320369</a></p>
    </div></div></div></div><div id="solution19" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 19</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>"Never use two dots with COM objects" is a great rule of thumb to avoid leakage of COM references, but Excel PIA can lead to leakage in more ways than apparent at first sight.</p>
<p>One of these ways is subscribing to any event exposed by any of the Excel object model's COM objects.</p>
<p>For example, subscribing to the Application class's WorkbookOpen event.</p>
<h3>Some theory on COM events</h3>
<p>COM classes expose a group of events through call-back interfaces. In order to subscribe to events, the client code can simply register an object implementing the call-back interface and the COM class will invoke its methods in response to specific events. Since the call-back interface is a COM interface, it is the duty of the implementing object to decrement the reference count of any COM object it receives (as a parameter) for any of the event handlers.</p>
<h3>How Excel PIA expose COM Events</h3>
<p>Excel PIA exposes COM events of Excel Application class as conventional .NET events. Whenever the client code subscribes to <strong>a .NET event</strong> (emphasis on 'a'), PIA creates <strong>an</strong> instance of a class implementing the call-back interface and registers it with Excel.</p>
<p>Hence, a number of call-back objects get registered with Excel in response to different subscription requests from the .NET code. One call-back object per event subscription.</p>
<p>A call-back interface for event handling means that, PIA has to subscribe to all interface events for every .NET event subscription request. It cannot pick and choose. On receiving an event call-back, the call-back object checks if the associated .NET event handler is interested in the current event or not and then either invokes the handler or silently ignores the call-back.</p>
<h3>Effect on COM instance reference counts</h3>
<p>All these call-back objects do not decrement the reference count of any of the COM objects they receive (as parameters) for any of the call-back methods (even for the ones that are silently ignored). They rely solely on the <a href="http://en.wikipedia.org/wiki/Common_Language_Runtime" rel="nofollow noreferrer">CLR</a> garbage collector to free up the COM objects.</p>
<p>Since GC run is non-deterministic, this can lead to the holding off of Excel process for a longer duration than desired and create an impression of a 'memory leak'.</p>
<h3>Solution</h3>
<p>The only solution as of now is to avoid the PIAs event provider for the COM class and write your own event provider which deterministically releases COM objects.</p>
<p>For the Application class, this can be done by implementing the AppEvents interface and then registering the implementation with Excel by using <a href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.comtypes.iconnectionpointcontainer.aspx" rel="nofollow noreferrer">IConnectionPointContainer interface</a>. The Application class (and for that matter all COM objects exposing events using callback mechanism) implements the IConnectionPointContainer interface.</p>
    </div></div></div></div><div id="solution20" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 20</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>As others have pointed out, you need to create an explicit reference for every Excel object you use, and call Marshal.ReleaseComObject on that reference, as described in <a href="http://support.microsoft.com/default.aspx/kb/317109" rel="nofollow noreferrer">this KB article</a>.  You also need to use try/finally to ensure ReleaseComObject is always called, even when an exception is thrown.  I.e. instead of:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">Worksheet sheet = excelApp.Worksheets(<span class="hljs-number">1</span>)
... <span class="hljs-keyword">do</span> something <span class="hljs-keyword">with</span> sheet
</code></pre>

<p>you need to do something like:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">Worksheets sheets = <span class="hljs-literal">null</span>;
Worksheet sheet = <span class="hljs-literal">null</span>
<span class="hljs-keyword">try</span>
{ 
    sheets = excelApp.Worksheets;
    sheet = sheets(<span class="hljs-number">1</span>);
    ...
}
<span class="hljs-keyword">finally</span>
{
    <span class="hljs-keyword">if</span> (sheets != <span class="hljs-literal">null</span>) Marshal.ReleaseComObject(sheets);
    <span class="hljs-keyword">if</span> (sheet != <span class="hljs-literal">null</span>) Marshal.ReleaseComObject(sheet);
}
</code></pre>

<p>You also need to call Application.Quit before releasing the Application object if you want Excel to close.</p>

<p>As you can see, this quickly becomes extremely unwieldy as soon as you try to do anything even moderately complex.  I have successfully developed .NET applications with a simple wrapper class that wraps a few simple manipulations of the Excel object model (open a workbook, write to a Range, save/close the workbook etc).  The wrapper class implements IDisposable, carefully implements Marshal.ReleaseComObject on every object it uses, and does not pubicly expose any Excel objects to the rest of the app.</p>

<p>But this approach doesn't scale well for more complex requirements.  </p>

<p>This is a big deficiency of .NET COM Interop.  For more complex scenarios, I would seriously consider writing an ActiveX DLL in VB6 or other unmanaged language to which you can delegate all interaction with out-proc COM objects such as Office.  You can then reference this ActiveX DLL from your .NET application, and things will be much easier as you will only need to release this one reference.</p>
    </div></div></div></div><div id="solution21" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 21</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>When all the stuff above didn't work, try giving Excel some time to close its sheets:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">app.workbooks.Close();
Thread.Sleep(<span class="hljs-number">500</span>); <span class="hljs-comment">// adjust, for me it works at around 300+</span>
app.Quit();

...
FinalReleaseComObject(app);
</code></pre>
    </div></div></div></div><div id="solution22" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 22</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Make sure that you release all objects related to Excel!</p>

<p>I spent a few hours by trying several ways. All are great ideas but I finally found my mistake: <strong>If you don't release all objects, none of the ways above can help you</strong> like in my case. Make sure you release all objects including range one!</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">Excel.Range rng = (Excel.Range)worksheet.Cells[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>];
worksheet.Paste(rng, <span class="hljs-literal">false</span>);
releaseObject(rng);
</code></pre>

<p>The options are together <a href="http://birvesifir.com/2012/08/08/how-to-properly-clean-up-excel-interop-objects-in-c/" rel="nofollow">here</a>.</p>
    </div></div></div></div><div id="solution23" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 23</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>A great article on releasing COM objects is <em><a href="http://msdn.microsoft.com/en-us/library/office/aa679807(v=office.12).aspx#officeinteroperabilitych2_part2_rco" rel="nofollow noreferrer">2.5 Releasing COM Objects</a></em> (MSDN).</p>

<p>The method that I would advocate is to null your Excel.Interop references if they are non-local variables, and then call <code>GC.Collect()</code> and <code>GC.WaitForPendingFinalizers()</code> twice. Locally scoped Interop variables will be taken care of automatically.</p>

<p>This removes the need to keep a named reference for <strong>every</strong> COM object.</p>

<p>Here's an example taken from the article:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> {

    <span class="hljs-comment">// These instance variables must be nulled or Excel will not quit</span>
    <span class="hljs-keyword">private</span> Excel.Application xl;
    <span class="hljs-keyword">private</span> Excel.Workbook book;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoSomething</span>()</span>
    {
        xl = <span class="hljs-keyword">new</span> Excel.Application();
        xl.Visible = <span class="hljs-literal">true</span>;
        book = xl.Workbooks.Add(Type.Missing);

        <span class="hljs-comment">// These variables are locally scoped, so we need not worry about them.</span>
        <span class="hljs-comment">// Notice I don't care about using two dots.</span>
        Excel.Range rng = book.Worksheets[<span class="hljs-number">1</span>].UsedRange;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CleanUp</span>()</span>
    {
        book = <span class="hljs-literal">null</span>;
        xl.Quit();
        xl = <span class="hljs-literal">null</span>;

        GC.Collect();
        GC.WaitForPendingFinalizers();
        GC.Collect();
        GC.WaitForPendingFinalizers();
    }
}
</code></pre>

<p>These words are straight from the article:</p>

<blockquote>
  <p>In almost all situations, nulling the RCW reference and forcing a garbage collection will clean up properly. If you also call GC.WaitForPendingFinalizers, garbage collection will be as deterministic as you can make it. That is, you'll be pretty sure exactly when the object has been cleaned upon the return from the second call to WaitForPendingFinalizers. As an alternative, you can use Marshal.ReleaseComObject. However, note that you are very unlikely to ever need to use this method.</p>
</blockquote>
    </div></div></div></div><div id="solution24" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 24</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The two dots rule did not work for me. In my case I created a method to clean my resources as follows:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Clean</span>()</span>
{
    workBook.Close();
    Marshall.ReleaseComObject(workBook);
    excel.Quit();
    CG.Collect();
    CG.WaitForPendingFinalizers();
}
</code></pre>
    </div></div></div></div><div id="solution25" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 25</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>My solution</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">[<span class="hljs-meta">DllImport(<span class="hljs-string">"user32.dll"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetWindowThreadProcessId</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> hWnd, <span class="hljs-keyword">out</span> <span class="hljs-built_in">int</span> lpdwProcessId</span>)</span>;

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GenerateExcel</span>()</span>
{
    <span class="hljs-keyword">var</span> excel = <span class="hljs-keyword">new</span> Microsoft.Office.Interop.Excel.Application();
    <span class="hljs-built_in">int</span> id;
    <span class="hljs-comment">// Find the Excel Process Id (ath the end, you kill him</span>
    GetWindowThreadProcessId(excel.Hwnd, <span class="hljs-keyword">out</span> id);
    Process excelProcess = Process.GetProcessById(id);

<span class="hljs-keyword">try</span>
{
    <span class="hljs-comment">// Your code</span>
}
<span class="hljs-keyword">finally</span>
{
    excel.Quit();

    <span class="hljs-comment">// Kill him !</span>
    excelProcess.Kill();
}
</code></pre>
    </div></div></div></div><div id="solution26" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 26</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>You should be very careful using Word/Excel interop applications. After trying all the solutions we still had a lot of "WinWord" process left open on server (with more than 2000 users).</p>

<p>After working on the problem for hours, I realized that if I open more than a couple of documents using <code>Word.ApplicationClass.Document.Open()</code> on different threads simultaneously, IIS worker process (w3wp.exe) would crash leaving all WinWord processes open!</p>

<p>So I guess there is no absolute solution to this problem, but switching to other methods such as <a href="https://en.wikipedia.org/wiki/Office_Open_XML" rel="nofollow noreferrer">Office Open XML</a> development.</p>
    </div></div></div></div><div id="solution27" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 27</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The accepted answer did not work for me. The following code in the destructor did the job.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">if</span> (xlApp != <span class="hljs-literal">null</span>)
{
    xlApp.Workbooks.Close();
    xlApp.Quit();
}

System.Diagnostics.Process[] processArray = System.Diagnostics.Process.GetProcessesByName(<span class="hljs-string">"EXCEL"</span>);
<span class="hljs-keyword">foreach</span> (System.Diagnostics.Process process <span class="hljs-keyword">in</span> processArray)
{
    <span class="hljs-keyword">if</span> (process.MainWindowTitle.Length == <span class="hljs-number">0</span>) { process.Kill(); }
}
</code></pre>
    </div></div></div></div><div id="solution28" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 28</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>I am currently working on Office automation and have stumbled across a solution for this that works every time for me. It is simple and does not involve killing any processes.</p>

<p>It seems that by merely looping through the current active processes, and in any way 'accessing' an open Excel process, any stray hanging instance of Excel will be removed. The below code simply checks for processes where the name is 'Excel', then writes the MainWindowTitle property of the process to a string. This 'interaction' with the process seems to make Windows catch up and abort the frozen instance of Excel. </p>

<p>I run the below method just before the add-in which I am developing quits, as it fires it unloading event. It removes any hanging instances of Excel every time. In all honesty I am not entirely sure why this works, but it works well for me and could be placed at the end of any Excel application without having to worry about double dots, Marshal.ReleaseComObject, nor killing processes. I would be very interested in any suggestions as to why this is effective.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SweepExcelProcesses</span>()</span>
{           
            <span class="hljs-keyword">if</span> (Process.GetProcessesByName(<span class="hljs-string">"EXCEL"</span>).Length != <span class="hljs-number">0</span>)
            {
                Process[] processes = Process.GetProcesses();
                <span class="hljs-keyword">foreach</span> (Process process <span class="hljs-keyword">in</span> processes)
                {
                    <span class="hljs-keyword">if</span> (process.ProcessName.ToString() == <span class="hljs-string">"excel"</span>)
                    {                           
                        <span class="hljs-built_in">string</span> title = process.MainWindowTitle;
                    }
                }
            }
}
</code></pre>
    </div></div></div></div><div id="solution29" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 29</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>I think that some of that is just the way that the framework handles Office applications, but I could be wrong. On some days, some applications clean up the processes immediately, and other days it seems to wait until the application closes. In general, I quit paying attention to the details and just make sure that there aren't any extra processes floating around at the end of the day.</p>

<p>Also, and maybe I'm over simplifying things, but I think you can just...</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">objExcel = <span class="hljs-keyword">new</span> Excel.Application();
objBook = (Excel.Workbook)(objExcel.Workbooks.Add(Type.Missing));
DoSomeStuff(objBook);
SaveTheBook(objBook);
objBook.Close(<span class="hljs-literal">false</span>, Type.Missing, Type.Missing);
objExcel.Quit();
</code></pre>

<p>Like I said earlier, I don't tend to pay attention to the details of when the Excel process appears or disappears, but that usually works for me.  I also don't like to keep Excel processes around for anything other than the minimal amount of time, but I'm probably just being paranoid on that.</p>
    </div></div></div></div><div id="solution30" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 30</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/interop">interop</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/com-interop">com-interop</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>As some have probably already written, it's not just important how you <em>close</em> the Excel (object); it's also important how you <em>open</em> it and also by the type of the project.</p>

<p>In a WPF application, basically the same code is working without or with very few problems.</p>

<p>I have a project in which the same Excel file is being processed several times for different parameter value - e.g. parsing it based on values inside a generic list. </p>

<p>I put all Excel-related functions into the base class, and parser into a subclass (different parsers use common Excel functions). I didn't want that Excel is opened and closed again for each item in a generic list, so I've opened it only once in the base class and close it in the subclass. I had problems when moving the code into a desktop application. I've tried many of the above mentioned solutions. <code>GC.Collect()</code> was already implemented before, twice as suggested.</p>

<p>Then I've decided that I will move the code for opening Excel to a subclass. Instead of opening only once, now I create a new object (base class) and open Excel for every item and close it at the end. There is some performance penalty, but based on several tests Excel processes are closing without problems (in debug mode), so also temporary files are removed. I will continue with testing and write some more if I will get some updates.</p>

<p>The bottom line is: You must also check the initialize code, especially if you have many classes, etc.</p>
    </div></div></div></div></div></div><div class="widget"><a href="/questions/how-do-i-write-a-correct-micro-benchmark-in-java-1657384488725">How do I write a correct micro-benchmark in Java?</a><a href="/questions/%22thinking-in-angularjs%22-if-i-have-a-jquery-background-closed-1657384761159">&quot;Thinking in AngularJS&quot; if I have a jQuery background? [closed]</a><a href="/questions/how-do-i-install-pip-on-windows-1657388147761">How do I install pip on Windows?</a><a href="/questions/what-is-dom-event-delegation-1657387625599">What is DOM Event delegation?</a><a href="/questions/how-to-deal-with-mysqli-problems-mysqli_fetch_array():-argument-1-must-be-of-type-mysqli_result-1657384360922">How to deal with mysqli problems? mysqli_fetch_array(): Argument #1 must be of type mysqli_result</a><a href="/questions/how-do-i-split-a-delimited-string-so-i-can-access-individual-items-1657388042385">How do I split a delimited string so I can access individual items?</a><a href="/questions/how-can-i-prevent-sql-injection-in-php-1657384220094">How can I prevent SQL injection in PHP?</a><a href="/questions/how-can-i-deserialize-json-with-c-1657388102941">How can I deserialize JSON with C#?</a><a href="/questions/are-dictionaries-ordered-in-python-3.6+-1657387834234">Are dictionaries ordered in Python 3.6+?</a><a href="/questions/switch-between-two-frames-in-tkinter-1657388528781">Switch between two frames in tkinter?</a><a href="/questions/is-floating-point-math-broken-1657384238910">Is floating point math broken?</a><a href="/questions/what-is-the-best-algorithm-for-overriding-gethashcode-1657387848932">What is the best algorithm for overriding GetHashCode?</a><a href="/questions/disable-same-origin-policy-in-chrome-1657387743804">Disable same origin policy in Chrome</a><a href="/questions/where-and-why-do-i-have-to-put-the-%22template%22-and-%22typename%22-keywords-1657384467606">Where and why do I have to put the &quot;template&quot; and &quot;typename&quot; keywords?</a><a href="/questions/understanding-slicing-1657384397680">Understanding slicing</a><a href="/questions/how-to-get-all-possible-combinations-of-a-list&#x27;s-elements-1657388271070">How to get all possible combinations of a list’s elements?</a><a href="/questions/detecting-a-mobile-browser-1657388460071">Detecting a mobile browser</a><a href="/questions/why-does-std::getline()-skip-input-after-a-formatted-extraction-1657384756118">Why does std::getline() skip input after a formatted extraction?</a><a href="/questions/how-do-i-detect-collision-in-pygame-1657387496338">How do I detect collision in pygame?</a><a href="/questions/can-you-provide-some-examples-of-why-it-is-hard-to-parse-xml-and-html-with-a-regex-closed-1657388410824">Can you provide some examples of why it is hard to parse XML and HTML with a regex? [closed]</a></div></div><span class="cursor-pointer text-lg p-2" style="position:fixed;bottom:20px;left:20px;background:#000;z-index:2000;color:white">Go go top</span></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"answer":["\n\u0026lt;p\u0026gt;Excel does not quit because your application is still holding references to COM objects.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;I guess you\u0026apos;re invoking at least one member of a COM object without assigning it to a variable.\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;For me it was the \u0026lt;em\u0026gt;excelApp.Worksheets\u0026lt;/em\u0026gt; object which I directly used without assigning it to a variable:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;Worksheet sheet = excelApp.Worksheets.Open(...);\n...\nMarshal.ReleaseComObject(sheet);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;I didn\u0026apos;t know that internally C# created a wrapper for the \u0026lt;strong\u0026gt;Worksheets\u0026lt;/strong\u0026gt; COM object which didn\u0026apos;t get released by my code (because I wasn\u0026apos;t aware of it) and was the cause why Excel was not unloaded.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I found the solution to my problem on \u0026lt;a href=\u0026quot;http://www.velocityreviews.com/forums/showpost.php?s=f87f0674feda4442dcbd40019cbca65b\u0026amp;amp;p=528575\u0026amp;amp;postcount=2\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;this page\u0026lt;/a\u0026gt;, which also has a nice rule for the usage of COM objects in C#:\u0026lt;/p\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;Never use two dots with COM objects.\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;hr\u0026gt;\n\n\u0026lt;p\u0026gt;So with this knowledge the right way of doing the above is:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;Worksheets sheets = excelApp.Worksheets; \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// \u0026amp;lt;-- The important part\u0026lt;/span\u0026gt;\nWorksheet sheet = sheets.Open(...);\n...\nMarshal.ReleaseComObject(sheets);\nMarshal.ReleaseComObject(sheet);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;POST MORTEM UPDATE:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I want every reader to read this answer by Hans Passant very carefully as it explains the trap I and lots of other developers stumbled into. When I wrote this answer years ago I didn\u0026apos;t know about the effect the debugger has to the garbage collector and drew the wrong conclusions. I keep my answer unaltered for the sake of history but please read this link and \u0026lt;strong\u0026gt;don\u0026apos;t\u0026lt;/strong\u0026gt; go the way of \u0026quot;the two dots\u0026quot;: \u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/17130382/understanding-garbage-collection-in-net/17131389#17131389\u0026quot;\u0026gt;Understanding garbage collection in .NET\u0026lt;/a\u0026gt; and \u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/25134024/clean-up-excel-interop-objects-with-idisposable/25135685#25135685\u0026quot;\u0026gt;Clean up Excel Interop Objects with IDisposable\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;You can actually release your Excel Application object cleanly, but you do have to take care. \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;The advice to maintain a named reference for absolutely every COM object you access and then explicitly release it via \u0026lt;code\u0026gt;Marshal.FinalReleaseComObject()\u0026lt;/code\u0026gt; is correct in theory, but, unfortunately, very difficult to manage in practice. If one ever slips anywhere and uses \u0026quot;two dots\u0026quot;, or iterates cells via a \u0026lt;code\u0026gt;for each\u0026lt;/code\u0026gt; loop, or any other similar kind of command, then you\u0026apos;ll have unreferenced COM objects and risk a hang. In this case, there would be no way to find the cause in the code; you would have to review all your code by eye and hopefully find the cause, a task that could be nearly impossible for a large project.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;The good news is that you do not actually have to maintain a named variable reference to every COM object you use. Instead, call \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; and then \u0026lt;code\u0026gt;GC.WaitForPendingFinalizers()\u0026lt;/code\u0026gt; to release all the (usually minor) objects to which you do not hold a reference, and then explicitly release the objects to which you do hold a named variable reference. \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;You should also release your named references in reverse order of importance: range objects first, then worksheets, workbooks, and then finally your Excel Application object.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;For example, assuming that you had a Range object variable named \u0026lt;code\u0026gt;xlRng\u0026lt;/code\u0026gt;, a Worksheet variable named \u0026lt;code\u0026gt;xlSheet\u0026lt;/code\u0026gt;, a Workbook variable named \u0026lt;code\u0026gt;xlBook\u0026lt;/code\u0026gt; and an Excel Application variable named \u0026lt;code\u0026gt;xlApp\u0026lt;/code\u0026gt;, then your cleanup code could look something like the following:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Cleanup\u0026lt;/span\u0026gt;\nGC.Collect();\nGC.WaitForPendingFinalizers();\n\nMarshal.FinalReleaseComObject(xlRng);\nMarshal.FinalReleaseComObject(xlSheet);\n\nxlBook.Close(Type.Missing, Type.Missing, Type.Missing);\nMarshal.FinalReleaseComObject(xlBook);\n\nxlApp.Quit();\nMarshal.FinalReleaseComObject(xlApp);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;In most code examples you\u0026apos;ll see for cleaning up COM objects from .NET, the \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; and \u0026lt;code\u0026gt;GC.WaitForPendingFinalizers()\u0026lt;/code\u0026gt; calls are made TWICE as in:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;GC.Collect();\nGC.WaitForPendingFinalizers();\nGC.Collect();\nGC.WaitForPendingFinalizers();\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;This should not be required, however, unless you are using Visual Studio Tools for Office (VSTO), which uses finalizers that cause an entire graph of objects to be promoted in the finalization queue. Such objects would not be released until the \u0026lt;em\u0026gt;next\u0026lt;/em\u0026gt; garbage collection. However, if you are not using VSTO, you should be able to call \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; and \u0026lt;code\u0026gt;GC.WaitForPendingFinalizers()\u0026lt;/code\u0026gt; just once.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I know that explicitly calling \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; is a no-no (and certainly doing it twice sounds very painful), but there is no way around it, to be honest. Through normal operations you will generate hidden objects to which you hold no reference that you, therefore, cannot release through any other means other than calling \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt;.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;This is a complex topic, but this really is all there is to it. Once you establish this template for your cleanup procedure you can code normally, without the need for wrappers, etc. :-)\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I have a tutorial on this here:\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;http://www.xtremevbtalk.com/showthread.php?t=160433\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;Automating Office Programs with VB.Net / COM Interop\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;It\u0026apos;s written for VB.NET, but don\u0026apos;t be put off by that, the principles are exactly the same as when using C#.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Preface: my answer contains two solutions, so be careful when reading and don\u0026apos;t miss anything.\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;There are different ways and advice of how to make Excel instance unload, such as:  \u0026lt;/p\u0026gt;\n\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;Releasing EVERY com object explicitly\nwith Marshal.FinalReleaseComObject()\n(not forgetting about implicitly\ncreated com-objects). To release\nevery created com object, you may use\nthe rule of 2 dots mentioned here:\u0026lt;br\u0026gt;\n\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/158706/how-to-properly-clean-up-excel-interop-objects-in-c/158752#158752\u0026quot;\u0026gt;How do I properly clean up Excel interop objects?\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;Calling GC.Collect() and\nGC.WaitForPendingFinalizers() to make\nCLR release unused com-objects * (Actually, it works, see my second solution for details)\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;Checking if com-server-application\nmaybe shows a message box waiting for\nthe user to answer (though I am not\nsure it can prevent Excel from\nclosing, but I heard about it a few\ntimes)\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;Sending WM_CLOSE message to the main\nExcel window\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;Executing the function that works\nwith Excel in a separate AppDomain.\nSome people believe Excel instance\nwill be shut, when AppDomain is\nunloaded.\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;Killing all excel instances which were instantiated after our excel-interoping code started.\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;BUT!\u0026lt;/strong\u0026gt; Sometimes all these options just don\u0026apos;t help or can\u0026apos;t be appropriate!\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;For example, yesterday I found out that in one of my functions (which works with excel) Excel keeps running after the function ends. I tried everything! I thoroughly checked the whole function 10 times and added Marshal.FinalReleaseComObject() for everything! I also had GC.Collect() and GC.WaitForPendingFinalizers(). I checked for hidden message boxes. I tried to send WM_CLOSE message to the main Excel window. I executed my function in a separate AppDomain and unloaded that domain. Nothing helped! The option with closing all excel instances is inappropriate, because if the user starts another Excel instance manually, during execution of my function which works also with Excel, then that instance will also be closed by my function. I bet the user will not be happy! So, honestly, this is a lame option (no offence guys). So I spent a couple of hours before I found a good (in my humble opinion) \u0026lt;strong\u0026gt;solution\u0026lt;/strong\u0026gt;: \u0026lt;strong\u0026gt;Kill excel process by hWnd of its main window\u0026lt;/strong\u0026gt; (it\u0026apos;s the first solution).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Here is the simple code:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;[\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;DllImport(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;user32.dll\u0026quot;\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;]\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;extern\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;GetWindowThreadProcessId\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;IntPtr hWnd, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt; lpdwProcessId\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;;\n\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;summary\u0026amp;gt;\u0026lt;/span\u0026gt; Tries to find and kill process by hWnd to the main window of the process.\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/summary\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;param name=\u0026quot;hWnd\u0026quot;\u0026amp;gt;\u0026lt;/span\u0026gt;Handle to the main window of the process.\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/param\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;returns\u0026amp;gt;\u0026lt;/span\u0026gt;True if process was found and killed. False if process was not found by hWnd or if it could not be killed.\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/returns\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;TryKillProcessByMainWindowHwnd\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; hWnd\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt; processID;\n    GetWindowThreadProcessId((IntPtr)hWnd, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; processID);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt;(processID == \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n    {\n        Process.GetProcessById((\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;)processID).Kill();\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;catch\u0026lt;/span\u0026gt; (ArgumentException)\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;;\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;catch\u0026lt;/span\u0026gt; (Win32Exception)\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;;\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;catch\u0026lt;/span\u0026gt; (NotSupportedException)\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;;\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;catch\u0026lt;/span\u0026gt; (InvalidOperationException)\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;;\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;;\n}\n\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;summary\u0026amp;gt;\u0026lt;/span\u0026gt; Finds and kills process by hWnd to the main window of the process.\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/summary\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;param name=\u0026quot;hWnd\u0026quot;\u0026amp;gt;\u0026lt;/span\u0026gt;Handle to the main window of the process.\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/param\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;exception cref=\u0026quot;ArgumentException\u0026quot;\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; Thrown when process is not found by the hWnd parameter (the process is not running). \u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; The identifier of the process might be expired.\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/exception\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;exception cref=\u0026quot;Win32Exception\u0026quot;\u0026amp;gt;\u0026lt;/span\u0026gt;See Process.Kill() exceptions documentation.\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/exception\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;exception cref=\u0026quot;NotSupportedException\u0026quot;\u0026amp;gt;\u0026lt;/span\u0026gt;See Process.Kill() exceptions documentation.\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/exception\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;///\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;exception cref=\u0026quot;InvalidOperationException\u0026quot;\u0026amp;gt;\u0026lt;/span\u0026gt;See Process.Kill() exceptions documentation.\u0026lt;span class=\u0026quot;hljs-doctag\u0026quot;\u0026gt;\u0026amp;lt;/exception\u0026amp;gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;KillProcessByMainWindowHwnd\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; hWnd\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt; processID;\n    GetWindowThreadProcessId((IntPtr)hWnd, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; processID);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (processID == \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;)\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;throw\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; ArgumentException(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;Process has not been found by the given main window handle.\u0026quot;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;hWnd\u0026quot;\u0026lt;/span\u0026gt;);\n    Process.GetProcessById((\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;)processID).Kill();\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;As you can see I provided two methods, according to Try-Parse pattern (I think it is appropriate here): one method doesn\u0026apos;t throw the exception if the Process could not be killed (for example the process doesn\u0026apos;t exist anymore), and another method throws the exception if the Process was not killed. The only weak place in this code is security permissions. Theoretically, the user may not have permissions to kill the process, but in 99.99% of all cases, user has such permissions. I also tested it with a guest account - it works perfectly.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;So, your code, working with Excel, can look like this:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; hWnd = xl.Application.Hwnd;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// ...\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// here we try to close Excel as usual, with xl.Quit(),\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Marshal.FinalReleaseComObject(xl) and so on\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// ...\u0026lt;/span\u0026gt;\nTryKillProcessByMainWindowHwnd(hWnd);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Voila! Excel is terminated! :)\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Ok, let\u0026apos;s go back to the second solution, as I promised in the beginning of the post.\n\u0026lt;strong\u0026gt;The second solution is to call GC.Collect() and GC.WaitForPendingFinalizers().\u0026lt;/strong\u0026gt; Yes, they actually work, but you need to be careful here!\u0026lt;br\u0026gt;\nMany people say (and I said) that calling GC.Collect() doesn\u0026apos;t help. But the reason it wouldn\u0026apos;t help is if there are still references to COM objects! One of the most popular reasons for GC.Collect() not being helpful is running the project in Debug-mode. In debug-mode objects that are not really referenced anymore will not be garbage collected until the end of the method.\u0026lt;br\u0026gt;\nSo, if you tried GC.Collect() and GC.WaitForPendingFinalizers() and it didn\u0026apos;t help, try to do the following:  \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;1) Try to run your project in Release mode and check if Excel closed correctly  \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;2) Wrap the method of working with Excel in a separate method.\nSo, instead of something like this:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;GenerateWorkbook\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;...\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n  ApplicationClass xl;\n  Workbook xlWB;\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n  {\n    xl = ...\n    xlWB = xl.Workbooks.Add(...);\n    ...\n  }\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt;\n  {\n    ...\n    Marshal.ReleaseComObject(xlWB)\n    ...\n    GC.Collect();\n    GC.WaitForPendingFinalizers();\n  }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;you write:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;GenerateWorkbook\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;...\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n  {\n    GenerateWorkbookInternal(...);\n  }\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt;\n  {\n    GC.Collect();\n    GC.WaitForPendingFinalizers();\n  }\n}\n\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;GenerateWorkbookInternal\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;...\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n  ApplicationClass xl;\n  Workbook xlWB;\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n  {\n    xl = ...\n    xlWB = xl.Workbooks.Add(...);\n    ...\n  }\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt;\n  {\n    ...\n    Marshal.ReleaseComObject(xlWB)\n    ...\n  }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Now, Excel will close =)\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;UPDATE\u0026lt;/strong\u0026gt;: Added C# code, and link to Windows Jobs\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I spent sometime trying to figure out this problem, and at the time XtremeVBTalk was the most active and responsive.  Here is a link to my original post, \u0026lt;a href=\u0026quot;http://www.xtremevbtalk.com/showpost.php?p=1335552\u0026amp;amp;postcount=22\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;Closing an Excel Interop process cleanly, even if your application crashes\u0026lt;/a\u0026gt;. Below is a summary of the post, and the code copied to this post. \u0026lt;/p\u0026gt;\n\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Closing the Interop process with \u0026lt;code\u0026gt;Application.Quit()\u0026lt;/code\u0026gt; and \u0026lt;code\u0026gt;Process.Kill()\u0026lt;/code\u0026gt; works for the most part, but fails if the applications crashes catastrophically. I.e. if the app crashes, the Excel process will still be running loose.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;The solution is to let the OS handle the cleanup of your processes through \u0026lt;a href=\u0026quot;http://msdn.microsoft.com/en-us/library/ms682409(VS.85).aspx\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;Windows Job Objects\u0026lt;/a\u0026gt; using Win32 calls.  When your main application dies, the associated processes (i.e. Excel) will get terminated as well.  \u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\n\u0026lt;p\u0026gt;I found this to be a clean solution because the OS is doing real work of cleaning up.  All you have to do is \u0026lt;em\u0026gt;register\u0026lt;/em\u0026gt; the Excel process.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Windows Job Code\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Wraps the Win32 API Calls to register Interop processes.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;enum\u0026lt;/span\u0026gt; JobObjectInfoType\n{\n    AssociateCompletionPortInformation = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;7\u0026lt;/span\u0026gt;,\n    BasicLimitInformation = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;,\n    BasicUIRestrictions = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt;,\n    EndOfJobTimeInformation = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6\u0026lt;/span\u0026gt;,\n    ExtendedLimitInformation = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;9\u0026lt;/span\u0026gt;,\n    SecurityLimitInformation = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;,\n    GroupInformation = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;11\u0026lt;/span\u0026gt;\n}\n\n[\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;StructLayout(LayoutKind.Sequential)\u0026lt;/span\u0026gt;]\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;struct\u0026lt;/span\u0026gt; SECURITY_ATTRIBUTES\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; nLength;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; IntPtr lpSecurityDescriptor;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; bInheritHandle;\n}\n\n[\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;StructLayout(LayoutKind.Sequential)\u0026lt;/span\u0026gt;]\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;struct\u0026lt;/span\u0026gt; JOBOBJECT_BASIC_LIMIT_INFORMATION\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; Int64 PerProcessUserTimeLimit;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; Int64 PerJobUserTimeLimit;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; Int16 LimitFlags;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt32 MinimumWorkingSetSize;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt32 MaximumWorkingSetSize;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; Int16 ActiveProcessLimit;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; Int64 Affinity;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; Int16 PriorityClass;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; Int16 SchedulingClass;\n}\n\n[\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;StructLayout(LayoutKind.Sequential)\u0026lt;/span\u0026gt;]\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;struct\u0026lt;/span\u0026gt; IO_COUNTERS\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt64 ReadOperationCount;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt64 WriteOperationCount;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt64 OtherOperationCount;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt64 ReadTransferCount;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt64 WriteTransferCount;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt64 OtherTransferCount;\n}\n\n[\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;StructLayout(LayoutKind.Sequential)\u0026lt;/span\u0026gt;]\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;struct\u0026lt;/span\u0026gt; JOBOBJECT_EXTENDED_LIMIT_INFORMATION\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; JOBOBJECT_BASIC_LIMIT_INFORMATION BasicLimitInformation;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; IO_COUNTERS IoInfo;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt32 ProcessMemoryLimit;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt32 JobMemoryLimit;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt32 PeakProcessMemoryUsed;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; UInt32 PeakJobMemoryUsed;\n}\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;class\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Job\u0026lt;/span\u0026gt; : \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;IDisposable\u0026lt;/span\u0026gt;\n{\n    [\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;DllImport(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;kernel32.dll\u0026quot;\u0026lt;/span\u0026gt;, CharSet = CharSet.Unicode)\u0026lt;/span\u0026gt;]\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;extern\u0026lt;/span\u0026gt; IntPtr \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;CreateJobObject\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;object\u0026lt;/span\u0026gt; a, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt; lpName\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;;\n\n    [\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;DllImport(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;kernel32.dll\u0026quot;\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;]\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;extern\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;SetInformationJobObject\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;IntPtr hJob, JobObjectInfoType infoType, IntPtr lpJobObjectInfo, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt; cbJobObjectInfoLength\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;;\n\n    [\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;DllImport(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;kernel32.dll\u0026quot;\u0026lt;/span\u0026gt;, SetLastError = true)\u0026lt;/span\u0026gt;]\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;extern\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;AssignProcessToJobObject\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;IntPtr job, IntPtr process\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; IntPtr m_handle;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; m_disposed = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Job\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        m_handle = CreateJobObject(\u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;);\n\n        JOBOBJECT_BASIC_LIMIT_INFORMATION info = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; JOBOBJECT_BASIC_LIMIT_INFORMATION();\n        info.LimitFlags = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0x2000\u0026lt;/span\u0026gt;;\n\n        JOBOBJECT_EXTENDED_LIMIT_INFORMATION extendedInfo = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; JOBOBJECT_EXTENDED_LIMIT_INFORMATION();\n        extendedInfo.BasicLimitInformation = info;\n\n        \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; length = Marshal.SizeOf(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;typeof\u0026lt;/span\u0026gt;(JOBOBJECT_EXTENDED_LIMIT_INFORMATION));\n        IntPtr extendedInfoPtr = Marshal.AllocHGlobal(length);\n        Marshal.StructureToPtr(extendedInfo, extendedInfoPtr, \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;);\n\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (!SetInformationJobObject(m_handle, JobObjectInfoType.ExtendedLimitInformation, extendedInfoPtr, (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt;)length))\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;throw\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Exception(\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt;.Format(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;Unable to set information.  Error: {0}\u0026quot;\u0026lt;/span\u0026gt;, Marshal.GetLastWin32Error()));\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;#\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;region\u0026lt;/span\u0026gt; IDisposable Members\u0026lt;/span\u0026gt;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Dispose\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        Dispose(\u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;);\n        GC.SuppressFinalize(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;this\u0026lt;/span\u0026gt;);\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;#\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;endregion\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Dispose\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; disposing\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (m_disposed)\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt;;\n\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (disposing) {}\n\n        Close();\n        m_disposed = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;;\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Close\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        Win32.CloseHandle(m_handle);\n        m_handle = IntPtr.Zero;\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;AddProcess\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;IntPtr handle\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; AssignProcessToJobObject(m_handle, handle);\n    }\n\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Note about Constructor code\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;In the constructor, the \u0026lt;code\u0026gt;info.LimitFlags = 0x2000;\u0026lt;/code\u0026gt; is called. \u0026lt;code\u0026gt;0x2000\u0026lt;/code\u0026gt; is the \u0026lt;code\u0026gt;JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE\u0026lt;/code\u0026gt; enum value, and this value is defined by \u0026lt;a href=\u0026quot;http://msdn.microsoft.com/en-us/library/windows/desktop/ms684147(v=vs.85).aspx\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;MSDN\u0026lt;/a\u0026gt; as:\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;Causes all processes associated with the job to terminate when the\n  last handle to the job is closed.\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Extra Win32 API Call to get the Process ID (PID)\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;    [\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;DllImport(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;user32.dll\u0026quot;\u0026lt;/span\u0026gt;, SetLastError = true)\u0026lt;/span\u0026gt;]\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;extern\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;GetWindowThreadProcessId\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;IntPtr hWnd, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt; lpdwProcessId\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Using the code\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;    Excel.Application app = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Excel.ApplicationClass();\n    Job job = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Job();\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;uint\u0026lt;/span\u0026gt; pid = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n    Win32.GetWindowThreadProcessId(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; IntPtr(app.Hwnd), \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; pid);\n    job.AddProcess(Process.GetProcessById((\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;)pid).Handle);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This worked for a project I was working on:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;excelApp.Quit();\nMarshal.ReleaseComObject (excelWB);\nMarshal.ReleaseComObject (excelApp);\nexcelApp = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;We learned that it was important to set \u0026lt;strong\u0026gt;every\u0026lt;/strong\u0026gt; reference to an Excel COM object to null when you were done with it. This included Cells, Sheets, and everything.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;First - you \u0026lt;em\u0026gt;never\u0026lt;/em\u0026gt; have to call \u0026lt;code\u0026gt;Marshal.ReleaseComObject(...)\u0026lt;/code\u0026gt; or \u0026lt;code\u0026gt;Marshal.FinalReleaseComObject(...)\u0026lt;/code\u0026gt; when doing Excel interop. It is a confusing anti-pattern, but any information about this, including from Microsoft, that indicates you have to manually release COM references from .NET is incorrect. The fact is that the .NET runtime and garbage collector correctly keep track of and clean up COM references. For your code, this means you can remove the whole `while (...) loop at the top.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Second, if you want to ensure that the COM references to an out-of-process COM object are cleaned up when your process ends (so that the Excel process will close), you need to ensure that the garbage collector runs. You do this correctly with calls to \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; and \u0026lt;code\u0026gt;GC.WaitForPendingFinalizers()\u0026lt;/code\u0026gt;. Calling this twice is safe, and ensures that cycles are definitely cleaned up too (though I\u0026apos;m not sure it\u0026apos;s needed, and would appreciate an example that shows this).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Third, when running under the debugger, local references will be artificially kept alive until the end of the method (so that local variable inspection works). So  \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; calls are not effective for cleaning object like \u0026lt;code\u0026gt;rng.Cells\u0026lt;/code\u0026gt; from the same method. You should split the code doing the COM interop from the GC cleanup into separate methods. (This was a key discovery for me, from one part of the answer posted here by @nightcoder.)\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;The general pattern would thus be:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;Sub \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;WrapperThatCleansUp\u0026lt;/span\u0026gt;()\n\n    \u0026apos; NOTE: Don\u0026apos;t call Excel objects \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; here... \n    \u0026apos;       Debugger would keep alive until end, preventing GC cleanup\n\n    \u0026apos; Call a separate function that talks to Excel\n    \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;DoTheWork\u0026lt;/span\u0026gt;()\n\n    \u0026apos; Now \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;let\u0026lt;/span\u0026gt; the GC clean \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;up\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;twice, to clean up cycles too\u0026lt;/span\u0026gt;)\n    GC.\u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Collect\u0026lt;/span\u0026gt;()    \n    GC.\u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;WaitForPendingFinalizers\u0026lt;/span\u0026gt;()\n    GC.\u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Collect\u0026lt;/span\u0026gt;()    \n    GC.\u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;WaitForPendingFinalizers\u0026lt;/span\u0026gt;()\n\nEnd Sub\n\nSub \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;DoTheWork\u0026lt;/span\u0026gt;()\n    Dim app As New Microsoft.Office.Interop.Excel.Application\n    Dim book As Microsoft.Office.Interop.Excel.Workbook\u0026lt;/span\u0026gt; = app.Workbooks.Add()\n    Dim worksheet As Microsoft.Office.Interop.Excel.Worksheet = book.Worksheets(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;Sheet1\u0026quot;\u0026lt;/span\u0026gt;)\n    app.Visible = True\n    For i As Integer = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt; To \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;\n        worksheet.Cells.Range(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;A\u0026quot;\u0026lt;/span\u0026gt; \u0026amp;amp; i).Value = \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;Hello\u0026quot;\u0026lt;/span\u0026gt;\n    Next\n    book.Save()\n    book.Close()\n    app.Quit()\n\n    \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos; NOTE: No calls the Marshal.ReleaseComObject() are ever needed\nEnd Sub\n\u0026lt;/span\u0026gt;\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;There is a lot of false information and confusion about this issue, including many posts on MSDN and on Stack Overflow (and especially this question!).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;What finally convinced me to have a closer look and figure out the right advice was blog post \u0026lt;em\u0026gt;\u0026lt;a href=\u0026quot;https://blogs.msdn.microsoft.com/visualstudio/2010/03/01/marshal-releasecomobject-considered-dangerous/\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;Marshal.ReleaseComObject Considered Dangerous\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt; together with finding the issue with references kept alive under the debugger that was confusing my earlier testing.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Anything that is in the Excel namespace needs to be released. Period\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;You can\u0026apos;t be doing:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;Worksheet ws = excel.WorkBooks[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;].WorkSheets[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;];\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;You have to be doing\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;Workbooks books = excel.WorkBooks;\nWorkbook book = books[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;];\nSheets sheets = book.WorkSheets;\nWorksheet ws = sheets[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;];\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;followed by the releasing of the objects.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I \u0026lt;a href=\u0026quot;http://www.deez.info/sengelha/2005/02/11/useful-idisposable-class-3-autoreleasecomobject/\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;found\u0026lt;/a\u0026gt; a useful generic template that can help implement the correct disposal pattern for COM objects, that need Marshal.ReleaseComObject called when they go out of scope:\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Usage:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;using\u0026lt;/span\u0026gt; (AutoReleaseComObject\u0026amp;lt;Application\u0026amp;gt; excelApplicationWrapper = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; AutoReleaseComObject\u0026amp;lt;Application\u0026amp;gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Application()))\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;using\u0026lt;/span\u0026gt; (AutoReleaseComObject\u0026amp;lt;Workbook\u0026amp;gt; workbookWrapper = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; AutoReleaseComObject\u0026amp;lt;Workbook\u0026amp;gt;(excelApplicationWrapper.ComObject.Workbooks.Open(namedRangeBase.FullName, \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;, missing, missing, missing, \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;, missing, missing, \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;, missing, missing, missing, missing, missing)))\n        {\n           \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// do something with your workbook....\u0026lt;/span\u0026gt;\n        }\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt;\n    {\n         excelApplicationWrapper.ComObject.Quit();\n    } \n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Template:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;class\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;AutoReleaseComObject\u0026lt;/span\u0026gt;\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;T\u0026lt;/span\u0026gt;\u0026amp;gt; : \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;IDisposable\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; T m_comObject;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; m_armed = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; m_disposed = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;AutoReleaseComObject\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;T comObject\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n    {\n        Debug.Assert(comObject != \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;);\n        m_comObject = comObject;\n    }\n\n\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;#\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; DEBUG\u0026lt;/span\u0026gt;\n    ~AutoReleaseComObject()\n    {\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// We should have been disposed using Dispose().\u0026lt;/span\u0026gt;\n        Debug.WriteLine(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;Finalize being called, should have been disposed\u0026quot;\u0026lt;/span\u0026gt;);\n\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;this\u0026lt;/span\u0026gt;.ComObject != \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;)\n        {\n            Debug.WriteLine(\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt;.Format(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;ComObject was not null:{0}, name:{1}.\u0026quot;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;this\u0026lt;/span\u0026gt;.ComObject, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;this\u0026lt;/span\u0026gt;.ComObjectName));\n        }\n\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;//Debug.Assert(false);\u0026lt;/span\u0026gt;\n    }\n\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;#\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;endif\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; T ComObject\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;get\u0026lt;/span\u0026gt;\n        {\n            Debug.Assert(!m_disposed);\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; m_comObject;\n        }\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt; ComObjectName\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;get\u0026lt;/span\u0026gt;\n        {\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;this\u0026lt;/span\u0026gt;.ComObject \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;is\u0026lt;/span\u0026gt; Microsoft.Office.Interop.Excel.Workbook)\n            {\n                \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; ((Microsoft.Office.Interop.Excel.Workbook)\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;this\u0026lt;/span\u0026gt;.ComObject).Name;\n            }\n\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n        }\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Disarm\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        Debug.Assert(!m_disposed);\n        m_armed = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;;\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;#\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;region\u0026lt;/span\u0026gt; IDisposable Members\u0026lt;/span\u0026gt;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Dispose\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        Dispose(\u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;#\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; DEBUG\u0026lt;/span\u0026gt;\n        GC.SuppressFinalize(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;this\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;#\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;endif\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;#\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;endregion\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;protected\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;virtual\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Dispose\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;bool\u0026lt;/span\u0026gt; disposing\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (!m_disposed)\n        {\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (m_armed)\n            {\n                \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; refcnt = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n                \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;do\u0026lt;/span\u0026gt;\n                {\n                    refcnt = System.Runtime.InteropServices.Marshal.ReleaseComObject(m_comObject);\n                } \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (refcnt \u0026amp;gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;);\n\n                m_comObject = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;default\u0026lt;/span\u0026gt;(T);\n            }\n\n            m_disposed = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;;\n        }\n    }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Reference:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;http://www.deez.info/sengelha/2005/02/11/useful-idisposable-class-3-autoreleasecomobject/\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;http://www.deez.info/sengelha/2005/02/11/useful-idisposable-class-3-autoreleasecomobject/\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I cant believe this problem has haunted the world for 5 years.... If you have created an application, you need to shut it down first before removing the link.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;objExcel = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Excel.Application();  \nobjBook = (Excel.Workbook)(objExcel.Workbooks.Add(Type.Missing)); \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;when closing\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;objBook.Close(\u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;, Type.Missing, Type.Missing); \nobjExcel.Application.Quit();\nobjExcel.Quit(); \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;When you new an excel application, it opens a excel program in the background. You need to command that excel program to quit before you release the link because that excel program is not part of your direct control. Therefore, it will stay open if the link is released!\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Good programming everyone~~\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Common developers, none of your solutions worked for me, \nso I decide to implement a new \u0026lt;strong\u0026gt;trick\u0026lt;/strong\u0026gt;.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;First let specify \u0026quot;What is our goal?\u0026quot; =\u0026amp;gt; \u0026quot;Not to see excel object after our job in task manager\u0026quot; \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Ok. Let no to challenge and start destroying it, but consider not to destroy other instance os Excel which are running in parallel.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;So , get the list of current processors and fetch PID of EXCEL processes , then once your job is done, we have a new guest in processes list with a unique PID ,find and destroy just that one.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026amp;lt; keep in mind any new excel process during your excel job will be detected as new and destroyed \u0026amp;gt;\n \u0026amp;lt; A better solution is to capture PID of new created excel object and just destroy that\u0026amp;gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;Process[] prs = Process.GetProcesses();\nList\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt; excelPID = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; List\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;();\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (Process p \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; prs)\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (p.ProcessName == \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;EXCEL\u0026quot;\u0026lt;/span\u0026gt;)\n       excelPID.Add(p.Id);\n\n.... \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// your job \u0026lt;/span\u0026gt;\n\nprs = Process.GetProcesses();\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (Process p \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; prs)\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (p.ProcessName == \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;EXCEL\u0026quot;\u0026lt;/span\u0026gt; \u0026amp;amp;\u0026amp;amp; !excelPID.Contains(p.Id))\n       p.Kill();\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;This resolves my issue, hope yours too.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This sure seems like it has been over-complicated. From my experience, there are just three key things to get Excel to close properly:\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;1: make sure there are no remaining references to the excel application you created (you should only have one anyway; set it to \u0026lt;code\u0026gt;null\u0026lt;/code\u0026gt;)\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;2: call \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;3: Excel has to be closed, either by the user manually closing the program, or by you calling \u0026lt;code\u0026gt;Quit\u0026lt;/code\u0026gt; on the Excel object. (Note that \u0026lt;code\u0026gt;Quit\u0026lt;/code\u0026gt; will function just as if the user tried to close the program, and will present a confirmation dialog if there are unsaved changes, even if Excel is not visible. The user could press cancel, and then Excel will not have been closed.)\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;1 needs to happen before 2, but 3 can happen anytime.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;One way to implement this is to wrap the interop Excel object with your own class, create the interop instance in the constructor, and implement IDisposable with Dispose looking something like\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (!mDisposed) {\n   mExcel = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n   GC.Collect();\n   mDisposed = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;;\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;That will clean up excel from your program\u0026apos;s side of things. Once Excel is closed (manually by the user or by you calling \u0026lt;code\u0026gt;Quit\u0026lt;/code\u0026gt;) the process will go away. If the program has already been closed, then the process will disappear on the \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; call.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;(I\u0026apos;m not sure how important it is, but you may want a \u0026lt;code\u0026gt;GC.WaitForPendingFinalizers()\u0026lt;/code\u0026gt; call after the \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; call but it is not strictly necessary to get rid of the Excel process.)\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;This has worked for me without issue for years. Keep in mind though that while this works, you actually have to close gracefully for it to work. You will still get accumulating excel.exe processes if you interrupt your program before Excel is cleaned up (usually by hitting \u0026quot;stop\u0026quot; while your program is being debugged).\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I\u0026apos;ve traditionally followed the advice found in \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/158752/741988\u0026quot;\u0026gt;VVS\u0026apos;s answer\u0026lt;/a\u0026gt;.  However, in an effort to keep this answer up-to-date with the latest options, I think all my future projects will use the \u0026quot;NetOffice\u0026quot; library.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://osdn.net/projects/netoffice/\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;NetOffice\u0026lt;/a\u0026gt; is a complete replacement for the Office PIAs and is completely version-agnostic. It\u0026apos;s a collection of Managed COM wrappers that can handle the cleanup that often causes such headaches when working with Microsoft Office in .NET.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Some key features are:\u0026lt;/p\u0026gt;\n\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Mostly version-independent (and version-dependant features are documented)\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;No dependencies\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;No PIA\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;No registration\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;No VSTO\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\n\u0026lt;p\u0026gt;I am in no way affiliated with the project; I just genuinely appreciate the stark reduction in headaches.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;To add to reasons why Excel does not close, even when you create direct refrences to each object upon read, creation, is the \u0026apos;For\u0026apos; loop.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;For Each objWorkBook As WorkBook \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; objWorkBooks \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;local ref, created from ExcelApp.WorkBooks to avoid the double-dot\n   objWorkBook.Close \u0026apos;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;or\u0026lt;/span\u0026gt; whatever\n   \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;FinalReleaseComObject\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;objWorkBook\u0026lt;/span\u0026gt;)\n   objWorkBook\u0026lt;/span\u0026gt; = Nothing\nNext \n\n\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;The above does not work, and this is the workaround:\n\nFor intCounter As Integer = 1 To mobjExcel_WorkBooks.Count\n   Dim objTempWorkBook As Workbook = mobjExcel_WorkBooks.Item(intCounter)\n   objTempWorkBook.Saved = True\n   objTempWorkBook.Close(False, Type.Missing, Type.Missing)\n   FinalReleaseComObject(objTempWorkBook)\n   objTempWorkBook = Nothing\nNext\n\u0026lt;/span\u0026gt;\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The accepted answer here is correct, but also take note that not only \u0026quot;two dot\u0026quot; references need to be avoided, but also objects that are retrieved via the index.  You also do not need to wait until you are finished with the program to clean up these objects, it\u0026apos;s best to create functions that will clean them up as soon as you\u0026apos;re finished with them, when possible.  Here is a function I created that assigns some properties of a Style object called \u0026lt;code\u0026gt;xlStyleHeader\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; Excel.Style xlStyleHeader = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;CreateHeaderStyle\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n{\n    Excel.Styles xlStyles = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n    Excel.Font xlFont = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n    Excel.Interior xlInterior = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n    Excel.Borders xlBorders = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n    Excel.Border xlBorderBottom = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n    {\n        xlStyles = xlWorkbook.Styles;\n        xlStyleHeader = xlStyles.Add(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;Header\u0026quot;\u0026lt;/span\u0026gt;, Type.Missing);\n\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Text Format\u0026lt;/span\u0026gt;\n        xlStyleHeader.NumberFormat = \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;@\u0026quot;\u0026lt;/span\u0026gt;;\n\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Bold\u0026lt;/span\u0026gt;\n        xlFont = xlStyleHeader.Font;\n        xlFont.Bold = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;;\n\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Light Gray Cell Color\u0026lt;/span\u0026gt;\n        xlInterior = xlStyleHeader.Interior;\n        xlInterior.Color = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12632256\u0026lt;/span\u0026gt;;\n\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Medium Bottom border\u0026lt;/span\u0026gt;\n        xlBorders = xlStyleHeader.Borders;\n        xlBorderBottom = xlBorders[Excel.XlBordersIndex.xlEdgeBottom];\n        xlBorderBottom.Weight = Excel.XlBorderWeight.xlMedium;\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;catch\u0026lt;/span\u0026gt; (Exception ex)\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;throw\u0026lt;/span\u0026gt; ex;\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt;\n    {\n        Release(xlBorderBottom);\n        Release(xlBorders);\n        Release(xlInterior);\n        Release(xlFont);\n        Release(xlStyles);\n    }\n}\n\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Release\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;object\u0026lt;/span\u0026gt; obj\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Errors are ignored per Microsoft\u0026apos;s suggestion for this type of function:\u0026lt;/span\u0026gt;\n    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// http://support.microsoft.com/default.aspx/kb/317109\u0026lt;/span\u0026gt;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n    {\n        System.Runtime.InteropServices.Marshal.ReleaseComObject(obj);\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;catch\u0026lt;/span\u0026gt; { } \n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Notice that I had to set \u0026lt;code\u0026gt;xlBorders[Excel.XlBordersIndex.xlEdgeBottom]\u0026lt;/code\u0026gt; to a variable in order to clean that up (Not because of the two dots, which refer to an enumeration which does not need to be released, but because the object I\u0026apos;m referring to is actually a Border object that does need to be released).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;This sort of thing is not really necessary in standard applications, which do a great job of cleaning up after themselves, but in ASP.NET applications, if you miss even one of these, no matter how often you call the garbage collector, Excel will still be running on your server.  \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;It requires a lot of attention to detail and many test executions while monitoring the Task Manager when writing this code, but doing so saves you the hassle of desperately searching through pages of code to find the one instance you missed.  This is especially important when working in loops, where you need to release EACH INSTANCE of an object, even though it uses the same variable name each time it loops.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;After trying\u0026lt;/p\u0026gt;\n\n\u0026lt;ol\u0026gt;\n\u0026lt;li\u0026gt;Release COM objects in reverse order\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Add \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; and \u0026lt;code\u0026gt;GC.WaitForPendingFinalizers()\u0026lt;/code\u0026gt; twice at the end\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;No more than two dots\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Close workbook and quit application\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Run in release mode\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\n\u0026lt;p\u0026gt;the final solution that works for me is to move one set of\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;GC.Collect();\nGC.WaitForPendingFinalizers();\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;that we added to the end of the function to a wrapper, as follows:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;FunctionWrapper\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt; sourcePath, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt; targetPath\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n    {\n        FunctionThatCallsExcel(sourcePath, targetPath);\n    }\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt;\n    {\n        GC.Collect();\n        GC.WaitForPendingFinalizers();\n    }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I followed this exactly... But I still ran into issues 1 out of 1000 times. Who knows why. Time to bring out the hammer...\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Right after the Excel Application class is instantiated I get a hold of the Excel process that was just created.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;excel = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Microsoft.Office.Interop.Excel.Application();\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; process = Process.GetProcessesByName(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;EXCEL\u0026quot;\u0026lt;/span\u0026gt;).OrderByDescending(p =\u0026amp;gt; p.StartTime).First();\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Then once I\u0026apos;ve done all the above COM clean-up, I make sure that process isn\u0026apos;t running. If it is still running, kill it!\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (!process.HasExited)\n   process.Kill();\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;¨°º¤ø¸ Shoot Excel proc and chew bubble gum ¸ø¤º°¨\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;class\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;MyExcelInteropClass\u0026lt;/span\u0026gt;\n{\n    Excel.Application xlApp;\n    Excel.Workbook xlBook;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;dothingswithExcel\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt; \n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt; { \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;/* Do stuff manipulating cells sheets and workbooks ... */\u0026lt;/span\u0026gt; }\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;catch\u0026lt;/span\u0026gt; {}\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt; {KillExcelProcess(xlApp);}\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;KillExcelProcess\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;Excel.Application xlApp\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (xlApp != \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;)\n        {\n            \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; excelProcessId = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n            GetWindowThreadProcessId(xlApp.Hwnd, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; excelProcessId);\n            Process p = Process.GetProcessById(excelProcessId);\n            p.Kill();\n            xlApp = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n        }\n    }\n\n    [\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;DllImport(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;user32.dll\u0026quot;\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;]\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;extern\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;GetWindowThreadProcessId\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; hWnd, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; lpdwProcessId\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;;\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;You need to be aware that Excel is very sensitive to the culture you are running under as well.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;You may find that you need to set the culture to EN-US before calling Excel functions.\nThis does not apply to all functions - but some of them.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;    CultureInfo en_US = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; System.Globalization.CultureInfo(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;en-US\u0026quot;\u0026lt;/span\u0026gt;); \n    System.Threading.Thread.CurrentThread.CurrentCulture = en_US;\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt; filePathLocal = _applicationObject.ActiveWorkbook.Path;\n    System.Threading.Thread.CurrentThread.CurrentCulture = orgCulture;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;This applies even if you are using VSTO.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;For details: \u0026lt;a href=\u0026quot;http://support.microsoft.com/default.aspx?scid=kb;en-us;Q320369\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;http://support.microsoft.com/default.aspx?scid=kb;en-us;Q320369\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;\u0026quot;Never use two dots with COM objects\u0026quot; is a great rule of thumb to avoid leakage of COM references, but Excel PIA can lead to leakage in more ways than apparent at first sight.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;One of these ways is subscribing to any event exposed by any of the Excel object model\u0026apos;s COM objects.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;For example, subscribing to the Application class\u0026apos;s WorkbookOpen event.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;Some theory on COM events\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;COM classes expose a group of events through call-back interfaces. In order to subscribe to events, the client code can simply register an object implementing the call-back interface and the COM class will invoke its methods in response to specific events. Since the call-back interface is a COM interface, it is the duty of the implementing object to decrement the reference count of any COM object it receives (as a parameter) for any of the event handlers.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;How Excel PIA expose COM Events\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;Excel PIA exposes COM events of Excel Application class as conventional .NET events. Whenever the client code subscribes to \u0026lt;strong\u0026gt;a .NET event\u0026lt;/strong\u0026gt; (emphasis on \u0026apos;a\u0026apos;), PIA creates \u0026lt;strong\u0026gt;an\u0026lt;/strong\u0026gt; instance of a class implementing the call-back interface and registers it with Excel.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Hence, a number of call-back objects get registered with Excel in response to different subscription requests from the .NET code. One call-back object per event subscription.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;A call-back interface for event handling means that, PIA has to subscribe to all interface events for every .NET event subscription request. It cannot pick and choose. On receiving an event call-back, the call-back object checks if the associated .NET event handler is interested in the current event or not and then either invokes the handler or silently ignores the call-back.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;Effect on COM instance reference counts\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;All these call-back objects do not decrement the reference count of any of the COM objects they receive (as parameters) for any of the call-back methods (even for the ones that are silently ignored). They rely solely on the \u0026lt;a href=\u0026quot;http://en.wikipedia.org/wiki/Common_Language_Runtime\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;CLR\u0026lt;/a\u0026gt; garbage collector to free up the COM objects.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Since GC run is non-deterministic, this can lead to the holding off of Excel process for a longer duration than desired and create an impression of a \u0026apos;memory leak\u0026apos;.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;Solution\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;The only solution as of now is to avoid the PIAs event provider for the COM class and write your own event provider which deterministically releases COM objects.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;For the Application class, this can be done by implementing the AppEvents interface and then registering the implementation with Excel by using \u0026lt;a href=\u0026quot;http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.comtypes.iconnectionpointcontainer.aspx\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;IConnectionPointContainer interface\u0026lt;/a\u0026gt;. The Application class (and for that matter all COM objects exposing events using callback mechanism) implements the IConnectionPointContainer interface.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;As others have pointed out, you need to create an explicit reference for every Excel object you use, and call Marshal.ReleaseComObject on that reference, as described in \u0026lt;a href=\u0026quot;http://support.microsoft.com/default.aspx/kb/317109\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;this KB article\u0026lt;/a\u0026gt;.  You also need to use try/finally to ensure ReleaseComObject is always called, even when an exception is thrown.  I.e. instead of:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;Worksheet sheet = excelApp.Worksheets(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;)\n... \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;do\u0026lt;/span\u0026gt; something \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;with\u0026lt;/span\u0026gt; sheet\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;you need to do something like:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;Worksheets sheets = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\nWorksheet sheet = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n{ \n    sheets = excelApp.Worksheets;\n    sheet = sheets(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;);\n    ...\n}\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (sheets != \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;) Marshal.ReleaseComObject(sheets);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (sheet != \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;) Marshal.ReleaseComObject(sheet);\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;You also need to call Application.Quit before releasing the Application object if you want Excel to close.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;As you can see, this quickly becomes extremely unwieldy as soon as you try to do anything even moderately complex.  I have successfully developed .NET applications with a simple wrapper class that wraps a few simple manipulations of the Excel object model (open a workbook, write to a Range, save/close the workbook etc).  The wrapper class implements IDisposable, carefully implements Marshal.ReleaseComObject on every object it uses, and does not pubicly expose any Excel objects to the rest of the app.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;But this approach doesn\u0026apos;t scale well for more complex requirements.  \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;This is a big deficiency of .NET COM Interop.  For more complex scenarios, I would seriously consider writing an ActiveX DLL in VB6 or other unmanaged language to which you can delegate all interaction with out-proc COM objects such as Office.  You can then reference this ActiveX DLL from your .NET application, and things will be much easier as you will only need to release this one reference.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;When all the stuff above didn\u0026apos;t work, try giving Excel some time to close its sheets:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;app.workbooks.Close();\nThread.Sleep(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt;); \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// adjust, for me it works at around 300+\u0026lt;/span\u0026gt;\napp.Quit();\n\n...\nFinalReleaseComObject(app);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Make sure that you release all objects related to Excel!\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I spent a few hours by trying several ways. All are great ideas but I finally found my mistake: \u0026lt;strong\u0026gt;If you don\u0026apos;t release all objects, none of the ways above can help you\u0026lt;/strong\u0026gt; like in my case. Make sure you release all objects including range one!\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;Excel.Range rng = (Excel.Range)worksheet.Cells[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;];\nworksheet.Paste(rng, \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;);\nreleaseObject(rng);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;The options are together \u0026lt;a href=\u0026quot;http://birvesifir.com/2012/08/08/how-to-properly-clean-up-excel-interop-objects-in-c/\u0026quot; rel=\u0026quot;nofollow\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;A great article on releasing COM objects is \u0026lt;em\u0026gt;\u0026lt;a href=\u0026quot;http://msdn.microsoft.com/en-us/library/office/aa679807(v=office.12).aspx#officeinteroperabilitych2_part2_rco\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;2.5 Releasing COM Objects\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt; (MSDN).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;The method that I would advocate is to null your Excel.Interop references if they are non-local variables, and then call \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; and \u0026lt;code\u0026gt;GC.WaitForPendingFinalizers()\u0026lt;/code\u0026gt; twice. Locally scoped Interop variables will be taken care of automatically.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;This removes the need to keep a named reference for \u0026lt;strong\u0026gt;every\u0026lt;/strong\u0026gt; COM object.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Here\u0026apos;s an example taken from the article:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;class\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Test\u0026lt;/span\u0026gt; {\n\n    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// These instance variables must be nulled or Excel will not quit\u0026lt;/span\u0026gt;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; Excel.Application xl;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; Excel.Workbook book;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;DoSomething\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        xl = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Excel.Application();\n        xl.Visible = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;true\u0026lt;/span\u0026gt;;\n        book = xl.Workbooks.Add(Type.Missing);\n\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// These variables are locally scoped, so we need not worry about them.\u0026lt;/span\u0026gt;\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Notice I don\u0026apos;t care about using two dots.\u0026lt;/span\u0026gt;\n        Excel.Range rng = book.Worksheets[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;].UsedRange;\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;CleanUp\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        book = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n        xl.Quit();\n        xl = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n\n        GC.Collect();\n        GC.WaitForPendingFinalizers();\n        GC.Collect();\n        GC.WaitForPendingFinalizers();\n    }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;These words are straight from the article:\u0026lt;/p\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;In almost all situations, nulling the RCW reference and forcing a garbage collection will clean up properly. If you also call GC.WaitForPendingFinalizers, garbage collection will be as deterministic as you can make it. That is, you\u0026apos;ll be pretty sure exactly when the object has been cleaned upon the return from the second call to WaitForPendingFinalizers. As an alternative, you can use Marshal.ReleaseComObject. However, note that you are very unlikely to ever need to use this method.\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The two dots rule did not work for me. In my case I created a method to clean my resources as follows:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Clean\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n{\n    workBook.Close();\n    Marshall.ReleaseComObject(workBook);\n    excel.Quit();\n    CG.Collect();\n    CG.WaitForPendingFinalizers();\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;My solution\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;[\u0026lt;span class=\u0026quot;hljs-meta\u0026quot;\u0026gt;DllImport(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;user32.dll\u0026quot;\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;]\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;extern\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;GetWindowThreadProcessId\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; hWnd, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; lpdwProcessId\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;;\n\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;private\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;GenerateExcel\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; excel = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Microsoft.Office.Interop.Excel.Application();\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; id;\n    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Find the Excel Process Id (ath the end, you kill him\u0026lt;/span\u0026gt;\n    GetWindowThreadProcessId(excel.Hwnd, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;out\u0026lt;/span\u0026gt; id);\n    Process excelProcess = Process.GetProcessById(id);\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;try\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Your code\u0026lt;/span\u0026gt;\n}\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;finally\u0026lt;/span\u0026gt;\n{\n    excel.Quit();\n\n    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Kill him !\u0026lt;/span\u0026gt;\n    excelProcess.Kill();\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;You should be very careful using Word/Excel interop applications. After trying all the solutions we still had a lot of \u0026quot;WinWord\u0026quot; process left open on server (with more than 2000 users).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;After working on the problem for hours, I realized that if I open more than a couple of documents using \u0026lt;code\u0026gt;Word.ApplicationClass.Document.Open()\u0026lt;/code\u0026gt; on different threads simultaneously, IIS worker process (w3wp.exe) would crash leaving all WinWord processes open!\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;So I guess there is no absolute solution to this problem, but switching to other methods such as \u0026lt;a href=\u0026quot;https://en.wikipedia.org/wiki/Office_Open_XML\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;Office Open XML\u0026lt;/a\u0026gt; development.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The accepted answer did not work for me. The following code in the destructor did the job.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (xlApp != \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;)\n{\n    xlApp.Workbooks.Close();\n    xlApp.Quit();\n}\n\nSystem.Diagnostics.Process[] processArray = System.Diagnostics.Process.GetProcessesByName(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;EXCEL\u0026quot;\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (System.Diagnostics.Process process \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; processArray)\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (process.MainWindowTitle.Length == \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;) { process.Kill(); }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I am currently working on Office automation and have stumbled across a solution for this that works every time for me. It is simple and does not involve killing any processes.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;It seems that by merely looping through the current active processes, and in any way \u0026apos;accessing\u0026apos; an open Excel process, any stray hanging instance of Excel will be removed. The below code simply checks for processes where the name is \u0026apos;Excel\u0026apos;, then writes the MainWindowTitle property of the process to a string. This \u0026apos;interaction\u0026apos; with the process seems to make Windows catch up and abort the frozen instance of Excel. \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I run the below method just before the add-in which I am developing quits, as it fires it unloading event. It removes any hanging instances of Excel every time. In all honesty I am not entirely sure why this works, but it works well for me and could be placed at the end of any Excel application without having to worry about double dots, Marshal.ReleaseComObject, nor killing processes. I would be very interested in any suggestions as to why this is effective.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;SweepExcelProcesses\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n{           \n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (Process.GetProcessesByName(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;EXCEL\u0026quot;\u0026lt;/span\u0026gt;).Length != \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;)\n            {\n                Process[] processes = Process.GetProcesses();\n                \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (Process process \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; processes)\n                {\n                    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt; (process.ProcessName.ToString() == \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026quot;excel\u0026quot;\u0026lt;/span\u0026gt;)\n                    {                           \n                        \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt; title = process.MainWindowTitle;\n                    }\n                }\n            }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I think that some of that is just the way that the framework handles Office applications, but I could be wrong. On some days, some applications clean up the processes immediately, and other days it seems to wait until the application closes. In general, I quit paying attention to the details and just make sure that there aren\u0026apos;t any extra processes floating around at the end of the day.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Also, and maybe I\u0026apos;m over simplifying things, but I think you can just...\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;objExcel = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Excel.Application();\nobjBook = (Excel.Workbook)(objExcel.Workbooks.Add(Type.Missing));\nDoSomeStuff(objBook);\nSaveTheBook(objBook);\nobjBook.Close(\u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;false\u0026lt;/span\u0026gt;, Type.Missing, Type.Missing);\nobjExcel.Quit();\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Like I said earlier, I don\u0026apos;t tend to pay attention to the details of when the Excel process appears or disappears, but that usually works for me.  I also don\u0026apos;t like to keep Excel processes around for anything other than the minimal amount of time, but I\u0026apos;m probably just being paranoid on that.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;As some have probably already written, it\u0026apos;s not just important how you \u0026lt;em\u0026gt;close\u0026lt;/em\u0026gt; the Excel (object); it\u0026apos;s also important how you \u0026lt;em\u0026gt;open\u0026lt;/em\u0026gt; it and also by the type of the project.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;In a WPF application, basically the same code is working without or with very few problems.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I have a project in which the same Excel file is being processed several times for different parameter value - e.g. parsing it based on values inside a generic list. \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I put all Excel-related functions into the base class, and parser into a subclass (different parsers use common Excel functions). I didn\u0026apos;t want that Excel is opened and closed again for each item in a generic list, so I\u0026apos;ve opened it only once in the base class and close it in the subclass. I had problems when moving the code into a desktop application. I\u0026apos;ve tried many of the above mentioned solutions. \u0026lt;code\u0026gt;GC.Collect()\u0026lt;/code\u0026gt; was already implemented before, twice as suggested.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Then I\u0026apos;ve decided that I will move the code for opening Excel to a subclass. Instead of opening only once, now I create a new object (base class) and open Excel for every item and close it at the end. There is some performance penalty, but based on several tests Excel processes are closing without problems (in debug mode), so also temporary files are removed. I will continue with testing and write some more if I will get some updates.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;The bottom line is: You must also check the initialize code, especially if you have many classes, etc.\u0026lt;/p\u0026gt;\n    "],"id":531,"title":"How do I properly clean up Excel interop objects?","content":"\n                \n\u0026lt;p\u0026gt;I\u0026apos;m using the Excel interop in C# (\u0026lt;code\u0026gt;ApplicationClass\u0026lt;/code\u0026gt;) and have placed the following code in my finally clause:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (System.Runtime.InteropServices.Marshal.ReleaseComObject(excelSheet) != \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;) { }\nexcelSheet = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\nGC.Collect();\nGC.WaitForPendingFinalizers();\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Although this kind of works, the \u0026lt;code\u0026gt;Excel.exe\u0026lt;/code\u0026gt; process is still in the background even after I close Excel. It is only released once my application is manually closed.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;What am I doing wrong, or is there an alternative to ensure interop objects are properly disposed of?\u0026lt;/p\u0026gt;\n    ","slug":"how-do-i-properly-clean-up-excel-interop-objects-1657388329706","postType":"QUESTION","createdAt":"2022-07-09T17:38:49.000Z","updatedAt":"2022-07-09T17:38:49.000Z","tags":[{"id":2612,"name":"interop","slug":"interop","createdAt":"2022-07-09T17:38:49.000Z","updatedAt":"2022-07-09T17:38:49.000Z","Questions_Tags":{"questionId":531,"tagId":2612}},{"id":2613,"name":"com-interop","slug":"com-interop","createdAt":"2022-07-09T17:38:49.000Z","updatedAt":"2022-07-09T17:38:49.000Z","Questions_Tags":{"questionId":531,"tagId":2613}}],"relatedQuestions":[{"title":"How do I properly clean up Excel interop objects?","slug":"how-do-i-properly-clean-up-excel-interop-objects-1657388329706","tags":[{"name":"interop","Questions_Tags":{"questionId":531,"tagId":2612}},{"name":"com-interop","Questions_Tags":{"questionId":531,"tagId":2613}}]}]},"randomQuestions":[{"title":"How do I write a correct micro-benchmark in Java?","slug":"how-do-i-write-a-correct-micro-benchmark-in-java-1657384488725"},{"title":"\"Thinking in AngularJS\" if I have a jQuery background? [closed]","slug":"\"thinking-in-angularjs\"-if-i-have-a-jquery-background-closed-1657384761159"},{"title":"How do I install pip on Windows?","slug":"how-do-i-install-pip-on-windows-1657388147761"},{"title":"What is DOM Event delegation?","slug":"what-is-dom-event-delegation-1657387625599"},{"title":"How to deal with mysqli problems? mysqli_fetch_array(): Argument #1 must be of type mysqli_result","slug":"how-to-deal-with-mysqli-problems-mysqli_fetch_array():-argument-1-must-be-of-type-mysqli_result-1657384360922"},{"title":"How do I split a delimited string so I can access individual items?","slug":"how-do-i-split-a-delimited-string-so-i-can-access-individual-items-1657388042385"},{"title":"How can I prevent SQL injection in PHP?","slug":"how-can-i-prevent-sql-injection-in-php-1657384220094"},{"title":"How can I deserialize JSON with C#?","slug":"how-can-i-deserialize-json-with-c-1657388102941"},{"title":"Are dictionaries ordered in Python 3.6+?","slug":"are-dictionaries-ordered-in-python-3.6+-1657387834234"},{"title":"Switch between two frames in tkinter?","slug":"switch-between-two-frames-in-tkinter-1657388528781"},{"title":"Is floating point math broken?","slug":"is-floating-point-math-broken-1657384238910"},{"title":"What is the best algorithm for overriding GetHashCode?","slug":"what-is-the-best-algorithm-for-overriding-gethashcode-1657387848932"},{"title":"Disable same origin policy in Chrome","slug":"disable-same-origin-policy-in-chrome-1657387743804"},{"title":"Where and why do I have to put the \"template\" and \"typename\" keywords?","slug":"where-and-why-do-i-have-to-put-the-\"template\"-and-\"typename\"-keywords-1657384467606"},{"title":"Understanding slicing","slug":"understanding-slicing-1657384397680"},{"title":"How to get all possible combinations of a list’s elements?","slug":"how-to-get-all-possible-combinations-of-a-list's-elements-1657388271070"},{"title":"Detecting a mobile browser","slug":"detecting-a-mobile-browser-1657388460071"},{"title":"Why does std::getline() skip input after a formatted extraction?","slug":"why-does-std::getline()-skip-input-after-a-formatted-extraction-1657384756118"},{"title":"How do I detect collision in pygame?","slug":"how-do-i-detect-collision-in-pygame-1657387496338"},{"title":"Can you provide some examples of why it is hard to parse XML and HTML with a regex? [closed]","slug":"can-you-provide-some-examples-of-why-it-is-hard-to-parse-xml-and-html-with-a-regex-closed-1657388410824"}]},"__N_SSG":true},"page":"/questions/[slug]","query":{"slug":"how-do-i-properly-clean-up-excel-interop-objects-1657388329706"},"buildId":"DSpI0pSdXueTMCIVyw0q4","isFallback":false,"gsp":true,"locale":"en","locales":["en"],"defaultLocale":"en","scriptLoader":[]}</script></body></html>