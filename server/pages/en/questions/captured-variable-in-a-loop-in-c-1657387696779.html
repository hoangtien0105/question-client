<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@solutionschecker.com"/><meta name="twitter:creator" content="@solutionschecker.com"/><meta property="og:url" content="https://solutionschecker.com"/><meta property="og:type" content="website"/><meta property="og:image" content="https://solutionschecker.com/solutions-checker-banner.png"/><meta property="og:image:alt" content="Find the solution to any question. We focus on finding the fastest possible solution for users. Main topics like coding, learning. - solutionschecker.com"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","logo":"/logo.svg","url":"https://solutionschecker.com"}</script><link name="keywords" content="captured-variable,solutions checker, solution checker, how to, solution for, check for solution, resolve question, what is, what solution for, find solution"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://solutionschecker.com","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@id":"https://solutionschecker.com/questions","name":"Questions"}},{"@type":"ListItem","position":3,"item":{"@id":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779","name":"Questions"}}]}</script><title>Captured variable in a loop in C# | Solution Checker</title><meta name="robots" content="index,follow"/><meta name="description" content="I met an interesting issue about C#. I have code like below.

List&lt;Func&lt;int&gt;&gt; actions = new List&lt;Func&lt;int&gt;&gt;();

int variable = 0;
while (variable &lt; 5)
{
    actions.Add(() =&gt; variable * 2);
    ++ variable;
}

foreach (var act in actions)
{
    Console.WriteLine(act.Invoke());
}


I expect it to output 0, 2, 4, 6, 8. However, it actually outputs five 10s.

It seems that it is due to all actions referring to one captured variable. As a result, when they get invoked, they all have same output.

Is there a way to work round this limit to have each action instance have its own captured variable?
    "/><meta property="og:title" content="Captured variable in a loop in C# | Solution Checker"/><meta property="og:description" content="I met an interesting issue about C#. I have code like below.

List&lt;Func&lt;int&gt;&gt; actions = new List&lt;Func&lt;int&gt;&gt;();

int variable = 0;
while (variable &lt; 5)
{
    actions.Add(() =&gt; variable * 2);
    ++ variable;
}

foreach (var act in actions)
{
    Console.WriteLine(act.Invoke());
}


I expect it to output 0, 2, 4, 6, 8. However, it actually outputs five 10s.

It seems that it is due to all actions referring to one captured variable. As a result, when they get invoked, they all have same output.

Is there a way to work round this limit to have each action instance have its own captured variable?
    "/><script type="application/ld+json">{"@context":"https://schema.org","@type":"QAPage","mainEntity":{"name":"Captured variable in a loop in C#","text":"I met an interesting issue about C#. I have code like below.\n\nList&lt;Func&lt;int&gt;&gt; actions = new List&lt;Func&lt;int&gt;&gt;();\n\nint variable = 0;\nwhile (variable &lt; 5)\n{\n    actions.Add(() =&gt; variable * 2);\n    ++ variable;\n}\n\nforeach (var act in actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\n\nI expect it to output 0, 2, 4, 6, 8. However, it actually outputs five 10s.\n\nIt seems that it is due to all actions referring to one captured variable. As a result, when they get invoked, they all have same output.\n\nIs there a way to work round this limit to have each action instance have its own captured variable?\n    ","answerCount":10,"upVoteCount":500,"suggestedAnswer":[{"text":"Yes - take a copy of the variable inside the loop:\n\nwhile (variable &lt; 5)\n{\n    int copy = variable;\n    actions.Add(() =&gt; copy * 2);\n    ++ variable;\n}\n\n\nYou can think of it as if the C# compiler creates a &quot;new&quot; local variable every time it hits the variable declaration. In fact it&apos;ll create appropriate new closure objects, and it gets complicated (in terms of implementation) if you refer to variables in multiple scopes, but it works :)\n\nNote that a more common occurrence of this problem is using for or foreach:\n\nfor (int i=0; i &lt; 10; i++) // Just one variable\nforeach (string x in foo) // And again, despite how it reads out loud\n\n\nSee section 7.14.4.2 of the C# 3.0 spec for more details of this, and my article on closures has more examples too.\n\nNote that as of the C# 5 compiler and beyond (even when specifying an earlier version of C#), the behavior of foreach changed so you no longer need to make local copy. See this answer for more details.\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution1","@type":"Answer","upvoteCount":0},{"text":"I believe what you are experiencing is something known as Closure http://en.wikipedia.org/wiki/Closure_(computer_science). Your lamba has a reference to a variable which is scoped outside the function itself. Your lamba is not interpreted until you invoke it and once it is it will get the value the variable has at execution time.\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution2","@type":"Answer","upvoteCount":0},{"text":"Behind the scenes, the compiler is generating a class that represents the closure for your method call. It uses that single instance of the closure class for each iteration of the loop. The code looks something like this, which makes it easier to see why the bug happens:\n\nvoid Main()\n{\n    List&lt;Func&lt;int&gt;&gt; actions = new List&lt;Func&lt;int&gt;&gt;();\n\n    int variable = 0;\n\n    var closure = new CompilerGeneratedClosure();\n\n    Func&lt;int&gt; anonymousMethodAction = null;\n\n    while (closure.variable &lt; 5)\n    {\n        if(anonymousMethodAction == null)\n            anonymousMethodAction = new Func&lt;int&gt;(closure.YourAnonymousMethod);\n\n        //we&apos;re re-adding the same function \n        actions.Add(anonymousMethodAction);\n\n        ++closure.variable;\n    }\n\n    foreach (var act in actions)\n    {\n        Console.WriteLine(act.Invoke());\n    }\n}\n\nclass CompilerGeneratedClosure\n{\n    public int variable;\n\n    public int YourAnonymousMethod()\n    {\n        return this.variable * 2;\n    }\n}\n\n\nThis isn&apos;t actually the compiled code from your sample, but I&apos;ve examined my own code and this looks very much like what the compiler would actually generate.\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution3","@type":"Answer","upvoteCount":0},{"text":"The way around this is to store the value you need in a proxy variable, and have that variable get captured.\n\nI.E.\n\nwhile( variable &lt; 5 )\n{\n    int copy = variable;\n    actions.Add( () =&gt; copy * 2 );\n    ++variable;\n}\n\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution4","@type":"Answer","upvoteCount":0},{"text":"This has nothing to do with loops. \n\nThis behavior is triggered because you use a lambda expression () =&gt; variable * 2 where the outer scoped variable not actually defined in the lambda&apos;s inner scope. \n\nLambda expressions (in C#3+, as well as anonymous methods in C#2) still create actual methods. Passing variables to these methods involve some dilemmas (pass by value? pass by reference? C# goes with by reference - but this opens another problem where the reference can outlive the actual variable). What C# does to resolve all these dilemmas is to create a new helper class (&quot;closure&quot;) with fields corresponding to the local variables used in the lambda expressions, and methods corresponding to the actual lambda methods. Any changes to variable in your code is actually translated to change in that ClosureClass.variable\n\nSo your while loop keeps updating the ClosureClass.variable until it reaches 10, then you for loops executes the actions, which all operate on the same ClosureClass.variable.\n\nTo get your expected result, you need to create a separation between the loop variable, and the variable that is being closured. You can do this by introducing another variable, i.e.:\n\nList&lt;Func&lt;int&gt;&gt; actions = new List&lt;Func&lt;int&gt;&gt;();\nint variable = 0;\nwhile (variable &lt; 5)\n{\n    var t = variable; // now t will be closured (i.e. replaced by a field in the new class)\n    actions.Add(() =&gt; t * 2);\n    ++variable; // changing variable won&apos;t affect the closured variable t\n}\nforeach (var act in actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\n\nYou could also move the closure to another method to create this separation:\n\nList&lt;Func&lt;int&gt;&gt; actions = new List&lt;Func&lt;int&gt;&gt;();\n\nint variable = 0;\nwhile (variable &lt; 5)\n{\n    actions.Add(Mult(variable));\n    ++variable;\n}\n\nforeach (var act in actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\n\nYou can implement Mult as a lambda expression (implicit closure) \n\nstatic Func&lt;int&gt; Mult(int i)\n{\n    return () =&gt; i * 2;\n}\n\n\nor with an actual helper class:\n\npublic class Helper\n{\n    public int _i;\n    public Helper(int i)\n    {\n        _i = i;\n    }\n    public int Method()\n    {\n        return _i * 2;\n    }\n}\n\nstatic Func&lt;int&gt; Mult(int i)\n{\n    Helper help = new Helper(i);\n    return help.Method;\n}\n\n\nIn any case, &quot;Closures&quot; are NOT a concept related to loops, but rather to anonymous methods / lambda expressions use of local scoped variables - although some incautious use of loops demonstrate closures traps.\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution5","@type":"Answer","upvoteCount":0},{"text":"Yes you need to scope variable within the loop and pass it to the lambda that way:\n\nList&lt;Func&lt;int&gt;&gt; actions = new List&lt;Func&lt;int&gt;&gt;();\n\nint variable = 0;\nwhile (variable &lt; 5)\n{\n    int variable1 = variable;\n    actions.Add(() =&gt; variable1 * 2);\n    ++variable;\n}\n\nforeach (var act in actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\nConsole.ReadLine();\n\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution6","@type":"Answer","upvoteCount":0},{"text":"The same situation is happening in multi-threading (C#, .NET 4.0].\n\nSee the following code:\n\nPurpose is to print 1,2,3,4,5 in order.\n\nfor (int counter = 1; counter &lt;= 5; counter++)\n{\n    new Thread (() =&gt; Console.Write (counter)).Start();\n}\n\n\nThe output is interesting! (It might be like 21334...)\n\nThe only solution is to use local variables.\n\nfor (int counter = 1; counter &lt;= 5; counter++)\n{\n    int localVar= counter;\n    new Thread (() =&gt; Console.Write (localVar)).Start();\n}\n\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution7","@type":"Answer","upvoteCount":0},{"text":"for (int n=0; n &lt; 10; n++) //forloop syntax\nforeach (string item in foo) foreach syntax\n\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution8","@type":"Answer","upvoteCount":0},{"text":"It is called the closure problem,\nsimply use a copy variable, and it&apos;s done.\n\nList&lt;Func&lt;int&gt;&gt; actions = new List&lt;Func&lt;int&gt;&gt;();\n\nint variable = 0;\nwhile (variable &lt; 5)\n{\n    int i = variable;\n    actions.Add(() =&gt; i * 2);\n    ++ variable;\n}\n\nforeach (var act in actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution9","@type":"Answer","upvoteCount":0},{"text":"Since no one here directly quoted ECMA-334:\n\n\n  10.4.4.10 For statements \n  \n  Definite assignment checking for a for-statement of the form:\n\n\nfor (for-initializer; for-condition; for-iterator) embedded-statement\n\n\n\n  is done as if the statement were written:\n\n\n{\n    for-initializer;\n    while (for-condition) {\n        embedded-statement;\n    LLoop: for-iterator;\n    }\n}\n\n\nFurther on in the spec,\n\n\n  12.16.6.3 Instantiation of local variables\n  \n  A local variable is considered to be instantiated when execution enters the scope of the variable. \n  \n  [Example: For example, when the following method is invoked, the local variable x is instantiated and initialized three timesonce for each iteration of the loop.\n\n\nstatic void F() {\n  for (int i = 0; i &lt; 3; i++) {\n    int x = i * 2 + 1;\n    ...\n  }\n}\n\n\n\n  However, moving the declaration of x outside the loop results in a single instantiation of x:\n\n\nstatic void F() {\n  int x;\n  for (int i = 0; i &lt; 3; i++) {\n    x = i * 2 + 1;\n    ...\n  }\n}\n\n\n\n  end example]\n  \n  When not captured, there is no way to observe exactly how often a local variable is instantiatedbecause the lifetimes of the instantiations are disjoint, it is possible for each instantation to simply use the same storage location. However, when an anonymous function captures a local variable, the effects of instantiation become apparent.\n  \n  [Example: The example \n\n\nusing System;\n\ndelegate void D();\n\nclass Test{\n  static D[] F() {\n    D[] result = new D[3];\n    for (int i = 0; i &lt; 3; i++) {\n      int x = i * 2 + 1;\n      result[i] = () =&gt; { Console.WriteLine(x); };\n    }\n  return result;\n  }\n  static void Main() {\n    foreach (D d in F()) d();\n  }\n}\n\n\n\n  produces the output:\n\n\n1\n3\n5\n\n\n\n  However, when the declaration of x is moved outside the loop:\n\n\nstatic D[] F() {\n  D[] result = new D[3];\n  int x;\n  for (int i = 0; i &lt; 3; i++) {\n    x = i * 2 + 1;\n    result[i] = () =&gt; { Console.WriteLine(x); };\n  }\n  return result;\n}\n\n\n\n  the output is:\n\n\n5\n5\n5\n\n\n\n  Note that the compiler is permitted (but not required) to optimize the three instantiations into a single delegate instance (ยง11.7.2).\n  \n  If a for-loop declares an iteration variable, that variable itself is considered to be declared outside of the loop. \n  [Example: Thus, if the example is changed to capture the iteration variable itself:\n\n\nstatic D[] F() {\n  D[] result = new D[3];\n  for (int i = 0; i &lt; 3; i++) {\n    result[i] = () =&gt; { Console.WriteLine(i); };\n  }\n  return result;\n}\n\n\n\n  only one instance of the iteration variable is captured, which produces the output:\n\n\n3\n3\n3\n\n\n\n  end example]\n\n\nOh yea, I guess it should be mentioned that in C++ this problem doesn&apos;t occur because you can choose if the variable is captured by value or by reference (see: Lambda capture).\n    ","url":"https://solutionschecker.com/questions/captured-variable-in-a-loop-in-c-1657387696779#solution10","@type":"Answer","upvoteCount":0}],"@type":"Question"}}</script><meta name="next-head-count" content="22"/><script id="google-analytics" data-nscript="beforeInteractive">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NXVLL8B');</script><link rel="preload" href="/_next/static/css/c116652e2d6f4ad0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c116652e2d6f4ad0.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-42cdea76c8170223.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-ccfab947c79712f4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-862498b6ec7885c3.js" defer=""></script><script src="/_next/static/chunks/294-106ef8570fa99deb.js" defer=""></script><script src="/_next/static/chunks/490-7f0418bb4354ac73.js" defer=""></script><script src="/_next/static/chunks/pages/questions/%5Bslug%5D-47289857226115f9.js" defer=""></script><script src="/_next/static/xZs8haGjOP63QuDE0kxeX/_buildManifest.js" defer=""></script><script src="/_next/static/xZs8haGjOP63QuDE0kxeX/_ssgManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXVLL8B"
        height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next"><div class="wrapper"><header><nav class="bg-white border-gray-200 px-4 lg:px-6 py-2.5 dark:bg-gray-800"><div class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl"><a class="flex items-center" href="/"><img src="/logo-second.png" class="mr-3 h-6 sm:h-9" alt="Solution Checker Logo"/><h1 class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">Solution Checker</h1></a><div class="flex items-center lg:order-2"><button data-collapse-toggle="mobile-menu-2" type="button" class="inline-flex items-center p-2 ml-1 text-sm text-gray-500 rounded-lg lg:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="mobile-menu-2" aria-expanded="false"><span class="sr-only">Open main menu</span><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg><svg class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><div class="hidden justify-between items-center w-full lg:flex lg:w-auto lg:order-1" id="mobile-menu-2"><ul class="flex flex-col mt-4 font-medium lg:flex-row lg:space-x-8 lg:mt-0"><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" aria-current="page" href="/">Home</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions?tab=news">Questions</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/post?tab=news">Post</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions/captured-variable-in-a-loop-in-c-1657387696779#">Coding</a></li></ul></div></div></nav></header><div class="main-content"><div class="question my-5"><div class="flex question-header items-center m-auto justify-center"><div class="rounded-xl w-full border p-5 shadow-md bg-white"><div class="flex w-full items-center justify-between border-b pb-3"><div class="flex items-center space-x-3"><div class="text-lg font-bold text-slate-700"><a href="/questions/captured-variable-in-a-loop-in-c-1657387696779"><h1>Captured variable in a loop in C#</h1></a></div></div><div class="flex flex-wrap h-auto justify-end items-center space-x-8"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold" href="/questions/tag/captured-variable">captured-variable</a></div></div><div class="question-content mt-5">
                
<p>I met an interesting issue about C#. I have code like below.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt; actions = <span class="hljs-keyword">new</span> List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt;();

<span class="hljs-built_in">int</span> variable = <span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span> (variable &lt; <span class="hljs-number">5</span>)
{
    actions.Add(() =&gt; variable * <span class="hljs-number">2</span>);
    ++ variable;
}

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> act <span class="hljs-keyword">in</span> actions)
{
    Console.WriteLine(act.Invoke());
}
</code></pre>

<p>I expect it to output 0, 2, 4, 6, 8. However, it actually outputs five 10s.</p>

<p>It seems that it is due to all actions referring to one captured variable. As a result, when they get invoked, they all have same output.</p>

<p>Is there a way to work round this limit to have each action instance have its own captured variable?</p>
    </div></div></div><div class="solution-section"><nav class="flex pagination-solution flex-col justify-end"><h1 class="text-lg font-semibold mb-5">Navigate to solutions: </h1><ul class="inline-flex -space-x-px overflow-auto"><li class="pagination-solution-item"><span data-id="#solution1" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">1</span></li><li class="pagination-solution-item"><span data-id="#solution2" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">2</span></li><li class="pagination-solution-item"><span data-id="#solution3" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">3</span></li><li class="pagination-solution-item"><span data-id="#solution4" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">4</span></li><li class="pagination-solution-item"><span data-id="#solution5" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">5</span></li><li class="pagination-solution-item"><span data-id="#solution6" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">6</span></li><li class="pagination-solution-item"><span data-id="#solution7" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">7</span></li><li class="pagination-solution-item"><span data-id="#solution8" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">8</span></li><li class="pagination-solution-item"><span data-id="#solution9" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">9</span></li><li class="pagination-solution-item"><span data-id="#solution10" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">10</span></li></ul></nav><div id="solution1" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 1</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Yes - take a copy of the variable inside the loop:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">while</span> (variable &lt; <span class="hljs-number">5</span>)
{
    <span class="hljs-built_in">int</span> copy = variable;
    actions.Add(() =&gt; copy * <span class="hljs-number">2</span>);
    ++ variable;
}
</code></pre>

<p>You can think of it as if the C# compiler creates a "new" local variable every time it hits the variable declaration. In fact it'll create appropriate new closure objects, and it gets complicated (in terms of implementation) if you refer to variables in multiple scopes, but it works :)</p>

<p>Note that a more common occurrence of this problem is using <code>for</code> or <code>foreach</code>:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) <span class="hljs-comment">// Just one variable</span>
<span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> x <span class="hljs-keyword">in</span> foo) <span class="hljs-comment">// And again, despite how it reads out loud</span>
</code></pre>

<p>See section 7.14.4.2 of the C# 3.0 spec for more details of this, and my <a href="http://csharpindepth.com/Articles/Chapter5/Closures.aspx" rel="noreferrer">article on closures</a> has more examples too.</p>

<p>Note that as of the C# 5 compiler and beyond (even when specifying an earlier version of C#), the behavior of <code>foreach</code> changed so you no longer need to make local copy. See <a href="https://stackoverflow.com/questions/8898925/is-there-a-reason-for-cs-reuse-of-the-variable-in-a-foreach/8899347#8899347">this answer</a> for more details.</p>
    </div></div></div></div><div id="solution2" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 2</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>I believe what you are experiencing is something known as Closure <a href="http://en.wikipedia.org/wiki/Closure_(computer_science)" rel="noreferrer">http://en.wikipedia.org/wiki/Closure_(computer_science)</a>. Your lamba has a reference to a variable which is scoped outside the function itself. Your lamba is not interpreted until you invoke it and once it is it will get the value the variable has at execution time.</p>
    </div></div></div></div><div id="solution3" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 3</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Behind the scenes, the compiler is generating a class that represents the closure for your method call. It uses that single instance of the closure class for each iteration of the loop. The code looks something like this, which makes it easier to see why the bug happens:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
{
    List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt; actions = <span class="hljs-keyword">new</span> List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt;();

    <span class="hljs-built_in">int</span> variable = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">var</span> closure = <span class="hljs-keyword">new</span> CompilerGeneratedClosure();

    Func&lt;<span class="hljs-built_in">int</span>&gt; anonymousMethodAction = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">while</span> (closure.variable &lt; <span class="hljs-number">5</span>)
    {
        <span class="hljs-keyword">if</span>(anonymousMethodAction == <span class="hljs-literal">null</span>)
            anonymousMethodAction = <span class="hljs-keyword">new</span> Func&lt;<span class="hljs-built_in">int</span>&gt;(closure.YourAnonymousMethod);

        <span class="hljs-comment">//we're re-adding the same function </span>
        actions.Add(anonymousMethodAction);

        ++closure.variable;
    }

    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> act <span class="hljs-keyword">in</span> actions)
    {
        Console.WriteLine(act.Invoke());
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title">CompilerGeneratedClosure</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> variable;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">YourAnonymousMethod</span>()</span>
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.variable * <span class="hljs-number">2</span>;
    }
}
</code></pre>

<p>This isn't actually the compiled code from your sample, but I've examined my own code and this looks very much like what the compiler would actually generate.</p>
    </div></div></div></div><div id="solution4" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 4</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The way around this is to store the value you need in a proxy variable, and have that variable get captured.</p>

<p>I.E.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">while</span>( variable &lt; <span class="hljs-number">5</span> )
{
    <span class="hljs-built_in">int</span> copy = variable;
    actions.Add( () =&gt; copy * <span class="hljs-number">2</span> );
    ++variable;
}
</code></pre>
    </div></div></div></div><div id="solution5" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 5</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<h1>This has nothing to do with loops. </h1>

<p>This behavior is triggered because you use a lambda expression <code>() =&gt; variable * 2</code> where the outer scoped <code>variable</code> not actually defined in the lambda's inner scope. </p>

<p>Lambda expressions (in C#3+, as well as anonymous methods in C#2) still create actual methods. Passing variables to these methods involve some dilemmas (pass by value? pass by reference? C# goes with by reference - but this opens another problem where the reference can outlive the actual variable). What C# does to resolve all these dilemmas is to create a new helper class ("closure") with fields corresponding to the local variables used in the lambda expressions, and methods corresponding to the actual lambda methods. Any changes to <code>variable</code> in your code is actually translated to change in that <code>ClosureClass.variable</code></p>

<p>So your while loop keeps updating the <code>ClosureClass.variable</code> until it reaches 10, then you for loops executes the actions, which all operate on the same <code>ClosureClass.variable</code>.</p>

<p>To get your expected result, you need to create a separation between the loop variable, and the variable that is being closured. You can do this by introducing another variable, i.e.:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt; actions = <span class="hljs-keyword">new</span> List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt;();
<span class="hljs-built_in">int</span> variable = <span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span> (variable &lt; <span class="hljs-number">5</span>)
{
    <span class="hljs-keyword">var</span> t = variable; <span class="hljs-comment">// now t will be closured (i.e. replaced by a field in the new class)</span>
    actions.Add(() =&gt; t * <span class="hljs-number">2</span>);
    ++variable; <span class="hljs-comment">// changing variable won't affect the closured variable t</span>
}
<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> act <span class="hljs-keyword">in</span> actions)
{
    Console.WriteLine(act.Invoke());
}
</code></pre>

<p>You could also move the closure to another method to create this separation:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt; actions = <span class="hljs-keyword">new</span> List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt;();

<span class="hljs-built_in">int</span> variable = <span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span> (variable &lt; <span class="hljs-number">5</span>)
{
    actions.Add(Mult(variable));
    ++variable;
}

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> act <span class="hljs-keyword">in</span> actions)
{
    Console.WriteLine(act.Invoke());
}
</code></pre>

<p>You can implement Mult as a lambda expression (implicit closure) </p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">static</span> Func&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">Mult</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> i</span>)</span>
{
    <span class="hljs-keyword">return</span> () =&gt; i * <span class="hljs-number">2</span>;
}
</code></pre>

<p>or with an actual helper class:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> _i;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Helper</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> i</span>)</span>
    {
        _i = i;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Method</span>()</span>
    {
        <span class="hljs-keyword">return</span> _i * <span class="hljs-number">2</span>;
    }
}

<span class="hljs-function"><span class="hljs-keyword">static</span> Func&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">Mult</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> i</span>)</span>
{
    Helper help = <span class="hljs-keyword">new</span> Helper(i);
    <span class="hljs-keyword">return</span> help.Method;
}
</code></pre>

<p>In any case, <strong>"Closures" are NOT a concept related to loops</strong>, but rather to anonymous methods / lambda expressions use of local scoped variables - although some incautious use of loops demonstrate closures traps.</p>
    </div></div></div></div><div id="solution6" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 6</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Yes you need to scope <code>variable</code> within the loop and pass it to the lambda that way:</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt; actions = <span class="hljs-keyword">new</span> List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt;();

<span class="hljs-built_in">int</span> variable = <span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span> (variable &lt; <span class="hljs-number">5</span>)
{
    <span class="hljs-built_in">int</span> variable1 = variable;
    actions.Add(() =&gt; variable1 * <span class="hljs-number">2</span>);
    ++variable;
}

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> act <span class="hljs-keyword">in</span> actions)
{
    Console.WriteLine(act.Invoke());
}

Console.ReadLine();
</code></pre>
    </div></div></div></div><div id="solution7" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 7</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The same situation is happening in multi-threading (C#, <a href="http://en.wikipedia.org/wiki/.NET_Framework" rel="nofollow">.NET</a> 4.0].</p>

<p>See the following code:</p>

<p>Purpose is to print 1,2,3,4,5 in order.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> counter = <span class="hljs-number">1</span>; counter &lt;= <span class="hljs-number">5</span>; counter++)
{
    <span class="hljs-keyword">new</span> Thread (() =&gt; Console.Write (counter)).Start();
}
</code></pre>

<p>The output is interesting! (It might be like 21334...)</p>

<p>The only solution is to use local variables.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> counter = <span class="hljs-number">1</span>; counter &lt;= <span class="hljs-number">5</span>; counter++)
{
    <span class="hljs-built_in">int</span> localVar= counter;
    <span class="hljs-keyword">new</span> Thread (() =&gt; Console.Write (localVar)).Start();
}
</code></pre>
    </div></div></div></div><div id="solution8" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 8</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> n=<span class="hljs-number">0</span>; n &lt; <span class="hljs-number">10</span>; n++) <span class="hljs-comment">//forloop syntax</span>
<span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> item <span class="hljs-keyword">in</span> foo) <span class="hljs-keyword">foreach</span> syntax
</code></pre>
    </div></div></div></div><div id="solution9" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 9</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>It is called the closure problem,
simply use a copy variable, and it's done.</p>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt; actions = <span class="hljs-keyword">new</span> List&lt;Func&lt;<span class="hljs-built_in">int</span>&gt;&gt;();

<span class="hljs-built_in">int</span> variable = <span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span> (variable &lt; <span class="hljs-number">5</span>)
{
    <span class="hljs-built_in">int</span> i = variable;
    actions.Add(() =&gt; i * <span class="hljs-number">2</span>);
    ++ variable;
}

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> act <span class="hljs-keyword">in</span> actions)
{
    Console.WriteLine(act.Invoke());
}
</code></pre>
    </div></div></div></div><div id="solution10" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h1 class="text-4xl font-semibold mb-5">Solution 10</h1><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/captured-variable">captured-variable</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Since no one here directly quoted <a href="https://ecma-international.org/publications/files/ECMA-ST/ECMA-334.pdf" rel="nofollow noreferrer">ECMA-334</a>:</p>

<blockquote>
  <p>10.4.4.10 For statements </p>
  
  <p>Definite assignment checking for a for-statement of the form:</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">for</span>-initializer; <span class="hljs-keyword">for</span>-condition; <span class="hljs-keyword">for</span>-iterator) embedded-statement
</code></pre>

<blockquote>
  <p>is done as if the statement were written:</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp">{
    <span class="hljs-keyword">for</span>-initializer;
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">for</span>-condition) {
        embedded-statement;
    LLoop: <span class="hljs-keyword">for</span>-iterator;
    }
}
</code></pre>

<p>Further on in the spec,</p>

<blockquote>
  <p>12.16.6.3 Instantiation of local variables</p>
  
  <p>A local variable is considered to be instantiated when execution enters the scope of the variable. </p>
  
  <p>[Example: For example, when the following method is invoked, the local variable <code>x</code> is instantiated and initialized three timesonce for each iteration of the loop.</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">F</span>()</span> {
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    <span class="hljs-built_in">int</span> x = i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
    ...
  }
}
</code></pre>

<blockquote>
  <p>However, moving the declaration of <code>x</code> outside the loop results in a single instantiation of <code>x</code>:</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">F</span>()</span> {
  <span class="hljs-built_in">int</span> x;
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    x = i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
    ...
  }
}
</code></pre>

<blockquote>
  <p>end example]</p>
  
  <p>When not captured, there is no way to observe exactly how often a local variable is instantiatedbecause the lifetimes of the instantiations are disjoint, it is possible for each instantation to simply use the same storage location. However, when an anonymous function captures a local variable, the effects of instantiation become apparent.</p>
  
  <p>[Example: The example </p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-keyword">using</span> System;

<span class="hljs-function"><span class="hljs-built_in">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">D</span>()</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>{
  <span class="hljs-function"><span class="hljs-keyword">static</span> D[] <span class="hljs-title">F</span>()</span> {
    D[] result = <span class="hljs-keyword">new</span> D[<span class="hljs-number">3</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
      <span class="hljs-built_in">int</span> x = i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
      result[i] = () =&gt; { Console.WriteLine(x); };
    }
  <span class="hljs-keyword">return</span> result;
  }
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span> {
    <span class="hljs-keyword">foreach</span> (<span class="hljs-function">D d <span class="hljs-keyword">in</span> <span class="hljs-title">F</span>()) <span class="hljs-title">d</span>()</span>;
  }
}
</code></pre>

<blockquote>
  <p>produces the output:</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-number">1</span>
<span class="hljs-number">3</span>
<span class="hljs-number">5</span>
</code></pre>

<blockquote>
  <p>However, when the declaration of <code>x</code> is moved outside the loop:</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">static</span> D[] <span class="hljs-title">F</span>()</span> {
  D[] result = <span class="hljs-keyword">new</span> D[<span class="hljs-number">3</span>];
  <span class="hljs-built_in">int</span> x;
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    x = i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
    result[i] = () =&gt; { Console.WriteLine(x); };
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>

<blockquote>
  <p>the output is:</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-number">5</span>
<span class="hljs-number">5</span>
<span class="hljs-number">5</span>
</code></pre>

<blockquote>
  <p>Note that the compiler is permitted (but not required) to optimize the three instantiations into a single delegate instance (ยง11.7.2).</p>
  
  <p>If a for-loop declares an iteration variable, that variable itself is considered to be declared outside of the loop. 
  [Example: Thus, if the example is changed to capture the iteration variable itself:</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">static</span> D[] <span class="hljs-title">F</span>()</span> {
  D[] result = <span class="hljs-keyword">new</span> D[<span class="hljs-number">3</span>];
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    result[i] = () =&gt; { Console.WriteLine(i); };
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>

<blockquote>
  <p>only one instance of the iteration variable is captured, which produces the output:</p>
</blockquote>

<pre class="lang-cs s-code-block"><code class="hljs language-csharp"><span class="hljs-number">3</span>
<span class="hljs-number">3</span>
<span class="hljs-number">3</span>
</code></pre>

<blockquote>
  <p>end example]</p>
</blockquote>

<p>Oh yea, I guess it should be mentioned that in C++ this problem doesn't occur because you can choose if the variable is captured by value or by reference (see: <a href="https://en.cppreference.com/w/cpp/language/lambda#Lambda_capture" rel="nofollow noreferrer">Lambda capture</a>).</p>
    </div></div></div></div></div></div><div class="widget"><a href="/questions/how-do-i-count-the-occurrences-of-a-list-item-1657387916234">How do I count the occurrences of a list item?</a><a href="/questions/performance-optimization-strategies-of-last-resort-closed-1657388420614">Performance optimization strategies of last resort [closed]</a><a href="/questions/how-to-create-recyclerview-with-multiple-view-types-1657388121512">How to create RecyclerView with multiple view types</a><a href="/questions/selecting-and-manipulating-css-pseudo-elements-such-as-::before-and-::after-using-javascript-(or-jquery)-1657387406132">Selecting and manipulating CSS pseudo-elements such as ::before and ::after using javascript (or jQuery)</a><a href="/questions/how-do-i-make-git-forget-about-a-file-that-was-tracked-but-is-now-in-.gitignore-1657387328843">How do I make Git forget about a file that was tracked, but is now in .gitignore?</a><a href="/questions/how-to-randomize-(shuffle)-a-javascript-array-1657384790171">How to randomize (shuffle) a JavaScript array?</a><a href="/questions/how-do-i-match-any-character-across-multiple-lines-in-a-regular-expression-1657387839720">How do I match any character across multiple lines in a regular expression?</a><a href="/questions/of-the-many-findelement(s)by-functions-in-selenium-when-would-you-use-one-over-the-other-1657388412658">Of the many findElement(s)/By functions in Selenium, when would you use one over the other?</a><a href="/questions/crash-or-%22segmentation-fault%22-when-data-is-copiedscannedread-to-an-uninitialized-pointer-1657387520581">Crash or &quot;segmentation fault&quot; when data is copied/scanned/read to an uninitialized pointer</a><a href="/questions/what-is-an-efficient-way-to-implement-a-singleton-pattern-in-java-closed-1657387970474">What is an efficient way to implement a singleton pattern in Java? [closed]</a><a href="/questions/how-can-i-make-bootstrap-columns-all-the-same-height-1657388551403">How can I make Bootstrap columns all the same height?</a><a href="/questions/what-is-this-weird-colon-member-(%22-:-%22)-syntax-in-the-constructor-1657387264047">What is this weird colon-member (&quot; : &quot;) syntax in the constructor?</a><a href="/questions/why-use-integer-instead-of-long-1657388012352">Why Use Integer Instead of Long?</a><a href="/questions/what-is-the-canonical-way-to-check-for-errors-using-the-cuda-runtime-api-1657387302698">What is the canonical way to check for errors using the CUDA runtime API?</a><a href="/questions/what-is-move-semantics-1657387702625">What is move semantics?</a><a href="/questions/how-can-i-access-and-process-nested-objects-arrays-or-json-1657384332823">How can I access and process nested objects, arrays, or JSON?</a><a href="/questions/how-do-i-use-arrays-in-c++-1657387456118">How do I use arrays in C++?</a><a href="/questions/how-to-reshape-data-from-long-to-wide-format-1657384486421">How to reshape data from long to wide format</a><a href="/questions/what-to-do-regular-expression-pattern-doesn&#x27;t-match-anywhere-in-string-1657388095896">What to do Regular expression pattern doesn&#x27;t match anywhere in string?</a><a href="/questions/what-should-main()-return-in-c-and-c++-1657384745630">What should main() return in C and C++?</a></div></div><span class="cursor-pointer text-lg p-2" style="position:fixed;bottom:20px;left:20px;background:#000;z-index:2000;color:white">Go go top</span></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"answer":["\n\u0026lt;p\u0026gt;Yes - take a copy of the variable inside the loop:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (variable \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;)\n{\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; copy = variable;\n    actions.Add(() =\u0026amp;gt; copy * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;);\n    ++ variable;\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;You can think of it as if the C# compiler creates a \u0026quot;new\u0026quot; local variable every time it hits the variable declaration. In fact it\u0026apos;ll create appropriate new closure objects, and it gets complicated (in terms of implementation) if you refer to variables in multiple scopes, but it works :)\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Note that a more common occurrence of this problem is using \u0026lt;code\u0026gt;for\u0026lt;/code\u0026gt; or \u0026lt;code\u0026gt;foreach\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i=\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;; i \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;; i++) \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// Just one variable\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt; x \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; foo) \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// And again, despite how it reads out loud\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;See section 7.14.4.2 of the C# 3.0 spec for more details of this, and my \u0026lt;a href=\u0026quot;http://csharpindepth.com/Articles/Chapter5/Closures.aspx\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;article on closures\u0026lt;/a\u0026gt; has more examples too.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Note that as of the C# 5 compiler and beyond (even when specifying an earlier version of C#), the behavior of \u0026lt;code\u0026gt;foreach\u0026lt;/code\u0026gt; changed so you no longer need to make local copy. See \u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/8898925/is-there-a-reason-for-cs-reuse-of-the-variable-in-a-foreach/8899347#8899347\u0026quot;\u0026gt;this answer\u0026lt;/a\u0026gt; for more details.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I believe what you are experiencing is something known as Closure \u0026lt;a href=\u0026quot;http://en.wikipedia.org/wiki/Closure_(computer_science)\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;http://en.wikipedia.org/wiki/Closure_(computer_science)\u0026lt;/a\u0026gt;. Your lamba has a reference to a variable which is scoped outside the function itself. Your lamba is not interpreted until you invoke it and once it is it will get the value the variable has at execution time.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Behind the scenes, the compiler is generating a class that represents the closure for your method call. It uses that single instance of the closure class for each iteration of the loop. The code looks something like this, which makes it easier to see why the bug happens:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Main\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n{\n    List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt; actions = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt;();\n\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; variable = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; closure = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; CompilerGeneratedClosure();\n\n    Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt; anonymousMethodAction = \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (closure.variable \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;)\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;if\u0026lt;/span\u0026gt;(anonymousMethodAction == \u0026lt;span class=\u0026quot;hljs-literal\u0026quot;\u0026gt;null\u0026lt;/span\u0026gt;)\n            anonymousMethodAction = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;(closure.YourAnonymousMethod);\n\n        \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;//we\u0026apos;re re-adding the same function \u0026lt;/span\u0026gt;\n        actions.Add(anonymousMethodAction);\n\n        ++closure.variable;\n    }\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; act \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; actions)\n    {\n        Console.WriteLine(act.Invoke());\n    }\n}\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;class\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;CompilerGeneratedClosure\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; variable;\n\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;YourAnonymousMethod\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;this\u0026lt;/span\u0026gt;.variable * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;;\n    }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;This isn\u0026apos;t actually the compiled code from your sample, but I\u0026apos;ve examined my own code and this looks very much like what the compiler would actually generate.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The way around this is to store the value you need in a proxy variable, and have that variable get captured.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;I.E.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt;( variable \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt; )\n{\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; copy = variable;\n    actions.Add( () =\u0026amp;gt; copy * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; );\n    ++variable;\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;h1\u0026gt;This has nothing to do with loops. \u0026lt;/h1\u0026gt;\n\n\u0026lt;p\u0026gt;This behavior is triggered because you use a lambda expression \u0026lt;code\u0026gt;() =\u0026amp;gt; variable * 2\u0026lt;/code\u0026gt; where the outer scoped \u0026lt;code\u0026gt;variable\u0026lt;/code\u0026gt; not actually defined in the lambda\u0026apos;s inner scope. \u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Lambda expressions (in C#3+, as well as anonymous methods in C#2) still create actual methods. Passing variables to these methods involve some dilemmas (pass by value? pass by reference? C# goes with by reference - but this opens another problem where the reference can outlive the actual variable). What C# does to resolve all these dilemmas is to create a new helper class (\u0026quot;closure\u0026quot;) with fields corresponding to the local variables used in the lambda expressions, and methods corresponding to the actual lambda methods. Any changes to \u0026lt;code\u0026gt;variable\u0026lt;/code\u0026gt; in your code is actually translated to change in that \u0026lt;code\u0026gt;ClosureClass.variable\u0026lt;/code\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;So your while loop keeps updating the \u0026lt;code\u0026gt;ClosureClass.variable\u0026lt;/code\u0026gt; until it reaches 10, then you for loops executes the actions, which all operate on the same \u0026lt;code\u0026gt;ClosureClass.variable\u0026lt;/code\u0026gt;.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;To get your expected result, you need to create a separation between the loop variable, and the variable that is being closured. You can do this by introducing another variable, i.e.:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt; actions = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt;();\n\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; variable = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (variable \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;)\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; t = variable; \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// now t will be closured (i.e. replaced by a field in the new class)\u0026lt;/span\u0026gt;\n    actions.Add(() =\u0026amp;gt; t * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;);\n    ++variable; \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;// changing variable won\u0026apos;t affect the closured variable t\u0026lt;/span\u0026gt;\n}\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; act \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;You could also move the closure to another method to create this separation:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt; actions = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt;();\n\n\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; variable = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (variable \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;)\n{\n    actions.Add(Mult(variable));\n    ++variable;\n}\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; act \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;You can implement Mult as a lambda expression (implicit closure) \u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Mult\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; () =\u0026amp;gt; i * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;;\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;or with an actual helper class:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;class\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Helper\u0026lt;/span\u0026gt;\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; _i;\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Helper\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n    {\n        _i = i;\n    }\n    \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;public\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Method\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;\n    {\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; _i * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;;\n    }\n}\n\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Mult\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-params\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i\u0026lt;/span\u0026gt;)\u0026lt;/span\u0026gt;\n{\n    Helper help = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Helper(i);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; help.Method;\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;In any case, \u0026lt;strong\u0026gt;\u0026quot;Closures\u0026quot; are NOT a concept related to loops\u0026lt;/strong\u0026gt;, but rather to anonymous methods / lambda expressions use of local scoped variables - although some incautious use of loops demonstrate closures traps.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Yes you need to scope \u0026lt;code\u0026gt;variable\u0026lt;/code\u0026gt; within the loop and pass it to the lambda that way:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt; actions = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt;();\n\n\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; variable = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (variable \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;)\n{\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; variable1 = variable;\n    actions.Add(() =\u0026amp;gt; variable1 * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;);\n    ++variable;\n}\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; act \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\nConsole.ReadLine();\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The same situation is happening in multi-threading (C#, \u0026lt;a href=\u0026quot;http://en.wikipedia.org/wiki/.NET_Framework\u0026quot; rel=\u0026quot;nofollow\u0026quot;\u0026gt;.NET\u0026lt;/a\u0026gt; 4.0].\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;See the following code:\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Purpose is to print 1,2,3,4,5 in order.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; counter = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;; counter \u0026amp;lt;= \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;; counter++)\n{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Thread (() =\u0026amp;gt; Console.Write (counter)).Start();\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;The output is interesting! (It might be like 21334...)\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;The only solution is to use local variables.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; counter = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;; counter \u0026amp;lt;= \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;; counter++)\n{\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; localVar= counter;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; Thread (() =\u0026amp;gt; Console.Write (localVar)).Start();\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; n=\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;; n \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;; n++) \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;//forloop syntax\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;string\u0026lt;/span\u0026gt; item \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; foo) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; syntax\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;It is called the closure problem,\nsimply use a copy variable, and it\u0026apos;s done.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt; actions = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt;();\n\n\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; variable = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (variable \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;)\n{\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i = variable;\n    actions.Add(() =\u0026amp;gt; i * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;);\n    ++ variable;\n}\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; act \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Since no one here directly quoted \u0026lt;a href=\u0026quot;https://ecma-international.org/publications/files/ECMA-ST/ECMA-334.pdf\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;ECMA-334\u0026lt;/a\u0026gt;:\u0026lt;/p\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;10.4.4.10 For statements \u0026lt;/p\u0026gt;\n  \n  \u0026lt;p\u0026gt;Definite assignment checking for a for-statement of the form:\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt;-initializer; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt;-condition; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt;-iterator) embedded-statement\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;is done as if the statement were written:\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;{\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt;-initializer;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt;-condition) {\n        embedded-statement;\n    LLoop: \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt;-iterator;\n    }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Further on in the spec,\u0026lt;/p\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;12.16.6.3 Instantiation of local variables\u0026lt;/p\u0026gt;\n  \n  \u0026lt;p\u0026gt;A local variable is considered to be instantiated when execution enters the scope of the variable. \u0026lt;/p\u0026gt;\n  \n  \u0026lt;p\u0026gt;[Example: For example, when the following method is invoked, the local variable \u0026lt;code\u0026gt;x\u0026lt;/code\u0026gt; is instantiated and initialized three timesonce for each iteration of the loop.\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;F\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt; {\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;; i \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;; i++) {\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; x = i * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; + \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n    ...\n  }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;However, moving the declaration of \u0026lt;code\u0026gt;x\u0026lt;/code\u0026gt; outside the loop results in a single instantiation of \u0026lt;code\u0026gt;x\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;F\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt; {\n  \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; x;\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;; i \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;; i++) {\n    x = i * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; + \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n    ...\n  }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;end example]\u0026lt;/p\u0026gt;\n  \n  \u0026lt;p\u0026gt;When not captured, there is no way to observe exactly how often a local variable is instantiatedbecause the lifetimes of the instantiations are disjoint, it is possible for each instantation to simply use the same storage location. However, when an anonymous function captures a local variable, the effects of instantiation become apparent.\u0026lt;/p\u0026gt;\n  \n  \u0026lt;p\u0026gt;[Example: The example \u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;using\u0026lt;/span\u0026gt; System;\n\n\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;delegate\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;D\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;class\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Test\u0026lt;/span\u0026gt;{\n  \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; D[] \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;F\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt; {\n    D[] result = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; D[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;];\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;; i \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;; i++) {\n      \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; x = i * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; + \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n      result[i] = () =\u0026amp;gt; { Console.WriteLine(x); };\n    }\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; result;\n  }\n  \u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;void\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;Main\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt; {\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;D d \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;F\u0026lt;/span\u0026gt;()) \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;d\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt;;\n  }\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;produces the output:\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;However, when the declaration of \u0026lt;code\u0026gt;x\u0026lt;/code\u0026gt; is moved outside the loop:\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; D[] \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;F\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt; {\n  D[] result = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; D[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;];\n  \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; x;\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;; i \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;; i++) {\n    x = i * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; + \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n    result[i] = () =\u0026amp;gt; { Console.WriteLine(x); };\n  }\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; result;\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;the output is:\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;Note that the compiler is permitted (but not required) to optimize the three instantiations into a single delegate instance (ยง11.7.2).\u0026lt;/p\u0026gt;\n  \n  \u0026lt;p\u0026gt;If a for-loop declares an iteration variable, that variable itself is considered to be declared outside of the loop. \n  [Example: Thus, if the example is changed to capture the iteration variable itself:\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-function\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt; D[] \u0026lt;span class=\u0026quot;hljs-title\u0026quot;\u0026gt;F\u0026lt;/span\u0026gt;()\u0026lt;/span\u0026gt; {\n  D[] result = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; D[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;];\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;for\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; i = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;; i \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;; i++) {\n    result[i] = () =\u0026amp;gt; { Console.WriteLine(i); };\n  }\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;return\u0026lt;/span\u0026gt; result;\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;only one instance of the iteration variable is captured, which produces the output:\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;blockquote\u0026gt;\n  \u0026lt;p\u0026gt;end example]\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\n\u0026lt;p\u0026gt;Oh yea, I guess it should be mentioned that in C++ this problem doesn\u0026apos;t occur because you can choose if the variable is captured by value or by reference (see: \u0026lt;a href=\u0026quot;https://en.cppreference.com/w/cpp/language/lambda#Lambda_capture\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;Lambda capture\u0026lt;/a\u0026gt;).\u0026lt;/p\u0026gt;\n    "],"id":343,"title":"Captured variable in a loop in C#","content":"\n                \n\u0026lt;p\u0026gt;I met an interesting issue about C#. I have code like below.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-cs s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-csharp\u0026quot;\u0026gt;List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt; actions = \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;new\u0026lt;/span\u0026gt; List\u0026amp;lt;Func\u0026amp;lt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;\u0026amp;gt;\u0026amp;gt;();\n\n\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; variable = \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;while\u0026lt;/span\u0026gt; (variable \u0026amp;lt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;)\n{\n    actions.Add(() =\u0026amp;gt; variable * \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;);\n    ++ variable;\n}\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;foreach\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;var\u0026lt;/span\u0026gt; act \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt; actions)\n{\n    Console.WriteLine(act.Invoke());\n}\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;I expect it to output 0, 2, 4, 6, 8. However, it actually outputs five 10s.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;It seems that it is due to all actions referring to one captured variable. As a result, when they get invoked, they all have same output.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Is there a way to work round this limit to have each action instance have its own captured variable?\u0026lt;/p\u0026gt;\n    ","slug":"captured-variable-in-a-loop-in-c-1657387696779","postType":"QUESTION","createdAt":"2022-07-09T17:28:16.000Z","updatedAt":"2022-07-09T17:28:16.000Z","tags":[{"id":1947,"name":"captured-variable","slug":"captured-variable","createdAt":"2022-07-09T17:28:16.000Z","updatedAt":"2022-07-09T17:28:16.000Z","Questions_Tags":{"questionId":343,"tagId":1947}}],"relatedQuestions":[{"title":"Captured variable in a loop in C#","slug":"captured-variable-in-a-loop-in-c-1657387696779","tags":[{"name":"captured-variable","Questions_Tags":{"questionId":343,"tagId":1947}}]}]},"randomQuestions":[{"title":"How do I count the occurrences of a list item?","slug":"how-do-i-count-the-occurrences-of-a-list-item-1657387916234"},{"title":"Performance optimization strategies of last resort [closed]","slug":"performance-optimization-strategies-of-last-resort-closed-1657388420614"},{"title":"How to create RecyclerView with multiple view types","slug":"how-to-create-recyclerview-with-multiple-view-types-1657388121512"},{"title":"Selecting and manipulating CSS pseudo-elements such as ::before and ::after using javascript (or jQuery)","slug":"selecting-and-manipulating-css-pseudo-elements-such-as-::before-and-::after-using-javascript-(or-jquery)-1657387406132"},{"title":"How do I make Git forget about a file that was tracked, but is now in .gitignore?","slug":"how-do-i-make-git-forget-about-a-file-that-was-tracked-but-is-now-in-.gitignore-1657387328843"},{"title":"How to randomize (shuffle) a JavaScript array?","slug":"how-to-randomize-(shuffle)-a-javascript-array-1657384790171"},{"title":"How do I match any character across multiple lines in a regular expression?","slug":"how-do-i-match-any-character-across-multiple-lines-in-a-regular-expression-1657387839720"},{"title":"Of the many findElement(s)/By functions in Selenium, when would you use one over the other?","slug":"of-the-many-findelement(s)by-functions-in-selenium-when-would-you-use-one-over-the-other-1657388412658"},{"title":"Crash or \"segmentation fault\" when data is copied/scanned/read to an uninitialized pointer","slug":"crash-or-\"segmentation-fault\"-when-data-is-copiedscannedread-to-an-uninitialized-pointer-1657387520581"},{"title":"What is an efficient way to implement a singleton pattern in Java? [closed]","slug":"what-is-an-efficient-way-to-implement-a-singleton-pattern-in-java-closed-1657387970474"},{"title":"How can I make Bootstrap columns all the same height?","slug":"how-can-i-make-bootstrap-columns-all-the-same-height-1657388551403"},{"title":"What is this weird colon-member (\" : \") syntax in the constructor?","slug":"what-is-this-weird-colon-member-(\"-:-\")-syntax-in-the-constructor-1657387264047"},{"title":"Why Use Integer Instead of Long?","slug":"why-use-integer-instead-of-long-1657388012352"},{"title":"What is the canonical way to check for errors using the CUDA runtime API?","slug":"what-is-the-canonical-way-to-check-for-errors-using-the-cuda-runtime-api-1657387302698"},{"title":"What is move semantics?","slug":"what-is-move-semantics-1657387702625"},{"title":"How can I access and process nested objects, arrays, or JSON?","slug":"how-can-i-access-and-process-nested-objects-arrays-or-json-1657384332823"},{"title":"How do I use arrays in C++?","slug":"how-do-i-use-arrays-in-c++-1657387456118"},{"title":"How to reshape data from long to wide format","slug":"how-to-reshape-data-from-long-to-wide-format-1657384486421"},{"title":"What to do Regular expression pattern doesn't match anywhere in string?","slug":"what-to-do-regular-expression-pattern-doesn't-match-anywhere-in-string-1657388095896"},{"title":"What should main() return in C and C++?","slug":"what-should-main()-return-in-c-and-c++-1657384745630"}]},"__N_SSG":true},"page":"/questions/[slug]","query":{"slug":"captured-variable-in-a-loop-in-c-1657387696779"},"buildId":"xZs8haGjOP63QuDE0kxeX","isFallback":false,"gsp":true,"locale":"en","locales":["en"],"defaultLocale":"en","scriptLoader":[]}</script></body></html>