{"pageProps":{"data":{"answer":["\n&lt;p&gt;You could use &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html#function_group-concat&quot; rel=&quot;noreferrer&quot;&gt;GROUP_CONCAT&lt;/a&gt; aggregated function to get all years into a single column, grouped by &lt;code&gt;id&lt;/code&gt; and ordered by &lt;code&gt;rate&lt;/code&gt;:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;   id, GROUP_CONCAT(&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;) grouped_year\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;     yourtable\n&lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Result:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;-----------------------------------------------------------&lt;/span&gt;\n&lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt;  ID &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; GROUPED_YEAR                                      &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt;\n&lt;span class=&quot;hljs-comment&quot;&gt;-----------------------------------------------------------&lt;/span&gt;\n&lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; p01 &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2008&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2005&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt;\n&lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; p02 &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;                &lt;span class=&quot;hljs-operator&quot;&gt;|&lt;/span&gt;\n&lt;span class=&quot;hljs-comment&quot;&gt;-----------------------------------------------------------&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;And then you could use &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_find-in-set&quot; rel=&quot;noreferrer&quot;&gt;FIND_IN_SET&lt;/a&gt;, that returns the position of the first argument inside the second one, eg.&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; FIND_IN_SET(&lt;span class=&quot;hljs-string&quot;&gt;&apos;2006&apos;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&apos;2006,2003,2008,2001,2007,2009,2002,2004,2005,2000&apos;&lt;/span&gt;);\n&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;\n\n&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; FIND_IN_SET(&lt;span class=&quot;hljs-string&quot;&gt;&apos;2009&apos;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&apos;2006,2003,2008,2001,2007,2009,2002,2004,2005,2000&apos;&lt;/span&gt;);\n&lt;span class=&quot;hljs-number&quot;&gt;6&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Using a combination of &lt;code&gt;GROUP_CONCAT&lt;/code&gt; and &lt;code&gt;FIND_IN_SET&lt;/code&gt;, and filtering by the position returned by find_in_set, you could then use this query that returns only the first 5 years for every id:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;\n  yourtable.&lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;\n  yourtable &lt;span class=&quot;hljs-keyword&quot;&gt;INNER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;JOIN&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;\n      id,\n      GROUP_CONCAT(&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;) grouped_year\n    &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;\n      yourtable\n    &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id) group_max\n  &lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; yourtable.id &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; group_max.id\n     &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; FIND_IN_SET(&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;, grouped_year) &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt;\n  yourtable.id, yourtable.year &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Please see fiddle &lt;a href=&quot;http://sqlfiddle.com/#!2/1c220/1&quot; rel=&quot;noreferrer&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;\n&lt;p&gt;Please note that if more than one row can have the same rate, you should consider using &lt;code&gt;GROUP_CONCAT(DISTINCT rate ORDER BY rate)&lt;/code&gt; on the &lt;code&gt;rate&lt;/code&gt; column instead of the &lt;code&gt;year&lt;/code&gt; column.&lt;/p&gt;\n&lt;p&gt;The maximum length of the string returned by &lt;code&gt;GROUP_CONCAT&lt;/code&gt; is limited, so this works well if you need to select a few records for every group.&lt;/p&gt;\n    ","\n&lt;p&gt;You want to find &lt;em&gt;&lt;strong&gt;top n rows per group&lt;/strong&gt;&lt;/em&gt;. This answer provides a generic solution using example data that is different from OP.&lt;/p&gt;\n&lt;p&gt;In MySQL 8 or later you can use the &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html&quot; rel=&quot;noreferrer&quot;&gt;&lt;code&gt;ROW_NUMBER&lt;/code&gt;, &lt;code&gt;RANK&lt;/code&gt; or &lt;code&gt;DENSE_RANK&lt;/code&gt;&lt;/a&gt; function depending on the exact definition of top 5. Below are the numbers generated by these functions based on &lt;code&gt;value&lt;/code&gt; sorted descending. Notice how ties are handled:&lt;/p&gt;\n&lt;div class=&quot;s-table-container&quot;&gt;\n&lt;table class=&quot;s-table&quot;&gt;\n&lt;thead&gt;\n&lt;tr&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;pkid&lt;/th&gt;\n&lt;th&gt;catid&lt;/th&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;value&lt;/th&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;row_number&lt;/th&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;rank&lt;/th&gt;\n&lt;th style=&quot;text-align: right;&quot;&gt;dense_rank&lt;/th&gt;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;1&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;100&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*1&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*1&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*1&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;2&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;90&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;3&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;90&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*3&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*2&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;4&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;80&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*3&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;5&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;80&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*5&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*3&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;6&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;80&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;6&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*3&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;7&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;70&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;7&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;7&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*4&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;8&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;60&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;8&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;8&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;*5&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;9&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;50&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;9&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;9&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;6&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;10&lt;/td&gt;\n&lt;td&gt;p01&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;40&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;10&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;10&lt;/td&gt;\n&lt;td style=&quot;text-align: right;&quot;&gt;7&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;/div&gt;\n&lt;p&gt;Once you have chosen the function, use it like so:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;, &lt;span class=&quot;hljs-built_in&quot;&gt;ROW_NUMBER&lt;/span&gt;() &lt;span class=&quot;hljs-keyword&quot;&gt;OVER&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;PARTITION&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; t\n) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; x\n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; n &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;a href=&quot;https://dbfiddle.uk/?rdbms=mysql_8.0&amp;amp;fiddle=29ff3dde85d2fb2085fcd195a7a9134e&quot; rel=&quot;noreferrer&quot;&gt;DB&amp;lt;&amp;gt;Fiddle&lt;/a&gt;&lt;/p&gt;\n&lt;hr&gt;\n&lt;p&gt;In MySQL 5.x you can use poor man&apos;s rank over partition to achieve desired result: outer join the table with itself and for each row, count the number of rows &lt;em&gt;&lt;strong&gt;before&lt;/strong&gt;&lt;/em&gt; it (e.g. the before row could be the one with higher value).&lt;/p&gt;\n&lt;p&gt;The following will produce results similar to &lt;code&gt;RANK&lt;/code&gt; function:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; t.pkid, t.catid, t.value, &lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(b.value) &lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; rank\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; t\n&lt;span class=&quot;hljs-keyword&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;JOIN&lt;/span&gt; t &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; b &lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; b.catid &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; t.catid &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; b.value &lt;span class=&quot;hljs-operator&quot;&gt;&amp;gt;&lt;/span&gt; t.value\n&lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; t.pkid, t.catid, t.value\n&lt;span class=&quot;hljs-keyword&quot;&gt;HAVING&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(b.value) &lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; t.catid, t.value &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;, t.pkid\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Make the following change to produce results similar to &lt;code&gt;DENSE_RANK&lt;/code&gt; function:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;DISTINCT&lt;/span&gt; b.value)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Or make the following change to produce results similar to &lt;code&gt;ROW_NUMBER&lt;/code&gt; function:&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; b.catid &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; t.catid &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; (b.value &lt;span class=&quot;hljs-operator&quot;&gt;&amp;gt;&lt;/span&gt; t.value &lt;span class=&quot;hljs-keyword&quot;&gt;OR&lt;/span&gt; b.value &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; t.value &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; b.pkid &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;&lt;/span&gt; t.pkid)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;a href=&quot;https://dbfiddle.uk/?rdbms=mysql_5.5&amp;amp;fiddle=d4baaf1a1df9b681545b13031e641d9f&quot; rel=&quot;noreferrer&quot;&gt;DB&amp;lt;&amp;gt;Fiddle&lt;/a&gt;&lt;/p&gt;\n    ","\n&lt;p&gt;For me something like &lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;SUBSTRING_INDEX(group_concat(col_name &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; desired_col_order_name), &lt;span class=&quot;hljs-string&quot;&gt;&apos;,&apos;&lt;/span&gt;, N) \n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;works perfectly. No complicated query.&lt;/p&gt;\n\n&lt;hr&gt;\n\n&lt;p&gt;for example: get top 1 for each group&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; \n    &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;\n    yourtable\n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt;\n    id &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; \n            SUBSTRING_INDEX(GROUP_CONCAT(id\n                            &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;),\n                        &lt;span class=&quot;hljs-string&quot;&gt;&apos;,&apos;&lt;/span&gt;,\n                        &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) id\n        &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt;\n            yourtable\n        &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;)\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;No, you can&apos;t LIMIT subqueries arbitrarily (you can do it to a limited extent in newer MySQLs, but not for 5 results per group).&lt;/p&gt;\n\n&lt;p&gt;This is a groupwise-maximum type query, which is not trivial to do in SQL. There are &lt;a href=&quot;https://stackoverflow.com/questions/755918/simple-query-to-grab-max-value-for-each-id/756892#756892&quot;&gt;various ways&lt;/a&gt; to tackle that which can be more efficient for some cases, but for top-n in general you&apos;ll want to look at &lt;a href=&quot;https://stackoverflow.com/questions/1442527/how-to-select-the-newest-four-items-per-category/1442867#1442867&quot;&gt;Bill&apos;s answer&lt;/a&gt; to a similar previous question.&lt;/p&gt;\n\n&lt;p&gt;As with most solutions to this problem, it can return more than five rows if there are multiple rows with the same &lt;code&gt;rate&lt;/code&gt; value, so you may still need a quantity of post-processing to check for that.&lt;/p&gt;\n    ","\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;, id, rate\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;\n  &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;, id, rate, &lt;span class=&quot;hljs-built_in&quot;&gt;row_number&lt;/span&gt;() &lt;span class=&quot;hljs-keyword&quot;&gt;over&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;)\n  &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; h\n  &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;\n  &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; rid &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; table2)\n  &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;\n  &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; subquery\n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; row_number &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;The subquery is almost identical to your query. Only change is adding&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;row_number&lt;/span&gt;() &lt;span class=&quot;hljs-keyword&quot;&gt;over&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;)\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;This requires a series of subqueries to rank the values, limit them, then perform the sum while grouping&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-variable&quot;&gt;@Rnk&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;\n&lt;span class=&quot;hljs-variable&quot;&gt;@N&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;;\n&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;\n  c.id,\n  &lt;span class=&quot;hljs-built_in&quot;&gt;sum&lt;/span&gt;(c.val)\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; (\n&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;\n  b.id,\n  b.bal\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; (\n&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;   \n  if(&lt;span class=&quot;hljs-variable&quot;&gt;@last&lt;/span&gt;_id&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;id,&lt;span class=&quot;hljs-variable&quot;&gt;@Rnk&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; Rnk,\n  a.id,\n  a.val,\n  &lt;span class=&quot;hljs-variable&quot;&gt;@last&lt;/span&gt;_id&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;id,\n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; (   \n&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; \n  id,\n  val \n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; list\n&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; id,val &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; a) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; b\n&lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt; b.rnk &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@N&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; c\n&lt;span class=&quot;hljs-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; c.id;\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;Try this: &lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; h.year, h.id, h.rate \n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; h.year, h.id, h.rate, IF(&lt;span class=&quot;hljs-variable&quot;&gt;@lastid&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; (&lt;span class=&quot;hljs-variable&quot;&gt;@lastid&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;h.id), &lt;span class=&quot;hljs-variable&quot;&gt;@index&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-variable&quot;&gt;@index&lt;/span&gt;&lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;@index&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;) indx \n      &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; h.year, h.id, h.rate \n            &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; h\n            &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; h.year &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; rid &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; table2)\n            &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, h.year\n            &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;\n            ) h, (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@lastid&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;&apos;&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;@index&lt;/span&gt;:&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; a\n    ) h \n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; h.indx &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;Build the virtual columnslike RowID in Oracle&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;Table:&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;TABLE&lt;/span&gt; `stack` \n(`&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;` &lt;span class=&quot;hljs-type&quot;&gt;int&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;NULL&lt;/span&gt;,\n`id` &lt;span class=&quot;hljs-type&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;NULL&lt;/span&gt;,\n`rate` &lt;span class=&quot;hljs-type&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;NULL&lt;/span&gt;) \nENGINE&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;InnoDB &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; CHARSET&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;utf8mb4\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;Data:&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;5.9&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;5.3&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;4.4&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;12.5&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;12.4&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2005&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;2.1&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;0.8&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;12.2&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;3.9&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;3.5&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;10.3&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;8.7&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;4.6&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p02&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;3.3&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;7.4&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; stack &lt;span class=&quot;hljs-keyword&quot;&gt;values&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;2008&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;p01&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-number&quot;&gt;6.8&lt;/span&gt;);\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;SQL like this:&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; t3.year,t3.id,t3.rate \n&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; t1.&lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;, (&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; stack t2 &lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt; t1.rate&lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt;t2.rate &lt;span class=&quot;hljs-keyword&quot;&gt;and&lt;/span&gt; t1.id&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;t2.id) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; rownum &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; stack t1) t3 \n&lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt; rownum &lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; id,rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;If delete the where clause in t3, it shows like this:&lt;/p&gt;\n&lt;p&gt;&lt;a href=&quot;https://i.stack.imgur.com/lnxDj.jpg&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;img src=&quot;https://i.stack.imgur.com/lnxDj.jpg&quot; alt=&quot;enter image description here&quot;&gt;&lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;GET &quot;TOP N Record&quot; --&amp;gt; add the &lt;code&gt;rownum &amp;lt;=3&lt;/code&gt; in &lt;code&gt;where&lt;/code&gt; clause (the where-clause of t3);&lt;/p&gt;\n&lt;p&gt;CHOOSE &quot;the year&quot; --&amp;gt; add the &lt;code&gt;BETWEEN 2000 AND 2009&lt;/code&gt; in &lt;code&gt;where&lt;/code&gt; clause (the where-clause of t3);&lt;/p&gt;\n    ","\n&lt;p&gt;Took some working, but I thougth my solution would be something to share as it is seems elegant as well as quite fast.&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; h.year, h.id, h.rate \n  &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; id, \n      SUBSTRING_INDEX(GROUP_CONCAT(CONCAT(id, &lt;span class=&quot;hljs-string&quot;&gt;&apos;-&apos;&lt;/span&gt;, &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;), &lt;span class=&quot;hljs-string&quot;&gt;&apos;,&apos;&lt;/span&gt; , &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; l\n      &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; h\n      &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;\n      &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id\n      &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id\n  ) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; h_temp\n    &lt;span class=&quot;hljs-keyword&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;JOIN&lt;/span&gt; h &lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; h.id &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; h_temp.id \n      &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; SUBSTRING_INDEX(h_temp.l, CONCAT(h.id, &lt;span class=&quot;hljs-string&quot;&gt;&apos;-&apos;&lt;/span&gt;, h.year), &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;hljs-operator&quot;&gt;!=&lt;/span&gt; h_temp.l\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;Note that this example is specified for the purpose of the question and can be modified quite easily for other similar purposes.&lt;/p&gt;\n    ","\n&lt;p&gt;The following post: &lt;a href=&quot;http://code.openark.org/blog/mysql/sql-selecting-top-n-records-per-group&quot; rel=&quot;nofollow&quot;&gt;sql: selcting top N record per group&lt;/a&gt; describes the complicated way of achieving this without subqueries.&lt;/p&gt;\n\n&lt;p&gt;It improves on other solutions offered here by:&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;Doing everything in a single query&lt;/li&gt;\n&lt;li&gt;Being able to properly utilize indexes&lt;/li&gt;\n&lt;li&gt;Avoiding subqueries, notoriously known to produce bad execution plans in MySQL&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;p&gt;It is however not pretty. A good solution would be achievable were Window Functions (aka Analytic Functions) enabled in MySQL -- but they are not.\nThe trick used in said post utilizes GROUP_CONCAT, which is sometimes described as &quot;poor man&apos;s Window Functions for MySQL&quot;.&lt;/p&gt;\n    ","\n&lt;p&gt;for those like me that had queries time out. I made the below to use limits and anything else by a specific group.&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;DELIMITER $$\n&lt;span class=&quot;hljs-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;PROCEDURE&lt;/span&gt; count_limit200()\n&lt;span class=&quot;hljs-keyword&quot;&gt;BEGIN&lt;/span&gt;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; a &lt;span class=&quot;hljs-type&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;Default&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; stop_loop &lt;span class=&quot;hljs-type&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;Default&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; domain_val &lt;span class=&quot;hljs-type&quot;&gt;VARCHAR&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;250&lt;/span&gt;);\n    &lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; domain_list &lt;span class=&quot;hljs-keyword&quot;&gt;CURSOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;DISTINCT&lt;/span&gt; domain &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; db.one;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;OPEN&lt;/span&gt; domain_list;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;DISTINCT&lt;/span&gt;(domain)) &lt;span class=&quot;hljs-keyword&quot;&gt;INTO&lt;/span&gt; stop_loop \n    &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; db.one;\n    &lt;span class=&quot;hljs-comment&quot;&gt;-- BEGIN LOOP&lt;/span&gt;\n    loop_thru_domains: LOOP\n        &lt;span class=&quot;hljs-keyword&quot;&gt;FETCH&lt;/span&gt; domain_list &lt;span class=&quot;hljs-keyword&quot;&gt;INTO&lt;/span&gt; domain_val;\n        &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; a&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;a&lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;;\n\n        &lt;span class=&quot;hljs-keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;INTO&lt;/span&gt; db.two(book,artist,title,title_count,last_updated) \n        &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; \n        (\n            &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; book,artist,title,&lt;span class=&quot;hljs-built_in&quot;&gt;COUNT&lt;/span&gt;(ObjectKey) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; titleCount, NOW() \n            &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; db.one \n            &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; book &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; domain_val\n            &lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; artist,title\n            &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; book,titleCount &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;\n            LIMIT &lt;span class=&quot;hljs-number&quot;&gt;200&lt;/span&gt;\n        ) a &lt;span class=&quot;hljs-keyword&quot;&gt;ON&lt;/span&gt; DUPLICATE KEY &lt;span class=&quot;hljs-keyword&quot;&gt;UPDATE&lt;/span&gt; title_count &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; titleCount, last_updated &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; NOW();\n\n        IF a &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; stop_loop &lt;span class=&quot;hljs-keyword&quot;&gt;THEN&lt;/span&gt;\n            LEAVE loop_thru_domain;\n        &lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; IF;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; LOOP loop_thru_domain;\n&lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; $$\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;it loops through a list of domains and then inserts only a limit of 200 each&lt;/p&gt;\n    ","\n&lt;p&gt;Try this:&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@num&lt;/span&gt; :&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;hljs-variable&quot;&gt;@type&lt;/span&gt; :&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&apos;&apos;&lt;/span&gt;;\n&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; `&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;`, `id`, `rate`,\n    &lt;span class=&quot;hljs-variable&quot;&gt;@num&lt;/span&gt; :&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; if(&lt;span class=&quot;hljs-variable&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; `id`, &lt;span class=&quot;hljs-variable&quot;&gt;@num&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; `row_number`,\n    &lt;span class=&quot;hljs-variable&quot;&gt;@type&lt;/span&gt; :&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; `id` &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; `dummy`\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; (\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;*&lt;/span&gt;\n    &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; `h`\n    &lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; (\n        `&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;` &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&apos;2000&apos;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&apos;2009&apos;&lt;/span&gt;\n        &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; `id` &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; `rid` &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; `table2`) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; `temp_rid`\n    )\n    &lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; `id`\n) &lt;span class=&quot;hljs-keyword&quot;&gt;AS&lt;/span&gt; `temph`\n&lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; `&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;`, `id`, `rate`\n&lt;span class=&quot;hljs-keyword&quot;&gt;HAVING&lt;/span&gt; `row_number`&lt;span class=&quot;hljs-operator&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;5&apos;&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; `id`, `rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;;\n&lt;/code&gt;&lt;/pre&gt;\n    ","\n&lt;p&gt;Please try below stored procedure. I have already verified. I am getting proper result but without using &lt;code&gt;groupby&lt;/code&gt;.&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;CREATE&lt;/span&gt; DEFINER&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;`ks_root`@`&lt;span class=&quot;hljs-operator&quot;&gt;%&lt;/span&gt;` &lt;span class=&quot;hljs-keyword&quot;&gt;PROCEDURE&lt;/span&gt; `first_five_record_per_id`()\n&lt;span class=&quot;hljs-keyword&quot;&gt;BEGIN&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; query_string text;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; datasource1 &lt;span class=&quot;hljs-type&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; done &lt;span class=&quot;hljs-type&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; tenants &lt;span class=&quot;hljs-type&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;50&lt;/span&gt;);\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; cur1 &lt;span class=&quot;hljs-keyword&quot;&gt;CURSOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; rid &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; demo1;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DECLARE&lt;/span&gt; CONTINUE HANDLER &lt;span class=&quot;hljs-keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;NOT&lt;/span&gt; FOUND &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; done &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string&lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&apos;&apos;&lt;/span&gt;;\n\n      &lt;span class=&quot;hljs-keyword&quot;&gt;OPEN&lt;/span&gt; cur1;\n      read_loop: LOOP\n\n      &lt;span class=&quot;hljs-keyword&quot;&gt;FETCH&lt;/span&gt; cur1 &lt;span class=&quot;hljs-keyword&quot;&gt;INTO&lt;/span&gt; tenants ;\n\n      IF done &lt;span class=&quot;hljs-keyword&quot;&gt;THEN&lt;/span&gt;\n        LEAVE read_loop;\n      &lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; IF;\n\n      &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@datasource1&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; tenants;\n      &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; concat(&lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string,&lt;span class=&quot;hljs-string&quot;&gt;&apos;(select * from demo  where `id` = &apos;&apos;&apos;&lt;/span&gt;,&lt;span class=&quot;hljs-variable&quot;&gt;@datasource1&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&apos;&apos;&apos; order by rate desc LIMIT 5) UNION ALL &apos;&lt;/span&gt;);\n\n       &lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt; LOOP; \n      &lt;span class=&quot;hljs-keyword&quot;&gt;close&lt;/span&gt; cur1;\n\n    &lt;span class=&quot;hljs-keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string  &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;TRIM&lt;/span&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;TRAILING&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&apos;UNION ALL&apos;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;TRIM&lt;/span&gt;(&lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string));  \n  &lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string;\n&lt;span class=&quot;hljs-keyword&quot;&gt;PREPARE&lt;/span&gt; stmt &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;@query&lt;/span&gt;_string;\n&lt;span class=&quot;hljs-keyword&quot;&gt;EXECUTE&lt;/span&gt; stmt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;DEALLOCATE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;PREPARE&lt;/span&gt; stmt;\n\n&lt;span class=&quot;hljs-keyword&quot;&gt;END&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n    "],"comment":["\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;This can be done in MySQL, but it is not as simple as adding a &lt;code&gt;LIMIT&lt;/code&gt; clause. Here is an article that explains the problem in detail: &lt;a href=&quot;http://www.xaprb.com/blog/2006/12/07/how-to-select-the-firstleastmax-row-per-group-in-sql/&quot; rel=&quot;nofollow noreferrer&quot;&gt;How to select the first/least/max row per group in SQL&lt;/a&gt; It&apos;s a good article - he introduces an elegant but nave solution to the &quot;Top N per group&quot; problem, and then gradually improves on it.&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/217332/danben&quot; title=&quot;77,868 reputation&quot; class=&quot;comment-user&quot;&gt;danben&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment63612664_2129693&quot;&gt;&lt;span title=&quot;2010-01-25 01:31:14Z, License: CC BY-SA 2.5&quot; class=&quot;relativetime-clean&quot;&gt;Jan 25, 2010 at 1:31&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n                        &lt;span title=&quot;this comment was edited 1 time&quot;&gt;\n                            &lt;svg aria-hidden=&quot;true&quot; class=&quot;va-text-bottom o50 svg-icon iconPencilSm&quot; width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 14 14&quot;&gt;&lt;path d=&quot;m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n                        &lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;SELECT * FROM (SELECT year, id, rate FROM h WHERE year BETWEEN 2000 AND 2009 AND id IN (SELECT rid FROM table2) GROUP BY id, year ORDER BY id, rate DESC) LIMIT 5&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/2291805/mixcoatl&quot; title=&quot;160 reputation&quot; class=&quot;comment-user&quot;&gt;Mixcoatl&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment58090285_2129693&quot;&gt;&lt;span title=&quot;2016-02-03 20:05:48Z, License: CC BY-SA 3.0&quot; class=&quot;relativetime-clean&quot;&gt;Feb 3, 2016 at 20:05&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;This problem has been resolved by introducing sql windowing functions as it is explained in this answer. &lt;a href=&quot;https://stackoverflow.com/a/38854846/2723942&quot;&gt;stackoverflow.com/a/38854846/2723942&lt;/a&gt;&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/2723942/paramvir-singh-karwal&quot; title=&quot;557 reputation&quot; class=&quot;comment-user&quot;&gt;Paramvir Singh Karwal&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment125412930_2129693&quot;&gt;&lt;span title=&quot;2022-02-01 14:52:40Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;Feb 1 at 14:52&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n                        &lt;span title=&quot;this comment was edited 1 time&quot;&gt;\n                            &lt;svg aria-hidden=&quot;true&quot; class=&quot;va-text-bottom o50 svg-icon iconPencilSm&quot; width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 14 14&quot;&gt;&lt;path d=&quot;m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n                        &lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;That&apos;s &lt;i&gt;beautifully&lt;/i&gt; performant, comparatively simple, and great explanation; thank you SO MUCH. To your last point, Where a reasonable maximum length can be computed, one can use &lt;code&gt;SET SESSION group_concat_max_len = &amp;lt;maximum length&amp;gt;;&lt;/code&gt; In the OP&apos;s case, a non-issue (since the default is 1024), but by way of example, group_concat_max_len should be at least 25: 4 (max length of a year string) + 1 (separator character), times 5 (first 5 years).  The strings are truncated rather than throwing an error, so watch for warnings such as &lt;code&gt;1054 rows in set, 789 warnings (0.31 sec)&lt;/code&gt;.&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/1015143/timothy-johns&quot; title=&quot;1,045 reputation&quot; class=&quot;comment-user&quot;&gt;Timothy Johns&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment85623840_15585351&quot;&gt;&lt;span title=&quot;2018-03-15 23:35:43Z, License: CC BY-SA 3.0&quot; class=&quot;relativetime-clean&quot;&gt;Mar 15, 2018 at 23:35&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n                        &lt;span title=&quot;this comment was edited 2 times&quot;&gt;\n                            &lt;svg aria-hidden=&quot;true&quot; class=&quot;va-text-bottom o50 svg-icon iconPencilSm&quot; width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 14 14&quot;&gt;&lt;path d=&quot;m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n                        &lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;If i want to fetch exact 2 rows rather than 1 to 5 than what should I use with &lt;code&gt;FIND_IN_SET()&lt;/code&gt;. I tried for &lt;code&gt;FIND_IN_SET() =2&lt;/code&gt; but not showing result as expected.&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/1629242/amogh&quot; title=&quot;4,340 reputation&quot; class=&quot;comment-user&quot;&gt;Amogh&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment91171575_15585351&quot;&gt;&lt;span title=&quot;2018-08-31 07:32:21Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;Aug 31, 2018 at 7:32&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;FIND_IN_SET BETWEEN 1 and 5 will take the first 5 positions of GROUP_CONCAT set if size equal to or greater than 5. So FIND_IN_SET = 2 will take only the data with the 2nd position in your GROUP_CONCAT. Getting 2 rows you can try BETWEEN 1 and 2 for 1st and 2nd position assuming set has 2 rows to give.&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/7438853/wheelerswebservices&quot; title=&quot;1,320 reputation&quot; class=&quot;comment-user&quot;&gt;wheelerswebservices&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment93524495_15585351&quot;&gt;&lt;span title=&quot;2018-11-15 14:57:37Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;Nov 15, 2018 at 14:57&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;This solution has much better performance than Salman&apos;s for large datasets. I gave a thumbs up to both for such clever solutions anyway. Thanks!!&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/5279675/tiomno&quot; title=&quot;2,001 reputation&quot; class=&quot;comment-user&quot;&gt;tiomno&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment95894534_15585351&quot;&gt;&lt;span title=&quot;2019-02-06 05:20:45Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;Feb 6, 2019 at 5:20&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;Regarding &quot;this works well if you need to select a few records for every group&quot;: does MySQL actually &lt;i&gt;avoid reading more data&lt;/i&gt; once the string is full? I have a suspicion that it will first load all rows into memory, thus risking a full index/table scan regardless of the max string length. I&apos;d be thrilled if I&apos;m wrong.&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/543814/timo&quot; title=&quot;7,078 reputation&quot; class=&quot;comment-user&quot;&gt;Timo&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment125816269_15585351&quot;&gt;&lt;span title=&quot;2022-02-18 16:23:51Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;Feb 18 at 16:23&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;+1 your answer rewrite is very valid, as modern MySQL/MariaDB versions follow the ANSI/ISO SQL 1992/1999/2003 standards more where it was never really was allowed to use &lt;code&gt;ORDER BY&lt;/code&gt; in deliverd/subqueries like that.. That is the reason why modern MySQL/MariaDB versions ignore the &lt;code&gt;ORDER BY&lt;/code&gt; in subquery without using &lt;code&gt;LIMIT&lt;/code&gt;, i believe ANSI/ISO SQL Standards 2008/2011/2016 makes &lt;code&gt;ORDER BY&lt;/code&gt; in deliverd/subqueries legal when using it in combination with &lt;code&gt;FETCH FIRST n ROWS ONLY&lt;/code&gt;&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/2548147/raymond-nijland&quot; title=&quot;11,223 reputation&quot; class=&quot;comment-user&quot;&gt;Raymond Nijland&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment98623827_30269273&quot;&gt;&lt;span title=&quot;2019-05-04 23:05:18Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;May 4, 2019 at 23:05&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n                        &lt;span title=&quot;this comment was edited 7 times&quot;&gt;\n                            &lt;svg aria-hidden=&quot;true&quot; class=&quot;va-text-bottom o50 svg-icon iconPencilSm&quot; width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 14 14&quot;&gt;&lt;path d=&quot;m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n                        &lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;Great, this works perfectly ... I came across another solution (&lt;a href=&quot;https://stackoverflow.com/a/48593547&quot;&gt;stackoverflow.com/a/48593547&lt;/a&gt;) which uses a correlated subquery, that one also works and yields the same results, however I think your solution (with a join) runs a lot faster.&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/2474068/leo&quot; title=&quot;1,099 reputation&quot; class=&quot;comment-user&quot;&gt;leo&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment107365596_30269273&quot;&gt;&lt;span title=&quot;2020-03-14 15:05:03Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;Mar 14, 2020 at 15:05&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;Your solution worked perfectly, but I also want to retrieve year and other columns from the subquery, How can we do that?&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/1718982/mann&quot; title=&quot;695 reputation&quot; class=&quot;comment-user&quot;&gt;MaNn&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment100678431_19185232&quot;&gt;&lt;span title=&quot;2019-07-17 13:57:23Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;Jul 17, 2019 at 13:57&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;This is nice but MySQL has no window functions (like &lt;code&gt;ROW_NUMBER()&lt;/code&gt;).&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/344949/ypercube%e1%b5%80%e1%b4%b9&quot; title=&quot;109,988 reputation&quot; class=&quot;comment-user&quot;&gt;ypercube&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment19686604_13616644&quot;&gt;&lt;span title=&quot;2013-01-07 16:06:06Z, License: CC BY-SA 3.0&quot; class=&quot;relativetime-clean&quot;&gt;Jan 7, 2013 at 16:06&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n                        &lt;span title=&quot;this comment was edited 1 time&quot;&gt;\n                            &lt;svg aria-hidden=&quot;true&quot; class=&quot;va-text-bottom o50 svg-icon iconPencilSm&quot; width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 14 14&quot;&gt;&lt;path d=&quot;m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n                        &lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;As of MySQL 8.0, &lt;code&gt;row_number()&lt;/code&gt; is &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html#function_row-number&quot; rel=&quot;nofollow noreferrer&quot;&gt;available&lt;/a&gt;.&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/1612428/erickg&quot; title=&quot;891 reputation&quot; class=&quot;comment-user&quot;&gt;erickg&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment81980633_13616644&quot;&gt;&lt;span title=&quot;2017-11-27 13:47:34Z, License: CC BY-SA 3.0&quot; class=&quot;relativetime-clean&quot;&gt;Nov 27, 2017 at 13:47&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;For the example to work as is, would only add an alias to the row number:  &lt;code&gt;(row_number() over (partition by user_id order by created_at DESC)) as row_number&lt;/code&gt;&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/575060/soniaseguz&quot; title=&quot;73 reputation&quot; class=&quot;comment-user&quot;&gt;soniaseguz&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment119299683_13616644&quot;&gt;&lt;span title=&quot;2021-05-11 23:09:44Z, License: CC BY-SA 4.0&quot; class=&quot;relativetime-clean&quot;&gt;May 11, 2021 at 23:09&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n                        &lt;span title=&quot;this comment was edited 1 time&quot;&gt;\n                            &lt;svg aria-hidden=&quot;true&quot; class=&quot;va-text-bottom o50 svg-icon iconPencilSm&quot; width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 14 14&quot;&gt;&lt;path d=&quot;m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n                        &lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;unknown column a.type in field list&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/1841456/anu&quot; title=&quot;977 reputation&quot; class=&quot;comment-user&quot;&gt;anu&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment41200537_14170492&quot;&gt;&lt;span title=&quot;2014-10-08 17:25:09Z, License: CC BY-SA 3.0&quot; class=&quot;relativetime-clean&quot;&gt;Oct 8, 2014 at 17:25&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;If you have rates that repeat for the same id, then this will not work because  your rowNum count will increase higher; you will not get 3 per row, you can get 0, 1 or 2. Can you think of any solution to this?&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/3397607/starvator&quot; title=&quot;949 reputation&quot; class=&quot;comment-user&quot;&gt;starvator&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment63433727_37113202&quot;&gt;&lt;span title=&quot;2016-06-23 14:52:14Z, License: CC BY-SA 3.0&quot; class=&quot;relativetime-clean&quot;&gt;Jun 23, 2016 at 14:52&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n            &lt;/div&gt;\n        ","\n            &lt;div class=&quot;comment-body js-comment-edit-hide&quot;&gt;\n                \n                &lt;span class=&quot;comment-copy&quot;&gt;@starvator change the &quot;t1.rate&amp;lt;=t2.rate&quot; to &quot;t1.rate&amp;lt;t2.rate&quot;, if the best rate has same values in the same id, all of them has the same rownum but will not increase higher; like &quot;rate 8 in id p01&quot;, if it repeats, by using &quot;t1.rate&amp;lt;t2.rate&quot;, both of &quot;rate 8 in id p01&quot; has the same rownum 0; if using &quot;t1.rate&amp;lt;=t2.rate&quot;, the rownum is 2;&lt;/span&gt;\n                \n              &lt;div class=&quot;d-inline-flex ai-center&quot;&gt;\n&amp;nbsp;&lt;a href=&quot;/users/6138456/wang-wenan&quot; title=&quot;312 reputation&quot; class=&quot;comment-user&quot;&gt;Wang Wen&apos;an&lt;/a&gt;\n                &lt;/div&gt;\n                &lt;span class=&quot;comment-date&quot; dir=&quot;ltr&quot;&gt;&lt;a class=&quot;comment-link&quot; href=&quot;#comment64059609_37113202&quot;&gt;&lt;span title=&quot;2016-07-12 07:11:49Z, License: CC BY-SA 3.0&quot; class=&quot;relativetime-clean&quot;&gt;Jul 12, 2016 at 7:11&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;\n                        &lt;span title=&quot;this comment was edited 2 times&quot;&gt;\n                            &lt;svg aria-hidden=&quot;true&quot; class=&quot;va-text-bottom o50 svg-icon iconPencilSm&quot; width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 14 14&quot;&gt;&lt;path d=&quot;m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n                        &lt;/span&gt;\n            &lt;/div&gt;\n        "],"id":529,"title":"Using LIMIT within GROUP BY to get N results per group?","content":"\n                \n&lt;p&gt;The following query:&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;, id, rate\n&lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; h\n&lt;span class=&quot;hljs-keyword&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BETWEEN&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;AND&lt;/span&gt; id &lt;span class=&quot;hljs-keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;SELECT&lt;/span&gt; rid &lt;span class=&quot;hljs-keyword&quot;&gt;FROM&lt;/span&gt; table2)\n&lt;span class=&quot;hljs-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, &lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;\n&lt;span class=&quot;hljs-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;BY&lt;/span&gt; id, rate &lt;span class=&quot;hljs-keyword&quot;&gt;DESC&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;yields:&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;year&lt;/span&gt;    id  rate\n&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;7.4&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2008&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;6.8&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;5.9&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;5.3&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2009&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;4.4&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;3.9&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;3.5&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2005&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;2.1&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;0.8&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;12.5&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;12.4&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;12.2&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;10.3&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;8.7&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;4.6&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;3.3&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;What I&apos;d like is only the top 5 results for each id:&lt;/p&gt;\n\n&lt;pre class=&quot;lang-sql s-code-block&quot;&gt;&lt;code class=&quot;hljs language-sql&quot;&gt;&lt;span class=&quot;hljs-number&quot;&gt;2006&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;7.4&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2008&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;6.8&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;5.9&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2007&lt;/span&gt;    p01 &lt;span class=&quot;hljs-number&quot;&gt;5.3&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2001&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;12.5&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2004&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;12.4&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2002&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;12.2&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2003&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;10.3&lt;/span&gt;\n&lt;span class=&quot;hljs-number&quot;&gt;2000&lt;/span&gt;    p02 &lt;span class=&quot;hljs-number&quot;&gt;8.7&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n\n&lt;p&gt;Is there a way to do this using some kind of LIMIT like modifier that works within the GROUP BY?&lt;/p&gt;\n    ","slug":"using-limit-within-group-by-to-get-n-results-per-group-1657388324167","postType":"QUESTION","createdAt":"2022-07-09T17:38:44.000Z","updatedAt":"2022-07-09T17:38:44.000Z","tags":[{"id":2604,"name":"ranking","slug":"ranking","createdAt":"2022-07-09T17:38:44.000Z","updatedAt":"2022-07-09T17:38:44.000Z","Questions_Tags":{"questionId":529,"tagId":2604}}]}},"__N_SSG":true}