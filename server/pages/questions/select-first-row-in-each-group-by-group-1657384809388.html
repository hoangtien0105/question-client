<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@solutionschecker.com"/><meta name="twitter:creator" content="@solutionschecker.com"/><meta property="og:url" content="https://solutionschecker.com"/><meta property="og:type" content="website"/><meta property="og:image" content="https://solutionschecker.com/solutions-checker-banner.png"/><meta property="og:image:alt" content="Find solution for coding, HTML, CSS, JAVASCRIPT, MYSQL, PHP, PYTHON,... quickly. - solutionschecker.com"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","logo":"/logo.svg","url":"https://solutionschecker.com"}</script><title>Select first row in each GROUP BY group? | Solutions Checker</title><meta name="robots" content="index,follow"/><meta name="description" content="As the title suggests, I&#x27;d like to select the first row of each set of rows grouped with a GROUP BY.
Specifically, if I&#x27;ve got a purchases table that looks like this:
SELECT * FROM purchases;

My Output:




id
customer
total




1
Joe
5


2
Sally
3


3
Joe
2


4
Sally
1




I&#x27;d like to query for the id of the largest purchase (total) made by each customer. Something like this:
SELECT FIRST(id), customer, FIRST(total)
FROM  purchases
GROUP BY customer
ORDER BY total DESC;

Expected Output:




FIRST(id)
customer
FIRST(total)




1
Joe
5


2
Sally
3



    "/><meta property="og:title" content="Select first row in each GROUP BY group? | Solutions Checker"/><meta property="og:description" content="As the title suggests, I&#x27;d like to select the first row of each set of rows grouped with a GROUP BY.
Specifically, if I&#x27;ve got a purchases table that looks like this:
SELECT * FROM purchases;

My Output:




id
customer
total




1
Joe
5


2
Sally
3


3
Joe
2


4
Sally
1




I&#x27;d like to query for the id of the largest purchase (total) made by each customer. Something like this:
SELECT FIRST(id), customer, FIRST(total)
FROM  purchases
GROUP BY customer
ORDER BY total DESC;

Expected Output:




FIRST(id)
customer
FIRST(total)




1
Joe
5


2
Sally
3



    "/><script type="application/ld+json">{"@context":"https://schema.org","@type":"QAPage","mainEntity":{"name":"Select first row in each GROUP BY group?","text":"As the title suggests, I&apos;d like to select the first row of each set of rows grouped with a GROUP BY.\nSpecifically, if I&apos;ve got a purchases table that looks like this:\nSELECT * FROM purchases;\n\nMy Output:\n\n\n\n\nid\ncustomer\ntotal\n\n\n\n\n1\nJoe\n5\n\n\n2\nSally\n3\n\n\n3\nJoe\n2\n\n\n4\nSally\n1\n\n\n\n\nI&apos;d like to query for the id of the largest purchase (total) made by each customer. Something like this:\nSELECT FIRST(id), customer, FIRST(total)\nFROM  purchases\nGROUP BY customer\nORDER BY total DESC;\n\nExpected Output:\n\n\n\n\nFIRST(id)\ncustomer\nFIRST(total)\n\n\n\n\n1\nJoe\n5\n\n\n2\nSally\n3\n\n\n\n    ","answerCount":20,"upVoteCount":500,"suggestedAnswer":[{"text":"DISTINCT ON is typically simplest and fastest for this in PostgreSQL.\n(For performance optimization for certain workloads see below.)\nSELECT DISTINCT ON (customer)\n       id, customer, total\nFROM   purchases\nORDER  BY customer, total DESC, id;\n\nOr shorter (if not as clear) with ordinal numbers of output columns:\nSELECT DISTINCT ON (2)\n       id, customer, total\nFROM   purchases\nORDER  BY 2, 3 DESC, 1;\n\nIf total can be NULL, add NULLS LAST:\n...\nORDER  BY customer, total DESC NULLS LAST, id;\n\nWorks either way, but you&apos;ll want to match existing indexes\ndb&lt;&gt;fiddle here\nMajor points\nDISTINCT ON is a PostgreSQL extension of the standard, where only DISTINCT on the whole SELECT list is defined.\nList any number of expressions in the DISTINCT ON clause, the combined row value defines duplicates. The manual:\n\nObviously, two rows are considered distinct if they differ in at least\none column value. Null values are considered equal in this\ncomparison.\n\nBold emphasis mine.\nDISTINCT ON can be combined with ORDER BY. Leading expressions in ORDER BY must be in the set of expressions in DISTINCT ON, but you can rearrange order among those freely. Example.\nYou can add additional expressions to ORDER BY to pick a particular row from each group of peers. Or, as the manual puts it:\n\nThe DISTINCT ON expression(s) must match the leftmost ORDER BY\nexpression(s). The ORDER BY clause will normally contain additional\nexpression(s) that determine the desired precedence of rows within\neach DISTINCT ON group.\n\nI added id as last item to break ties:\n&quot;Pick the row with the smallest id from each group sharing the highest total.&quot;\nTo order results in a way that disagrees with the sort order determining the first per group, you can nest above query in an outer query with another ORDER BY. Example.\nIf total can be NULL, you most probably want the row with the greatest non-null value. Add NULLS LAST like demonstrated. See:\n\nSort by column ASC, but NULL values first?\n\nThe SELECT list is not constrained by expressions in DISTINCT ON or ORDER BY in any way:\n\nYou don&apos;t have to include any of the expressions in DISTINCT ON or ORDER BY.\n\nYou can include any other expression in the SELECT list. This is instrumental for replacing complex subqueries and aggregate / window functions.\n\n\nI tested with Postgres versions 8.3  15. But the feature has been there at least since version 7.1, so basically always.\nIndex\nThe perfect index for the above query would be a multi-column index spanning all three columns in matching sequence and with matching sort order:\nCREATE INDEX purchases_3c_idx ON purchases (customer, total DESC, id);\n\nMay be too specialized. But use it if read performance for the particular query is crucial. If you have DESC NULLS LAST in the query, use the same in the index so that sort order matches and the index is perfectly applicable.\nEffectiveness / Performance optimization\nWeigh cost and benefit before creating tailored indexes for each query. The potential of above index largely depends on data distribution.\nThe index is used because it delivers pre-sorted data. In Postgres 9.2 or later the query can also benefit from an index only scan if the index is smaller than the underlying table. The index has to be scanned in its entirety, though. Example.\nFor few rows per customer (high cardinality in column customer), this is very efficient. Even more so if you need sorted output anyway. The benefit shrinks with a growing number of rows per customer.\nIdeally, you have enough work_mem to process the involved sort step in RAM and not spill to disk. But generally setting work_mem too high can have adverse effects. Consider SET LOCAL for exceptionally big queries. Find how much you need with EXPLAIN ANALYZE. Mention of &quot;Disk:&quot; in the sort step indicates the need for more:\n\nConfiguration parameter work_mem in PostgreSQL on Linux\nOptimize simple query using ORDER BY date and text\n\nFor many rows per customer (low cardinality in column customer), a loose index scan (a.k.a. &quot;skip scan&quot;) would be (much) more efficient, but that&apos;s not implemented up to Postgres 14. (An implementation for index-only scans is in development for Postgres 15. See here and here.)\nFor now, there are faster query techniques to substitute for this. In particular if you have a separate table holding unique customers, which is the typical use case. But also if you don&apos;t:\n\nSELECT DISTINCT is slower than expected on my table in PostgreSQL\nOptimize GROUP BY query to retrieve latest row per user\nOptimize groupwise maximum query\nQuery last N related rows per row\n\nBenchmarks\nSee separate answer.\n    ","url":"/questions/[slug]#solution1","@type":"Answer","upvoteCount":0},{"text":"On databases that support CTE and windowing functions:\nWITH summary AS (\n    SELECT p.id, \n           p.customer, \n           p.total, \n           ROW_NUMBER() OVER(PARTITION BY p.customer \n                                 ORDER BY p.total DESC) AS rank\n      FROM PURCHASES p)\n SELECT *\n   FROM summary\n WHERE rank = 1\n\nSupported by any database:\nBut you need to add logic to break ties:\n  SELECT MIN(x.id),  -- change to MAX if you want the highest\n         x.customer, \n         x.total\n    FROM PURCHASES x\n    JOIN (SELECT p.customer,\n                 MAX(total) AS max_total\n            FROM PURCHASES p\n        GROUP BY p.customer) y ON y.customer = x.customer\n                              AND y.max_total = x.total\nGROUP BY x.customer, x.total\n\n    ","url":"/questions/[slug]#solution2","@type":"Answer","upvoteCount":0},{"text":"Benchmarks\nI tested the most interesting candidates:\n\nInitially with Postgres 9.4 and 9.5.\nAdded accented tests for Postgres 13 later.\n\nBasic test setup\nMain table: purchases:\nCREATE TABLE purchases (\n  id          serial  -- PK constraint added below\n, customer_id int     -- REFERENCES customer\n, total       int     -- could be amount of money in Cent\n, some_column text    -- to make the row bigger, more realistic\n);\n\nDummy data (with some dead tuples), PK, index:\nINSERT INTO purchases (customer_id, total, some_column)    -- 200k rows\nSELECT (random() * 10000)::int             AS customer_id  -- 10k distinct customers\n     , (random() * random() * 100000)::int AS total     \n     , &apos;note: &apos; || repeat(&apos;x&apos;, (random()^2 * random() * random() * 500)::int)\nFROM   generate_series(1,200000) g;\n\nALTER TABLE purchases ADD CONSTRAINT purchases_id_pkey PRIMARY KEY (id);\n\nDELETE FROM purchases WHERE random() &gt; 0.9;  -- some dead rows\n\nINSERT INTO purchases (customer_id, total, some_column)\nSELECT (random() * 10000)::int             AS customer_id  -- 10k customers\n     , (random() * random() * 100000)::int AS total     \n     , &apos;note: &apos; || repeat(&apos;x&apos;, (random()^2 * random() * random() * 500)::int)\nFROM   generate_series(1,20000) g;  -- add 20k to make it ~ 200k\n\nCREATE INDEX purchases_3c_idx ON purchases (customer_id, total DESC, id);\n\nVACUUM ANALYZE purchases;\n\ncustomer table - used for optimized query:\nCREATE TABLE customer AS\nSELECT customer_id, &apos;customer_&apos; || customer_id AS customer\nFROM   purchases\nGROUP  BY 1\nORDER  BY 1;\n\nALTER TABLE customer ADD CONSTRAINT customer_customer_id_pkey PRIMARY KEY (customer_id);\n\nVACUUM ANALYZE customer;\n\nIn my second test for 9.5 I used the same setup, but with 100000 distinct customer_id to get few rows per customer_id.\nObject sizes for table purchases\nBasic setup: 200k rows in purchases, 10k distinct customer_id, avg. 20 rows per customer.\nFor Postgres 9.5 I added a 2nd test with 86446 distinct customers - avg. 2.3 rows per customer.\nGenerated with a query taken from here:\n\nMeasure the size of a PostgreSQL table row\n\nGathered for Postgres 9.5:\n               what                | bytes/ct | bytes_pretty | bytes_per_row\n-----------------------------------+----------+--------------+---------------\n core_relation_size                | 20496384 | 20 MB        |           102\n visibility_map                    |        0 | 0 bytes      |             0\n free_space_map                    |    24576 | 24 kB        |             0\n table_size_incl_toast             | 20529152 | 20 MB        |           102\n indexes_size                      | 10977280 | 10 MB        |            54\n total_size_incl_toast_and_indexes | 31506432 | 30 MB        |           157\n live_rows_in_text_representation  | 13729802 | 13 MB        |            68\n ------------------------------    |          |              |\n row_count                         |   200045 |              |\n live_tuples                       |   200045 |              |\n dead_tuples                       |    19955 |              |\n\nQueries\n1. row_number() in CTE, (see other answer)\nWITH cte AS (\n   SELECT id, customer_id, total\n        , row_number() OVER (PARTITION BY customer_id ORDER BY total DESC) AS rn\n   FROM   purchases\n   )\nSELECT id, customer_id, total\nFROM   cte\nWHERE  rn = 1;\n\n2. row_number() in subquery (my optimization)\nSELECT id, customer_id, total\nFROM   (\n   SELECT id, customer_id, total\n        , row_number() OVER (PARTITION BY customer_id ORDER BY total DESC) AS rn\n   FROM   purchases\n   ) sub\nWHERE  rn = 1;\n\n3. DISTINCT ON (see other answer)\nSELECT DISTINCT ON (customer_id)\n       id, customer_id, total\nFROM   purchases\nORDER  BY customer_id, total DESC, id;\n\n4. rCTE with LATERAL subquery (see here)\nWITH RECURSIVE cte AS (\n   (  -- parentheses required\n   SELECT id, customer_id, total\n   FROM   purchases\n   ORDER  BY customer_id, total DESC\n   LIMIT  1\n   )\n   UNION ALL\n   SELECT u.*\n   FROM   cte c\n   ,      LATERAL (\n      SELECT id, customer_id, total\n      FROM   purchases\n      WHERE  customer_id &gt; c.customer_id  -- lateral reference\n      ORDER  BY customer_id, total DESC\n      LIMIT  1\n      ) u\n   )\nSELECT id, customer_id, total\nFROM   cte\nORDER  BY customer_id;\n\n5. customer table with LATERAL (see here)\nSELECT l.*\nFROM   customer c\n,      LATERAL (\n   SELECT id, customer_id, total\n   FROM   purchases\n   WHERE  customer_id = c.customer_id  -- lateral reference\n   ORDER  BY total DESC\n   LIMIT  1\n   ) l;\n\n6. array_agg() with ORDER BY (see other answer)\nSELECT (array_agg(id ORDER BY total DESC))[1] AS id\n     , customer_id\n     , max(total) AS total\nFROM   purchases\nGROUP  BY customer_id;\n\nResults\nExecution time for above queries with EXPLAIN (ANALYZE, TIMING OFF, COSTS OFF, best of 5 runs to compare with warm cache.\nAll queries used an Index Only Scan on purchases2_3c_idx (among other steps). Some only to benefit from the smaller size of the index, others more effectively.\nA. Postgres 9.4 with 200k rows and ~ 20 per customer_id\n1. 273.274 ms  \n2. 194.572 ms  \n3. 111.067 ms  \n4.  92.922 ms  -- !\n5.  37.679 ms  -- winner\n6. 189.495 ms\n\nB. Same as A. with Postgres 9.5\n1. 288.006 ms\n2. 223.032 ms  \n3. 107.074 ms  \n4.  78.032 ms  -- !\n5.  33.944 ms  -- winner\n6. 211.540 ms  \n\nC. Same as B., but with ~ 2.3 rows per customer_id\n1. 381.573 ms\n2. 311.976 ms\n3. 124.074 ms  -- winner\n4. 710.631 ms\n5. 311.976 ms\n6. 421.679 ms\n\nRetest with Postgres 13 on 2021-08-11\nSimplified test setup: no deleted rows, because VACUUM ANALYZE cleans the table completely for the simple case.\nImportant changes for Postgres:\n\nGeneral performance improvements.\nCTEs can be inlined since Postgres 12, so query 1. and 2. now perform mostly identical (same query plan).\n\nD. Like B. ~ 20 rows per customer_id\n1. 103 ms\n2. 103 ms  \n3.  23 ms  -- winner  \n4.  71 ms  \n5.  22 ms  -- winner\n6.  81 ms  \n\ndb&lt;&gt;fiddle here\nE. Like C. ~ 2.3 rows per customer_id\n1. 127 ms\n2. 126 ms  \n3.  36 ms  -- winner  \n4. 620 ms  \n5. 145 ms\n6. 203 ms  \n\ndb&lt;&gt;fiddle here\nAccented tests with Postgres 13\n1M rows, 10.000 vs. 100 vs. 1.6 rows per customer.\nF. with ~ 10.000 rows per customer\n1. 526 ms\n2. 527 ms  \n3. 127 ms\n4.   2 ms  -- winner !\n5.   1 ms  -- winner !\n6. 356 ms  \n\ndb&lt;&gt;fiddle here\nG. with ~ 100 rows per customer\n1. 535 ms\n2. 529 ms  \n3. 132 ms\n4. 108 ms  -- !\n5.  71 ms  -- winner\n6. 376 ms  \n\ndb&lt;&gt;fiddle here\nH. with ~ 1.6 rows per customer\n1.  691 ms\n2.  684 ms  \n3.  234 ms  -- winner\n4. 4669 ms\n5. 1089 ms\n6. 1264 ms  \n\ndb&lt;&gt;fiddle here\nConclusions\n\nDISTINCT ON uses the index effectively and typically performs best for few rows per group. And it performs decently even with many rows per group.\n\nFor many rows per group, emulating an index skip scan with an rCTE performs best - second only to the query technique with a separate lookup table (if that&apos;s available).\n\nThe row_number() technique demonstrated in the currently accepted answer never wins any performance test. Not then, not now. It never comes even close to DISTINCT ON, not even when the data distribution is unfavorable for the latter. The only good thing about row_number(): it does not scale terribly, just mediocre.\n\n\nMore benchmarks\nBenchmark by &quot;ogr&quot; with 10M rows and 60k unique &quot;customers&quot; on Postgres 11.5. Results are in line with what we have seen so far:\n\nProper way to access latest row for each individual identifier?\n\nOriginal (outdated) benchmark from 2011\nI ran three tests with PostgreSQL 9.1 on a real life table of 65579 rows and single-column btree indexes on each of the three columns involved and took the best execution time of 5 runs.\nComparing @OMGPonies&apos; first query (A) to the above DISTINCT ON solution (B):\n\nSelect the whole table, results in 5958 rows in this case.\n\nA: 567.218 ms\nB: 386.673 ms\n\n\nUse condition WHERE customer BETWEEN x AND y resulting in 1000 rows.\n\nA: 249.136 ms\nB:  55.111 ms\n\n\nSelect a single customer with WHERE customer = x.\n\nA:   0.143 ms\nB:   0.072 ms\n\nSame test repeated with the index described in the other answer:\nCREATE INDEX purchases_3c_idx ON purchases (customer, total DESC, id);\n\n\n1A: 277.953 ms  \n1B: 193.547 ms\n\n2A: 249.796 ms -- special index not used  \n2B:  28.679 ms\n\n3A:   0.120 ms  \n3B:   0.048 ms\n\n    ","url":"/questions/[slug]#solution3","@type":"Answer","upvoteCount":0},{"text":"This is common greatest-n-per-group problem, which already has well tested and highly optimized solutions. Personally I prefer the left join solution by Bill Karwin (the original post with lots of other solutions).\n\nNote that bunch of solutions to this common problem can surprisingly be found in the one of most official sources, MySQL manual! See Examples of Common Queries :: The Rows Holding the Group-wise Maximum of a Certain Column.\n    ","url":"/questions/[slug]#solution4","@type":"Answer","upvoteCount":0},{"text":"In Postgres you can use array_agg like this:\n\nSELECT  customer,\n        (array_agg(id ORDER BY total DESC))[1],\n        max(total)\nFROM purchases\nGROUP BY customer\n\n\nThis will give you the id of each customer&apos;s largest purchase.\n\nSome things to note:\n\n\narray_agg is an aggregate function, so it works with GROUP BY.\narray_agg lets you specify an ordering scoped to just itself, so it doesn&apos;t constrain the structure of the whole query. There is also syntax for how you sort NULLs, if you need to do something different from the default.\nOnce we build the array, we take the first element. (Postgres arrays are 1-indexed, not 0-indexed).\nYou could use array_agg in a similar way for your third output column, but max(total) is simpler.\nUnlike DISTINCT ON, using array_agg lets you keep your GROUP BY, in case you want that for other reasons.\n\n    ","url":"/questions/[slug]#solution5","@type":"Answer","upvoteCount":0},{"text":"The solution is not very efficient as pointed by Erwin, because of presence of SubQs\n\nselect * from purchases p1 where total in\n(select max(total) from purchases where p1.customer=customer) order by total desc;\n\n    ","url":"/questions/[slug]#solution6","@type":"Answer","upvoteCount":0},{"text":"The Query:\nSELECT purchases.*\nFROM purchases\nLEFT JOIN purchases as p \nON \n  p.customer = purchases.customer \n  AND \n  purchases.total &lt; p.total\nWHERE p.total IS NULL\n\nHOW DOES THAT WORK! (I&apos;ve been there)\nWe want to make sure that we only have the highest total for each purchase.\n\nSome Theoretical Stuff (skip this part if you only want to understand the query)\nLet Total be a function T(customer,id) where it returns a value given the name and id\nTo prove that the given total (T(customer,id)) is the highest we have to prove that\nWe want to prove either\n\nx T(customer,id) &gt; T(customer,x) (this total is higher than all other\ntotal for that customer)\n\nOR\n\nÂ¬x T(customer, id) &lt; T(customer, x)   (there exists no higher total for\nthat customer)\n\nThe first approach will need us to get all the records for that name which I do not really like.\nThe second one will need a smart way to say there can be no record higher than this one.\n\nBack to SQL\nIf we left joins the table on the name and total being less than the joined table:\nLEFT JOIN purchases as p \nON \np.customer = purchases.customer \nAND \npurchases.total &lt; p.total\n\nwe make sure that all records that have another record with the higher total for the same user to be joined:\n+--------------+---------------------+-----------------+------+------------+---------+\n| purchases.id |  purchases.customer | purchases.total | p.id | p.customer | p.total |\n+--------------+---------------------+-----------------+------+------------+---------+\n|            1 | Tom                 |             200 |    2 | Tom        |     300 |\n|            2 | Tom                 |             300 |      |            |         |\n|            3 | Bob                 |             400 |    4 | Bob        |     500 |\n|            4 | Bob                 |             500 |      |            |         |\n|            5 | Alice               |             600 |    6 | Alice      |     700 |\n|            6 | Alice               |             700 |      |            |         |\n+--------------+---------------------+-----------------+------+------------+---------+\n\nThat will help us filter for the highest total for each purchase with no grouping needed:\nWHERE p.total IS NULL\n    \n+--------------+----------------+-----------------+------+--------+---------+\n| purchases.id | purchases.name | purchases.total | p.id | p.name | p.total |\n+--------------+----------------+-----------------+------+--------+---------+\n|            2 | Tom            |             300 |      |        |         |\n|            4 | Bob            |             500 |      |        |         |\n|            6 | Alice          |             700 |      |        |         |\n+--------------+----------------+-----------------+------+--------+---------+\n\nAnd that&apos;s the answer we need.\n    ","url":"/questions/[slug]#solution7","@type":"Answer","upvoteCount":0},{"text":"I use this way (postgresql only): https://wiki.postgresql.org/wiki/First/last_%28aggregate%29\n\n-- Create a function that always returns the first non-NULL item\nCREATE OR REPLACE FUNCTION public.first_agg ( anyelement, anyelement )\nRETURNS anyelement LANGUAGE sql IMMUTABLE STRICT AS $$\n        SELECT $1;\n$$;\n\n-- And then wrap an aggregate around it\nCREATE AGGREGATE public.first (\n        sfunc    = public.first_agg,\n        basetype = anyelement,\n        stype    = anyelement\n);\n\n-- Create a function that always returns the last non-NULL item\nCREATE OR REPLACE FUNCTION public.last_agg ( anyelement, anyelement )\nRETURNS anyelement LANGUAGE sql IMMUTABLE STRICT AS $$\n        SELECT $2;\n$$;\n\n-- And then wrap an aggregate around it\nCREATE AGGREGATE public.last (\n        sfunc    = public.last_agg,\n        basetype = anyelement,\n        stype    = anyelement\n);\n\n\nThen your example should work almost as is:\n\nSELECT FIRST(id), customer, FIRST(total)\nFROM  purchases\nGROUP BY customer\nORDER BY FIRST(total) DESC;\n\n\nCAVEAT: It ignore&apos;s NULL rows\n\n\n\nEdit 1 - Use the postgres extension instead\n\nNow I use this way: http://pgxn.org/dist/first_last_agg/\n\nTo install on ubuntu 14.04:\n\napt-get install postgresql-server-dev-9.3 git build-essential -y\ngit clone git://github.com/wulczer/first_last_agg.git\ncd first_last_app\nmake &amp;&amp; sudo make install\npsql -c &apos;create extension first_last_agg&apos;\n\n\nIt&apos;s a postgres extension that gives you first and last functions; apparently faster than the above way.\n\n\n\nEdit 2 - Ordering and filtering\n\nIf you use aggregate functions (like these), you can order the results, without the need to have the data already ordered:\n\nhttp://www.postgresql.org/docs/current/static/sql-expressions.html#SYNTAX-AGGREGATES\n\n\nSo the equivalent example, with ordering would be something like:\n\nSELECT first(id order by id), customer, first(total order by id)\n  FROM purchases\n GROUP BY customer\n ORDER BY first(total);\n\n\nOf course you can order and filter as you deem fit within the aggregate; it&apos;s very powerful syntax.\n    ","url":"/questions/[slug]#solution8","@type":"Answer","upvoteCount":0},{"text":"Use ARRAY_AGG function for PostgreSQL, U-SQL, IBM DB2, and Google BigQuery SQL:\n\nSELECT customer, (ARRAY_AGG(id ORDER BY total DESC))[1], MAX(total)\nFROM purchases\nGROUP BY customer\n\n    ","url":"/questions/[slug]#solution9","@type":"Answer","upvoteCount":0},{"text":"In SQL Server you can do this:\n\nSELECT *\nFROM (\nSELECT ROW_NUMBER()\nOVER(PARTITION BY customer\nORDER BY total DESC) AS StRank, *\nFROM Purchases) n\nWHERE StRank = 1\n\n\nExplaination:Here  Group by is done on the basis of customer and then order it by total then each such group is given serial number as StRank and we are taking out first 1 customer whose StRank is 1\n    ","url":"/questions/[slug]#solution10","@type":"Answer","upvoteCount":0},{"text":"Very fast solution\n\nSELECT a.* \nFROM\n    purchases a \n    JOIN ( \n        SELECT customer, min( id ) as id \n        FROM purchases \n        GROUP BY customer \n    ) b USING ( id );\n\n\nand really very fast if table is indexed by id:\n\ncreate index purchases_id on purchases (id);\n\n    ","url":"/questions/[slug]#solution11","@type":"Answer","upvoteCount":0},{"text":"Snowflake/Teradata supports QUALIFY clause which works like HAVING for windowed functions:\n\nSELECT id, customer, total\nFROM PURCHASES\nQUALIFY ROW_NUMBER() OVER(PARTITION BY p.customer ORDER BY p.total DESC) = 1\n\n    ","url":"/questions/[slug]#solution12","@type":"Answer","upvoteCount":0},{"text":"In PostgreSQL, another possibility is to use the first_value window function in combination with SELECT DISTINCT:\n\nselect distinct customer_id,\n                first_value(row(id, total)) over(partition by customer_id order by total desc, id)\nfrom            purchases;\n\n\nI created a composite (id, total), so both values are returned by the same aggregate. You can of course always apply first_value() twice.\n    ","url":"/questions/[slug]#solution13","@type":"Answer","upvoteCount":0},{"text":"This way it work for me:\nSELECT article, dealer, price\nFROM   shop s1\nWHERE  price=(SELECT MAX(s2.price)\n              FROM shop s2\n              WHERE s1.article = s2.article\n              GROUP BY s2.article)\nORDER BY article;\n\nSelect highest price on each article\n    ","url":"/questions/[slug]#solution14","@type":"Answer","upvoteCount":0},{"text":"This is how we can achieve this by using windows function:\n    create table purchases (id int4, customer varchar(10), total integer);\n    insert into purchases values (1, &apos;Joe&apos;, 5);\n    insert into purchases values (2, &apos;Sally&apos;, 3);\n    insert into purchases values (3, &apos;Joe&apos;, 2);\n    insert into purchases values (4, &apos;Sally&apos;, 1);\n    \n    select ID, CUSTOMER, TOTAL from (\n    select ID, CUSTOMER, TOTAL,\n    row_number () over (partition by CUSTOMER order by TOTAL desc) RN\n    from purchases) A where RN = 1;\n\n\n    ","url":"/questions/[slug]#solution15","@type":"Answer","upvoteCount":0},{"text":"The accepted OMG Ponies&apos; &quot;Supported by any database&quot; solution has good speed from my test.\n\nHere I provide a same-approach, but more complete and clean any-database solution.   Ties are considered (assume desire to get only one row for each customer, even multiple records for max total per customer), and other purchase fields (e.g. purchase_payment_id) will be selected for the real matching rows in the purchase table.\n\nSupported by any database:\n\nselect * from purchase\njoin (\n    select min(id) as id from purchase\n    join (\n        select customer, max(total) as total from purchase\n        group by customer\n    ) t1 using (customer, total)\n    group by customer\n) t2 using (id)\norder by customer\n\n\nThis query is reasonably fast especially when there is a composite index like (customer, total) on the purchase table.\n\nRemark:\n\n\nt1, t2 are subquery alias which could be removed depending on database.\nCaveat: the using (...) clause is currently not supported in MS-SQL and Oracle db as of this edit on Jan 2017. You have to expand it yourself to e.g. on t2.id = purchase.id etc.  The USING syntax works in SQLite, MySQL and PostgreSQL.\n\n    ","url":"/questions/[slug]#solution16","@type":"Answer","upvoteCount":0},{"text":"\nIf you want to select any (by your some specific condition) row from the set of aggregated rows. \nIf you want to use another (sum/avg) aggregation function in addition to max/min. Thus you can not use clue with DISTINCT ON\n\n\nYou can use next subquery:\n\nSELECT  \n    (  \n       SELECT **id** FROM t2   \n       WHERE id = ANY ( ARRAY_AGG( tf.id ) ) AND amount = MAX( tf.amount )   \n    ) id,  \n    name,   \n    MAX(amount) ma,  \n    SUM( ratio )  \nFROM t2  tf  \nGROUP BY name\n\n\nYou can replace amount = MAX( tf.amount ) with any condition you want with one restriction: This subquery must not return more than one row\n\nBut if you wanna to do such things you probably looking for window functions\n    ","url":"/questions/[slug]#solution17","@type":"Answer","upvoteCount":0},{"text":"For SQl Server the most efficient way is:   \n\nwith\nids as ( --condition for split table into groups\n    select i from (values (9),(12),(17),(18),(19),(20),(22),(21),(23),(10)) as v(i) \n) \n,src as ( \n    select * from yourTable where  &lt;condition&gt; --use this as filter for other conditions\n)\n,joined as (\n    select tops.* from ids \n    cross apply --it`s like for each rows\n    (\n        select top(1) * \n        from src\n        where CommodityId = ids.i \n    ) as tops\n)\nselect * from joined\n\n\nand don&apos;t forget to create clustered index for used columns\n    ","url":"/questions/[slug]#solution18","@type":"Answer","upvoteCount":0},{"text":"My approach via window function dbfiddle:\n\nAssign row_number at each group: row_number() over (partition by agreement_id, order_id ) as nrow\nTake only first row at group: filter (where nrow = 1)\n\nwith intermediate as (select \n *,\n row_number() over ( partition by agreement_id, order_id ) as nrow,\n (sum( suma ) over ( partition by agreement_id, order_id ))::numeric( 10, 2) as order_suma,\nfrom &lt;your table&gt;)\n\nselect \n  *,\n  sum( order_suma ) filter (where nrow = 1) over (partition by agreement_id)\nfrom intermediate\n\n    ","url":"/questions/[slug]#solution19","@type":"Answer","upvoteCount":0},{"text":"This can be achieved easily by MAX FUNCTION on total and GROUP BY id and customer.\nSELECT id, customer, MAX(total) FROM  purchases GROUP BY id, customer\nORDER BY total DESC;\n\n    ","url":"/questions/[slug]#solution20","@type":"Answer","upvoteCount":0}],"@type":"Question"}}</script><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/08bcc42a26fe5c92.css" as="style"/><link rel="stylesheet" href="/_next/static/css/08bcc42a26fe5c92.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-42cdea76c8170223.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-25e5079ab4bd6ecd.js" defer=""></script><script src="/_next/static/chunks/pages/_app-08d1a634dea6705e.js" defer=""></script><script src="/_next/static/chunks/29107295-fbcfe2172188e46f.js" defer=""></script><script src="/_next/static/chunks/150-12e9794e898cd5f3.js" defer=""></script><script src="/_next/static/chunks/490-7f0418bb4354ac73.js" defer=""></script><script src="/_next/static/chunks/108-87de33c23337ff53.js" defer=""></script><script src="/_next/static/chunks/pages/questions/%5Bslug%5D-928c5d1eb8fb0bba.js" defer=""></script><script src="/_next/static/BnkbnjkWYxefPXjTJLVVv/_buildManifest.js" defer=""></script><script src="/_next/static/BnkbnjkWYxefPXjTJLVVv/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="wrapper"><header><nav class="bg-white border-gray-200 px-4 lg:px-6 py-2.5 dark:bg-gray-800"><div class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl"><a class="flex items-center" href="/"><img src="/logo-second.png" class="mr-3 h-6 sm:h-9" alt="Solution Checker Logo"/><h4 class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">Solution Checker</h4></a><div class="flex items-center lg:order-2"><button data-collapse-toggle="mobile-menu-2" type="button" class="inline-flex items-center p-2 ml-1 text-sm text-gray-500 rounded-lg lg:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="mobile-menu-2" aria-expanded="false"><span class="sr-only">Open main menu</span><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg><svg class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><div class="hidden justify-between items-center w-full lg:flex lg:w-auto lg:order-1" id="mobile-menu-2"><ul class="flex flex-col mt-4 font-medium lg:flex-row lg:space-x-8 lg:mt-0"><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" aria-current="page" href="/">Home</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions?tab=news">Questions</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/post?tab=news">Post</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions/select-first-row-in-each-group-by-group-1657384809388#">Coding</a></li></ul></div></div></nav></header><div class="main-content"><div class="question my-5"><div class="flex question-header items-center m-auto justify-center"><div class="rounded-xl w-full border p-5 shadow-md bg-white"><div class="flex w-full items-center justify-between border-b pb-3"><div class="flex items-center space-x-3"><div class="text-lg font-bold text-slate-700"><a href="/questions/select-first-row-in-each-group-by-group-1657384809388"><h1>Select first row in each GROUP BY group?</h1></a></div></div><div class="flex flex-wrap h-auto justify-end items-center space-x-8"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold" href="/questions/tag/postgresql">postgresql</a></div></div><div class="question-content mt-5">
                

<p>As the title suggests, I'd like to select the first row of each set of rows grouped with a <code>GROUP BY</code>.</p>
<p>Specifically, if I've got a <code>purchases</code> table that looks like this:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> purchases;
</code></pre>
<p><strong>My Output:</strong></p>
<div class="s-table-container">
<table class="s-table">
<thead>
<tr>
<th>id</th>
<th>customer</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Joe</td>
<td>5</td>
</tr>
<tr>
<td>2</td>
<td>Sally</td>
<td>3</td>
</tr>
<tr>
<td>3</td>
<td>Joe</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>Sally</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p>I'd like to query for the <code>id</code> of the largest purchase (<code>total</code>) made by each <code>customer</code>. Something like this:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">FIRST</span>(id), customer, <span class="hljs-keyword">FIRST</span>(total)
<span class="hljs-keyword">FROM</span>  purchases
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><strong>Expected Output:</strong></p>
<div class="s-table-container">
<table class="s-table">
<thead>
<tr>
<th>FIRST(id)</th>
<th>customer</th>
<th>FIRST(total)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Joe</td>
<td>5</td>
</tr>
<tr>
<td>2</td>
<td>Sally</td>
<td>3</td>
</tr>
</tbody>
</table>
</div>    </div></div></div><div class="solution-section"><nav class="flex pagination-solution flex-col justify-end"><ul class="inline-flex -space-x-px overflow-auto"><li class="pagination-solution-item"><span data-id="#solution1" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">1</span></li><li class="pagination-solution-item"><span data-id="#solution2" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">2</span></li><li class="pagination-solution-item"><span data-id="#solution3" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">3</span></li><li class="pagination-solution-item"><span data-id="#solution4" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">4</span></li><li class="pagination-solution-item"><span data-id="#solution5" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">5</span></li><li class="pagination-solution-item"><span data-id="#solution6" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">6</span></li><li class="pagination-solution-item"><span data-id="#solution7" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">7</span></li><li class="pagination-solution-item"><span data-id="#solution8" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">8</span></li><li class="pagination-solution-item"><span data-id="#solution9" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">9</span></li><li class="pagination-solution-item"><span data-id="#solution10" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">10</span></li><li class="pagination-solution-item"><span data-id="#solution11" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">11</span></li><li class="pagination-solution-item"><span data-id="#solution12" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">12</span></li><li class="pagination-solution-item"><span data-id="#solution13" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">13</span></li><li class="pagination-solution-item"><span data-id="#solution14" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">14</span></li><li class="pagination-solution-item"><span data-id="#solution15" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">15</span></li><li class="pagination-solution-item"><span data-id="#solution16" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">16</span></li><li class="pagination-solution-item"><span data-id="#solution17" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">17</span></li><li class="pagination-solution-item"><span data-id="#solution18" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">18</span></li><li class="pagination-solution-item"><span data-id="#solution19" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">19</span></li><li class="pagination-solution-item"><span data-id="#solution20" class="cursor-pointer py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">20</span></li></ul></nav><div id="solution1" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 1</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p><a href="https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT" rel="noreferrer"><strong><code>DISTINCT ON</code></strong></a> is typically simplest and fastest for this in <strong>PostgreSQL</strong>.<br>
<sub>(For performance optimization for certain workloads see below.)</sub></p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span> (customer)
       id, customer, total
<span class="hljs-keyword">FROM</span>   purchases
<span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> customer, total <span class="hljs-keyword">DESC</span>, id;
</code></pre>
<p>Or shorter (if not as clear) with ordinal numbers of output columns:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span> (<span class="hljs-number">2</span>)
       id, customer, total
<span class="hljs-keyword">FROM</span>   purchases
<span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> <span class="hljs-number">2</span>, <span class="hljs-number">3</span> <span class="hljs-keyword">DESC</span>, <span class="hljs-number">1</span>;
</code></pre>
<p>If <code>total</code> can be NULL, add <code>NULLS LAST</code>:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql">...
<span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> customer, total <span class="hljs-keyword">DESC</span> NULLS <span class="hljs-keyword">LAST</span>, id;
</code></pre>
<p>Works either way, but you'll want to <a href="https://dba.stackexchange.com/q/254731/3684">match existing indexes</a></p>
<p><em>db&lt;&gt;fiddle <a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=bf589b26f6e9fe8cdf3c6ca6e045eb6d" rel="noreferrer">here</a></em></p>
<h3>Major points</h3>
<p><strong><code>DISTINCT ON</code></strong> is a PostgreSQL extension of the standard, where only <code>DISTINCT</code> on the whole <code>SELECT</code> list is defined.</p>
<p>List any number of expressions in the <code>DISTINCT ON</code> clause, the combined row value defines duplicates. <a href="https://www.postgresql.org/docs/current/queries-select-lists.html#QUERIES-DISTINCT" rel="noreferrer">The manual:</a></p>
<blockquote>
<p>Obviously, two rows are considered distinct if they differ in at least
one column value. <strong>Null values are considered equal in this
comparison.</strong></p>
</blockquote>
<p>Bold emphasis mine.</p>
<p><code>DISTINCT ON</code> can be combined with <strong><code>ORDER BY</code></strong>. Leading expressions in <code>ORDER BY</code> must be in the set of expressions in <code>DISTINCT ON</code>, but you can rearrange order among those freely. <a href="https://dba.stackexchange.com/a/89786/3684">Example.</a><br>
You can add <em>additional</em> expressions to <code>ORDER BY</code> to pick a particular row from each group of peers. Or, as <a href="https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT" rel="noreferrer">the manual puts it</a>:</p>
<blockquote>
<p>The <code>DISTINCT ON</code> expression(s) must match the leftmost <code>ORDER BY</code>
expression(s). The <code>ORDER BY</code> clause will normally contain additional
expression(s) that determine the desired precedence of rows within
each <code>DISTINCT ON</code> group.</p>
</blockquote>
<p>I added <code>id</code> as last item to break ties:<br>
<em>"Pick the row with the smallest <code>id</code> from each group sharing the highest <code>total</code>."</em></p>
<p>To order results in a way that disagrees with the sort order determining the first per group, you can nest above query in an outer query with another <code>ORDER BY</code>. <a href="https://stackoverflow.com/a/9796104/939860">Example.</a></p>
<p>If <code>total</code> can be NULL, you <em>most probably</em> want the row with the greatest non-null value. Add <strong><code>NULLS LAST</code></strong> like demonstrated. See:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/9510509/postgresql-sort-by-datetime-asc-null-first/9511492#9511492">Sort by column ASC, but NULL values first?</a></li>
</ul>
<p><strong>The <code>SELECT</code> list</strong> is not constrained by expressions in <code>DISTINCT ON</code> or <code>ORDER BY</code> in any way:</p>
<ul>
<li><p>You <em>don't have to</em> include any of the expressions in <code>DISTINCT ON</code> or <code>ORDER BY</code>.</p>
</li>
<li><p>You <em>can</em> include any other expression in the <code>SELECT</code> list. This is instrumental for replacing complex subqueries and aggregate / window functions.</p>
</li>
</ul>
<p>I tested with Postgres versions 8.3  15. But the feature has been there at least since version 7.1, so basically always.</p>
<h2>Index</h2>
<p>The <em>perfect</em> index for the above query would be a <a href="https://www.postgresql.org/docs/current/indexes-multicolumn.html" rel="noreferrer">multi-column index</a> spanning all three columns in matching sequence and with matching sort order:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">CREATE</span> INDEX purchases_3c_idx <span class="hljs-keyword">ON</span> purchases (customer, total <span class="hljs-keyword">DESC</span>, id);
</code></pre>
<p>May be too specialized. But use it if read performance for the particular query is crucial. If you have <code>DESC NULLS LAST</code> in the query, use the same in the index so that sort order matches and the index is perfectly applicable.</p>
<h2>Effectiveness / Performance optimization</h2>
<p>Weigh cost and benefit before creating tailored indexes for each query. The potential of above index largely depends on <strong>data distribution</strong>.</p>
<p>The index is used because it delivers pre-sorted data. In Postgres 9.2 or later the query can also benefit from an <strong><a href="https://www.postgresql.org/docs/current/indexes-index-only-scans.html" rel="noreferrer">index only scan</a></strong> if the index is smaller than the underlying table. The index has to be scanned in its entirety, though. <a href="https://dba.stackexchange.com/a/313755/3684">Example.</a></p>
<p>For <strong><em>few</em> rows per customer</strong> (high cardinality in column <code>customer</code>), this is very efficient. Even more so if you need sorted output anyway. The benefit shrinks with a growing number of rows per customer.<br>
Ideally, you have enough <a href="https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-WORK-MEM" rel="noreferrer"><strong><code>work_mem</code></strong></a> to process the involved sort step in RAM and not spill to disk. But generally setting <code>work_mem</code> <em>too</em> high can have adverse effects. Consider <code>SET LOCAL</code> for exceptionally big queries. Find how much you need with <code>EXPLAIN ANALYZE</code>. Mention of "<em>Disk:</em>" in the sort step indicates the need for more:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/8106181/configuration-parameter-work-mem-in-postgresql-on-linux/8108807#8108807">Configuration parameter work_mem in PostgreSQL on Linux</a></li>
<li><a href="https://dba.stackexchange.com/a/48633/3684">Optimize simple query using ORDER BY date and text</a></li>
</ul>
<p>For <strong><em>many</em> rows per customer</strong> (low cardinality in column <code>customer</code>), a <a href="https://wiki.postgresql.org/wiki/Loose_indexscan" rel="noreferrer"><strong>loose index scan</strong></a> (a.k.a. "skip scan") would be (much) more efficient, but that's not implemented up to Postgres 14. (An implementation for index-only scans is in development for Postgres 15. See <a href="https://commitfest.postgresql.org/19/1741/" rel="noreferrer">here</a> and <a href="https://www.postgresql.org/message-id/flat/20200609102247.jdlatmfyeecg52fi%40localhost" rel="noreferrer">here</a>.)<br>
For now, there are <strong>faster query techniques</strong> to substitute for this. In particular if you have a separate table holding unique customers, which is the typical use case. But also if you don't:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/66893968/select-distinct-is-slower-than-expected-on-my-table-in-postgresql/66894500#66894500">SELECT DISTINCT is slower than expected on my table in PostgreSQL</a></li>
<li><strong><a href="https://stackoverflow.com/questions/25536422/optimize-group-by-query-to-retrieve-latest-record-per-user/25536748#25536748">Optimize GROUP BY query to retrieve latest row per user</a></strong></li>
<li><a href="https://stackoverflow.com/questions/24244026/optimize-groupwise-maximum-query/24377356#24377356">Optimize groupwise maximum query</a></li>
<li><a href="https://stackoverflow.com/questions/25957558/querying-last-n-related-records-in-postgres/25965393#25965393">Query last N related rows per row</a></li>
</ul>
<h2>Benchmarks</h2>
<p><a href="https://stackoverflow.com/a/34715134/939860">See separate answer.</a></p>
    </div></div></div></div><div id="solution2" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 2</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<h2>On databases that <a href="https://en.wikipedia.org/wiki/Hierarchical_and_recursive_queries_in_SQL#Common_table_expression" rel="noreferrer">support CTE and windowing functions</a>:</h2>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">WITH</span> summary <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> p.id, 
           p.customer, 
           p.total, 
           <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> p.customer 
                                 <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.total <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rank
      <span class="hljs-keyword">FROM</span> PURCHASES p)
 <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
   <span class="hljs-keyword">FROM</span> summary
 <span class="hljs-keyword">WHERE</span> rank <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<h2>Supported by any database:</h2>
<p>But you need to add logic to break ties:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql">  <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(x.id),  <span class="hljs-comment">-- change to MAX if you want the highest</span>
         x.customer, 
         x.total
    <span class="hljs-keyword">FROM</span> PURCHASES x
    <span class="hljs-keyword">JOIN</span> (<span class="hljs-keyword">SELECT</span> p.customer,
                 <span class="hljs-built_in">MAX</span>(total) <span class="hljs-keyword">AS</span> max_total
            <span class="hljs-keyword">FROM</span> PURCHASES p
        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.customer) y <span class="hljs-keyword">ON</span> y.customer <span class="hljs-operator">=</span> x.customer
                              <span class="hljs-keyword">AND</span> y.max_total <span class="hljs-operator">=</span> x.total
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> x.customer, x.total
</code></pre>
    </div></div></div></div><div id="solution3" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 3</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<h1>Benchmarks</h1>
<p>I tested the most interesting candidates:</p>
<ul>
<li>Initially with <strong>Postgres 9.4</strong> and <strong>9.5</strong>.</li>
<li>Added accented tests for <strong>Postgres 13</strong> later.</li>
</ul>
<h3>Basic test setup</h3>
<p>Main table: <code>purchases</code>:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> purchases (
  id          serial  <span class="hljs-comment">-- PK constraint added below</span>
, customer_id <span class="hljs-type">int</span>     <span class="hljs-comment">-- REFERENCES customer</span>
, total       <span class="hljs-type">int</span>     <span class="hljs-comment">-- could be amount of money in Cent</span>
, some_column text    <span class="hljs-comment">-- to make the row bigger, more realistic</span>
);
</code></pre>
<p>Dummy data (with some dead tuples), PK, index:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> purchases (customer_id, total, some_column)    <span class="hljs-comment">-- 200k rows</span>
<span class="hljs-keyword">SELECT</span> (random() <span class="hljs-operator">*</span> <span class="hljs-number">10000</span>)::<span class="hljs-type">int</span>             <span class="hljs-keyword">AS</span> customer_id  <span class="hljs-comment">-- 10k distinct customers</span>
     , (random() <span class="hljs-operator">*</span> random() <span class="hljs-operator">*</span> <span class="hljs-number">100000</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">AS</span> total     
     , <span class="hljs-string">'note: '</span> <span class="hljs-operator">||</span> repeat(<span class="hljs-string">'x'</span>, (random()<span class="hljs-operator">^</span><span class="hljs-number">2</span> <span class="hljs-operator">*</span> random() <span class="hljs-operator">*</span> random() <span class="hljs-operator">*</span> <span class="hljs-number">500</span>)::<span class="hljs-type">int</span>)
<span class="hljs-keyword">FROM</span>   generate_series(<span class="hljs-number">1</span>,<span class="hljs-number">200000</span>) g;

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> purchases <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> purchases_id_pkey <span class="hljs-keyword">PRIMARY</span> KEY (id);

<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> purchases <span class="hljs-keyword">WHERE</span> random() <span class="hljs-operator">&gt;</span> <span class="hljs-number">0.9</span>;  <span class="hljs-comment">-- some dead rows</span>

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> purchases (customer_id, total, some_column)
<span class="hljs-keyword">SELECT</span> (random() <span class="hljs-operator">*</span> <span class="hljs-number">10000</span>)::<span class="hljs-type">int</span>             <span class="hljs-keyword">AS</span> customer_id  <span class="hljs-comment">-- 10k customers</span>
     , (random() <span class="hljs-operator">*</span> random() <span class="hljs-operator">*</span> <span class="hljs-number">100000</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">AS</span> total     
     , <span class="hljs-string">'note: '</span> <span class="hljs-operator">||</span> repeat(<span class="hljs-string">'x'</span>, (random()<span class="hljs-operator">^</span><span class="hljs-number">2</span> <span class="hljs-operator">*</span> random() <span class="hljs-operator">*</span> random() <span class="hljs-operator">*</span> <span class="hljs-number">500</span>)::<span class="hljs-type">int</span>)
<span class="hljs-keyword">FROM</span>   generate_series(<span class="hljs-number">1</span>,<span class="hljs-number">20000</span>) g;  <span class="hljs-comment">-- add 20k to make it ~ 200k</span>

<span class="hljs-keyword">CREATE</span> INDEX purchases_3c_idx <span class="hljs-keyword">ON</span> purchases (customer_id, total <span class="hljs-keyword">DESC</span>, id);

VACUUM ANALYZE purchases;
</code></pre>
<p><code>customer</code> table - used for optimized query:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-string">'customer_'</span> <span class="hljs-operator">||</span> customer_id <span class="hljs-keyword">AS</span> customer
<span class="hljs-keyword">FROM</span>   purchases
<span class="hljs-keyword">GROUP</span>  <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customer <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> customer_customer_id_pkey <span class="hljs-keyword">PRIMARY</span> KEY (customer_id);

VACUUM ANALYZE customer;
</code></pre>
<p>In my second test for 9.5 I used the same setup, but with 100000 distinct <code>customer_id</code> to get <em>few</em> rows per <code>customer_id</code>.</p>
<h3>Object sizes for table <code>purchases</code></h3>
<p>Basic setup: 200k rows in <code>purchases</code>, 10k distinct <code>customer_id</code>, avg. 20 rows per customer.<br>
For Postgres 9.5 I added a 2nd test with 86446 distinct customers - avg. 2.3 rows per customer.</p>
<p>Generated with a query taken from here:</p>
<ul>
<li><a href="https://dba.stackexchange.com/a/23933/3684">Measure the size of a PostgreSQL table row</a></li>
</ul>
<p>Gathered for Postgres 9.5:</p>
<pre class="lang-none s-code-block"><code>               what                | bytes/ct | bytes_pretty | bytes_per_row
-----------------------------------+----------+--------------+---------------
 core_relation_size                | 20496384 | 20 MB        |           102
 visibility_map                    |        0 | 0 bytes      |             0
 free_space_map                    |    24576 | 24 kB        |             0
 table_size_incl_toast             | 20529152 | 20 MB        |           102
 indexes_size                      | 10977280 | 10 MB        |            54
 total_size_incl_toast_and_indexes | 31506432 | 30 MB        |           157
 live_rows_in_text_representation  | 13729802 | 13 MB        |            68
 ------------------------------    |          |              |
 row_count                         |   200045 |              |
 live_tuples                       |   200045 |              |
 dead_tuples                       |    19955 |              |
</code></pre>
<h1>Queries</h1>
<h3>1. <code>row_number()</code> in CTE, (<a href="https://stackoverflow.com/a/3800572/939860">see other answer</a>)</h3>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">WITH</span> cte <span class="hljs-keyword">AS</span> (
   <span class="hljs-keyword">SELECT</span> id, customer_id, total
        , <span class="hljs-built_in">row_number</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rn
   <span class="hljs-keyword">FROM</span>   purchases
   )
<span class="hljs-keyword">SELECT</span> id, customer_id, total
<span class="hljs-keyword">FROM</span>   cte
<span class="hljs-keyword">WHERE</span>  rn <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<h3>2. <code>row_number()</code> in subquery (my optimization)</h3>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> id, customer_id, total
<span class="hljs-keyword">FROM</span>   (
   <span class="hljs-keyword">SELECT</span> id, customer_id, total
        , <span class="hljs-built_in">row_number</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rn
   <span class="hljs-keyword">FROM</span>   purchases
   ) sub
<span class="hljs-keyword">WHERE</span>  rn <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<h3>3. <code>DISTINCT ON</code> (<a href="https://stackoverflow.com/a/7630564/939860">see other answer</a>)</h3>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span> (customer_id)
       id, customer_id, total
<span class="hljs-keyword">FROM</span>   purchases
<span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> customer_id, total <span class="hljs-keyword">DESC</span>, id;
</code></pre>
<h3>4. rCTE with <code>LATERAL</code> subquery (<a href="https://stackoverflow.com/a/25536748/939860">see here</a>)</h3>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> cte <span class="hljs-keyword">AS</span> (
   (  <span class="hljs-comment">-- parentheses required</span>
   <span class="hljs-keyword">SELECT</span> id, customer_id, total
   <span class="hljs-keyword">FROM</span>   purchases
   <span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> customer_id, total <span class="hljs-keyword">DESC</span>
   LIMIT  <span class="hljs-number">1</span>
   )
   <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
   <span class="hljs-keyword">SELECT</span> u.<span class="hljs-operator">*</span>
   <span class="hljs-keyword">FROM</span>   cte c
   ,      <span class="hljs-keyword">LATERAL</span> (
      <span class="hljs-keyword">SELECT</span> id, customer_id, total
      <span class="hljs-keyword">FROM</span>   purchases
      <span class="hljs-keyword">WHERE</span>  customer_id <span class="hljs-operator">&gt;</span> c.customer_id  <span class="hljs-comment">-- lateral reference</span>
      <span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> customer_id, total <span class="hljs-keyword">DESC</span>
      LIMIT  <span class="hljs-number">1</span>
      ) u
   )
<span class="hljs-keyword">SELECT</span> id, customer_id, total
<span class="hljs-keyword">FROM</span>   cte
<span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> customer_id;
</code></pre>
<h3>5. <code>customer</code> table with <code>LATERAL</code> (<a href="https://stackoverflow.com/a/25536748/939860">see here</a>)</h3>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> l.<span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span>   customer c
,      <span class="hljs-keyword">LATERAL</span> (
   <span class="hljs-keyword">SELECT</span> id, customer_id, total
   <span class="hljs-keyword">FROM</span>   purchases
   <span class="hljs-keyword">WHERE</span>  customer_id <span class="hljs-operator">=</span> c.customer_id  <span class="hljs-comment">-- lateral reference</span>
   <span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>
   LIMIT  <span class="hljs-number">1</span>
   ) l;
</code></pre>
<h3>6. <code>array_agg()</code> with <code>ORDER BY</code> (<a href="https://stackoverflow.com/a/25534279/939860">see other answer</a>)</h3>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> (<span class="hljs-built_in">array_agg</span>(id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>))[<span class="hljs-number">1</span>] <span class="hljs-keyword">AS</span> id
     , customer_id
     , <span class="hljs-built_in">max</span>(total) <span class="hljs-keyword">AS</span> total
<span class="hljs-keyword">FROM</span>   purchases
<span class="hljs-keyword">GROUP</span>  <span class="hljs-keyword">BY</span> customer_id;
</code></pre>
<h1>Results</h1>
<p>Execution time for above queries with <a href="https://www.postgresql.org/docs/current/sql-explain.html" rel="noreferrer"><code>EXPLAIN (ANALYZE, TIMING OFF, COSTS OFF</code></a>, <em>best of 5 runs</em> to compare with warm cache.</p>
<p><em>All</em> queries used an <strong>Index Only Scan</strong> on <code>purchases2_3c_idx</code> (among other steps). Some only to benefit from the smaller size of the index, others more effectively.</p>
<h3>A. Postgres 9.4 with 200k rows and ~ 20 per <code>customer_id</code></h3>
<pre class="lang-none s-code-block"><code>1. 273.274 ms  
2. 194.572 ms  
3. 111.067 ms  
4.  92.922 ms  -- !
5.  37.679 ms  -- winner
6. 189.495 ms
</code></pre>
<h3>B. Same as A. with Postgres 9.5</h3>
<pre class="lang-none s-code-block"><code>1. 288.006 ms
2. 223.032 ms  
3. 107.074 ms  
4.  78.032 ms  -- !
5.  33.944 ms  -- winner
6. 211.540 ms  
</code></pre>
<h3>C. Same as B., but with ~ 2.3 rows per <code>customer_id</code></h3>
<pre class="lang-none s-code-block"><code>1. 381.573 ms
2. 311.976 ms
3. 124.074 ms  -- winner
4. 710.631 ms
5. 311.976 ms
6. 421.679 ms
</code></pre>
<h1>Retest with Postgres 13 on 2021-08-11</h1>
<p>Simplified test setup: no deleted rows, because <code>VACUUM ANALYZE</code> cleans the table completely for the simple case.</p>
<p>Important changes for Postgres:</p>
<ul>
<li>General performance improvements.</li>
<li>CTEs can be inlined since Postgres 12, so query 1. and 2. now perform mostly identical (same query plan).</li>
</ul>
<h3>D. Like B. ~ 20 rows per customer_id</h3>
<pre class="lang-none s-code-block"><code>1. 103 ms
2. 103 ms  
3.  23 ms  -- winner  
4.  71 ms  
5.  22 ms  -- winner
6.  81 ms  
</code></pre>
<p><em>db&lt;&gt;fiddle <a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=4cfd751a33e9d0ca3b024cb5795a5f6b" rel="noreferrer">here</a></em></p>
<h3>E. Like C. ~ 2.3 rows per customer_id</h3>
<pre class="lang-none s-code-block"><code>1. 127 ms
2. 126 ms  
3.  36 ms  -- winner  
4. 620 ms  
5. 145 ms
6. 203 ms  
</code></pre>
<p><em>db&lt;&gt;fiddle <a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=e0eda395be68b453f51dc6fba4f3d4a6" rel="noreferrer">here</a></em></p>
<h2>Accented tests with Postgres 13</h2>
<p><strong>1M rows</strong>, 10.000 vs. 100 vs. 1.6 rows per customer.</p>
<h3>F. with ~ 10.000 rows per customer</h3>
<pre class="lang-none s-code-block"><code>1. 526 ms
2. 527 ms  
3. 127 ms
4.   2 ms  -- winner !
5.   1 ms  -- winner !
6. 356 ms  
</code></pre>
<p><em>db&lt;&gt;fiddle <a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=1ded28c4adedd3292ba5e0a8401a641f" rel="noreferrer">here</a></em></p>
<h3>G. with ~ 100 rows per customer</h3>
<pre class="lang-none s-code-block"><code>1. 535 ms
2. 529 ms  
3. 132 ms
4. 108 ms  -- !
5.  71 ms  -- winner
6. 376 ms  
</code></pre>
<p><em>db&lt;&gt;fiddle <a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=5f797bb9e694a4f0117ed3c957af1de2" rel="noreferrer">here</a></em></p>
<h3>H. with ~ 1.6 rows per customer</h3>
<pre class="lang-none s-code-block"><code>1.  691 ms
2.  684 ms  
3.  234 ms  -- winner
4. 4669 ms
5. 1089 ms
6. 1264 ms  
</code></pre>
<p><em>db&lt;&gt;fiddle <a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=6cd53673f04cf3b00a3aeb16fc071926" rel="noreferrer">here</a></em></p>
<h1>Conclusions</h1>
<ul>
<li><p><code>DISTINCT ON</code> uses the index effectively and typically performs best for <strong>few</strong> rows per group. And it performs decently even with many rows per group.</p>
</li>
<li><p>For <strong>many</strong> rows per group, emulating an index skip scan with an rCTE performs best - second only to the query technique with a separate lookup table (if that's available).</p>
</li>
<li><p>The <strong><code>row_number()</code></strong> technique demonstrated in the currently accepted answer <strong>never wins any performance test</strong>. Not then, not now. It never comes even close to <code>DISTINCT ON</code>, not even when the data distribution is unfavorable for the latter. The only good thing about <code>row_number()</code>: it does not scale terribly, just mediocre.</p>
</li>
</ul>
<h2>More benchmarks</h2>
<p>Benchmark by "ogr" with <strong>10M rows and 60k unique "customers"</strong> on <strong>Postgres 11.5</strong>. Results are in line with what we have seen so far:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/57893251/proper-way-to-access-latest-row-for-each-individual-identifier/57975451#57975451">Proper way to access latest row for each individual identifier?</a></li>
</ul>
<h3>Original (outdated) benchmark from 2011</h3>
<p>I ran three tests with PostgreSQL <strong>9.1</strong> on a real life table of 65579 rows and single-column btree indexes on each of the three columns involved and took the best <em>execution time</em> of 5 runs.<br>
Comparing <a href="https://stackoverflow.com/a/3800572/939860">@OMGPonies'</a> first query (<strong><code>A</code></strong>) to the <a href="https://stackoverflow.com/a/7630564/939860">above <code>DISTINCT ON</code> solution</a> (<strong><code>B</code></strong>):</p>
<ol>
<li>Select the whole table, results in 5958 rows in this case.</li>
</ol>
<pre class="lang-none s-code-block"><code>A: 567.218 ms
B: 386.673 ms
</code></pre>
<ol start="2">
<li>Use condition <code>WHERE customer BETWEEN x AND y</code> resulting in 1000 rows.</li>
</ol>
<pre class="lang-none s-code-block"><code>A: 249.136 ms
B:  55.111 ms
</code></pre>
<ol start="3">
<li>Select a single customer with <code>WHERE customer = x</code>.</li>
</ol>
<pre class="lang-none s-code-block"><code>A:   0.143 ms
B:   0.072 ms
</code></pre>
<p>Same test repeated with the index described in the other answer:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">CREATE</span> INDEX purchases_3c_idx <span class="hljs-keyword">ON</span> purchases (customer, total <span class="hljs-keyword">DESC</span>, id);
</code></pre>
<p></p>
<pre class="lang-none s-code-block"><code>1A: 277.953 ms  
1B: 193.547 ms

2A: 249.796 ms -- special index not used  
2B:  28.679 ms

3A:   0.120 ms  
3B:   0.048 ms
</code></pre>
    </div></div></div></div><div id="solution4" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 4</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>This is common <a href="/questions/tagged/greatest-n-per-group" class="post-tag" title="show questions tagged 'greatest-n-per-group'" rel="tag">greatest-n-per-group</a> problem, which already has well tested and highly <a href="https://stackoverflow.com/q/8748986/684229">optimized solutions</a>. Personally I prefer the <a href="https://stackoverflow.com/a/8749095/684229">left join solution by Bill Karwin</a> (the <a href="https://stackoverflow.com/a/123481/684229">original post with lots of other solutions</a>).</p>

<p>Note that bunch of solutions to this common problem can surprisingly be found in the one of most official sources, <strong>MySQL manual</strong>! See <a href="http://dev.mysql.com/doc/refman/5.0/en/example-maximum-column-group-row.html" rel="noreferrer">Examples of Common Queries :: The Rows Holding the Group-wise Maximum of a Certain Column</a>.</p>
    </div></div></div></div><div id="solution5" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 5</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>In Postgres you can use <code>array_agg</code> like this:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>  customer,
        (<span class="hljs-built_in">array_agg</span>(id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>))[<span class="hljs-number">1</span>],
        <span class="hljs-built_in">max</span>(total)
<span class="hljs-keyword">FROM</span> purchases
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer
</code></pre>

<p>This will give you the <code>id</code> of each customer's largest purchase.</p>

<p>Some things to note:</p>

<ul>
<li><code>array_agg</code> is an aggregate function, so it works with <code>GROUP BY</code>.</li>
<li><code>array_agg</code> lets you specify an ordering scoped to just itself, so it doesn't constrain the structure of the whole query. There is also syntax for how you sort NULLs, if you need to do something different from the default.</li>
<li>Once we build the array, we take the first element. (Postgres arrays are 1-indexed, not 0-indexed).</li>
<li>You could use <code>array_agg</code> in a similar way for your third output column, but <code>max(total)</code> is simpler.</li>
<li>Unlike <code>DISTINCT ON</code>, using <code>array_agg</code> lets you keep your <code>GROUP BY</code>, in case you want that for other reasons.</li>
</ul>
    </div></div></div></div><div id="solution6" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 6</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The solution is not very efficient as pointed by Erwin, because of presence of SubQs</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> purchases p1 <span class="hljs-keyword">where</span> total <span class="hljs-keyword">in</span>
(<span class="hljs-keyword">select</span> <span class="hljs-built_in">max</span>(total) <span class="hljs-keyword">from</span> purchases <span class="hljs-keyword">where</span> p1.customer<span class="hljs-operator">=</span>customer) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> total <span class="hljs-keyword">desc</span>;
</code></pre>
    </div></div></div></div><div id="solution7" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 7</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The Query:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> purchases.<span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> purchases
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> purchases <span class="hljs-keyword">as</span> p 
<span class="hljs-keyword">ON</span> 
  p.customer <span class="hljs-operator">=</span> purchases.customer 
  <span class="hljs-keyword">AND</span> 
  purchases.total <span class="hljs-operator">&lt;</span> p.total
<span class="hljs-keyword">WHERE</span> p.total <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
</code></pre>
<p><strong>HOW DOES THAT WORK!</strong> (I've been there)</p>
<p>We want to make sure that we only have the highest total for each purchase.</p>
<hr>
<p><strong>Some Theoretical Stuff</strong> (skip this part if you only want to understand the query)</p>
<p>Let Total be a function T(customer,id) where it returns a value given the name and id
To prove that the given total (T(customer,id)) is the highest we have to prove that
We want to prove either</p>
<ul>
<li>x T(customer,id) &gt; T(customer,x) (this total is higher than all other
total for that customer)</li>
</ul>
<p>OR</p>
<ul>
<li>Â¬x T(customer, id) &lt; T(customer, x)   (there exists no higher total for
that customer)</li>
</ul>
<p>The first approach will need us to get all the records for that name which I do not really like.</p>
<p>The second one will need a smart way to say there can be no record higher than this one.</p>
<hr>
<p><strong>Back to SQL</strong></p>
<p>If we left joins the table on the name and total being less than the joined table:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> purchases <span class="hljs-keyword">as</span> p 
<span class="hljs-keyword">ON</span> 
p.customer <span class="hljs-operator">=</span> purchases.customer 
<span class="hljs-keyword">AND</span> 
purchases.total <span class="hljs-operator">&lt;</span> p.total
</code></pre>
<p>we make sure that all records that have another record with the higher total for the same user to be joined:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------------+---------------------+-----------------+------+------------+---------+</span>
<span class="hljs-operator">|</span> purchases.id <span class="hljs-operator">|</span>  purchases.customer <span class="hljs-operator">|</span> purchases.total <span class="hljs-operator">|</span> p.id <span class="hljs-operator">|</span> p.customer <span class="hljs-operator">|</span> p.total <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------+---------------------+-----------------+------+------------+---------+</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Tom                 <span class="hljs-operator">|</span>             <span class="hljs-number">200</span> <span class="hljs-operator">|</span>    <span class="hljs-number">2</span> <span class="hljs-operator">|</span> Tom        <span class="hljs-operator">|</span>     <span class="hljs-number">300</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">2</span> <span class="hljs-operator">|</span> Tom                 <span class="hljs-operator">|</span>             <span class="hljs-number">300</span> <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>            <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">3</span> <span class="hljs-operator">|</span> Bob                 <span class="hljs-operator">|</span>             <span class="hljs-number">400</span> <span class="hljs-operator">|</span>    <span class="hljs-number">4</span> <span class="hljs-operator">|</span> Bob        <span class="hljs-operator">|</span>     <span class="hljs-number">500</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">4</span> <span class="hljs-operator">|</span> Bob                 <span class="hljs-operator">|</span>             <span class="hljs-number">500</span> <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>            <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">5</span> <span class="hljs-operator">|</span> Alice               <span class="hljs-operator">|</span>             <span class="hljs-number">600</span> <span class="hljs-operator">|</span>    <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Alice      <span class="hljs-operator">|</span>     <span class="hljs-number">700</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Alice               <span class="hljs-operator">|</span>             <span class="hljs-number">700</span> <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>            <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------+---------------------+-----------------+------+------------+---------+</span>
</code></pre>
<p>That will help us filter for the highest total for each purchase with no grouping needed:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">WHERE</span> p.total <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
    
<span class="hljs-operator">+</span><span class="hljs-comment">--------------+----------------+-----------------+------+--------+---------+</span>
<span class="hljs-operator">|</span> purchases.id <span class="hljs-operator">|</span> purchases.name <span class="hljs-operator">|</span> purchases.total <span class="hljs-operator">|</span> p.id <span class="hljs-operator">|</span> p.name <span class="hljs-operator">|</span> p.total <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------+----------------+-----------------+------+--------+---------+</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">2</span> <span class="hljs-operator">|</span> Tom            <span class="hljs-operator">|</span>             <span class="hljs-number">300</span> <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">4</span> <span class="hljs-operator">|</span> Bob            <span class="hljs-operator">|</span>             <span class="hljs-number">500</span> <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>            <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Alice          <span class="hljs-operator">|</span>             <span class="hljs-number">700</span> <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------+----------------+-----------------+------+--------+---------+</span>
</code></pre>
<p>And that's the answer we need.</p>
    </div></div></div></div><div id="solution8" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 8</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>I use this way (postgresql only): <a href="https://wiki.postgresql.org/wiki/First/last_%28aggregate%29">https://wiki.postgresql.org/wiki/First/last_%28aggregate%29</a></p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-comment">-- Create a function that always returns the first non-NULL item</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> public.first_agg ( anyelement, anyelement )
<span class="hljs-keyword">RETURNS</span> anyelement <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">sql</span> IMMUTABLE STRICT <span class="hljs-keyword">AS</span> $$
        <span class="hljs-keyword">SELECT</span> $<span class="hljs-number">1</span>;
$$;

<span class="hljs-comment">-- And then wrap an aggregate around it</span>
<span class="hljs-keyword">CREATE</span> AGGREGATE public.first (
        sfunc    <span class="hljs-operator">=</span> public.first_agg,
        basetype <span class="hljs-operator">=</span> anyelement,
        stype    <span class="hljs-operator">=</span> anyelement
);

<span class="hljs-comment">-- Create a function that always returns the last non-NULL item</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> public.last_agg ( anyelement, anyelement )
<span class="hljs-keyword">RETURNS</span> anyelement <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">sql</span> IMMUTABLE STRICT <span class="hljs-keyword">AS</span> $$
        <span class="hljs-keyword">SELECT</span> $<span class="hljs-number">2</span>;
$$;

<span class="hljs-comment">-- And then wrap an aggregate around it</span>
<span class="hljs-keyword">CREATE</span> AGGREGATE public.last (
        sfunc    <span class="hljs-operator">=</span> public.last_agg,
        basetype <span class="hljs-operator">=</span> anyelement,
        stype    <span class="hljs-operator">=</span> anyelement
);
</code></pre>

<p>Then your example should work <em>almost</em> as is:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">FIRST</span>(id), customer, <span class="hljs-keyword">FIRST</span>(total)
<span class="hljs-keyword">FROM</span>  purchases
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">FIRST</span>(total) <span class="hljs-keyword">DESC</span>;
</code></pre>

<p>CAVEAT: It ignore's NULL rows</p>

<hr>

<h1>Edit 1 - Use the postgres extension instead</h1>

<p>Now I use this way: <a href="http://pgxn.org/dist/first_last_agg/">http://pgxn.org/dist/first_last_agg/</a></p>

<p>To install on ubuntu 14.04:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql">apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install postgresql<span class="hljs-operator">-</span>server<span class="hljs-operator">-</span>dev<span class="hljs-number">-9.3</span> git build<span class="hljs-operator">-</span>essential <span class="hljs-operator">-</span>y
git clone git:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>github.com<span class="hljs-operator">/</span>wulczer<span class="hljs-operator">/</span>first_last_agg.git
cd first_last_app
make <span class="hljs-operator">&amp;&amp;</span> sudo make install
psql <span class="hljs-operator">-</span>c <span class="hljs-string">'create extension first_last_agg'</span>
</code></pre>

<p>It's a postgres extension that gives you first and last functions; apparently faster than the above way.</p>

<hr>

<h1>Edit 2 - Ordering and filtering</h1>

<p>If you use aggregate functions (like these), you can order the results, without the need to have the data already ordered:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql">http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>www.postgresql.org<span class="hljs-operator">/</span>docs<span class="hljs-operator">/</span><span class="hljs-keyword">current</span><span class="hljs-operator">/</span><span class="hljs-keyword">static</span><span class="hljs-operator">/</span><span class="hljs-keyword">sql</span><span class="hljs-operator">-</span>expressions.html#SYNTAX<span class="hljs-operator">-</span>AGGREGATES
</code></pre>

<p>So the equivalent example, with ordering would be something like:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">first</span>(id <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id), customer, <span class="hljs-keyword">first</span>(total <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id)
  <span class="hljs-keyword">FROM</span> purchases
 <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer
 <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">first</span>(total);
</code></pre>

<p>Of course you can order and filter as you deem fit within the aggregate; it's very powerful syntax.</p>
    </div></div></div></div><div id="solution9" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 9</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Use <code>ARRAY_AGG</code> function for <a href="https://www.postgresql.org/docs/9.5/functions-aggregate.html" rel="noreferrer">PostgreSQL</a>, <a href="https://docs.microsoft.com/en-us/u-sql/functions/aggregate/array-agg" rel="noreferrer">U-SQL</a>, <a href="https://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0050494.html" rel="noreferrer">IBM DB2</a>, and <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#array_agg" rel="noreferrer">Google BigQuery SQL</a>:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> customer, (<span class="hljs-built_in">ARRAY_AGG</span>(id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>))[<span class="hljs-number">1</span>], <span class="hljs-built_in">MAX</span>(total)
<span class="hljs-keyword">FROM</span> purchases
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer
</code></pre>
    </div></div></div></div><div id="solution10" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 10</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>In SQL Server you can do this:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> (
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">ROW_NUMBER</span>()
<span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> StRank, <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> Purchases) n
<span class="hljs-keyword">WHERE</span> StRank <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>

<p>Explaination:Here  <strong>Group by</strong> is done on the basis of customer and then order it by total then each such group is given serial number as StRank and we are taking out first 1 customer whose StRank is 1</p>
    </div></div></div></div><div id="solution11" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 11</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Very fast solution</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> a.<span class="hljs-operator">*</span> 
<span class="hljs-keyword">FROM</span>
    purchases a 
    <span class="hljs-keyword">JOIN</span> ( 
        <span class="hljs-keyword">SELECT</span> customer, <span class="hljs-built_in">min</span>( id ) <span class="hljs-keyword">as</span> id 
        <span class="hljs-keyword">FROM</span> purchases 
        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer 
    ) b <span class="hljs-keyword">USING</span> ( id );
</code></pre>

<p>and really very fast if table is indexed by id:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">create</span> index purchases_id <span class="hljs-keyword">on</span> purchases (id);
</code></pre>
    </div></div></div></div><div id="solution12" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 12</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Snowflake/Teradata supports <a href="https://docs.snowflake.net/manuals/sql-reference/constructs/qualify.html" rel="noreferrer"><code>QUALIFY</code></a> clause which works like <code>HAVING</code> for windowed functions:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> id, customer, total
<span class="hljs-keyword">FROM</span> PURCHASES
QUALIFY <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> p.customer <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.total <span class="hljs-keyword">DESC</span>) <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
    </div></div></div></div><div id="solution13" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 13</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>In PostgreSQL, another possibility is to use the <a href="https://www.postgresql.org/docs/current/functions-window.html" rel="noreferrer"><code>first_value</code></a> window function in combination with <code>SELECT DISTINCT</code>:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> customer_id,
                <span class="hljs-built_in">first_value</span>(<span class="hljs-type">row</span>(id, total)) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> customer_id <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> total <span class="hljs-keyword">desc</span>, id)
<span class="hljs-keyword">from</span>            purchases;
</code></pre>

<p>I created a composite <code>(id, total)</code>, so both values are returned by the same aggregate. You can of course always apply <code>first_value()</code> twice.</p>
    </div></div></div></div><div id="solution14" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 14</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>This way it work for me:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> article, dealer, price
<span class="hljs-keyword">FROM</span>   shop s1
<span class="hljs-keyword">WHERE</span>  price<span class="hljs-operator">=</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(s2.price)
              <span class="hljs-keyword">FROM</span> shop s2
              <span class="hljs-keyword">WHERE</span> s1.article <span class="hljs-operator">=</span> s2.article
              <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> s2.article)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> article;
</code></pre>
<p>Select highest price on each article</p>
    </div></div></div></div><div id="solution15" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 15</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>This is how we can achieve this by using windows function:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql">    <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> purchases (id int4, customer <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>), total <span class="hljs-type">integer</span>);
    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> purchases <span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'Joe'</span>, <span class="hljs-number">5</span>);
    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> purchases <span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'Sally'</span>, <span class="hljs-number">3</span>);
    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> purchases <span class="hljs-keyword">values</span> (<span class="hljs-number">3</span>, <span class="hljs-string">'Joe'</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> purchases <span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>, <span class="hljs-string">'Sally'</span>, <span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">select</span> ID, CUSTOMER, TOTAL <span class="hljs-keyword">from</span> (
    <span class="hljs-keyword">select</span> ID, CUSTOMER, TOTAL,
    <span class="hljs-built_in">row_number</span> () <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> CUSTOMER <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> TOTAL <span class="hljs-keyword">desc</span>) RN
    <span class="hljs-keyword">from</span> purchases) A <span class="hljs-keyword">where</span> RN <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><a href="https://i.stack.imgur.com/uwrys.png" rel="noreferrer"><img src="https://i.stack.imgur.com/uwrys.png" alt="enter image description here"></a></p>
    </div></div></div></div><div id="solution16" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 16</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The accepted OMG Ponies' "Supported by any database" solution has good speed from my test.</p>

<p>Here I provide a same-approach, but more complete and clean any-database solution.   Ties are considered (assume desire to get only one row for each customer, even multiple records for max total per customer), and other purchase fields (e.g. purchase_payment_id) will be selected for the real matching rows in the purchase table.</p>

<p>Supported by any database:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> purchase
<span class="hljs-keyword">join</span> (
    <span class="hljs-keyword">select</span> <span class="hljs-built_in">min</span>(id) <span class="hljs-keyword">as</span> id <span class="hljs-keyword">from</span> purchase
    <span class="hljs-keyword">join</span> (
        <span class="hljs-keyword">select</span> customer, <span class="hljs-built_in">max</span>(total) <span class="hljs-keyword">as</span> total <span class="hljs-keyword">from</span> purchase
        <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> customer
    ) t1 <span class="hljs-keyword">using</span> (customer, total)
    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> customer
) t2 <span class="hljs-keyword">using</span> (id)
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> customer
</code></pre>

<p>This query is reasonably fast especially when there is a composite index like (customer, total) on the purchase table.</p>

<p>Remark:</p>

<ol>
<li><p>t1, t2 are subquery alias which could be removed depending on database.</p></li>
<li><p><strong>Caveat</strong>: the <code>using (...)</code> clause is currently not supported in MS-SQL and Oracle db as of this edit on Jan 2017. You have to expand it yourself to e.g. <code>on t2.id = purchase.id</code> etc.  The USING syntax works in SQLite, MySQL and PostgreSQL.</p></li>
</ol>
    </div></div></div></div><div id="solution17" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 17</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<ul>
<li><p>If you want to select any (by your some specific condition) row from the set of aggregated rows. </p></li>
<li><p>If you want to use another (<code>sum/avg</code>) aggregation function in addition to <code>max/min</code>. Thus you can not use clue with <code>DISTINCT ON</code></p></li>
</ul>

<p>You can use next subquery:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>  
    (  
       <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span>id<span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t2   
       <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-keyword">ANY</span> ( <span class="hljs-built_in">ARRAY_AGG</span>( tf.id ) ) <span class="hljs-keyword">AND</span> amount <span class="hljs-operator">=</span> <span class="hljs-built_in">MAX</span>( tf.amount )   
    ) id,  
    name,   
    <span class="hljs-built_in">MAX</span>(amount) ma,  
    <span class="hljs-built_in">SUM</span>( ratio )  
<span class="hljs-keyword">FROM</span> t2  tf  
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> name
</code></pre>

<p>You can replace <code>amount = MAX( tf.amount )</code> with any condition you want with one restriction: This subquery must not return more than one row</p>

<p>But if you wanna to do such things you probably looking for <a href="https://www.postgresql.org/docs/current/static/tutorial-window.html" rel="nofollow noreferrer">window functions</a></p>
    </div></div></div></div><div id="solution18" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 18</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>For SQl Server the most efficient way is:   </p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">with</span>
ids <span class="hljs-keyword">as</span> ( <span class="hljs-comment">--condition for split table into groups</span>
    <span class="hljs-keyword">select</span> i <span class="hljs-keyword">from</span> (<span class="hljs-keyword">values</span> (<span class="hljs-number">9</span>),(<span class="hljs-number">12</span>),(<span class="hljs-number">17</span>),(<span class="hljs-number">18</span>),(<span class="hljs-number">19</span>),(<span class="hljs-number">20</span>),(<span class="hljs-number">22</span>),(<span class="hljs-number">21</span>),(<span class="hljs-number">23</span>),(<span class="hljs-number">10</span>)) <span class="hljs-keyword">as</span> v(i) 
) 
,src <span class="hljs-keyword">as</span> ( 
    <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> yourTable <span class="hljs-keyword">where</span>  <span class="hljs-operator">&lt;</span><span class="hljs-keyword">condition</span><span class="hljs-operator">&gt;</span> <span class="hljs-comment">--use this as filter for other conditions</span>
)
,joined <span class="hljs-keyword">as</span> (
    <span class="hljs-keyword">select</span> tops.<span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ids 
    <span class="hljs-keyword">cross</span> apply <span class="hljs-comment">--it`s like for each rows</span>
    (
        <span class="hljs-keyword">select</span> top(<span class="hljs-number">1</span>) <span class="hljs-operator">*</span> 
        <span class="hljs-keyword">from</span> src
        <span class="hljs-keyword">where</span> CommodityId <span class="hljs-operator">=</span> ids.i 
    ) <span class="hljs-keyword">as</span> tops
)
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> joined
</code></pre>

<p>and don't forget to create clustered index for used columns</p>
    </div></div></div></div><div id="solution19" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 19</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>My approach via window function <a href="https://dbfiddle.uk/?rdbms=postgres_13&amp;fiddle=01c699f3f47ca9fca8215f8cbf556218" rel="nofollow noreferrer">dbfiddle</a>:</p>
<ol>
<li>Assign <code>row_number</code> at each group: <code>row_number() over (partition by agreement_id, order_id ) as nrow</code></li>
<li>Take only first row at group: <code>filter (where nrow = 1)</code></li>
</ol>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">with</span> intermediate <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> 
 <span class="hljs-operator">*</span>,
 <span class="hljs-built_in">row_number</span>() <span class="hljs-keyword">over</span> ( <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> agreement_id, order_id ) <span class="hljs-keyword">as</span> nrow,
 (<span class="hljs-built_in">sum</span>( suma ) <span class="hljs-keyword">over</span> ( <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> agreement_id, order_id ))::<span class="hljs-type">numeric</span>( <span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> order_suma,
<span class="hljs-keyword">from</span> <span class="hljs-operator">&lt;</span>your <span class="hljs-keyword">table</span><span class="hljs-operator">&gt;</span>)

<span class="hljs-keyword">select</span> 
  <span class="hljs-operator">*</span>,
  <span class="hljs-built_in">sum</span>( order_suma ) <span class="hljs-keyword">filter</span> (<span class="hljs-keyword">where</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> agreement_id)
<span class="hljs-keyword">from</span> intermediate
</code></pre>
    </div></div></div></div><div id="solution20" class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl solution-inner border md:px-10 md:py-10 px-2 py-10 shadow-md bg-white"><div style="display:flex;justify-content:space-between"><h4 class="text-4xl font-semibold mb-5">Solution 20</h4><div class="tags-wrap h-max space-x-8"><div class="tags"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/sqlite">sqlite</a><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold whitespace-nowrap" href="/questions/tag/postgresql">postgresql</a></div></div></div><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>This can be achieved easily by MAX FUNCTION on total and GROUP BY id and customer.</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> id, customer, <span class="hljs-built_in">MAX</span>(total) <span class="hljs-keyword">FROM</span>  purchases <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> id, customer
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>;
</code></pre>
    </div></div></div></div></div></div><div class="widget"><a href="/questions/when-does-sqliteopenhelper-oncreate()-onupgrade()-run-1657384883864">When does SQLiteOpenHelper onCreate() / onUpgrade() run?</a><a href="/questions/what-should-main()-return-in-c-and-c++-1657384745630">What should main() return in C and C++?</a><a href="/questions/storing-images-in-db-yea-or-nay-1657387248067">Storing Images in DB - Yea or Nay?</a><a href="/questions/daylight-saving-time-and-time-zone-best-practices-closed-1657387973687">Daylight saving time and time zone best practices [closed]</a><a href="/questions/how-do-i-split-a-list-into-equally-sized-chunks-1657384580399">How do I split a list into equally-sized chunks?</a><a href="/questions/when-should-i-wrap-quotes-around-a-shell-variable-1657384659265">When should I wrap quotes around a shell variable?</a><a href="/questions/how-do-i-determine-the-correct-path-for-fxml-files-css-files-images-and-other-resources-needed-by-my-javafx-application-1657388143988">How do I determine the correct path for FXML files, CSS files, Images, and other resources needed by my JavaFX Application?</a><a href="/questions/sending-email-in-android-using-javamail-api-without-using-the-defaultbuilt-in-app-1657387883400">Sending Email in Android using JavaMail API without using the default/built-in app</a><a href="/questions/is-it-possible-to-escape-regex-metacharacters-reliably-with-sed-1657388428795">Is it possible to escape regex metacharacters reliably with sed</a><a href="/questions/performance-optimization-strategies-of-last-resort-closed-1657388420614">Performance optimization strategies of last resort [closed]</a><a href="/questions/how-to-access-the-correct-this-inside-a-callback-1657384283261">How to access the correct `this` inside a callback</a><a href="/questions/list-of-lists-changes-reflected-across-sublists-unexpectedly-1657384393720">List of lists changes reflected across sublists unexpectedly</a><a href="/questions/sql-injection-that-gets-around-mysql_real_escape_string()-1657384364747">SQL injection that gets around mysql_real_escape_string()</a><a href="/questions/is-an-array-name-a-pointer-1657387874827">Is an array name a pointer?</a><a href="/questions/sort-(order)-data-frame-rows-by-multiple-columns-1657388355671">Sort (order) data frame rows by multiple columns</a><a href="/questions/jquery-ajax-post-example-with-php-1657387402634">jQuery Ajax POST example with PHP</a><a href="/questions/change-the-maximum-upload-file-size-1657388495156">Change the maximum upload file size</a><a href="/questions/useless-use-of-cat-1657388390794">Useless use of cat?</a><a href="/questions/how-to-iterate-over-rows-in-a-dataframe-in-pandas-1657387358115">How to iterate over rows in a DataFrame in Pandas</a><a href="/questions/tkinter:-attributeerror:-nonetype-object-has-no-attribute-lessattribute-namegreater-1657385472410">Tkinter: AttributeError: NoneType object has no attribute &lt;attribute name&gt;</a></div></div><span class="cursor-pointer text-lg p-2" style="position:fixed;bottom:20px;left:20px;background:#000;z-index:2000;color:white">Go go top</span></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"answer":["\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;\u0026lt;/a\u0026gt; is typically simplest and fastest for this in \u0026lt;strong\u0026gt;PostgreSQL\u0026lt;/strong\u0026gt;.\u0026lt;br\u0026gt;\n\u0026lt;sub\u0026gt;(For performance optimization for certain workloads see below.)\u0026lt;/sub\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; (customer)\n       id, customer, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Or shorter (if not as clear) with ordinal numbers of output columns:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;)\n       id, customer, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;If \u0026lt;code\u0026gt;total\u0026lt;/code\u0026gt; can be NULL, add \u0026lt;code\u0026gt;NULLS LAST\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;...\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt; NULLS \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LAST\u0026lt;/span\u0026gt;, id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Works either way, but you\u0026apos;ll want to \u0026lt;a href=\u0026quot;https://dba.stackexchange.com/q/254731/3684\u0026quot;\u0026gt;match existing indexes\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=bf589b26f6e9fe8cdf3c6ca6e045eb6d\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;Major points\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt; is a PostgreSQL extension of the standard, where only \u0026lt;code\u0026gt;DISTINCT\u0026lt;/code\u0026gt; on the whole \u0026lt;code\u0026gt;SELECT\u0026lt;/code\u0026gt; list is defined.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;List any number of expressions in the \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; clause, the combined row value defines duplicates. \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/queries-select-lists.html#QUERIES-DISTINCT\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;The manual:\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;Obviously, two rows are considered distinct if they differ in at least\none column value. \u0026lt;strong\u0026gt;Null values are considered equal in this\ncomparison.\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\u0026lt;p\u0026gt;Bold emphasis mine.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; can be combined with \u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;. Leading expressions in \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; must be in the set of expressions in \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;, but you can rearrange order among those freely. \u0026lt;a href=\u0026quot;https://dba.stackexchange.com/a/89786/3684\u0026quot;\u0026gt;Example.\u0026lt;/a\u0026gt;\u0026lt;br\u0026gt;\nYou can add \u0026lt;em\u0026gt;additional\u0026lt;/em\u0026gt; expressions to \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; to pick a particular row from each group of peers. Or, as \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;the manual puts it\u0026lt;/a\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;blockquote\u0026gt;\n\u0026lt;p\u0026gt;The \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; expression(s) must match the leftmost \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt;\nexpression(s). The \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; clause will normally contain additional\nexpression(s) that determine the desired precedence of rows within\neach \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; group.\u0026lt;/p\u0026gt;\n\u0026lt;/blockquote\u0026gt;\n\u0026lt;p\u0026gt;I added \u0026lt;code\u0026gt;id\u0026lt;/code\u0026gt; as last item to break ties:\u0026lt;br\u0026gt;\n\u0026lt;em\u0026gt;\u0026quot;Pick the row with the smallest \u0026lt;code\u0026gt;id\u0026lt;/code\u0026gt; from each group sharing the highest \u0026lt;code\u0026gt;total\u0026lt;/code\u0026gt;.\u0026quot;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;To order results in a way that disagrees with the sort order determining the first per group, you can nest above query in an outer query with another \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt;. \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/9796104/939860\u0026quot;\u0026gt;Example.\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;If \u0026lt;code\u0026gt;total\u0026lt;/code\u0026gt; can be NULL, you \u0026lt;em\u0026gt;most probably\u0026lt;/em\u0026gt; want the row with the greatest non-null value. Add \u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;NULLS LAST\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt; like demonstrated. See:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/9510509/postgresql-sort-by-datetime-asc-null-first/9511492#9511492\u0026quot;\u0026gt;Sort by column ASC, but NULL values first?\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;The \u0026lt;code\u0026gt;SELECT\u0026lt;/code\u0026gt; list\u0026lt;/strong\u0026gt; is not constrained by expressions in \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; or \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; in any way:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;You \u0026lt;em\u0026gt;don\u0026apos;t have to\u0026lt;/em\u0026gt; include any of the expressions in \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; or \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt;.\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;You \u0026lt;em\u0026gt;can\u0026lt;/em\u0026gt; include any other expression in the \u0026lt;code\u0026gt;SELECT\u0026lt;/code\u0026gt; list. This is instrumental for replacing complex subqueries and aggregate / window functions.\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;I tested with Postgres versions 8.3  15. But the feature has been there at least since version 7.1, so basically always.\u0026lt;/p\u0026gt;\n\u0026lt;h2\u0026gt;Index\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;The \u0026lt;em\u0026gt;perfect\u0026lt;/em\u0026gt; index for the above query would be a \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/indexes-multicolumn.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;multi-column index\u0026lt;/a\u0026gt; spanning all three columns in matching sequence and with matching sort order:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; INDEX purchases_3c_idx \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; purchases (customer, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;May be too specialized. But use it if read performance for the particular query is crucial. If you have \u0026lt;code\u0026gt;DESC NULLS LAST\u0026lt;/code\u0026gt; in the query, use the same in the index so that sort order matches and the index is perfectly applicable.\u0026lt;/p\u0026gt;\n\u0026lt;h2\u0026gt;Effectiveness / Performance optimization\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;Weigh cost and benefit before creating tailored indexes for each query. The potential of above index largely depends on \u0026lt;strong\u0026gt;data distribution\u0026lt;/strong\u0026gt;.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;The index is used because it delivers pre-sorted data. In Postgres 9.2 or later the query can also benefit from an \u0026lt;strong\u0026gt;\u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/indexes-index-only-scans.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;index only scan\u0026lt;/a\u0026gt;\u0026lt;/strong\u0026gt; if the index is smaller than the underlying table. The index has to be scanned in its entirety, though. \u0026lt;a href=\u0026quot;https://dba.stackexchange.com/a/313755/3684\u0026quot;\u0026gt;Example.\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;For \u0026lt;strong\u0026gt;\u0026lt;em\u0026gt;few\u0026lt;/em\u0026gt; rows per customer\u0026lt;/strong\u0026gt; (high cardinality in column \u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt;), this is very efficient. Even more so if you need sorted output anyway. The benefit shrinks with a growing number of rows per customer.\u0026lt;br\u0026gt;\nIdeally, you have enough \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-WORK-MEM\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;work_mem\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;\u0026lt;/a\u0026gt; to process the involved sort step in RAM and not spill to disk. But generally setting \u0026lt;code\u0026gt;work_mem\u0026lt;/code\u0026gt; \u0026lt;em\u0026gt;too\u0026lt;/em\u0026gt; high can have adverse effects. Consider \u0026lt;code\u0026gt;SET LOCAL\u0026lt;/code\u0026gt; for exceptionally big queries. Find how much you need with \u0026lt;code\u0026gt;EXPLAIN ANALYZE\u0026lt;/code\u0026gt;. Mention of \u0026quot;\u0026lt;em\u0026gt;Disk:\u0026lt;/em\u0026gt;\u0026quot; in the sort step indicates the need for more:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/8106181/configuration-parameter-work-mem-in-postgresql-on-linux/8108807#8108807\u0026quot;\u0026gt;Configuration parameter work_mem in PostgreSQL on Linux\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://dba.stackexchange.com/a/48633/3684\u0026quot;\u0026gt;Optimize simple query using ORDER BY date and text\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;For \u0026lt;strong\u0026gt;\u0026lt;em\u0026gt;many\u0026lt;/em\u0026gt; rows per customer\u0026lt;/strong\u0026gt; (low cardinality in column \u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt;), a \u0026lt;a href=\u0026quot;https://wiki.postgresql.org/wiki/Loose_indexscan\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;strong\u0026gt;loose index scan\u0026lt;/strong\u0026gt;\u0026lt;/a\u0026gt; (a.k.a. \u0026quot;skip scan\u0026quot;) would be (much) more efficient, but that\u0026apos;s not implemented up to Postgres 14. (An implementation for index-only scans is in development for Postgres 15. See \u0026lt;a href=\u0026quot;https://commitfest.postgresql.org/19/1741/\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt; and \u0026lt;a href=\u0026quot;https://www.postgresql.org/message-id/flat/20200609102247.jdlatmfyeecg52fi%40localhost\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;.)\u0026lt;br\u0026gt;\nFor now, there are \u0026lt;strong\u0026gt;faster query techniques\u0026lt;/strong\u0026gt; to substitute for this. In particular if you have a separate table holding unique customers, which is the typical use case. But also if you don\u0026apos;t:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/66893968/select-distinct-is-slower-than-expected-on-my-table-in-postgresql/66894500#66894500\u0026quot;\u0026gt;SELECT DISTINCT is slower than expected on my table in PostgreSQL\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/25536422/optimize-group-by-query-to-retrieve-latest-record-per-user/25536748#25536748\u0026quot;\u0026gt;Optimize GROUP BY query to retrieve latest row per user\u0026lt;/a\u0026gt;\u0026lt;/strong\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/24244026/optimize-groupwise-maximum-query/24377356#24377356\u0026quot;\u0026gt;Optimize groupwise maximum query\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/25957558/querying-last-n-related-records-in-postgres/25965393#25965393\u0026quot;\u0026gt;Query last N related rows per row\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h2\u0026gt;Benchmarks\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/34715134/939860\u0026quot;\u0026gt;See separate answer.\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;h2\u0026gt;On databases that \u0026lt;a href=\u0026quot;https://en.wikipedia.org/wiki/Hierarchical_and_recursive_queries_in_SQL#Common_table_expression\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;support CTE and windowing functions\u0026lt;/a\u0026gt;:\u0026lt;/h2\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WITH\u0026lt;/span\u0026gt; summary \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; p.id, \n           p.customer, \n           p.total, \n           \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ROW_NUMBER\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.customer \n                                 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; rank\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; PURCHASES p)\n \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; summary\n \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; rank \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h2\u0026gt;Supported by any database:\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;But you need to add logic to break ties:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MIN\u0026lt;/span\u0026gt;(x.id),  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- change to MAX if you want the highest\u0026lt;/span\u0026gt;\n         x.customer, \n         x.total\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; PURCHASES x\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; p.customer,\n                 \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; max_total\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; PURCHASES p\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.customer) y \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; y.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; x.customer\n                              \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; y.max_total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; x.total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; x.customer, x.total\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;h1\u0026gt;Benchmarks\u0026lt;/h1\u0026gt;\n\u0026lt;p\u0026gt;I tested the most interesting candidates:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Initially with \u0026lt;strong\u0026gt;Postgres 9.4\u0026lt;/strong\u0026gt; and \u0026lt;strong\u0026gt;9.5\u0026lt;/strong\u0026gt;.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Added accented tests for \u0026lt;strong\u0026gt;Postgres 13\u0026lt;/strong\u0026gt; later.\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h3\u0026gt;Basic test setup\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;Main table: \u0026lt;code\u0026gt;purchases\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; purchases (\n  id          serial  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- PK constraint added below\u0026lt;/span\u0026gt;\n, customer_id \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- REFERENCES customer\u0026lt;/span\u0026gt;\n, total       \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- could be amount of money in Cent\u0026lt;/span\u0026gt;\n, some_column text    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- to make the row bigger, more realistic\u0026lt;/span\u0026gt;\n);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Dummy data (with some dead tuples), PK, index:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INSERT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INTO\u0026lt;/span\u0026gt; purchases (customer_id, total, some_column)    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- 200k rows\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; (random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10000\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; customer_id  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- 10k distinct customers\u0026lt;/span\u0026gt;\n     , (random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;100000\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; total     \n     , \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;note: \u0026apos;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;||\u0026lt;/span\u0026gt; repeat(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;x\u0026apos;\u0026lt;/span\u0026gt;, (random()\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;^\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   generate_series(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;200000\u0026lt;/span\u0026gt;) g;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ALTER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ADD\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CONSTRAINT\u0026lt;/span\u0026gt; purchases_id_pkey \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PRIMARY\u0026lt;/span\u0026gt; KEY (id);\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DELETE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0.9\u0026lt;/span\u0026gt;;  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- some dead rows\u0026lt;/span\u0026gt;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INSERT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INTO\u0026lt;/span\u0026gt; purchases (customer_id, total, some_column)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; (random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10000\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; customer_id  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- 10k customers\u0026lt;/span\u0026gt;\n     , (random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;100000\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; total     \n     , \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;note: \u0026apos;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;||\u0026lt;/span\u0026gt; repeat(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;x\u0026apos;\u0026lt;/span\u0026gt;, (random()\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;^\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; random() \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt;)::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   generate_series(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;20000\u0026lt;/span\u0026gt;) g;  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- add 20k to make it ~ 200k\u0026lt;/span\u0026gt;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; INDEX purchases_3c_idx \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; purchases (customer_id, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id);\n\nVACUUM ANALYZE purchases;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt; table - used for optimized query:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; customer \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; customer_id, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;customer_\u0026apos;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;||\u0026lt;/span\u0026gt; customer_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ALTER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; customer \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ADD\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CONSTRAINT\u0026lt;/span\u0026gt; customer_customer_id_pkey \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PRIMARY\u0026lt;/span\u0026gt; KEY (customer_id);\n\nVACUUM ANALYZE customer;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;In my second test for 9.5 I used the same setup, but with 100000 distinct \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt; to get \u0026lt;em\u0026gt;few\u0026lt;/em\u0026gt; rows per \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt;.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;Object sizes for table \u0026lt;code\u0026gt;purchases\u0026lt;/code\u0026gt;\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;Basic setup: 200k rows in \u0026lt;code\u0026gt;purchases\u0026lt;/code\u0026gt;, 10k distinct \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt;, avg. 20 rows per customer.\u0026lt;br\u0026gt;\nFor Postgres 9.5 I added a 2nd test with 86446 distinct customers - avg. 2.3 rows per customer.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Generated with a query taken from here:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://dba.stackexchange.com/a/23933/3684\u0026quot;\u0026gt;Measure the size of a PostgreSQL table row\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;Gathered for Postgres 9.5:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;               what                | bytes/ct | bytes_pretty | bytes_per_row\n-----------------------------------+----------+--------------+---------------\n core_relation_size                | 20496384 | 20 MB        |           102\n visibility_map                    |        0 | 0 bytes      |             0\n free_space_map                    |    24576 | 24 kB        |             0\n table_size_incl_toast             | 20529152 | 20 MB        |           102\n indexes_size                      | 10977280 | 10 MB        |            54\n total_size_incl_toast_and_indexes | 31506432 | 30 MB        |           157\n live_rows_in_text_representation  | 13729802 | 13 MB        |            68\n ------------------------------    |          |              |\n row_count                         |   200045 |              |\n live_tuples                       |   200045 |              |\n dead_tuples                       |    19955 |              |\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h1\u0026gt;Queries\u0026lt;/h1\u0026gt;\n\u0026lt;h3\u0026gt;1. \u0026lt;code\u0026gt;row_number()\u0026lt;/code\u0026gt; in CTE, (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/3800572/939860\u0026quot;\u0026gt;see other answer\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WITH\u0026lt;/span\u0026gt; cte \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; (\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n        , \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; rn\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n   )\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   cte\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  rn \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;2. \u0026lt;code\u0026gt;row_number()\u0026lt;/code\u0026gt; in subquery (my optimization)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   (\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n        , \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; rn\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n   ) sub\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  rn \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;3. \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/7630564/939860\u0026quot;\u0026gt;see other answer\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; (customer_id)\n       id, customer_id, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;4. rCTE with \u0026lt;code\u0026gt;LATERAL\u0026lt;/code\u0026gt; subquery (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/25536748/939860\u0026quot;\u0026gt;see here\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WITH\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;RECURSIVE\u0026lt;/span\u0026gt; cte \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; (\n   (  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- parentheses required\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n   LIMIT  \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n   )\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;UNION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ALL\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; u.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   cte c\n   ,      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LATERAL\u0026lt;/span\u0026gt; (\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  customer_id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt; c.customer_id  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- lateral reference\u0026lt;/span\u0026gt;\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n      LIMIT  \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n      ) u\n   )\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   cte\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;5. \u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt; table with \u0026lt;code\u0026gt;LATERAL\u0026lt;/code\u0026gt; (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/25536748/939860\u0026quot;\u0026gt;see here\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; l.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   customer c\n,      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LATERAL\u0026lt;/span\u0026gt; (\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer_id, total\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  customer_id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; c.customer_id  \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- lateral reference\u0026lt;/span\u0026gt;\n   \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n   LIMIT  \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n   ) l;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;6. \u0026lt;code\u0026gt;array_agg()\u0026lt;/code\u0026gt; with \u0026lt;code\u0026gt;ORDER BY\u0026lt;/code\u0026gt; (\u0026lt;a href=\u0026quot;https://stackoverflow.com/a/25534279/939860\u0026quot;\u0026gt;see other answer\u0026lt;/a\u0026gt;)\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;array_agg\u0026lt;/span\u0026gt;(id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;))[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;] \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; id\n     , customer_id\n     , \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;max\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer_id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h1\u0026gt;Results\u0026lt;/h1\u0026gt;\n\u0026lt;p\u0026gt;Execution time for above queries with \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/sql-explain.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;code\u0026gt;EXPLAIN (ANALYZE, TIMING OFF, COSTS OFF\u0026lt;/code\u0026gt;\u0026lt;/a\u0026gt;, \u0026lt;em\u0026gt;best of 5 runs\u0026lt;/em\u0026gt; to compare with warm cache.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;All\u0026lt;/em\u0026gt; queries used an \u0026lt;strong\u0026gt;Index Only Scan\u0026lt;/strong\u0026gt; on \u0026lt;code\u0026gt;purchases2_3c_idx\u0026lt;/code\u0026gt; (among other steps). Some only to benefit from the smaller size of the index, others more effectively.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;A. Postgres 9.4 with 200k rows and ~ 20 per \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt;\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 273.274 ms  \n2. 194.572 ms  \n3. 111.067 ms  \n4.  92.922 ms  -- !\n5.  37.679 ms  -- winner\n6. 189.495 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;B. Same as A. with Postgres 9.5\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 288.006 ms\n2. 223.032 ms  \n3. 107.074 ms  \n4.  78.032 ms  -- !\n5.  33.944 ms  -- winner\n6. 211.540 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h3\u0026gt;C. Same as B., but with ~ 2.3 rows per \u0026lt;code\u0026gt;customer_id\u0026lt;/code\u0026gt;\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 381.573 ms\n2. 311.976 ms\n3. 124.074 ms  -- winner\n4. 710.631 ms\n5. 311.976 ms\n6. 421.679 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;h1\u0026gt;Retest with Postgres 13 on 2021-08-11\u0026lt;/h1\u0026gt;\n\u0026lt;p\u0026gt;Simplified test setup: no deleted rows, because \u0026lt;code\u0026gt;VACUUM ANALYZE\u0026lt;/code\u0026gt; cleans the table completely for the simple case.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Important changes for Postgres:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;General performance improvements.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;CTEs can be inlined since Postgres 12, so query 1. and 2. now perform mostly identical (same query plan).\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h3\u0026gt;D. Like B. ~ 20 rows per customer_id\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 103 ms\n2. 103 ms  \n3.  23 ms  -- winner  \n4.  71 ms  \n5.  22 ms  -- winner\n6.  81 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=4cfd751a33e9d0ca3b024cb5795a5f6b\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;E. Like C. ~ 2.3 rows per customer_id\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 127 ms\n2. 126 ms  \n3.  36 ms  -- winner  \n4. 620 ms  \n5. 145 ms\n6. 203 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=e0eda395be68b453f51dc6fba4f3d4a6\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h2\u0026gt;Accented tests with Postgres 13\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;1M rows\u0026lt;/strong\u0026gt;, 10.000 vs. 100 vs. 1.6 rows per customer.\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;F. with ~ 10.000 rows per customer\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 526 ms\n2. 527 ms  \n3. 127 ms\n4.   2 ms  -- winner !\n5.   1 ms  -- winner !\n6. 356 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=1ded28c4adedd3292ba5e0a8401a641f\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;G. with ~ 100 rows per customer\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1. 535 ms\n2. 529 ms  \n3. 132 ms\n4. 108 ms  -- !\n5.  71 ms  -- winner\n6. 376 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=5f797bb9e694a4f0117ed3c957af1de2\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h3\u0026gt;H. with ~ 1.6 rows per customer\u0026lt;/h3\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1.  691 ms\n2.  684 ms  \n3.  234 ms  -- winner\n4. 4669 ms\n5. 1089 ms\n6. 1264 ms  \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;db\u0026amp;lt;\u0026amp;gt;fiddle \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=6cd53673f04cf3b00a3aeb16fc071926\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;h1\u0026gt;Conclusions\u0026lt;/h1\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;\u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; uses the index effectively and typically performs best for \u0026lt;strong\u0026gt;few\u0026lt;/strong\u0026gt; rows per group. And it performs decently even with many rows per group.\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;For \u0026lt;strong\u0026gt;many\u0026lt;/strong\u0026gt; rows per group, emulating an index skip scan with an rCTE performs best - second only to the query technique with a separate lookup table (if that\u0026apos;s available).\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;The \u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;row_number()\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt; technique demonstrated in the currently accepted answer \u0026lt;strong\u0026gt;never wins any performance test\u0026lt;/strong\u0026gt;. Not then, not now. It never comes even close to \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;, not even when the data distribution is unfavorable for the latter. The only good thing about \u0026lt;code\u0026gt;row_number()\u0026lt;/code\u0026gt;: it does not scale terribly, just mediocre.\u0026lt;/p\u0026gt;\n\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h2\u0026gt;More benchmarks\u0026lt;/h2\u0026gt;\n\u0026lt;p\u0026gt;Benchmark by \u0026quot;ogr\u0026quot; with \u0026lt;strong\u0026gt;10M rows and 60k unique \u0026quot;customers\u0026quot;\u0026lt;/strong\u0026gt; on \u0026lt;strong\u0026gt;Postgres 11.5\u0026lt;/strong\u0026gt;. Results are in line with what we have seen so far:\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/57893251/proper-way-to-access-latest-row-for-each-individual-identifier/57975451#57975451\u0026quot;\u0026gt;Proper way to access latest row for each individual identifier?\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;h3\u0026gt;Original (outdated) benchmark from 2011\u0026lt;/h3\u0026gt;\n\u0026lt;p\u0026gt;I ran three tests with PostgreSQL \u0026lt;strong\u0026gt;9.1\u0026lt;/strong\u0026gt; on a real life table of 65579 rows and single-column btree indexes on each of the three columns involved and took the best \u0026lt;em\u0026gt;execution time\u0026lt;/em\u0026gt; of 5 runs.\u0026lt;br\u0026gt;\nComparing \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/3800572/939860\u0026quot;\u0026gt;@OMGPonies\u0026apos;\u0026lt;/a\u0026gt; first query (\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;A\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;) to the \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/7630564/939860\u0026quot;\u0026gt;above \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt; solution\u0026lt;/a\u0026gt; (\u0026lt;strong\u0026gt;\u0026lt;code\u0026gt;B\u0026lt;/code\u0026gt;\u0026lt;/strong\u0026gt;):\u0026lt;/p\u0026gt;\n\u0026lt;ol\u0026gt;\n\u0026lt;li\u0026gt;Select the whole table, results in 5958 rows in this case.\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;A: 567.218 ms\nB: 386.673 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;ol start=\u0026quot;2\u0026quot;\u0026gt;\n\u0026lt;li\u0026gt;Use condition \u0026lt;code\u0026gt;WHERE customer BETWEEN x AND y\u0026lt;/code\u0026gt; resulting in 1000 rows.\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;A: 249.136 ms\nB:  55.111 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;ol start=\u0026quot;3\u0026quot;\u0026gt;\n\u0026lt;li\u0026gt;Select a single customer with \u0026lt;code\u0026gt;WHERE customer = x\u0026lt;/code\u0026gt;.\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;A:   0.143 ms\nB:   0.072 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Same test repeated with the index described in the other answer:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; INDEX purchases_3c_idx \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; purchases (customer, total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, id);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-none s-code-block\u0026quot;\u0026gt;\u0026lt;code\u0026gt;1A: 277.953 ms  \n1B: 193.547 ms\n\n2A: 249.796 ms -- special index not used  \n2B:  28.679 ms\n\n3A:   0.120 ms  \n3B:   0.048 ms\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This is common \u0026lt;a href=\u0026quot;/questions/tagged/greatest-n-per-group\u0026quot; class=\u0026quot;post-tag\u0026quot; title=\u0026quot;show questions tagged \u0026apos;greatest-n-per-group\u0026apos;\u0026quot; rel=\u0026quot;tag\u0026quot;\u0026gt;greatest-n-per-group\u0026lt;/a\u0026gt; problem, which already has well tested and highly \u0026lt;a href=\u0026quot;https://stackoverflow.com/q/8748986/684229\u0026quot;\u0026gt;optimized solutions\u0026lt;/a\u0026gt;. Personally I prefer the \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/8749095/684229\u0026quot;\u0026gt;left join solution by Bill Karwin\u0026lt;/a\u0026gt; (the \u0026lt;a href=\u0026quot;https://stackoverflow.com/a/123481/684229\u0026quot;\u0026gt;original post with lots of other solutions\u0026lt;/a\u0026gt;).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Note that bunch of solutions to this common problem can surprisingly be found in the one of most official sources, \u0026lt;strong\u0026gt;MySQL manual\u0026lt;/strong\u0026gt;! See \u0026lt;a href=\u0026quot;http://dev.mysql.com/doc/refman/5.0/en/example-maximum-column-group-row.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;Examples of Common Queries :: The Rows Holding the Group-wise Maximum of a Certain Column\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;In Postgres you can use \u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; like this:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;  customer,\n        (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;array_agg\u0026lt;/span\u0026gt;(id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;))[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;],\n        \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;max\u0026lt;/span\u0026gt;(total)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;This will give you the \u0026lt;code\u0026gt;id\u0026lt;/code\u0026gt; of each customer\u0026apos;s largest purchase.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Some things to note:\u0026lt;/p\u0026gt;\n\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; is an aggregate function, so it works with \u0026lt;code\u0026gt;GROUP BY\u0026lt;/code\u0026gt;.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; lets you specify an ordering scoped to just itself, so it doesn\u0026apos;t constrain the structure of the whole query. There is also syntax for how you sort NULLs, if you need to do something different from the default.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Once we build the array, we take the first element. (Postgres arrays are 1-indexed, not 0-indexed).\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;You could use \u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; in a similar way for your third output column, but \u0026lt;code\u0026gt;max(total)\u0026lt;/code\u0026gt; is simpler.\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Unlike \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;, using \u0026lt;code\u0026gt;array_agg\u0026lt;/code\u0026gt; lets you keep your \u0026lt;code\u0026gt;GROUP BY\u0026lt;/code\u0026gt;, in case you want that for other reasons.\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The solution is not very efficient as pointed by Erwin, because of presence of SubQs\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchases p1 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt;\n(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;max\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; p1.customer\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;customer) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;desc\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The Query:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; purchases.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LEFT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; p \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; \n  p.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; purchases.customer \n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \n  purchases.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt; p.total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IS\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;NULL\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;HOW DOES THAT WORK!\u0026lt;/strong\u0026gt; (I\u0026apos;ve been there)\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;We want to make sure that we only have the highest total for each purchase.\u0026lt;/p\u0026gt;\n\u0026lt;hr\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Some Theoretical Stuff\u0026lt;/strong\u0026gt; (skip this part if you only want to understand the query)\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Let Total be a function T(customer,id) where it returns a value given the name and id\nTo prove that the given total (T(customer,id)) is the highest we have to prove that\nWe want to prove either\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;x T(customer,id) \u0026amp;gt; T(customer,x) (this total is higher than all other\ntotal for that customer)\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;OR\u0026lt;/p\u0026gt;\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Â¬x T(customer, id) \u0026amp;lt; T(customer, x)   (there exists no higher total for\nthat customer)\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\u0026lt;p\u0026gt;The first approach will need us to get all the records for that name which I do not really like.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;The second one will need a smart way to say there can be no record higher than this one.\u0026lt;/p\u0026gt;\n\u0026lt;hr\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Back to SQL\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;If we left joins the table on the name and total being less than the joined table:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LEFT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; p \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; \np.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; purchases.customer \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \npurchases.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt; p.total\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;we make sure that all records that have another record with the higher total for the same user to be joined:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+---------------------+-----------------+------+------------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;  purchases.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.customer \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+---------------------+-----------------+------+------------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Tom                 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;200\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;    \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Tom        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;300\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Tom                 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;300\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Bob                 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;400\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;    \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Bob        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Bob                 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Alice               \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;600\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;    \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Alice      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;     \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;700\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Alice               \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;700\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+---------------------+-----------------+------+------------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;That will help us filter for the highest total for each purchase with no grouping needed:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IS\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;NULL\u0026lt;/span\u0026gt;\n    \n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+----------------+-----------------+------+--------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.name \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; purchases.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.name \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+----------------+-----------------+------+--------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Tom            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;300\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Bob            \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;500\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;            \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; Alice          \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;             \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;700\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;        \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;         \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--------------+----------------+-----------------+------+--------+---------+\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;And that\u0026apos;s the answer we need.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;I use this way (postgresql only): \u0026lt;a href=\u0026quot;https://wiki.postgresql.org/wiki/First/last_%28aggregate%29\u0026quot;\u0026gt;https://wiki.postgresql.org/wiki/First/last_%28aggregate%29\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- Create a function that always returns the first non-NULL item\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OR\u0026lt;/span\u0026gt; REPLACE \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FUNCTION\u0026lt;/span\u0026gt; public.first_agg ( anyelement, anyelement )\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;RETURNS\u0026lt;/span\u0026gt; anyelement \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LANGUAGE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;sql\u0026lt;/span\u0026gt; IMMUTABLE STRICT \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; $$\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; $\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n$$;\n\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- And then wrap an aggregate around it\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; AGGREGATE public.first (\n        sfunc    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; public.first_agg,\n        basetype \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; anyelement,\n        stype    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; anyelement\n);\n\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- Create a function that always returns the last non-NULL item\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OR\u0026lt;/span\u0026gt; REPLACE \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FUNCTION\u0026lt;/span\u0026gt; public.last_agg ( anyelement, anyelement )\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;RETURNS\u0026lt;/span\u0026gt; anyelement \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LANGUAGE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;sql\u0026lt;/span\u0026gt; IMMUTABLE STRICT \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; $$\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; $\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;;\n$$;\n\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- And then wrap an aggregate around it\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; AGGREGATE public.last (\n        sfunc    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; public.last_agg,\n        basetype \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; anyelement,\n        stype    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; anyelement\n);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Then your example should work \u0026lt;em\u0026gt;almost\u0026lt;/em\u0026gt; as is:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FIRST\u0026lt;/span\u0026gt;(id), customer, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FIRST\u0026lt;/span\u0026gt;(total)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;  purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FIRST\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;CAVEAT: It ignore\u0026apos;s NULL rows\u0026lt;/p\u0026gt;\n\n\u0026lt;hr\u0026gt;\n\n\u0026lt;h1\u0026gt;Edit 1 - Use the postgres extension instead\u0026lt;/h1\u0026gt;\n\n\u0026lt;p\u0026gt;Now I use this way: \u0026lt;a href=\u0026quot;http://pgxn.org/dist/first_last_agg/\u0026quot;\u0026gt;http://pgxn.org/dist/first_last_agg/\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;To install on ubuntu 14.04:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;apt\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;get\u0026lt;/span\u0026gt; install postgresql\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;server\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;dev\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;-9.3\u0026lt;/span\u0026gt; git build\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;essential \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;y\ngit clone git:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;github.com\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;wulczer\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;first_last_agg.git\ncd first_last_app\nmake \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;amp;\u0026amp;amp;\u0026lt;/span\u0026gt; sudo make install\npsql \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;c \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;create extension first_last_agg\u0026apos;\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;It\u0026apos;s a postgres extension that gives you first and last functions; apparently faster than the above way.\u0026lt;/p\u0026gt;\n\n\u0026lt;hr\u0026gt;\n\n\u0026lt;h1\u0026gt;Edit 2 - Ordering and filtering\u0026lt;/h1\u0026gt;\n\n\u0026lt;p\u0026gt;If you use aggregate functions (like these), you can order the results, without the need to have the data already ordered:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;http:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;www.postgresql.org\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;docs\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;current\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;static\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;/\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;sql\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;expressions.html#SYNTAX\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;-\u0026lt;/span\u0026gt;AGGREGATES\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;So the equivalent example, with ordering would be something like:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;first\u0026lt;/span\u0026gt;(id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; id), customer, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;first\u0026lt;/span\u0026gt;(total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; id)\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases\n \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;first\u0026lt;/span\u0026gt;(total);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Of course you can order and filter as you deem fit within the aggregate; it\u0026apos;s very powerful syntax.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Use \u0026lt;code\u0026gt;ARRAY_AGG\u0026lt;/code\u0026gt; function for \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/9.5/functions-aggregate.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;PostgreSQL\u0026lt;/a\u0026gt;, \u0026lt;a href=\u0026quot;https://docs.microsoft.com/en-us/u-sql/functions/aggregate/array-agg\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;U-SQL\u0026lt;/a\u0026gt;, \u0026lt;a href=\u0026quot;https://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0050494.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;IBM DB2\u0026lt;/a\u0026gt;, and \u0026lt;a href=\u0026quot;https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#array_agg\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;Google BigQuery SQL\u0026lt;/a\u0026gt;:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; customer, (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ARRAY_AGG\u0026lt;/span\u0026gt;(id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;))[\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;], \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(total)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;In SQL Server you can do this:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; (\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ROW_NUMBER\u0026lt;/span\u0026gt;()\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; StRank, \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; Purchases) n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; StRank \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Explaination:Here  \u0026lt;strong\u0026gt;Group by\u0026lt;/strong\u0026gt; is done on the basis of customer and then order it by total then each such group is given serial number as StRank and we are taking out first 1 customer whose StRank is 1\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Very fast solution\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; a.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;\n    purchases a \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; ( \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; customer, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;min\u0026lt;/span\u0026gt;( id ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; id \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer \n    ) b \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;USING\u0026lt;/span\u0026gt; ( id );\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;and really very fast if table is indexed by id:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;create\u0026lt;/span\u0026gt; index purchases_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;on\u0026lt;/span\u0026gt; purchases (id);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Snowflake/Teradata supports \u0026lt;a href=\u0026quot;https://docs.snowflake.net/manuals/sql-reference/constructs/qualify.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;code\u0026gt;QUALIFY\u0026lt;/code\u0026gt;\u0026lt;/a\u0026gt; clause which works like \u0026lt;code\u0026gt;HAVING\u0026lt;/code\u0026gt; for windowed functions:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer, total\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; PURCHASES\nQUALIFY \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ROW_NUMBER\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.customer \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; p.total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;In PostgreSQL, another possibility is to use the \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/functions-window.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;code\u0026gt;first_value\u0026lt;/code\u0026gt;\u0026lt;/a\u0026gt; window function in combination with \u0026lt;code\u0026gt;SELECT DISTINCT\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;distinct\u0026lt;/span\u0026gt; customer_id,\n                \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;first_value\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;row\u0026lt;/span\u0026gt;(id, total)) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; customer_id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;desc\u0026lt;/span\u0026gt;, id)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt;            purchases;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;I created a composite \u0026lt;code\u0026gt;(id, total)\u0026lt;/code\u0026gt;, so both values are returned by the same aggregate. You can of course always apply \u0026lt;code\u0026gt;first_value()\u0026lt;/code\u0026gt; twice.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This way it work for me:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; article, dealer, price\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;   shop s1\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;  price\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(s2.price)\n              \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; shop s2\n              \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; s1.article \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; s2.article\n              \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; s2.article)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; article;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Select highest price on each article\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This is how we can achieve this by using windows function:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;create\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;table\u0026lt;/span\u0026gt; purchases (id int4, customer \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;varchar\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;), total \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;integer\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;Joe\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;Sally\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;Joe\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;Sally\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;);\n    \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; ID, CUSTOMER, TOTAL \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; ID, CUSTOMER, TOTAL,\n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt; () \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; CUSTOMER \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; TOTAL \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;desc\u0026lt;/span\u0026gt;) RN\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchases) A \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; RN \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://i.stack.imgur.com/uwrys.png\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;img src=\u0026quot;https://i.stack.imgur.com/uwrys.png\u0026quot; alt=\u0026quot;enter image description here\u0026quot;\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The accepted OMG Ponies\u0026apos; \u0026quot;Supported by any database\u0026quot; solution has good speed from my test.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Here I provide a same-approach, but more complete and clean any-database solution.   Ties are considered (assume desire to get only one row for each customer, even multiple records for max total per customer), and other purchase fields (e.g. purchase_payment_id) will be selected for the real matching rows in the purchase table.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Supported by any database:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchase\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;join\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;min\u0026lt;/span\u0026gt;(id) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchase\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;join\u0026lt;/span\u0026gt; (\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; customer, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;max\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; purchase\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;group\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; customer\n    ) t1 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;using\u0026lt;/span\u0026gt; (customer, total)\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;group\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; customer\n) t2 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;using\u0026lt;/span\u0026gt; (id)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; customer\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;This query is reasonably fast especially when there is a composite index like (customer, total) on the purchase table.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;Remark:\u0026lt;/p\u0026gt;\n\n\u0026lt;ol\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;t1, t2 are subquery alias which could be removed depending on database.\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Caveat\u0026lt;/strong\u0026gt;: the \u0026lt;code\u0026gt;using (...)\u0026lt;/code\u0026gt; clause is currently not supported in MS-SQL and Oracle db as of this edit on Jan 2017. You have to expand it yourself to e.g. \u0026lt;code\u0026gt;on t2.id = purchase.id\u0026lt;/code\u0026gt; etc.  The USING syntax works in SQLite, MySQL and PostgreSQL.\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n    ","\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;If you want to select any (by your some specific condition) row from the set of aggregated rows. \u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;\u0026lt;p\u0026gt;If you want to use another (\u0026lt;code\u0026gt;sum/avg\u0026lt;/code\u0026gt;) aggregation function in addition to \u0026lt;code\u0026gt;max/min\u0026lt;/code\u0026gt;. Thus you can not use clue with \u0026lt;code\u0026gt;DISTINCT ON\u0026lt;/code\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\n\u0026lt;p\u0026gt;You can use next subquery:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;  \n    (  \n       \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;id\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; t2   \n       \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ANY\u0026lt;/span\u0026gt; ( \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ARRAY_AGG\u0026lt;/span\u0026gt;( tf.id ) ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; amount \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;( tf.amount )   \n    ) id,  \n    name,   \n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(amount) ma,  \n    \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;SUM\u0026lt;/span\u0026gt;( ratio )  \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; t2  tf  \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; name\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;You can replace \u0026lt;code\u0026gt;amount = MAX( tf.amount )\u0026lt;/code\u0026gt; with any condition you want with one restriction: This subquery must not return more than one row\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;But if you wanna to do such things you probably looking for \u0026lt;a href=\u0026quot;https://www.postgresql.org/docs/current/static/tutorial-window.html\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;window functions\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;For SQl Server the most efficient way is:   \u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;with\u0026lt;/span\u0026gt;\nids \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; ( \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--condition for split table into groups\u0026lt;/span\u0026gt;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; i \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;9\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;17\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;18\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;19\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;20\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;22\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;21\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;23\u0026lt;/span\u0026gt;),(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;)) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; v(i) \n) \n,src \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; ( \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; yourTable \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt;  \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;condition\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--use this as filter for other conditions\u0026lt;/span\u0026gt;\n)\n,joined \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; tops.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; ids \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;cross\u0026lt;/span\u0026gt; apply \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;--it`s like for each rows\u0026lt;/span\u0026gt;\n    (\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; top(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; src\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; CommodityId \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; ids.i \n    ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; tops\n)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; joined\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;and don\u0026apos;t forget to create clustered index for used columns\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;My approach via window function \u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=postgres_13\u0026amp;amp;fiddle=01c699f3f47ca9fca8215f8cbf556218\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;dbfiddle\u0026lt;/a\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;ol\u0026gt;\n\u0026lt;li\u0026gt;Assign \u0026lt;code\u0026gt;row_number\u0026lt;/code\u0026gt; at each group: \u0026lt;code\u0026gt;row_number() over (partition by agreement_id, order_id ) as nrow\u0026lt;/code\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Take only first row at group: \u0026lt;code\u0026gt;filter (where nrow = 1)\u0026lt;/code\u0026gt;\u0026lt;/li\u0026gt;\n\u0026lt;/ol\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;with\u0026lt;/span\u0026gt; intermediate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \n \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;,\n \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; ( \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; agreement_id, order_id ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; nrow,\n (\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;sum\u0026lt;/span\u0026gt;( suma ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; ( \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; agreement_id, order_id ))::\u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;numeric\u0026lt;/span\u0026gt;( \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; order_suma,\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt;your \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;table\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt;)\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \n  \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;,\n  \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;sum\u0026lt;/span\u0026gt;( order_suma ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;filter\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; nrow \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; agreement_id)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; intermediate\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This can be achieved easily by MAX FUNCTION on total and GROUP BY id and customer.\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, customer, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;MAX\u0026lt;/span\u0026gt;(total) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;  purchases \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id, customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    "],"id":157,"title":"Select first row in each GROUP BY group?","content":"\n                \n\n\u0026lt;p\u0026gt;As the title suggests, I\u0026apos;d like to select the first row of each set of rows grouped with a \u0026lt;code\u0026gt;GROUP BY\u0026lt;/code\u0026gt;.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Specifically, if I\u0026apos;ve got a \u0026lt;code\u0026gt;purchases\u0026lt;/code\u0026gt; table that looks like this:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; purchases;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;My Output:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;div class=\u0026quot;s-table-container\u0026quot;\u0026gt;\n\u0026lt;table class=\u0026quot;s-table\u0026quot;\u0026gt;\n\u0026lt;thead\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;th\u0026gt;id\u0026lt;/th\u0026gt;\n\u0026lt;th\u0026gt;customer\u0026lt;/th\u0026gt;\n\u0026lt;th\u0026gt;total\u0026lt;/th\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;/thead\u0026gt;\n\u0026lt;tbody\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td\u0026gt;1\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;Joe\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;5\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td\u0026gt;2\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;Sally\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;3\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td\u0026gt;3\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;Joe\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;2\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td\u0026gt;4\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;Sally\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;1\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;/tbody\u0026gt;\n\u0026lt;/table\u0026gt;\n\u0026lt;/div\u0026gt;\n\u0026lt;p\u0026gt;I\u0026apos;d like to query for the \u0026lt;code\u0026gt;id\u0026lt;/code\u0026gt; of the largest purchase (\u0026lt;code\u0026gt;total\u0026lt;/code\u0026gt;) made by each \u0026lt;code\u0026gt;customer\u0026lt;/code\u0026gt;. Something like this:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FIRST\u0026lt;/span\u0026gt;(id), customer, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FIRST\u0026lt;/span\u0026gt;(total)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;  purchases\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; customer\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; total \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Expected Output:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;div class=\u0026quot;s-table-container\u0026quot;\u0026gt;\n\u0026lt;table class=\u0026quot;s-table\u0026quot;\u0026gt;\n\u0026lt;thead\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;th\u0026gt;FIRST(id)\u0026lt;/th\u0026gt;\n\u0026lt;th\u0026gt;customer\u0026lt;/th\u0026gt;\n\u0026lt;th\u0026gt;FIRST(total)\u0026lt;/th\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;/thead\u0026gt;\n\u0026lt;tbody\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td\u0026gt;1\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;Joe\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;5\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td\u0026gt;2\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;Sally\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;3\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;/tbody\u0026gt;\n\u0026lt;/table\u0026gt;\n\u0026lt;/div\u0026gt;    ","slug":"select-first-row-in-each-group-by-group-1657384809388","postType":"QUESTION","createdAt":"2022-07-09T16:40:09.000Z","updatedAt":"2022-07-09T16:40:09.000Z","tags":[{"id":570,"name":"sqlite","slug":"sqlite","createdAt":"2022-07-09T16:40:09.000Z","updatedAt":"2022-07-09T16:40:09.000Z","Questions_Tags":{"questionId":157,"tagId":570}},{"id":571,"name":"postgresql","slug":"postgresql","createdAt":"2022-07-09T16:40:09.000Z","updatedAt":"2022-07-09T16:40:09.000Z","Questions_Tags":{"questionId":157,"tagId":571}}],"relatedQuestions":[{"title":"Select first row in each GROUP BY group?","slug":"select-first-row-in-each-group-by-group-1657384809388","tags":[{"name":"sqlite","Questions_Tags":{"questionId":157,"tagId":570}},{"name":"postgresql","Questions_Tags":{"questionId":157,"tagId":571}}]}]},"randomQuestions":[{"title":"When does SQLiteOpenHelper onCreate() / onUpgrade() run?","slug":"when-does-sqliteopenhelper-oncreate()-onupgrade()-run-1657384883864"},{"title":"What should main() return in C and C++?","slug":"what-should-main()-return-in-c-and-c++-1657384745630"},{"title":"Storing Images in DB - Yea or Nay?","slug":"storing-images-in-db-yea-or-nay-1657387248067"},{"title":"Daylight saving time and time zone best practices [closed]","slug":"daylight-saving-time-and-time-zone-best-practices-closed-1657387973687"},{"title":"How do I split a list into equally-sized chunks?","slug":"how-do-i-split-a-list-into-equally-sized-chunks-1657384580399"},{"title":"When should I wrap quotes around a shell variable?","slug":"when-should-i-wrap-quotes-around-a-shell-variable-1657384659265"},{"title":"How do I determine the correct path for FXML files, CSS files, Images, and other resources needed by my JavaFX Application?","slug":"how-do-i-determine-the-correct-path-for-fxml-files-css-files-images-and-other-resources-needed-by-my-javafx-application-1657388143988"},{"title":"Sending Email in Android using JavaMail API without using the default/built-in app","slug":"sending-email-in-android-using-javamail-api-without-using-the-defaultbuilt-in-app-1657387883400"},{"title":"Is it possible to escape regex metacharacters reliably with sed","slug":"is-it-possible-to-escape-regex-metacharacters-reliably-with-sed-1657388428795"},{"title":"Performance optimization strategies of last resort [closed]","slug":"performance-optimization-strategies-of-last-resort-closed-1657388420614"},{"title":"How to access the correct `this` inside a callback","slug":"how-to-access-the-correct-this-inside-a-callback-1657384283261"},{"title":"List of lists changes reflected across sublists unexpectedly","slug":"list-of-lists-changes-reflected-across-sublists-unexpectedly-1657384393720"},{"title":"SQL injection that gets around mysql_real_escape_string()","slug":"sql-injection-that-gets-around-mysql_real_escape_string()-1657384364747"},{"title":"Is an array name a pointer?","slug":"is-an-array-name-a-pointer-1657387874827"},{"title":"Sort (order) data frame rows by multiple columns","slug":"sort-(order)-data-frame-rows-by-multiple-columns-1657388355671"},{"title":"jQuery Ajax POST example with PHP","slug":"jquery-ajax-post-example-with-php-1657387402634"},{"title":"Change the maximum upload file size","slug":"change-the-maximum-upload-file-size-1657388495156"},{"title":"Useless use of cat?","slug":"useless-use-of-cat-1657388390794"},{"title":"How to iterate over rows in a DataFrame in Pandas","slug":"how-to-iterate-over-rows-in-a-dataframe-in-pandas-1657387358115"},{"title":"Tkinter: AttributeError: NoneType object has no attribute \u003cattribute name\u003e","slug":"tkinter:-attributeerror:-nonetype-object-has-no-attribute-lessattribute-namegreater-1657385472410"}]},"__N_SSG":true},"page":"/questions/[slug]","query":{"slug":"select-first-row-in-each-group-by-group-1657384809388"},"buildId":"BnkbnjkWYxefPXjTJLVVv","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>