<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/2eccd4d47c856f2b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2eccd4d47c856f2b.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-cb7634a8b6194820.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-25e5079ab4bd6ecd.js" defer=""></script><script src="/_next/static/chunks/pages/_app-20edbe0b078add93.js" defer=""></script><script src="/_next/static/chunks/29107295-fbcfe2172188e46f.js" defer=""></script><script src="/_next/static/chunks/613-1e0aa2b2023820bb.js" defer=""></script><script src="/_next/static/chunks/495-bb1d5b202c02d7f2.js" defer=""></script><script src="/_next/static/chunks/471-84c36aa98dd4107c.js" defer=""></script><script src="/_next/static/chunks/81-301f760ac8107464.js" defer=""></script><script src="/_next/static/chunks/pages/questions/%5Bslug%5D-76d2c3e2d98bb08b.js" defer=""></script><script src="/_next/static/B9ZMQqRLGvIP-RcWN9dT2/_buildManifest.js" defer=""></script><script src="/_next/static/B9ZMQqRLGvIP-RcWN9dT2/_ssgManifest.js" defer=""></script><style data-styled="" data-styled-version="5.3.5">.eZIPKL code{padding:5px;color:hsl(210deg 8% 15%);background-color:hsl(210deg 8% 90%);border-radius:3px;}/*!sc*/
data-styled.g5[id="sc-c4b0431a-0"]{content:"eZIPKL,"}/*!sc*/
</style></head><body><div id="__next"><div class="sc-9099c029-0 cIPEih"><header><nav class="bg-white border-gray-200 px-4 lg:px-6 py-2.5 dark:bg-gray-800"><div class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl"><a class="flex items-center" href="/"><img src="https://flowbite.com/docs/images/logo.svg" class="mr-3 h-6 sm:h-9" alt="Flowbite Logo"/><span class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">Solution Hunter</span></a><div class="flex items-center lg:order-2"><button data-collapse-toggle="mobile-menu-2" type="button" class="inline-flex items-center p-2 ml-1 text-sm text-gray-500 rounded-lg lg:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="mobile-menu-2" aria-expanded="false"><span class="sr-only">Open main menu</span><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg><svg class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><div class="hidden justify-between items-center w-full lg:flex lg:w-auto lg:order-1" id="mobile-menu-2"><ul class="flex flex-col mt-4 font-medium lg:flex-row lg:space-x-8 lg:mt-0"><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" aria-current="page" href="/">Home</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions?tab=news">Questions</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/post?tab=news">Post</a></li><li><a class="block py-2 pr-4 pl-3 text-gray-700 border-b border-gray-100 hover:bg-gray-50 lg:hover:bg-transparent lg:border-0 lg:hover:text-blue-700 lg:p-0 dark:text-gray-400 lg:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white lg:dark:hover:bg-transparent dark:border-gray-700" href="/questions/using-limit-within-group-by-to-get-n-results-per-group-1657388324167#">Coding</a></li></ul></div></div></nav></header><div class="main-content"><div class="sc-c5440139-0 figLul question my-5"><div class="sc-c4b0431a-0 eZIPKL flex question-header items-center justify-center"><div class="rounded-xl border p-5 shadow-md w-9/12 bg-white"><div class="flex w-full items-center justify-between border-b pb-3"><div class="flex items-center space-x-3"><div class="text-lg font-bold text-slate-700"><a href="/questions/using-limit-within-group-by-to-get-n-results-per-group-1657388324167">Using LIMIT within GROUP BY to get N results per group?</a></div></div><div class="flex flex-wrap h-auto justify-end items-center space-x-8"><a class="rounded-2xl border bg-neutral-100 px-3 py-1 text-sm font-semibold" href="/questions/tag/ranking">ranking</a></div></div><div class="question-content mt-5">
                
<p>The following query:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>
<span class="hljs-keyword">year</span>, id, rate
<span class="hljs-keyword">FROM</span> h
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">year</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2000</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2009</span>
<span class="hljs-keyword">AND</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> rid <span class="hljs-keyword">FROM</span> table2)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> id, <span class="hljs-keyword">year</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id, rate <span class="hljs-keyword">DESC</span>
</code></pre>

<p>yields:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">year</span>    id  rate
<span class="hljs-number">2006</span>    p01 <span class="hljs-number">8</span>
<span class="hljs-number">2003</span>    p01 <span class="hljs-number">7.4</span>
<span class="hljs-number">2008</span>    p01 <span class="hljs-number">6.8</span>
<span class="hljs-number">2001</span>    p01 <span class="hljs-number">5.9</span>
<span class="hljs-number">2007</span>    p01 <span class="hljs-number">5.3</span>
<span class="hljs-number">2009</span>    p01 <span class="hljs-number">4.4</span>
<span class="hljs-number">2002</span>    p01 <span class="hljs-number">3.9</span>
<span class="hljs-number">2004</span>    p01 <span class="hljs-number">3.5</span>
<span class="hljs-number">2005</span>    p01 <span class="hljs-number">2.1</span>
<span class="hljs-number">2000</span>    p01 <span class="hljs-number">0.8</span>
<span class="hljs-number">2001</span>    p02 <span class="hljs-number">12.5</span>
<span class="hljs-number">2004</span>    p02 <span class="hljs-number">12.4</span>
<span class="hljs-number">2002</span>    p02 <span class="hljs-number">12.2</span>
<span class="hljs-number">2003</span>    p02 <span class="hljs-number">10.3</span>
<span class="hljs-number">2000</span>    p02 <span class="hljs-number">8.7</span>
<span class="hljs-number">2006</span>    p02 <span class="hljs-number">4.6</span>
<span class="hljs-number">2007</span>    p02 <span class="hljs-number">3.3</span>
</code></pre>

<p>What I'd like is only the top 5 results for each id:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-number">2006</span>    p01 <span class="hljs-number">8</span>
<span class="hljs-number">2003</span>    p01 <span class="hljs-number">7.4</span>
<span class="hljs-number">2008</span>    p01 <span class="hljs-number">6.8</span>
<span class="hljs-number">2001</span>    p01 <span class="hljs-number">5.9</span>
<span class="hljs-number">2007</span>    p01 <span class="hljs-number">5.3</span>
<span class="hljs-number">2001</span>    p02 <span class="hljs-number">12.5</span>
<span class="hljs-number">2004</span>    p02 <span class="hljs-number">12.4</span>
<span class="hljs-number">2002</span>    p02 <span class="hljs-number">12.2</span>
<span class="hljs-number">2003</span>    p02 <span class="hljs-number">10.3</span>
<span class="hljs-number">2000</span>    p02 <span class="hljs-number">8.7</span>
</code></pre>

<p>Is there a way to do this using some kind of LIMIT like modifier that works within the GROUP BY?</p>
    </div></div></div><div class="sc-c4b0431a-2 cRqwQe"><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 1</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>You could use <a href="https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html#function_group-concat" rel="noreferrer">GROUP_CONCAT</a> aggregated function to get all years into a single column, grouped by <code>id</code> and ordered by <code>rate</code>:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>   id, GROUP_CONCAT(<span class="hljs-keyword">year</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rate <span class="hljs-keyword">DESC</span>) grouped_year
<span class="hljs-keyword">FROM</span>     yourtable
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> id
</code></pre>
<p>Result:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-comment">-----------------------------------------------------------</span>
<span class="hljs-operator">|</span>  ID <span class="hljs-operator">|</span> GROUPED_YEAR                                      <span class="hljs-operator">|</span>
<span class="hljs-comment">-----------------------------------------------------------</span>
<span class="hljs-operator">|</span> p01 <span class="hljs-operator">|</span> <span class="hljs-number">2006</span>,<span class="hljs-number">2003</span>,<span class="hljs-number">2008</span>,<span class="hljs-number">2001</span>,<span class="hljs-number">2007</span>,<span class="hljs-number">2009</span>,<span class="hljs-number">2002</span>,<span class="hljs-number">2004</span>,<span class="hljs-number">2005</span>,<span class="hljs-number">2000</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> p02 <span class="hljs-operator">|</span> <span class="hljs-number">2001</span>,<span class="hljs-number">2004</span>,<span class="hljs-number">2002</span>,<span class="hljs-number">2003</span>,<span class="hljs-number">2000</span>,<span class="hljs-number">2006</span>,<span class="hljs-number">2007</span>                <span class="hljs-operator">|</span>
<span class="hljs-comment">-----------------------------------------------------------</span>
</code></pre>
<p>And then you could use <a href="https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_find-in-set" rel="noreferrer">FIND_IN_SET</a>, that returns the position of the first argument inside the second one, eg.</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> FIND_IN_SET(<span class="hljs-string">'2006'</span>, <span class="hljs-string">'2006,2003,2008,2001,2007,2009,2002,2004,2005,2000'</span>);
<span class="hljs-number">1</span>

<span class="hljs-keyword">SELECT</span> FIND_IN_SET(<span class="hljs-string">'2009'</span>, <span class="hljs-string">'2006,2003,2008,2001,2007,2009,2002,2004,2005,2000'</span>);
<span class="hljs-number">6</span>
</code></pre>
<p>Using a combination of <code>GROUP_CONCAT</code> and <code>FIND_IN_SET</code>, and filtering by the position returned by find_in_set, you could then use this query that returns only the first 5 years for every id:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>
  yourtable.<span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span>
  yourtable <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
      id,
      GROUP_CONCAT(<span class="hljs-keyword">year</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rate <span class="hljs-keyword">DESC</span>) grouped_year
    <span class="hljs-keyword">FROM</span>
      yourtable
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> id) group_max
  <span class="hljs-keyword">ON</span> yourtable.id <span class="hljs-operator">=</span> group_max.id
     <span class="hljs-keyword">AND</span> FIND_IN_SET(<span class="hljs-keyword">year</span>, grouped_year) <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">5</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  yourtable.id, yourtable.year <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>Please see fiddle <a href="http://sqlfiddle.com/#!2/1c220/1" rel="noreferrer">here</a>.</p>
<p>Please note that if more than one row can have the same rate, you should consider using <code>GROUP_CONCAT(DISTINCT rate ORDER BY rate)</code> on the <code>rate</code> column instead of the <code>year</code> column.</p>
<p>The maximum length of the string returned by <code>GROUP_CONCAT</code> is limited, so this works well if you need to select a few records for every group.</p>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 2</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>You want to find <em><strong>top n rows per group</strong></em>. This answer provides a generic solution using example data that is different from OP.</p>
<p>In MySQL 8 or later you can use the <a href="https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html" rel="noreferrer"><code>ROW_NUMBER</code>, <code>RANK</code> or <code>DENSE_RANK</code></a> function depending on the exact definition of top 5. Below are the numbers generated by these functions based on <code>value</code> sorted descending. Notice how ties are handled:</p>
<div class="s-table-container">
<table class="s-table">
<thead>
<tr>
<th style="text-align: right;">pkid</th>
<th>catid</th>
<th style="text-align: right;">value</th>
<th style="text-align: right;">row_number</th>
<th style="text-align: right;">rank</th>
<th style="text-align: right;">dense_rank</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">1</td>
<td>p01</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">*1</td>
<td style="text-align: right;">*1</td>
<td style="text-align: right;">*1</td>
</tr>
<tr>
<td style="text-align: right;">2</td>
<td>p01</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">*2</td>
<td style="text-align: right;">*2</td>
<td style="text-align: right;">*2</td>
</tr>
<tr>
<td style="text-align: right;">3</td>
<td>p01</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">*3</td>
<td style="text-align: right;">*2</td>
<td style="text-align: right;">*2</td>
</tr>
<tr>
<td style="text-align: right;">4</td>
<td>p01</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">*4</td>
<td style="text-align: right;">*4</td>
<td style="text-align: right;">*3</td>
</tr>
<tr>
<td style="text-align: right;">5</td>
<td>p01</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">*5</td>
<td style="text-align: right;">*4</td>
<td style="text-align: right;">*3</td>
</tr>
<tr>
<td style="text-align: right;">6</td>
<td>p01</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">*4</td>
<td style="text-align: right;">*3</td>
</tr>
<tr>
<td style="text-align: right;">7</td>
<td>p01</td>
<td style="text-align: right;">70</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">*4</td>
</tr>
<tr>
<td style="text-align: right;">8</td>
<td>p01</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">*5</td>
</tr>
<tr>
<td style="text-align: right;">9</td>
<td>p01</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">6</td>
</tr>
<tr>
<td style="text-align: right;">10</td>
<td>p01</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">7</td>
</tr>
</tbody>
</table>
</div>
<p>Once you have chosen the function, use it like so:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> n
    <span class="hljs-keyword">FROM</span> t
) <span class="hljs-keyword">AS</span> x
<span class="hljs-keyword">WHERE</span> n <span class="hljs-operator">&lt;=</span> <span class="hljs-number">5</span>
</code></pre>
<p><a href="https://dbfiddle.uk/?rdbms=mysql_8.0&amp;fiddle=29ff3dde85d2fb2085fcd195a7a9134e" rel="noreferrer">DB&lt;&gt;Fiddle</a></p>
<hr>
<p>In MySQL 5.x you can use poor man's rank over partition to achieve desired result: outer join the table with itself and for each row, count the number of rows <em><strong>before</strong></em> it (e.g. the before row could be the one with higher value).</p>
<p>The following will produce results similar to <code>RANK</code> function:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> t.pkid, t.catid, t.value, <span class="hljs-built_in">COUNT</span>(b.value) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> rank
<span class="hljs-keyword">FROM</span> t
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> t <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">ON</span> b.catid <span class="hljs-operator">=</span> t.catid <span class="hljs-keyword">AND</span> b.value <span class="hljs-operator">&gt;</span> t.value
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> t.pkid, t.catid, t.value
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(b.value) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-number">5</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> t.catid, t.value <span class="hljs-keyword">DESC</span>, t.pkid
</code></pre>
<p>Make the following change to produce results similar to <code>DENSE_RANK</code> function:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> b.value)
</code></pre>
<p>Or make the following change to produce results similar to <code>ROW_NUMBER</code> function:</p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">ON</span> b.catid <span class="hljs-operator">=</span> t.catid <span class="hljs-keyword">AND</span> (b.value <span class="hljs-operator">&gt;</span> t.value <span class="hljs-keyword">OR</span> b.value <span class="hljs-operator">=</span> t.value <span class="hljs-keyword">AND</span> b.pkid <span class="hljs-operator">&lt;</span> t.pkid)
</code></pre>
<p><a href="https://dbfiddle.uk/?rdbms=mysql_5.5&amp;fiddle=d4baaf1a1df9b681545b13031e641d9f" rel="noreferrer">DB&lt;&gt;Fiddle</a></p>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 3</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>For me something like </p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql">SUBSTRING_INDEX(group_concat(col_name <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> desired_col_order_name), <span class="hljs-string">','</span>, N) 
</code></pre>

<p>works perfectly. No complicated query.</p>

<hr>

<p>for example: get top 1 for each group</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> 
    <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span>
    yourtable
<span class="hljs-keyword">WHERE</span>
    id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> 
            SUBSTRING_INDEX(GROUP_CONCAT(id
                            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rate <span class="hljs-keyword">DESC</span>),
                        <span class="hljs-string">','</span>,
                        <span class="hljs-number">1</span>) id
        <span class="hljs-keyword">FROM</span>
            yourtable
        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">year</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rate <span class="hljs-keyword">DESC</span>;
</code></pre>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 4</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>No, you can't LIMIT subqueries arbitrarily (you can do it to a limited extent in newer MySQLs, but not for 5 results per group).</p>

<p>This is a groupwise-maximum type query, which is not trivial to do in SQL. There are <a href="https://stackoverflow.com/questions/755918/simple-query-to-grab-max-value-for-each-id/756892#756892">various ways</a> to tackle that which can be more efficient for some cases, but for top-n in general you'll want to look at <a href="https://stackoverflow.com/questions/1442527/how-to-select-the-newest-four-items-per-category/1442867#1442867">Bill's answer</a> to a similar previous question.</p>

<p>As with most solutions to this problem, it can return more than five rows if there are multiple rows with the same <code>rate</code> value, so you may still need a quantity of post-processing to check for that.</p>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 5</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">year</span>, id, rate
<span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">year</span>, id, rate, <span class="hljs-built_in">row_number</span>() <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> id <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> rate <span class="hljs-keyword">DESC</span>)
  <span class="hljs-keyword">FROM</span> h
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">year</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2000</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2009</span>
  <span class="hljs-keyword">AND</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> rid <span class="hljs-keyword">FROM</span> table2)
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> id, <span class="hljs-keyword">year</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id, rate <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> subquery
<span class="hljs-keyword">WHERE</span> row_number <span class="hljs-operator">&lt;=</span> <span class="hljs-number">5</span>
</code></pre>

<p>The subquery is almost identical to your query. Only change is adding</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-built_in">row_number</span>() <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> id <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> rate <span class="hljs-keyword">DESC</span>)
</code></pre>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 6</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>This requires a series of subqueries to rank the values, limit them, then perform the sum while grouping</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-variable">@Rnk</span>:<span class="hljs-operator">=</span><span class="hljs-number">0</span>;
<span class="hljs-variable">@N</span>:<span class="hljs-operator">=</span><span class="hljs-number">2</span>;
<span class="hljs-keyword">select</span>
  c.id,
  <span class="hljs-built_in">sum</span>(c.val)
<span class="hljs-keyword">from</span> (
<span class="hljs-keyword">select</span>
  b.id,
  b.bal
<span class="hljs-keyword">from</span> (
<span class="hljs-keyword">select</span>   
  if(<span class="hljs-variable">@last</span>_id<span class="hljs-operator">=</span>id,<span class="hljs-variable">@Rnk</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> Rnk,
  a.id,
  a.val,
  <span class="hljs-variable">@last</span>_id<span class="hljs-operator">=</span>id,
<span class="hljs-keyword">from</span> (   
<span class="hljs-keyword">select</span> 
  id,
  val 
<span class="hljs-keyword">from</span> list
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id,val <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> a) <span class="hljs-keyword">as</span> b
<span class="hljs-keyword">where</span> b.rnk <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@N</span>) <span class="hljs-keyword">as</span> c
<span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> c.id;
</code></pre>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 7</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Try this: </p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> h.year, h.id, h.rate 
<span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> h.year, h.id, h.rate, IF(<span class="hljs-variable">@lastid</span> <span class="hljs-operator">=</span> (<span class="hljs-variable">@lastid</span>:<span class="hljs-operator">=</span>h.id), <span class="hljs-variable">@index</span>:<span class="hljs-operator">=</span><span class="hljs-variable">@index</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>, <span class="hljs-variable">@index</span>:<span class="hljs-operator">=</span><span class="hljs-number">0</span>) indx 
      <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> h.year, h.id, h.rate 
            <span class="hljs-keyword">FROM</span> h
            <span class="hljs-keyword">WHERE</span> h.year <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2000</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2009</span> <span class="hljs-keyword">AND</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> rid <span class="hljs-keyword">FROM</span> table2)
            <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> id, h.year
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id, rate <span class="hljs-keyword">DESC</span>
            ) h, (<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@lastid</span>:<span class="hljs-operator">=</span><span class="hljs-string">''</span>, <span class="hljs-variable">@index</span>:<span class="hljs-operator">=</span><span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> a
    ) h 
<span class="hljs-keyword">WHERE</span> h.indx <span class="hljs-operator">&lt;=</span> <span class="hljs-number">5</span>;
</code></pre>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 8</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Build the virtual columnslike RowID in Oracle</p>
<p><strong>Table:</strong></p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `stack` 
(`<span class="hljs-keyword">year</span>` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
`id` <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
`rate` <span class="hljs-type">float</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>) 
ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4
</code></pre>
<p><strong>Data:</strong></p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2006</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">8</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2001</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">5.9</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2007</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">5.3</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2009</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">4.4</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2001</span>,<span class="hljs-string">'p02'</span>,<span class="hljs-number">12.5</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2004</span>,<span class="hljs-string">'p02'</span>,<span class="hljs-number">12.4</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2005</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">2.1</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2000</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">0.8</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2002</span>,<span class="hljs-string">'p02'</span>,<span class="hljs-number">12.2</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2002</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">3.9</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2004</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">3.5</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2003</span>,<span class="hljs-string">'p02'</span>,<span class="hljs-number">10.3</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2000</span>,<span class="hljs-string">'p02'</span>,<span class="hljs-number">8.7</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2006</span>,<span class="hljs-string">'p02'</span>,<span class="hljs-number">4.6</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2007</span>,<span class="hljs-string">'p02'</span>,<span class="hljs-number">3.3</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2003</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">7.4</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> stack <span class="hljs-keyword">values</span>(<span class="hljs-number">2008</span>,<span class="hljs-string">'p01'</span>,<span class="hljs-number">6.8</span>);
</code></pre>
<p><strong>SQL like this:</strong></p>
<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">select</span> t3.year,t3.id,t3.rate 
<span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> t1.<span class="hljs-operator">*</span>, (<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> stack t2 <span class="hljs-keyword">where</span> t1.rate<span class="hljs-operator">&lt;=</span>t2.rate <span class="hljs-keyword">and</span> t1.id<span class="hljs-operator">=</span>t2.id) <span class="hljs-keyword">as</span> rownum <span class="hljs-keyword">from</span> stack t1) t3 
<span class="hljs-keyword">where</span> rownum <span class="hljs-operator">&lt;=</span><span class="hljs-number">3</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id,rate <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>If delete the where clause in t3, it shows like this:</p>
<p><a href="https://i.stack.imgur.com/lnxDj.jpg" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/lnxDj.jpg" alt="enter image description here"></a></p>
<p>GET "TOP N Record" --&gt; add the <code>rownum &lt;=3</code> in <code>where</code> clause (the where-clause of t3);</p>
<p>CHOOSE "the year" --&gt; add the <code>BETWEEN 2000 AND 2009</code> in <code>where</code> clause (the where-clause of t3);</p>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 9</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Took some working, but I thougth my solution would be something to share as it is seems elegant as well as quite fast.</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> h.year, h.id, h.rate 
  <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> id, 
      SUBSTRING_INDEX(GROUP_CONCAT(CONCAT(id, <span class="hljs-string">'-'</span>, <span class="hljs-keyword">year</span>) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rate <span class="hljs-keyword">DESC</span>), <span class="hljs-string">','</span> , <span class="hljs-number">5</span>) <span class="hljs-keyword">AS</span> l
      <span class="hljs-keyword">FROM</span> h
      <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">year</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2000</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2009</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> id
      <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id
  ) <span class="hljs-keyword">AS</span> h_temp
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> h <span class="hljs-keyword">ON</span> h.id <span class="hljs-operator">=</span> h_temp.id 
      <span class="hljs-keyword">AND</span> SUBSTRING_INDEX(h_temp.l, CONCAT(h.id, <span class="hljs-string">'-'</span>, h.year), <span class="hljs-number">1</span>) <span class="hljs-operator">!=</span> h_temp.l
</code></pre>

<p>Note that this example is specified for the purpose of the question and can be modified quite easily for other similar purposes.</p>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 10</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>The following post: <a href="http://code.openark.org/blog/mysql/sql-selecting-top-n-records-per-group" rel="nofollow">sql: selcting top N record per group</a> describes the complicated way of achieving this without subqueries.</p>

<p>It improves on other solutions offered here by:</p>

<ul>
<li>Doing everything in a single query</li>
<li>Being able to properly utilize indexes</li>
<li>Avoiding subqueries, notoriously known to produce bad execution plans in MySQL</li>
</ul>

<p>It is however not pretty. A good solution would be achievable were Window Functions (aka Analytic Functions) enabled in MySQL -- but they are not.
The trick used in said post utilizes GROUP_CONCAT, which is sometimes described as "poor man's Window Functions for MySQL".</p>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 11</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>for those like me that had queries time out. I made the below to use limits and anything else by a specific group.</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql">DELIMITER $$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> count_limit200()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> a <span class="hljs-type">INT</span> <span class="hljs-keyword">Default</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">DECLARE</span> stop_loop <span class="hljs-type">INT</span> <span class="hljs-keyword">Default</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">DECLARE</span> domain_val <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">250</span>);
    <span class="hljs-keyword">DECLARE</span> domain_list <span class="hljs-keyword">CURSOR</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> domain <span class="hljs-keyword">FROM</span> db.one;

    <span class="hljs-keyword">OPEN</span> domain_list;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span>(domain)) <span class="hljs-keyword">INTO</span> stop_loop 
    <span class="hljs-keyword">FROM</span> db.one;
    <span class="hljs-comment">-- BEGIN LOOP</span>
    loop_thru_domains: LOOP
        <span class="hljs-keyword">FETCH</span> domain_list <span class="hljs-keyword">INTO</span> domain_val;
        <span class="hljs-keyword">SET</span> a<span class="hljs-operator">=</span>a<span class="hljs-operator">+</span><span class="hljs-number">1</span>;

        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> db.two(book,artist,title,title_count,last_updated) 
        <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> 
        (
            <span class="hljs-keyword">SELECT</span> book,artist,title,<span class="hljs-built_in">COUNT</span>(ObjectKey) <span class="hljs-keyword">AS</span> titleCount, NOW() 
            <span class="hljs-keyword">FROM</span> db.one 
            <span class="hljs-keyword">WHERE</span> book <span class="hljs-operator">=</span> domain_val
            <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> artist,title
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> book,titleCount <span class="hljs-keyword">DESC</span>
            LIMIT <span class="hljs-number">200</span>
        ) a <span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> title_count <span class="hljs-operator">=</span> titleCount, last_updated <span class="hljs-operator">=</span> NOW();

        IF a <span class="hljs-operator">=</span> stop_loop <span class="hljs-keyword">THEN</span>
            LEAVE loop_thru_domain;
        <span class="hljs-keyword">END</span> IF;
    <span class="hljs-keyword">END</span> LOOP loop_thru_domain;
<span class="hljs-keyword">END</span> $$
</code></pre>

<p>it loops through a list of domains and then inserts only a limit of 200 each</p>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 12</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Try this:</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">SET</span> <span class="hljs-variable">@num</span> :<span class="hljs-operator">=</span> <span class="hljs-number">0</span>, <span class="hljs-variable">@type</span> :<span class="hljs-operator">=</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">SELECT</span> `<span class="hljs-keyword">year</span>`, `id`, `rate`,
    <span class="hljs-variable">@num</span> :<span class="hljs-operator">=</span> if(<span class="hljs-variable">@type</span> <span class="hljs-operator">=</span> `id`, <span class="hljs-variable">@num</span> <span class="hljs-operator">+</span> <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> `row_number`,
    <span class="hljs-variable">@type</span> :<span class="hljs-operator">=</span> `id` <span class="hljs-keyword">AS</span> `dummy`
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
    <span class="hljs-keyword">FROM</span> `h`
    <span class="hljs-keyword">WHERE</span> (
        `<span class="hljs-keyword">year</span>` <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2000'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2009'</span>
        <span class="hljs-keyword">AND</span> `id` <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> `rid` <span class="hljs-keyword">FROM</span> `table2`) <span class="hljs-keyword">AS</span> `temp_rid`
    )
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> `id`
) <span class="hljs-keyword">AS</span> `temph`
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> `<span class="hljs-keyword">year</span>`, `id`, `rate`
<span class="hljs-keyword">HAVING</span> `row_number`<span class="hljs-operator">&lt;=</span><span class="hljs-string">'5'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> `id`, `rate <span class="hljs-keyword">DESC</span>;
</code></pre>
    </div></div></div></div><div class="flex mt-5 answer items-center justify-center py-5"><div class="rounded-xl border p-10 shadow-md w-9/12 bg-white"><h4 class="text-4xl font-semibold mb-5">Solution 13</h4><div class=" items-center justify-between"><div class=" space-x-4 md:space-x-8">
<p>Please try below stored procedure. I have already verified. I am getting proper result but without using <code>groupby</code>.</p>

<pre class="lang-sql s-code-block"><code class="hljs language-sql"><span class="hljs-keyword">CREATE</span> DEFINER<span class="hljs-operator">=</span>`ks_root`@`<span class="hljs-operator">%</span>` <span class="hljs-keyword">PROCEDURE</span> `first_five_record_per_id`()
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">DECLARE</span> query_string text;
<span class="hljs-keyword">DECLARE</span> datasource1 <span class="hljs-type">varchar</span>(<span class="hljs-number">24</span>);
<span class="hljs-keyword">DECLARE</span> done <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">DECLARE</span> tenants <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>);
<span class="hljs-keyword">DECLARE</span> cur1 <span class="hljs-keyword">CURSOR</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> rid <span class="hljs-keyword">FROM</span> demo1;
<span class="hljs-keyword">DECLARE</span> CONTINUE HANDLER <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NOT</span> FOUND <span class="hljs-keyword">SET</span> done <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@query</span>_string<span class="hljs-operator">=</span><span class="hljs-string">''</span>;

      <span class="hljs-keyword">OPEN</span> cur1;
      read_loop: LOOP

      <span class="hljs-keyword">FETCH</span> cur1 <span class="hljs-keyword">INTO</span> tenants ;

      IF done <span class="hljs-keyword">THEN</span>
        LEAVE read_loop;
      <span class="hljs-keyword">END</span> IF;

      <span class="hljs-keyword">SET</span> <span class="hljs-variable">@datasource1</span> <span class="hljs-operator">=</span> tenants;
      <span class="hljs-keyword">SET</span> <span class="hljs-variable">@query</span>_string <span class="hljs-operator">=</span> concat(<span class="hljs-variable">@query</span>_string,<span class="hljs-string">'(select * from demo  where `id` = '''</span>,<span class="hljs-variable">@datasource1</span>,<span class="hljs-string">''' order by rate desc LIMIT 5) UNION ALL '</span>);

       <span class="hljs-keyword">END</span> LOOP; 
      <span class="hljs-keyword">close</span> cur1;

    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@query</span>_string  <span class="hljs-operator">=</span> <span class="hljs-built_in">TRIM</span>(<span class="hljs-keyword">TRAILING</span> <span class="hljs-string">'UNION ALL'</span> <span class="hljs-keyword">FROM</span> <span class="hljs-built_in">TRIM</span>(<span class="hljs-variable">@query</span>_string));  
  <span class="hljs-keyword">select</span> <span class="hljs-variable">@query</span>_string;
<span class="hljs-keyword">PREPARE</span> stmt <span class="hljs-keyword">FROM</span> <span class="hljs-variable">@query</span>_string;
<span class="hljs-keyword">EXECUTE</span> stmt;
<span class="hljs-keyword">DEALLOCATE</span> <span class="hljs-keyword">PREPARE</span> stmt;

<span class="hljs-keyword">END</span>
</code></pre>
    </div></div></div></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"answer":["\n\u0026lt;p\u0026gt;You could use \u0026lt;a href=\u0026quot;https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html#function_group-concat\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;GROUP_CONCAT\u0026lt;/a\u0026gt; aggregated function to get all years into a single column, grouped by \u0026lt;code\u0026gt;id\u0026lt;/code\u0026gt; and ordered by \u0026lt;code\u0026gt;rate\u0026lt;/code\u0026gt;:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;   id, GROUP_CONCAT(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) grouped_year\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;     yourtable\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Result:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-----------------------------------------------------------\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;  ID \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; GROUPED_YEAR                                      \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-----------------------------------------------------------\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p01 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2006\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2003\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2008\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2001\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2007\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2009\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2002\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2004\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2005\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; p02 \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2001\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2004\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2002\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2003\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2006\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2007\u0026lt;/span\u0026gt;                \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;|\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-----------------------------------------------------------\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;And then you could use \u0026lt;a href=\u0026quot;https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_find-in-set\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;FIND_IN_SET\u0026lt;/a\u0026gt;, that returns the position of the first argument inside the second one, eg.\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; FIND_IN_SET(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;2006\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;2006,2003,2008,2001,2007,2009,2002,2004,2005,2000\u0026apos;\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; FIND_IN_SET(\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;2009\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;2006,2003,2008,2001,2007,2009,2002,2004,2005,2000\u0026apos;\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Using a combination of \u0026lt;code\u0026gt;GROUP_CONCAT\u0026lt;/code\u0026gt; and \u0026lt;code\u0026gt;FIND_IN_SET\u0026lt;/code\u0026gt;, and filtering by the position returned by find_in_set, you could then use this query that returns only the first 5 years for every id:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;\n  yourtable.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;\n  yourtable \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INNER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;\n      id,\n      GROUP_CONCAT(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) grouped_year\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;\n      yourtable\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id) group_max\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; yourtable.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; group_max.id\n     \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; FIND_IN_SET(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;, grouped_year) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BETWEEN\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt;\n  yourtable.id, yourtable.year \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Please see fiddle \u0026lt;a href=\u0026quot;http://sqlfiddle.com/#!2/1c220/1\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;here\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;Please note that if more than one row can have the same rate, you should consider using \u0026lt;code\u0026gt;GROUP_CONCAT(DISTINCT rate ORDER BY rate)\u0026lt;/code\u0026gt; on the \u0026lt;code\u0026gt;rate\u0026lt;/code\u0026gt; column instead of the \u0026lt;code\u0026gt;year\u0026lt;/code\u0026gt; column.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;The maximum length of the string returned by \u0026lt;code\u0026gt;GROUP_CONCAT\u0026lt;/code\u0026gt; is limited, so this works well if you need to select a few records for every group.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;You want to find \u0026lt;em\u0026gt;\u0026lt;strong\u0026gt;top n rows per group\u0026lt;/strong\u0026gt;\u0026lt;/em\u0026gt;. This answer provides a generic solution using example data that is different from OP.\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;In MySQL 8 or later you can use the \u0026lt;a href=\u0026quot;https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;\u0026lt;code\u0026gt;ROW_NUMBER\u0026lt;/code\u0026gt;, \u0026lt;code\u0026gt;RANK\u0026lt;/code\u0026gt; or \u0026lt;code\u0026gt;DENSE_RANK\u0026lt;/code\u0026gt;\u0026lt;/a\u0026gt; function depending on the exact definition of top 5. Below are the numbers generated by these functions based on \u0026lt;code\u0026gt;value\u0026lt;/code\u0026gt; sorted descending. Notice how ties are handled:\u0026lt;/p\u0026gt;\n\u0026lt;div class=\u0026quot;s-table-container\u0026quot;\u0026gt;\n\u0026lt;table class=\u0026quot;s-table\u0026quot;\u0026gt;\n\u0026lt;thead\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;th style=\u0026quot;text-align: right;\u0026quot;\u0026gt;pkid\u0026lt;/th\u0026gt;\n\u0026lt;th\u0026gt;catid\u0026lt;/th\u0026gt;\n\u0026lt;th style=\u0026quot;text-align: right;\u0026quot;\u0026gt;value\u0026lt;/th\u0026gt;\n\u0026lt;th style=\u0026quot;text-align: right;\u0026quot;\u0026gt;row_number\u0026lt;/th\u0026gt;\n\u0026lt;th style=\u0026quot;text-align: right;\u0026quot;\u0026gt;rank\u0026lt;/th\u0026gt;\n\u0026lt;th style=\u0026quot;text-align: right;\u0026quot;\u0026gt;dense_rank\u0026lt;/th\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;/thead\u0026gt;\n\u0026lt;tbody\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;1\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;100\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*1\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*1\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*1\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;2\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;90\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*2\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*2\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*2\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;3\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;90\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*3\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*2\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*2\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;4\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;80\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*4\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*4\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*3\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;5\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;80\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*5\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*4\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*3\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;6\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;80\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;6\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*4\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*3\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;7\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;70\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;7\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;7\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*4\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;8\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;60\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;8\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;8\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;*5\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;9\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;50\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;9\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;9\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;6\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;tr\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;10\u0026lt;/td\u0026gt;\n\u0026lt;td\u0026gt;p01\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;40\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;10\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;10\u0026lt;/td\u0026gt;\n\u0026lt;td style=\u0026quot;text-align: right;\u0026quot;\u0026gt;7\u0026lt;/td\u0026gt;\n\u0026lt;/tr\u0026gt;\n\u0026lt;/tbody\u0026gt;\n\u0026lt;/table\u0026gt;\n\u0026lt;/div\u0026gt;\n\u0026lt;p\u0026gt;Once you have chosen the function, use it like so:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;ROW_NUMBER\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OVER\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PARTITION\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;value\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; t\n) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; x\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; n \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=mysql_8.0\u0026amp;amp;fiddle=29ff3dde85d2fb2085fcd195a7a9134e\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;DB\u0026amp;lt;\u0026amp;gt;Fiddle\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;hr\u0026gt;\n\u0026lt;p\u0026gt;In MySQL 5.x you can use poor man\u0026apos;s rank over partition to achieve desired result: outer join the table with itself and for each row, count the number of rows \u0026lt;em\u0026gt;\u0026lt;strong\u0026gt;before\u0026lt;/strong\u0026gt;\u0026lt;/em\u0026gt; it (e.g. the before row could be the one with higher value).\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;The following will produce results similar to \u0026lt;code\u0026gt;RANK\u0026lt;/code\u0026gt; function:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; t.pkid, t.catid, t.value, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;COUNT\u0026lt;/span\u0026gt;(b.value) \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; rank\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; t\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LEFT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; t \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; b \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; b.catid \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; t.catid \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; b.value \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt; t.value\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; t.pkid, t.catid, t.value\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;HAVING\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;COUNT\u0026lt;/span\u0026gt;(b.value) \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; t.catid, t.value \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;, t.pkid\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Make the following change to produce results similar to \u0026lt;code\u0026gt;DENSE_RANK\u0026lt;/code\u0026gt; function:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;COUNT\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt; b.value)\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;Or make the following change to produce results similar to \u0026lt;code\u0026gt;ROW_NUMBER\u0026lt;/code\u0026gt; function:\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; b.catid \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; t.catid \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; (b.value \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;gt;\u0026lt;/span\u0026gt; t.value \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OR\u0026lt;/span\u0026gt; b.value \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; t.value \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; b.pkid \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt; t.pkid)\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://dbfiddle.uk/?rdbms=mysql_5.5\u0026amp;amp;fiddle=d4baaf1a1df9b681545b13031e641d9f\u0026quot; rel=\u0026quot;noreferrer\u0026quot;\u0026gt;DB\u0026amp;lt;\u0026amp;gt;Fiddle\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;For me something like \u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;SUBSTRING_INDEX(group_concat(col_name \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; desired_col_order_name), \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;,\u0026apos;\u0026lt;/span\u0026gt;, N) \n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;works perfectly. No complicated query.\u0026lt;/p\u0026gt;\n\n\u0026lt;hr\u0026gt;\n\n\u0026lt;p\u0026gt;for example: get top 1 for each group\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \n    \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;\n    yourtable\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt;\n    id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IN\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \n            SUBSTRING_INDEX(GROUP_CONCAT(id\n                            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;),\n                        \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;,\u0026apos;\u0026lt;/span\u0026gt;,\n                        \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;) id\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt;\n            yourtable\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;No, you can\u0026apos;t LIMIT subqueries arbitrarily (you can do it to a limited extent in newer MySQLs, but not for 5 results per group).\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;This is a groupwise-maximum type query, which is not trivial to do in SQL. There are \u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/755918/simple-query-to-grab-max-value-for-each-id/756892#756892\u0026quot;\u0026gt;various ways\u0026lt;/a\u0026gt; to tackle that which can be more efficient for some cases, but for top-n in general you\u0026apos;ll want to look at \u0026lt;a href=\u0026quot;https://stackoverflow.com/questions/1442527/how-to-select-the-newest-four-items-per-category/1442867#1442867\u0026quot;\u0026gt;Bill\u0026apos;s answer\u0026lt;/a\u0026gt; to a similar previous question.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;As with most solutions to this problem, it can return more than five rows if there are multiple rows with the same \u0026lt;code\u0026gt;rate\u0026lt;/code\u0026gt; value, so you may still need a quantity of post-processing to check for that.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;, id, rate\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;, id, rate, \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;)\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; h\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BETWEEN\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2009\u0026lt;/span\u0026gt;\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IN\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; rid \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; table2)\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;\n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id, rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; subquery\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; row_number \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;The subquery is almost identical to your query. Only change is adding\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;row_number\u0026lt;/span\u0026gt;() \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;over\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;partition\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;)\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;This requires a series of subqueries to rank the values, limit them, then perform the sum while grouping\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@Rnk\u0026lt;/span\u0026gt;:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@N\u0026lt;/span\u0026gt;:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt;\n  c.id,\n  \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;sum\u0026lt;/span\u0026gt;(c.val)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; (\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt;\n  b.id,\n  b.bal\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; (\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt;   \n  if(\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@last\u0026lt;/span\u0026gt;_id\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;id,\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@Rnk\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; Rnk,\n  a.id,\n  a.val,\n  \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@last\u0026lt;/span\u0026gt;_id\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;id,\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; (   \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \n  id,\n  val \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; list\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; id,val \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;desc\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; a) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; b\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; b.rnk \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@N\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; c\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;group\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; c.id;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Try this: \u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; h.year, h.id, h.rate \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; h.year, h.id, h.rate, IF(\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@lastid\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@lastid\u0026lt;/span\u0026gt;:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;h.id), \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@index\u0026lt;/span\u0026gt;:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@index\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@index\u0026lt;/span\u0026gt;:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;) indx \n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; h.year, h.id, h.rate \n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; h\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; h.year \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BETWEEN\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2009\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IN\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; rid \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; table2)\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id, h.year\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id, rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n            ) h, (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@lastid\u0026lt;/span\u0026gt;:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@index\u0026lt;/span\u0026gt;:\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; a\n    ) h \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; h.indx \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Build the virtual columnslike RowID in Oracle\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Table:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TABLE\u0026lt;/span\u0026gt; `stack` \n(`\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;` \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;int\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;11\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DEFAULT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;NULL\u0026lt;/span\u0026gt;,\n`id` \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;varchar\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DEFAULT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;NULL\u0026lt;/span\u0026gt;,\n`rate` \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;float\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DEFAULT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;NULL\u0026lt;/span\u0026gt;) \nENGINE\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;InnoDB \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DEFAULT\u0026lt;/span\u0026gt; CHARSET\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;utf8mb4\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;Data:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2006\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;8\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2001\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5.9\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2007\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5.3\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2009\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4.4\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2001\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p02\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.5\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2004\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p02\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.4\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2005\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2.1\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0.8\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2002\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p02\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.2\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2002\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3.9\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2004\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3.5\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2003\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p02\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10.3\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p02\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;8.7\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2006\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p02\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4.6\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2007\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p02\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3.3\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2003\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;7.4\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;insert\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;into\u0026lt;/span\u0026gt; stack \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;values\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2008\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;p01\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6.8\u0026lt;/span\u0026gt;);\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;SQL like this:\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; t3.year,t3.id,t3.rate \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; t1.\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;, (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;count\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; stack t2 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; t1.rate\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;=\u0026lt;/span\u0026gt;t2.rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;and\u0026lt;/span\u0026gt; t1.id\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;t2.id) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;as\u0026lt;/span\u0026gt; rownum \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;from\u0026lt;/span\u0026gt; stack t1) t3 \n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;where\u0026lt;/span\u0026gt; rownum \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;order\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;by\u0026lt;/span\u0026gt; id,rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\u0026lt;p\u0026gt;If delete the where clause in t3, it shows like this:\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;\u0026lt;a href=\u0026quot;https://i.stack.imgur.com/lnxDj.jpg\u0026quot; rel=\u0026quot;nofollow noreferrer\u0026quot;\u0026gt;\u0026lt;img src=\u0026quot;https://i.stack.imgur.com/lnxDj.jpg\u0026quot; alt=\u0026quot;enter image description here\u0026quot;\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;GET \u0026quot;TOP N Record\u0026quot; --\u0026amp;gt; add the \u0026lt;code\u0026gt;rownum \u0026amp;lt;=3\u0026lt;/code\u0026gt; in \u0026lt;code\u0026gt;where\u0026lt;/code\u0026gt; clause (the where-clause of t3);\u0026lt;/p\u0026gt;\n\u0026lt;p\u0026gt;CHOOSE \u0026quot;the year\u0026quot; --\u0026amp;gt; add the \u0026lt;code\u0026gt;BETWEEN 2000 AND 2009\u0026lt;/code\u0026gt; in \u0026lt;code\u0026gt;where\u0026lt;/code\u0026gt; clause (the where-clause of t3);\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Took some working, but I thougth my solution would be something to share as it is seems elegant as well as quite fast.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; h.year, h.id, h.rate \n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; id, \n      SUBSTRING_INDEX(GROUP_CONCAT(CONCAT(id, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;-\u0026apos;\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;), \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;,\u0026apos;\u0026lt;/span\u0026gt; , \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; l\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; h\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BETWEEN\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2009\u0026lt;/span\u0026gt;\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id\n  ) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; h_temp\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;LEFT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;JOIN\u0026lt;/span\u0026gt; h \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; h.id \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; h_temp.id \n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; SUBSTRING_INDEX(h_temp.l, CONCAT(h.id, \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;-\u0026apos;\u0026lt;/span\u0026gt;, h.year), \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;!=\u0026lt;/span\u0026gt; h_temp.l\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Note that this example is specified for the purpose of the question and can be modified quite easily for other similar purposes.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;The following post: \u0026lt;a href=\u0026quot;http://code.openark.org/blog/mysql/sql-selecting-top-n-records-per-group\u0026quot; rel=\u0026quot;nofollow\u0026quot;\u0026gt;sql: selcting top N record per group\u0026lt;/a\u0026gt; describes the complicated way of achieving this without subqueries.\u0026lt;/p\u0026gt;\n\n\u0026lt;p\u0026gt;It improves on other solutions offered here by:\u0026lt;/p\u0026gt;\n\n\u0026lt;ul\u0026gt;\n\u0026lt;li\u0026gt;Doing everything in a single query\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Being able to properly utilize indexes\u0026lt;/li\u0026gt;\n\u0026lt;li\u0026gt;Avoiding subqueries, notoriously known to produce bad execution plans in MySQL\u0026lt;/li\u0026gt;\n\u0026lt;/ul\u0026gt;\n\n\u0026lt;p\u0026gt;It is however not pretty. A good solution would be achievable were Window Functions (aka Analytic Functions) enabled in MySQL -- but they are not.\nThe trick used in said post utilizes GROUP_CONCAT, which is sometimes described as \u0026quot;poor man\u0026apos;s Window Functions for MySQL\u0026quot;.\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;for those like me that had queries time out. I made the below to use limits and anything else by a specific group.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;DELIMITER $$\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PROCEDURE\u0026lt;/span\u0026gt; count_limit200()\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BEGIN\u0026lt;/span\u0026gt;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; a \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;INT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;Default\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; stop_loop \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;INT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;Default\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; domain_val \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;VARCHAR\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;250\u0026lt;/span\u0026gt;);\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; domain_list \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CURSOR\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FOR\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt; domain \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; db.one;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OPEN\u0026lt;/span\u0026gt; domain_list;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;COUNT\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DISTINCT\u0026lt;/span\u0026gt;(domain)) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INTO\u0026lt;/span\u0026gt; stop_loop \n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; db.one;\n    \u0026lt;span class=\u0026quot;hljs-comment\u0026quot;\u0026gt;-- BEGIN LOOP\u0026lt;/span\u0026gt;\n    loop_thru_domains: LOOP\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FETCH\u0026lt;/span\u0026gt; domain_list \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INTO\u0026lt;/span\u0026gt; domain_val;\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SET\u0026lt;/span\u0026gt; a\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;a\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INSERT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INTO\u0026lt;/span\u0026gt; db.two(book,artist,title,title_count,last_updated) \n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; \n        (\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; book,artist,title,\u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;COUNT\u0026lt;/span\u0026gt;(ObjectKey) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; titleCount, NOW() \n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; db.one \n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; book \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; domain_val\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; artist,title\n            \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; book,titleCount \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n            LIMIT \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;200\u0026lt;/span\u0026gt;\n        ) a \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ON\u0026lt;/span\u0026gt; DUPLICATE KEY \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;UPDATE\u0026lt;/span\u0026gt; title_count \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; titleCount, last_updated \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; NOW();\n\n        IF a \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; stop_loop \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;THEN\u0026lt;/span\u0026gt;\n            LEAVE loop_thru_domain;\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;END\u0026lt;/span\u0026gt; IF;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;END\u0026lt;/span\u0026gt; LOOP loop_thru_domain;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;END\u0026lt;/span\u0026gt; $$\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;it loops through a list of domains and then inserts only a limit of 200 each\u0026lt;/p\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Try this:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SET\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@num\u0026lt;/span\u0026gt; :\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@type\u0026lt;/span\u0026gt; :\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;\u0026apos;\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; `\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;`, `id`, `rate`,\n    \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@num\u0026lt;/span\u0026gt; :\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; if(\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@type\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; `id`, \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@num\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;+\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;, \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; `row_number`,\n    \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@type\u0026lt;/span\u0026gt; :\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; `id` \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; `dummy`\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; (\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;*\u0026lt;/span\u0026gt;\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; `h`\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; (\n        `\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;` \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BETWEEN\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;2000\u0026apos;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;2009\u0026apos;\u0026lt;/span\u0026gt;\n        \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; `id` \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IN\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; `rid` \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; `table2`) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; `temp_rid`\n    )\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; `id`\n) \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AS\u0026lt;/span\u0026gt; `temph`\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; `\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;`, `id`, `rate`\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;HAVING\u0026lt;/span\u0026gt; `row_number`\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;\u0026amp;lt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;5\u0026apos;\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; `id`, `rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    ","\n\u0026lt;p\u0026gt;Please try below stored procedure. I have already verified. I am getting proper result but without using \u0026lt;code\u0026gt;groupby\u0026lt;/code\u0026gt;.\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CREATE\u0026lt;/span\u0026gt; DEFINER\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;`ks_root`@`\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;%\u0026lt;/span\u0026gt;` \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PROCEDURE\u0026lt;/span\u0026gt; `first_five_record_per_id`()\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BEGIN\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; query_string text;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; datasource1 \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;varchar\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;24\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; done \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;INT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DEFAULT\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0\u0026lt;/span\u0026gt;;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; tenants \u0026lt;span class=\u0026quot;hljs-type\u0026quot;\u0026gt;varchar\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;50\u0026lt;/span\u0026gt;);\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; cur1 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;CURSOR\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FOR\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; rid \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; demo1;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DECLARE\u0026lt;/span\u0026gt; CONTINUE HANDLER \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FOR\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;NOT\u0026lt;/span\u0026gt; FOUND \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SET\u0026lt;/span\u0026gt; done \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;1\u0026lt;/span\u0026gt;;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SET\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@query\u0026lt;/span\u0026gt;_string\u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;\u0026apos;\u0026lt;/span\u0026gt;;\n\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;OPEN\u0026lt;/span\u0026gt; cur1;\n      read_loop: LOOP\n\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FETCH\u0026lt;/span\u0026gt; cur1 \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;INTO\u0026lt;/span\u0026gt; tenants ;\n\n      IF done \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;THEN\u0026lt;/span\u0026gt;\n        LEAVE read_loop;\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;END\u0026lt;/span\u0026gt; IF;\n\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SET\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@datasource1\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; tenants;\n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SET\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@query\u0026lt;/span\u0026gt;_string \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; concat(\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@query\u0026lt;/span\u0026gt;_string,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;(select * from demo  where `id` = \u0026apos;\u0026apos;\u0026apos;\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@datasource1\u0026lt;/span\u0026gt;,\u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;\u0026apos;\u0026apos; order by rate desc LIMIT 5) UNION ALL \u0026apos;\u0026lt;/span\u0026gt;);\n\n       \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;END\u0026lt;/span\u0026gt; LOOP; \n      \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;close\u0026lt;/span\u0026gt; cur1;\n\n    \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SET\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@query\u0026lt;/span\u0026gt;_string  \u0026lt;span class=\u0026quot;hljs-operator\u0026quot;\u0026gt;=\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;TRIM\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;TRAILING\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-string\u0026quot;\u0026gt;\u0026apos;UNION ALL\u0026apos;\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-built_in\u0026quot;\u0026gt;TRIM\u0026lt;/span\u0026gt;(\u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@query\u0026lt;/span\u0026gt;_string));  \n  \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;select\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@query\u0026lt;/span\u0026gt;_string;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PREPARE\u0026lt;/span\u0026gt; stmt \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-variable\u0026quot;\u0026gt;@query\u0026lt;/span\u0026gt;_string;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;EXECUTE\u0026lt;/span\u0026gt; stmt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DEALLOCATE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;PREPARE\u0026lt;/span\u0026gt; stmt;\n\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;END\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n    "],"id":529,"title":"Using LIMIT within GROUP BY to get N results per group?","content":"\n                \n\u0026lt;p\u0026gt;The following query:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;, id, rate\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; h\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;WHERE\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BETWEEN\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2009\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;AND\u0026lt;/span\u0026gt; id \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;IN\u0026lt;/span\u0026gt; (\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;SELECT\u0026lt;/span\u0026gt; rid \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;FROM\u0026lt;/span\u0026gt; table2)\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;GROUP\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id, \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;ORDER\u0026lt;/span\u0026gt; \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;BY\u0026lt;/span\u0026gt; id, rate \u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;DESC\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;yields:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-keyword\u0026quot;\u0026gt;year\u0026lt;/span\u0026gt;    id  rate\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2006\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;8\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2003\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;7.4\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2008\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6.8\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2001\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5.9\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2007\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5.3\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2009\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4.4\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2002\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3.9\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2004\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3.5\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2005\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2.1\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;0.8\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2001\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.5\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2004\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.4\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2002\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.2\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2003\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10.3\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;8.7\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2006\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;4.6\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2007\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;3.3\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;What I\u0026apos;d like is only the top 5 results for each id:\u0026lt;/p\u0026gt;\n\n\u0026lt;pre class=\u0026quot;lang-sql s-code-block\u0026quot;\u0026gt;\u0026lt;code class=\u0026quot;hljs language-sql\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2006\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;8\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2003\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;7.4\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2008\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;6.8\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2001\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5.9\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2007\u0026lt;/span\u0026gt;    p01 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;5.3\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2001\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.5\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2004\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.4\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2002\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;12.2\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2003\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;10.3\u0026lt;/span\u0026gt;\n\u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;2000\u0026lt;/span\u0026gt;    p02 \u0026lt;span class=\u0026quot;hljs-number\u0026quot;\u0026gt;8.7\u0026lt;/span\u0026gt;\n\u0026lt;/code\u0026gt;\u0026lt;/pre\u0026gt;\n\n\u0026lt;p\u0026gt;Is there a way to do this using some kind of LIMIT like modifier that works within the GROUP BY?\u0026lt;/p\u0026gt;\n    ","slug":"using-limit-within-group-by-to-get-n-results-per-group-1657388324167","postType":"QUESTION","createdAt":"2022-07-09T17:38:44.000Z","updatedAt":"2022-07-09T17:38:44.000Z","tags":[{"id":2604,"name":"ranking","slug":"ranking","createdAt":"2022-07-09T17:38:44.000Z","updatedAt":"2022-07-09T17:38:44.000Z","Questions_Tags":{"questionId":529,"tagId":2604}}]}},"__N_SSG":true},"page":"/questions/[slug]","query":{"slug":"using-limit-within-group-by-to-get-n-results-per-group-1657388324167"},"buildId":"B9ZMQqRLGvIP-RcWN9dT2","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>